<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Bit D&D Character Creator</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b2500">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="D&D Creator">
    <link rel="apple-touch-icon" href="icons/icon.svg">
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: #2d1b0e;
            font-family: 'Press Start 2P', cursive;
            color: #f4e4bc;
            overflow-x: hidden;
        }

        /* ===== HEADER ===== */
        .header {
            background: #1a0f07;
            border-bottom: 4px solid #8b2500;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 0 #1a0f07;
        }

        .header h1 {
            color: #8b2500;
            font-size: 1rem;
            text-shadow: 3px 3px 0 #1a0f07;
        }

        .header h1 span {
            color: #daa520;
        }

        .sound-toggle {
            background: #3d2817;
            border: 3px solid #8b4513;
            color: #f4e4bc;
            padding: 8px 12px;
            font-family: inherit;
            font-size: 0.6rem;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
        }

        .sound-toggle:hover {
            background: #5c3317;
        }

        .sound-toggle.muted {
            color: #6b4423;
        }

        /* ===== MAIN LAYOUT ===== */
        .main-container {
            display: flex;
            min-height: calc(100vh - 60px);
        }

        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .preview-panel {
            width: 300px;
            background: #1a0f07;
            border-left: 4px solid #8b4513;
            padding: 15px;
            overflow-y: auto;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-bar {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .progress-step {
            background: #3d2817;
            border: 3px solid #8b4513;
            padding: 8px 12px;
            font-size: 0.5rem;
            color: #6b4423;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
        }

        .progress-step:hover {
            background: #5c3317;
        }

        .progress-step.active {
            background: #8b2500;
            border-color: #b8860b;
            color: #f4e4bc;
            box-shadow: 3px 3px 0 #1a0f07, 0 0 10px #8b2500;
        }

        .progress-step.completed {
            background: #1e4620;
            border-color: #2e7d32;
            color: #81c784;
        }

        .progress-step.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== STEP CONTAINER ===== */
        .step-container {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            color: #daa520;
            font-size: 1rem;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #1a0f07;
            text-align: center;
        }

        .step-subtitle {
            color: #c4a574;
            font-size: 0.5rem;
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.8;
        }

        /* ===== FORM ELEMENTS ===== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #daa520;
            font-size: 0.6rem;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            max-width: 400px;
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #2d1b0e;
            padding: 15px 12px;
            font-family: inherit;
            font-size: 0.7rem;
            box-shadow: inset 2px 2px 0 #d4c4a0;
            line-height: 1.2;
        }

        .form-input:focus {
            outline: none;
            border-color: #8b2500;
            box-shadow: inset 2px 2px 0 #d4c4a0, 0 0 10px #8b250044;
        }

        /* ===== ALIGNMENT GRID ===== */
        .alignment-grid {
            display: grid;
            grid-template-columns: repeat(3, auto);
            gap: 8px;
            max-width: 500px;
        }

        .alignment-btn {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #5c3317;
            padding: 14px 8px;
            font-family: inherit;
            font-size: 0.55rem;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
            line-height: 1.4;
            white-space: nowrap;
        }

        .alignment-btn:hover {
            background: #e8d4a8;
            color: #2d1b0e;
        }

        .alignment-btn.selected {
            background: #8b2500;
            border-color: #b8860b;
            color: #f4e4bc;
            box-shadow: 3px 3px 0 #1a0f07, 0 0 8px #8b2500;
        }

        /* ===== CARD GRID ===== */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .card {
            background: #f4e4bc;
            border: 4px solid #8b4513;
            padding: 15px;
            cursor: pointer;
            box-shadow: 4px 4px 0 #1a0f07;
            transition: all 0.2s;
        }

        .card:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #1a0f07;
            border-color: #a0522d;
        }

        .card.selected {
            border-color: #8b2500;
            box-shadow: 4px 4px 0 #1a0f07, 0 0 15px #8b250066;
        }

        .card-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .card-title {
            color: #8b2500;
            font-size: 0.6rem;
            margin-bottom: 8px;
            text-align: center;
        }

        .card-subtitle {
            color: #5c3317;
            font-size: 0.55rem;
            text-align: center;
            line-height: 1.6;
        }

        .card-stats {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #8b4513;
        }

        .card-stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.55rem;
            color: #6b4423;
            margin-bottom: 4px;
        }

        .card-stat-value {
            color: #2e7d32;
        }

        /* ===== SUBRACE PANEL ===== */
        .subrace-panel {
            background: #3d2817;
            border: 4px solid #8b4513;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .subrace-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .subrace-title {
            color: #daa520;
            font-size: 0.7rem;
            margin-bottom: 15px;
        }

        .subrace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .subrace-card {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            padding: 12px;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
        }

        .subrace-card:hover {
            border-color: #a0522d;
        }

        .subrace-card.selected {
            border-color: #2e7d32;
            box-shadow: 3px 3px 0 #1a0f07, 0 0 10px #2e7d3266;
        }

        .subrace-name {
            color: #8b2500;
            font-size: 0.55rem;
            margin-bottom: 6px;
        }

        .subrace-bonus {
            color: #2e7d32;
            font-size: 0.55rem;
        }

        /* ===== TRAIT LIST ===== */
        .traits-panel {
            background: #3d2817;
            border: 4px solid #8b4513;
            padding: 20px;
            margin-top: 20px;
        }

        .traits-title {
            color: #daa520;
            font-size: 0.7rem;
            margin-bottom: 15px;
        }

        .trait-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #5c3317;
        }

        .trait-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .trait-name {
            color: #daa520;
            font-size: 0.5rem;
            margin-bottom: 4px;
        }

        .trait-desc {
            color: #c4a574;
            font-size: 0.55rem;
            line-height: 1.8;
        }

        /* ===== NAVIGATION BUTTONS ===== */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 4px solid #5c3317;
        }

        .nav-btn {
            background: #3d2817;
            border: 4px solid #8b4513;
            color: #f4e4bc;
            padding: 12px 25px;
            font-family: inherit;
            font-size: 0.6rem;
            cursor: pointer;
            box-shadow: 4px 4px 0 #1a0f07;
            transition: all 0.2s;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #1a0f07;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn.primary {
            background: #8b2500;
            border-color: #b8860b;
        }

        .nav-btn.primary:hover:not(:disabled) {
            background: #a52a00;
        }

        /* ===== CHARACTER PREVIEW ===== */
        .preview-title {
            color: #daa520;
            font-size: 0.7rem;
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 2px 2px 0 #1a0f07;
        }

        .preview-section {
            background: #3d2817;
            border: 3px solid #8b4513;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 3px 3px 0 #1a0f07;
        }

        .preview-label {
            color: #c4a574;
            font-size: 0.55rem;
            margin-bottom: 4px;
        }

        .preview-value {
            color: #daa520;
            font-size: 0.55rem;
        }

        .preview-value.empty {
            color: #6b4423;
            font-style: italic;
        }

        .preview-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .preview-stat {
            background: #2d1b0e;
            border: 2px solid #5c3317;
            padding: 8px;
            text-align: center;
        }

        .preview-stat-name {
            color: #c4a574;
            font-size: 0.5rem;
            margin-bottom: 4px;
        }

        .preview-stat-value {
            color: #81c784;
            font-size: 0.7rem;
        }

        .preview-stat-mod {
            color: #6b4423;
            font-size: 0.55rem;
        }

        /* Subclass Features in Preview */
        .subclass-feature-item {
            padding: 2px 0;
            font-size: 0.45rem;
        }

        .subclass-feature-item .feature-name {
            color: #b8860b;
        }

        .subclass-feature-item .feature-level {
            color: #6b4423;
            font-size: 0.55rem;
        }

        /* Subclass granted spell indicator */
        .spell-granted {
            border-color: #b8860b !important;
            box-shadow: 0 0 10px rgba(184, 134, 11, 0.3);
        }

        .spell-granted::after {
            content: 'â˜…';
            position: absolute;
            top: 5px;
            right: 5px;
            color: #b8860b;
            font-size: 0.5rem;
        }

        .granted-spell-badge {
            background: #b8860b;
            color: #1a0f07;
            padding: 2px 6px;
            font-size: 0.5rem;
            border-radius: 2px;
            margin-left: 5px;
        }

        /* ===== ABILITY SCORES ===== */
        .method-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .method-btn {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #5c3317;
            padding: 12px 20px;
            font-family: inherit;
            font-size: 0.5rem;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
        }

        .method-btn:hover {
            background: #e8d4a8;
            color: #2d1b0e;
        }

        .method-btn.active {
            background: #8b2500;
            border-color: #b8860b;
            color: #f4e4bc;
        }

        .ability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            max-width: 700px;
            margin: 0 auto 25px;
        }

        .ability-box {
            background: #f4e4bc;
            border: 4px solid #8b4513;
            padding: 15px;
            text-align: center;
            box-shadow: 4px 4px 0 #1a0f07;
        }

        .ability-box.highlight {
            border-color: #2e7d32;
            box-shadow: 4px 4px 0 #1a0f07, 0 0 10px #2e7d3244;
        }

        .ability-name {
            color: #8b2500;
            font-size: 0.6rem;
            margin-bottom: 8px;
        }

        .ability-score {
            color: #2d1b0e;
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .ability-mod {
            color: #2e7d32;
            font-size: 0.7rem;
        }

        .ability-bonus {
            color: #1565c0;
            font-size: 0.45rem;
            margin-top: 6px;
        }

        .ability-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .ability-btn {
            background: #8b4513;
            border: 2px solid #a0522d;
            color: #f4e4bc;
            width: 28px;
            height: 28px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ability-btn:hover:not(:disabled) {
            background: #a0522d;
        }

        .ability-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Point Buy Info */
        .points-remaining {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #3d2817;
            border: 3px solid #8b4513;
        }

        .points-label {
            color: #c4a574;
            font-size: 0.5rem;
            margin-bottom: 5px;
        }

        .points-value {
            color: #daa520;
            font-size: 1.2rem;
        }

        .points-value.warning {
            color: #cd853f;
        }

        .points-value.depleted {
            color: #8b0000;
        }

        /* Standard Array */
        .standard-array {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .array-value {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            padding: 12px 18px;
            font-size: 0.8rem;
            color: #2d1b0e;
            cursor: grab;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
        }

        .array-value:hover {
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 #1a0f07;
        }

        .array-value.used {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .array-value.dragging {
            opacity: 0.5;
        }

        .ability-drop-zone {
            min-height: 40px;
            border: 2px dashed #8b4513;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ability-drop-zone.drag-over {
            border-color: #8b2500;
            background: #8b250022;
        }

        .ability-drop-zone.filled {
            border-style: solid;
            border-color: #2e7d32;
        }

        /* Racial Bonus Selection */
        .racial-bonus-panel {
            background: #3d2817;
            border: 4px solid #8b2500;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .racial-bonus-title {
            color: #daa520;
            font-size: 0.6rem;
            margin-bottom: 10px;
        }

        .racial-bonus-subtitle {
            color: #c4a574;
            font-size: 0.55rem;
            margin-bottom: 15px;
        }

        .racial-bonus-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .racial-bonus-btn {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #5c3317;
            padding: 10px 15px;
            font-family: inherit;
            font-size: 0.5rem;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
        }

        .racial-bonus-btn:hover:not(:disabled) {
            background: #e8d4a8;
            color: #2d1b0e;
        }

        .racial-bonus-btn.selected {
            background: #8b2500;
            border-color: #b8860b;
            color: #f4e4bc;
        }

        .racial-bonus-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .racial-bonus-counter {
            color: #daa520;
            font-size: 0.5rem;
            margin-top: 15px;
        }

        /* Background Cards */
        .background-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .background-card {
            background: #f4e4bc;
            border: 4px solid #8b4513;
            padding: 15px;
            cursor: pointer;
            box-shadow: 4px 4px 0 #1a0f07;
            transition: all 0.2s;
            text-align: center;
        }

        .background-card:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #1a0f07;
            border-color: #a0522d;
        }

        .background-card.selected {
            border-color: #8b2500;
            box-shadow: 4px 4px 0 #1a0f07, 0 0 15px #8b250055;
        }

        .background-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .background-name {
            color: #8b2500;
            font-size: 0.5rem;
        }

        .background-skills {
            color: #2e7d32;
            font-size: 0.5rem;
            margin-top: 5px;
        }

        /* Background Details Panel */
        .background-details {
            background: #3d2817;
            border: 4px solid #8b4513;
            padding: 20px;
            margin-bottom: 25px;
        }

        .background-details-title {
            color: #daa520;
            font-size: 0.7rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .background-details-title span {
            font-size: 1.5rem;
        }

        .background-section {
            margin-bottom: 15px;
        }

        .background-section-title {
            color: #daa520;
            font-size: 0.45rem;
            margin-bottom: 8px;
        }

        .background-section-content {
            color: #c4a574;
            font-size: 0.55rem;
            line-height: 1.6;
        }

        .background-feature {
            background: #f4e4bc;
            border-left: 4px solid #8b2500;
            padding: 10px 15px;
            margin: 10px 0;
        }

        .background-feature-name {
            color: #8b2500;
            font-size: 0.45rem;
            margin-bottom: 5px;
        }

        .background-feature-desc {
            color: #2d1b0e;
            font-size: 0.55rem;
            line-height: 1.5;
        }

        /* Personality Selection */
        .personality-section {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            padding: 15px;
            margin-bottom: 15px;
        }

        .personality-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .personality-title {
            color: #8b2500;
            font-size: 0.5rem;
        }

        .random-btn {
            background: #8b4513;
            border: 2px solid #a0522d;
            color: #f4e4bc;
            padding: 5px 10px;
            font-size: 0.5rem;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 2px 2px 0 #1a0f07;
        }

        .random-btn:hover {
            background: #a0522d;
        }

        .personality-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .personality-option {
            background: #e8d4a8;
            border: 2px solid #8b4513;
            padding: 10px;
            cursor: pointer;
            font-size: 0.5rem;
            color: #5c3317;
            text-align: left;
            transition: all 0.2s;
        }

        .personality-option:hover {
            border-color: #a0522d;
            color: #2d1b0e;
        }

        .personality-option.selected {
            border-color: #2e7d32;
            color: #1e4620;
            background: #c8e6c9;
        }

        /* Skills Selection */
        .skills-section {
            background: #3d2817;
            border: 4px solid #8b4513;
            padding: 20px;
            margin-bottom: 25px;
        }

        .skills-title {
            color: #daa520;
            font-size: 0.6rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .skills-subtitle {
            color: #c4a574;
            font-size: 0.55rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .skill-item {
            background: #f4e4bc;
            border: 2px solid #8b4513;
            padding: 8px 12px;
            font-size: 0.55rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skill-item:hover:not(.locked):not(.granted) {
            border-color: #a0522d;
        }

        .skill-item.selected {
            border-color: #2e7d32;
            background: #c8e6c9;
        }

        .skill-item.granted {
            border-color: #8b2500;
            background: #f4d4bc;
            cursor: default;
        }

        .skill-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skill-name {
            color: #2d1b0e;
        }

        .skill-ability {
            color: #6b4423;
            font-size: 0.5rem;
        }

        .skill-item.selected .skill-name,
        .skill-item.granted .skill-name {
            color: #1e4620;
        }

        .skill-item.granted .skill-name {
            color: #8b2500;
        }

        .skill-source {
            font-size: 0.45rem;
            color: #6b4423;
            margin-left: 5px;
        }

        /* Equipment Section */
        .equipment-container {
            display: grid;
            gap: 20px;
        }

        .equipment-choices {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .equipment-choice {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            padding: 15px;
        }

        .equipment-choice-title {
            color: #8b2500;
            font-size: 0.5rem;
            margin-bottom: 10px;
        }

        .equipment-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .equipment-option {
            background: #e8d4a8;
            border: 2px solid #8b4513;
            padding: 10px 15px;
            font-size: 0.55rem;
            color: #5c3317;
            cursor: pointer;
            transition: all 0.2s;
        }

        .equipment-option:hover {
            border-color: #a0522d;
            color: #2d1b0e;
        }

        .equipment-option.selected {
            border-color: #2e7d32;
            color: #1e4620;
            background: #c8e6c9;
        }

        .equipment-option.incompatible {
            opacity: 0.4;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .equipment-option.incompatible:hover {
            border-color: #8b4513;
            color: #6b4423;
        }

        .equipment-granted, .equipment-summary {
            background: #3d2817;
            border: 3px solid #8b4513;
            padding: 15px;
        }

        .equipment-section-title {
            color: #daa520;
            font-size: 0.5rem;
            margin-bottom: 10px;
        }

        .equipment-item {
            color: #c4a574;
            font-size: 0.55rem;
            padding: 5px 0;
            border-bottom: 1px solid #5c3317;
        }

        .equipment-item:last-child {
            border-bottom: none;
        }

        /* Spells Section */
        .non-caster-panel {
            background: #f4e4bc;
            border: 4px solid #8b4513;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
        }

        .non-caster-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .non-caster-text {
            color: #8b2500;
            font-size: 0.6rem;
            margin-bottom: 10px;
        }

        .non-caster-subtext {
            color: #5c3317;
            font-size: 0.55rem;
        }

        .spell-info-panel {
            background: #3d2817;
            border: 3px solid #8b2500;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .spell-info-item {
            text-align: center;
        }

        .spell-info-label {
            color: #c4a574;
            font-size: 0.5rem;
            margin-bottom: 5px;
        }

        .spell-info-value {
            color: #daa520;
            font-size: 0.6rem;
        }

        .spell-info-wide {
            width: 100%;
            margin-top: 10px;
        }

        .spell-slots-display {
            font-size: 0.55rem;
        }

        .spell-section-title {
            color: #daa520;
            font-size: 0.55rem;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #8b4513;
        }

        .spell-section-title span {
            color: #2e7d32;
        }

        .cantrips-section, .spells-section {
            margin-bottom: 25px;
        }

        .spell-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .spell-card {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .spell-card:hover {
            border-color: #a0522d;
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 #1a0f07;
        }

        .spell-card.selected {
            border-color: #2e7d32;
            background: #c8e6c9;
        }

        .spell-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .spell-name {
            color: #2d1b0e;
            font-size: 0.45rem;
            margin-bottom: 5px;
        }

        .spell-school {
            color: #6b4423;
            font-size: 0.45rem;
            margin-bottom: 8px;
        }

        .spell-desc {
            color: #5c3317;
            font-size: 0.45rem;
            line-height: 1.4;
        }

        .spell-card.selected .spell-name {
            color: #1e4620;
        }

        /* Level Selection */
        .level-selector {
            background: #3d2817;
            border: 4px solid #8b2500;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
        }

        .level-label {
            color: #daa520;
            font-size: 0.6rem;
            margin-bottom: 15px;
        }

        .level-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .level-btn {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #2d1b0e;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
        }

        .level-btn:hover {
            background: #e8d4a8;
        }

        .level-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 #1a0f07;
        }

        .level-display {
            color: #daa520;
            font-size: 2rem;
            min-width: 80px;
            text-shadow: 3px 3px 0 #1a0f07;
        }

        .level-slider {
            width: 100%;
            max-width: 400px;
            height: 20px;
            -webkit-appearance: none;
            background: #f4e4bc;
            border: 3px solid #8b4513;
            outline: none;
        }

        .level-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            background: #8b2500;
            border: 3px solid #b8860b;
            cursor: pointer;
        }

        .level-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            background: #8b2500;
            border: 3px solid #b8860b;
            cursor: pointer;
        }

        /* Level Summary */
        .level-summary {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .level-summary-item {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            padding: 15px 25px;
            text-align: center;
        }

        .level-summary-label {
            display: block;
            color: #6b4423;
            font-size: 0.5rem;
            margin-bottom: 5px;
        }

        .level-summary-value {
            color: #8b2500;
            font-size: 0.7rem;
        }

        /* Spell Summary Panel */
        .spell-summary-panel {
            background: #3d2817;
            border: 4px solid #6b5b95;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .spell-summary-title {
            color: #9370db;
            font-size: 0.6rem;
            margin-bottom: 15px;
        }

        .spell-summary-stats {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 0.55rem;
            color: #c4a574;
        }

        .spell-summary-stats strong {
            color: #daa520;
        }

        .spell-slots-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .slot-label {
            color: #c4a574;
            font-size: 0.5rem;
        }

        .slot-info {
            background: #f4e4bc;
            border: 2px solid #8b4513;
            padding: 5px 10px;
            font-size: 0.5rem;
            color: #2d1b0e;
        }

        .spell-warning {
            color: #cd853f;
            font-size: 0.55rem;
            margin-bottom: 15px;
        }

        .edit-spells-btn {
            background: #6b5b95;
            border: 3px solid #9370db;
            color: #f4e4bc;
            padding: 10px 20px;
            font-size: 0.55rem;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
        }

        .edit-spells-btn:hover {
            background: #9370db;
        }

        /* Subclass Features Panel */
        .subclass-features-panel {
            background: #3d2817;
            border: 4px solid #b8860b;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
            box-shadow: 5px 5px 0 #1a0f07;
        }

        .subclass-features-title {
            color: #b8860b;
            font-size: 0.6rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .subclass-features-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .subclass-feature-card {
            background: #f4e4bc;
            border: 2px solid #8b4513;
            padding: 12px;
            position: relative;
        }

        .subclass-feature-name {
            color: #8b2500;
            font-size: 0.5rem;
            margin-bottom: 5px;
        }

        .subclass-feature-level {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #6b4423;
            font-size: 0.5rem;
        }

        .subclass-feature-desc {
            color: #5c3317;
            font-size: 0.5rem;
            line-height: 1.4;
        }

        /* Feat Options Section */
        .feat-options-section {
            background: #3d2817;
            border: 4px solid #8e5ea2;
            padding: 20px;
            margin-bottom: 20px;
        }

        .feat-options-title {
            color: #ba68c8;
            font-size: 0.6rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .feat-fixed-spells, .feat-spell-choices {
            margin-bottom: 15px;
        }

        .feat-spell-label {
            color: #daa520;
            font-size: 0.55rem;
            margin-bottom: 8px;
        }

        .feat-spell-item {
            background: #f4e4bc;
            border: 2px solid #8b4513;
            padding: 8px 12px;
            font-size: 0.5rem;
            color: #5c3317;
            margin-bottom: 5px;
            display: inline-block;
            margin-right: 8px;
        }

        .feat-spell-item.granted {
            border-color: #8e5ea2;
            color: #8e5ea2;
        }

        .feat-spell-note {
            color: #cd853f;
            font-size: 0.5rem;
            font-style: italic;
        }

        /* ASI/Feat Section */
        .asi-section {
            background: #3d2817;
            border: 4px solid #8b4513;
            padding: 20px;
            margin-bottom: 20px;
        }

        .asi-section.active {
            border-color: #8b2500;
        }

        .asi-title {
            color: #daa520;
            font-size: 0.6rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .asi-subtitle {
            color: #c4a574;
            font-size: 0.55rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .asi-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .asi-toggle-btn {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #5c3317;
            padding: 12px 25px;
            font-size: 0.45rem;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
        }

        .asi-toggle-btn:hover {
            background: #e8d4a8;
        }

        .asi-toggle-btn.active {
            background: #8b2500;
            border-color: #b8860b;
            color: #f4e4bc;
        }

        /* ASI Ability Selection */
        .asi-abilities {
            display: none;
        }

        .asi-abilities.active {
            display: block;
        }

        .asi-ability-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .asi-ability-btn {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #2d1b0e;
            padding: 15px 20px;
            font-size: 0.5rem;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            min-width: 80px;
            text-align: center;
        }

        .asi-ability-btn:hover:not(.disabled) {
            background: #e8d4a8;
        }

        .asi-ability-btn.selected {
            border-color: #2e7d32;
            background: #c8e6c9;
            color: #1e4620;
        }

        .asi-ability-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .asi-ability-score {
            display: block;
            font-size: 0.5rem;
            color: #6b4423;
            margin-top: 5px;
        }

        .asi-ability-btn.selected .asi-ability-score {
            color: #1e4620;
        }

        /* Feat Grid */
        .feat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }

        .feat-card {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feat-card:hover:not(.disabled) {
            border-color: #a0522d;
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 #1a0f07;
        }

        .feat-card.selected {
            border-color: #2e7d32;
            background: #c8e6c9;
        }

        .feat-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .feat-name {
            color: #8b2500;
            font-size: 0.45rem;
            margin-bottom: 8px;
        }

        .feat-desc {
            color: #5c3317;
            font-size: 0.45rem;
            line-height: 1.4;
        }

        .feat-prereq {
            color: #8b0000;
            font-size: 0.45rem;
            margin-top: 8px;
            font-style: italic;
        }

        .feat-card.selected .feat-name {
            color: #1e4620;
        }

        .feat-bonus {
            color: #8b2500;
            font-size: 0.45rem;
            margin-top: 8px;
        }

        .feat-ability-choice {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #8b4513;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feat-ability-choice label {
            color: #2e7d32;
            font-size: 0.5rem;
        }

        .feat-ability-choice select {
            background: #f4e4bc;
            border: 2px solid #2e7d32;
            color: #2d1b0e;
            padding: 5px 10px;
            font-family: inherit;
            font-size: 0.5rem;
            cursor: pointer;
        }

        /* Export Section */
        .export-section {
            background: #3d2817;
            border: 4px solid #2e7d32;
            padding: 25px;
            text-align: center;
            margin: 30px 0;
        }

        .export-title {
            color: #2e7d32;
            font-size: 0.7rem;
            margin-bottom: 20px;
        }

        .export-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .export-btn {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #2d1b0e;
            padding: 15px 25px;
            font-size: 0.45rem;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #e8d4a8;
            border-color: #a0522d;
        }

        .export-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 #1a0f07;
        }

        /* Portrait Generator */
        .portrait-section {
            background: #3d2817;
            border: 4px solid #6b5b95;
            padding: 25px;
            text-align: center;
            margin: 30px 0;
        }

        .portrait-title {
            color: #9370db;
            font-size: 0.7rem;
            margin-bottom: 20px;
        }

        /* API Key Setup */
        .portrait-api-setup {
            padding: 20px;
            background: #2d1b0e;
            border: 2px solid #8b4513;
            margin-bottom: 20px;
        }

        .api-key-label {
            color: #daa520;
            font-size: 0.6rem;
            margin-bottom: 10px;
        }

        .api-key-desc {
            color: #c4a574;
            font-size: 0.45rem;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .api-key-input {
            width: 100%;
            max-width: 400px;
            background: #f4e4bc;
            border: 3px solid #8b4513;
            color: #2d1b0e;
            padding: 12px;
            font-family: inherit;
            font-size: 0.55rem;
            margin-bottom: 15px;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #6b5b95;
        }

        /* Portrait Display */
        .portrait-image-container {
            position: relative;
            width: 100%;
            max-width: 512px;
            margin: 0 auto 20px;
            aspect-ratio: 1;
            background: #1a0f07;
            border: 4px solid #8b4513;
            overflow: hidden;
        }

        #portraitImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        #portraitImage.loaded {
            display: block;
        }

        .portrait-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6b4423;
        }

        .placeholder-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .placeholder-text {
            font-size: 0.5rem;
            opacity: 0.7;
        }

        .portrait-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 15, 7, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #3d2817;
            border-top: 4px solid #9370db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #9370db;
            font-size: 0.55rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .portrait-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .portrait-btn {
            background: #f4e4bc;
            border: 3px solid #6b5b95;
            color: #2d1b0e;
            padding: 10px 15px;
            font-size: 0.55rem;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 3px 3px 0 #1a0f07;
            transition: all 0.2s;
        }

        .portrait-btn:hover:not(:disabled) {
            background: #e8d4a8;
            border-color: #9370db;
        }

        .portrait-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .portrait-btn.primary {
            background: #6b5b95;
            border-color: #9370db;
            color: #f4e4bc;
        }

        .portrait-btn.primary:hover:not(:disabled) {
            background: #9370db;
        }

        .portrait-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #2d1b0e;
            border: 2px solid #8b4513;
        }

        .portrait-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .portrait-option label {
            color: #c4a574;
            font-size: 0.45rem;
        }

        .portrait-option select {
            background: #f4e4bc;
            border: 2px solid #8b4513;
            color: #2d1b0e;
            padding: 5px;
            font-family: inherit;
            font-size: 0.45rem;
            cursor: pointer;
            width: 100%;
        }

        .portrait-prompt-preview {
            margin-top: 15px;
            padding: 15px;
            background: #2d1b0e;
            border: 2px solid #6b5b95;
            text-align: left;
        }

        .prompt-label {
            color: #9370db;
            font-size: 0.45rem;
            margin-bottom: 8px;
        }

        .prompt-text {
            color: #c4a574;
            font-size: 0.4rem;
            line-height: 1.6;
            max-height: 100px;
            overflow-y: auto;
        }

        .portrait-prompt-section {
            margin-top: 15px;
        }

        .prompt-mode-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .prompt-mode-btn {
            background: #2d1b0e;
            border: 2px solid #8b4513;
            color: #c4a574;
            padding: 8px 16px;
            font-size: 0.45rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-mode-btn:hover {
            border-color: #9370db;
            color: #f4e4bc;
        }

        .prompt-mode-btn.active {
            background: #6b5b95;
            border-color: #9370db;
            color: #f4e4bc;
        }

        .portrait-custom-prompt {
            padding: 15px;
            background: #2d1b0e;
            border: 2px solid #6b5b95;
            text-align: left;
        }

        .custom-prompt-textarea {
            width: 100%;
            min-height: 120px;
            background: #f4e4bc;
            border: 2px solid #8b4513;
            color: #2d1b0e;
            padding: 12px;
            font-family: inherit;
            font-size: 0.45rem;
            line-height: 1.6;
            resize: vertical;
            margin-top: 8px;
        }

        .custom-prompt-textarea:focus {
            outline: none;
            border-color: #9370db;
        }

        .custom-prompt-textarea::placeholder {
            color: #8b7355;
        }

        .prompt-tips {
            color: #8b7355;
            font-size: 0.4rem;
            margin-top: 10px;
            line-height: 1.5;
        }

        .prompt-tips strong {
            color: #c4a574;
        }

        /* Dice Rolling */
        .dice-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            min-height: 80px;
            align-items: center;
        }

        .die {
            width: 50px;
            height: 50px;
            background: #f4e4bc;
            border: 4px solid #5c3317;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #2d1b0e;
            font-family: inherit;
            box-shadow: 4px 4px 0 #1a0f07;
            transition: transform 0.1s;
        }

        .die.rolling {
            animation: diceRoll 0.1s infinite;
        }

        .die.dropped {
            opacity: 0.4;
            text-decoration: line-through;
        }

        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .roll-btn {
            background: #8b2500;
            border: 4px solid #cd5c5c;
            color: #f4e4bc;
            padding: 15px 30px;
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            box-shadow: 4px 4px 0 #1a0f07;
            transition: all 0.2s;
            display: block;
            margin: 0 auto;
        }

        .roll-btn:hover {
            background: #a52a00;
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #1a0f07;
        }

        .roll-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .roll-results {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .roll-result {
            background: #f4e4bc;
            border: 3px solid #8b4513;
            padding: 10px 15px;
            font-size: 0.8rem;
            color: #2d1b0e;
            box-shadow: 3px 3px 0 #1a0f07;
        }

        .roll-result.assigned {
            opacity: 0.4;
        }

        /* ===== SCANLINES ===== */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.05),
                rgba(0, 0, 0, 0.05) 2px,
                transparent 2px,
                transparent 4px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
            }

            .preview-panel {
                width: 100%;
                border-left: none;
                border-top: 4px solid #8b4513;
                order: -1;
                max-height: 200px;
            }

            .preview-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 500px) {
            .header h1 {
                font-size: 0.7rem;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }

            .progress-step {
                font-size: 0.55rem;
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>D&D <span>CHARACTER</span> CREATOR</h1>
        <div style="display: flex; gap: 10px;">
            <button class="sound-toggle music-toggle" onclick="toggleMusic()">ðŸŽµ MUSIC OFF</button>
            <button class="sound-toggle" onclick="toggleSound()">ðŸ”Š SOUND ON</button>
        </div>
    </header>

    <!-- Background Music - Generated Medieval Tavern Ambience -->
    <audio id="bgMusic" loop preload="auto" crossorigin="anonymous"></audio>

    <div class="main-container">
        <!-- Main Content Area -->
        <main class="content-area">
            <!-- Progress Bar -->
            <nav class="progress-bar">
                <button class="progress-step active" data-step="1">1. INFO</button>
                <button class="progress-step locked" data-step="2">2. RACE</button>
                <button class="progress-step locked" data-step="3">3. CLASS</button>
                <button class="progress-step locked" data-step="4">4. ABILITIES</button>
                <button class="progress-step locked" data-step="5">5. BACKGROUND</button>
                <button class="progress-step locked" data-step="6">6. EQUIPMENT</button>
                <button class="progress-step locked" data-step="7">7. SPELLS</button>
                <button class="progress-step locked" data-step="8">8. FINISH</button>
            </nav>

            <!-- Step 1: Basic Info -->
            <section class="step-container active" data-step="1">
                <h2 class="step-title">BASIC INFORMATION</h2>
                <p class="step-subtitle">Enter your character's name and choose their moral alignment</p>

                <div class="form-group">
                    <label class="form-label">CHARACTER NAME</label>
                    <input type="text" class="form-input" id="charName" placeholder="Enter name..." maxlength="30">
                </div>

                <div class="form-group">
                    <label class="form-label">ALIGNMENT</label>
                    <div class="alignment-grid">
                        <button class="alignment-btn" data-align="LG">LAWFUL GOOD</button>
                        <button class="alignment-btn" data-align="NG">NEUTRAL GOOD</button>
                        <button class="alignment-btn" data-align="CG">CHAOTIC GOOD</button>
                        <button class="alignment-btn" data-align="LN">LAWFUL NEUTRAL</button>
                        <button class="alignment-btn selected" data-align="TN">TRUE NEUTRAL</button>
                        <button class="alignment-btn" data-align="CN">CHAOTIC NEUTRAL</button>
                        <button class="alignment-btn" data-align="LE">LAWFUL EVIL</button>
                        <button class="alignment-btn" data-align="NE">NEUTRAL EVIL</button>
                        <button class="alignment-btn" data-align="CE">CHAOTIC EVIL</button>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" disabled>â† BACK</button>
                    <button class="nav-btn primary" onclick="nextStep()">NEXT â†’</button>
                </div>
            </section>

            <!-- Step 2: Race Selection -->
            <section class="step-container" data-step="2">
                <h2 class="step-title">CHOOSE YOUR RACE</h2>
                <p class="step-subtitle">Your race determines physical traits, abilities, and cultural background</p>

                <div class="card-grid" id="raceGrid">
                    <!-- Races will be populated by JS -->
                </div>

                <div class="subrace-panel" id="subracePanel">
                    <h3 class="subrace-title">CHOOSE SUBRACE</h3>
                    <div class="subrace-grid" id="subraceGrid">
                        <!-- Subraces populated by JS -->
                    </div>
                </div>

                <div class="traits-panel" id="traitsPanel" style="display: none;">
                    <h3 class="traits-title">RACIAL TRAITS</h3>
                    <div id="traitsList">
                        <!-- Traits populated by JS -->
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="prevStep()">â† BACK</button>
                    <button class="nav-btn primary" onclick="nextStep()" id="raceNextBtn" disabled>NEXT â†’</button>
                </div>
            </section>

            <!-- Step 3: Class Selection -->
            <section class="step-container" data-step="3">
                <h2 class="step-title">CHOOSE YOUR CLASS</h2>
                <p class="step-subtitle">Your class defines your abilities, skills, and role in the party</p>

                <div class="card-grid" id="classGrid">
                    <!-- Classes populated by JS -->
                </div>

                <div class="subrace-panel" id="subclassPanel">
                    <h3 class="subrace-title">CHOOSE SUBCLASS</h3>
                    <div class="subrace-grid" id="subclassGrid">
                        <!-- Subclasses populated by JS -->
                    </div>
                </div>

                <div class="traits-panel" id="classTraitsPanel" style="display: none;">
                    <h3 class="traits-title">CLASS FEATURES</h3>
                    <div id="classTraitsList"></div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="prevStep()">â† BACK</button>
                    <button class="nav-btn primary" onclick="nextStep()" id="classNextBtn" disabled>NEXT â†’</button>
                </div>
            </section>

            <!-- Step 4: Ability Scores -->
            <section class="step-container" data-step="4">
                <h2 class="step-title">ABILITY SCORES</h2>
                <p class="step-subtitle">Determine your character's core attributes</p>

                <!-- Racial Bonus Selection (for Variant Human, Half-Elf, etc.) -->
                <div class="racial-bonus-panel" id="racialBonusPanel" style="display: none;">
                    <div class="racial-bonus-title" id="racialBonusTitle">SELECT ABILITY BONUSES</div>
                    <div class="racial-bonus-subtitle" id="racialBonusSubtitle">Choose abilities to receive +1</div>
                    <div class="racial-bonus-grid" id="racialBonusGrid">
                        <button class="racial-bonus-btn" data-ability="STR" onclick="toggleRacialBonus('STR')">STR</button>
                        <button class="racial-bonus-btn" data-ability="DEX" onclick="toggleRacialBonus('DEX')">DEX</button>
                        <button class="racial-bonus-btn" data-ability="CON" onclick="toggleRacialBonus('CON')">CON</button>
                        <button class="racial-bonus-btn" data-ability="INT" onclick="toggleRacialBonus('INT')">INT</button>
                        <button class="racial-bonus-btn" data-ability="WIS" onclick="toggleRacialBonus('WIS')">WIS</button>
                        <button class="racial-bonus-btn" data-ability="CHA" onclick="toggleRacialBonus('CHA')">CHA</button>
                    </div>
                    <div class="racial-bonus-counter" id="racialBonusCounter">Selected: 0 / 2</div>
                </div>

                <div class="method-toggle">
                    <button class="method-btn active" data-method="standard" onclick="setAbilityMethod('standard')">STANDARD ARRAY</button>
                    <button class="method-btn" data-method="pointbuy" onclick="setAbilityMethod('pointbuy')">POINT BUY</button>
                    <button class="method-btn" data-method="roll" onclick="setAbilityMethod('roll')">ROLL DICE</button>
                </div>

                <!-- Standard Array Method -->
                <div id="standardArrayMethod" class="ability-method">
                    <p class="step-subtitle">Drag values to assign them to abilities</p>
                    <div class="standard-array" id="standardArrayValues">
                        <div class="array-value" draggable="true" data-value="15">15</div>
                        <div class="array-value" draggable="true" data-value="14">14</div>
                        <div class="array-value" draggable="true" data-value="13">13</div>
                        <div class="array-value" draggable="true" data-value="12">12</div>
                        <div class="array-value" draggable="true" data-value="10">10</div>
                        <div class="array-value" draggable="true" data-value="8">8</div>
                    </div>
                </div>

                <!-- Point Buy Method -->
                <div id="pointBuyMethod" class="ability-method" style="display: none;">
                    <div class="points-remaining">
                        <div class="points-label">POINTS REMAINING</div>
                        <div class="points-value" id="pointsRemaining">27</div>
                    </div>
                </div>

                <!-- Roll Method -->
                <div id="rollMethod" class="ability-method" style="display: none;">
                    <div class="dice-container" id="diceContainer">
                        <div class="die">?</div>
                        <div class="die">?</div>
                        <div class="die">?</div>
                        <div class="die">?</div>
                    </div>
                    <button class="roll-btn" id="rollBtn" onclick="rollAbilityScore()">ðŸŽ² ROLL 4d6</button>
                    <div class="roll-results" id="rollResults"></div>
                </div>

                <!-- Ability Score Grid (shared) -->
                <div class="ability-grid" id="abilityGrid">
                    <!-- Generated by JS -->
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="prevStep()">â† BACK</button>
                    <button class="nav-btn primary" onclick="nextStep()" id="abilityNextBtn">NEXT â†’</button>
                </div>
            </section>

            <section class="step-container" data-step="5">
                <h2 class="step-title">BACKGROUND</h2>
                <p class="step-subtitle">Your history shapes who you are and grants additional skills</p>

                <div class="background-grid" id="backgroundGrid">
                    <!-- Backgrounds populated by JS -->
                </div>

                <div class="background-details" id="backgroundDetails" style="display: none;">
                    <div class="background-details-title">
                        <span id="bgDetailsIcon"></span>
                        <span id="bgDetailsName"></span>
                    </div>

                    <div class="background-section">
                        <div class="background-section-title">PROFICIENCIES</div>
                        <div class="background-section-content" id="bgProficiencies"></div>
                    </div>

                    <div class="background-feature">
                        <div class="background-feature-name" id="bgFeatureName"></div>
                        <div class="background-feature-desc" id="bgFeatureDesc"></div>
                    </div>

                    <div class="background-section">
                        <div class="background-section-title">EQUIPMENT</div>
                        <div class="background-section-content" id="bgEquipment"></div>
                    </div>
                </div>

                <!-- Skills Section -->
                <div class="skills-section" id="skillsSection" style="display: none;">
                    <div class="skills-title">SKILL PROFICIENCIES</div>
                    <div class="skills-subtitle" id="skillsSubtitle">Select skills from your class choices</div>
                    <div class="skills-grid" id="skillsGrid">
                        <!-- Skills populated by JS -->
                    </div>
                </div>

                <!-- Personality Traits -->
                <div id="personalitySection" style="display: none;">
                    <div class="personality-section">
                        <div class="personality-header">
                            <div class="personality-title">PERSONALITY TRAIT</div>
                            <button class="random-btn" onclick="randomPersonality('trait')">ðŸŽ² RANDOM</button>
                        </div>
                        <div class="personality-options" id="traitOptions"></div>
                    </div>

                    <div class="personality-section">
                        <div class="personality-header">
                            <div class="personality-title">IDEAL</div>
                            <button class="random-btn" onclick="randomPersonality('ideal')">ðŸŽ² RANDOM</button>
                        </div>
                        <div class="personality-options" id="idealOptions"></div>
                    </div>

                    <div class="personality-section">
                        <div class="personality-header">
                            <div class="personality-title">BOND</div>
                            <button class="random-btn" onclick="randomPersonality('bond')">ðŸŽ² RANDOM</button>
                        </div>
                        <div class="personality-options" id="bondOptions"></div>
                    </div>

                    <div class="personality-section">
                        <div class="personality-header">
                            <div class="personality-title">FLAW</div>
                            <button class="random-btn" onclick="randomPersonality('flaw')">ðŸŽ² RANDOM</button>
                        </div>
                        <div class="personality-options" id="flawOptions"></div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="prevStep()">â† BACK</button>
                    <button class="nav-btn primary" onclick="nextStep()" id="bgNextBtn" disabled>NEXT â†’</button>
                </div>
            </section>

            <section class="step-container" data-step="6">
                <h2 class="step-title">EQUIPMENT</h2>
                <p class="step-subtitle">Choose your starting gear based on your class</p>

                <div class="equipment-container" id="equipmentContainer">
                    <div class="equipment-choices" id="equipmentChoices">
                        <!-- Equipment choices populated by JS -->
                    </div>

                    <div class="equipment-granted" id="equipmentGranted">
                        <div class="equipment-section-title">GRANTED EQUIPMENT</div>
                        <div id="grantedList">
                            <!-- Granted items populated by JS -->
                        </div>
                    </div>

                    <div class="equipment-summary" id="equipmentSummary">
                        <div class="equipment-section-title">YOUR INVENTORY</div>
                        <div id="inventoryList">
                            <!-- Full inventory populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="prevStep()">â† BACK</button>
                    <button class="nav-btn primary" onclick="nextStep()" id="equipNextBtn">NEXT â†’</button>
                </div>
            </section>

            <section class="step-container" data-step="7">
                <h2 class="step-title">SPELLS</h2>
                <p class="step-subtitle" id="spellsSubtitle">Select your known spells</p>

                <div id="nonCasterMessage" style="display: none;">
                    <div class="non-caster-panel">
                        <div class="non-caster-icon">âš”ï¸</div>
                        <div class="non-caster-text">Your class does not have spellcasting at level 1.</div>
                        <div class="non-caster-subtext">Fighters, Rogues, Barbarians, and Monks focus on martial abilities.</div>
                    </div>
                </div>

                <div id="spellcastingSection" style="display: none;">
                    <div class="spell-info-panel" id="spellInfoPanel">
                        <!-- Spellcasting info populated by JS -->
                    </div>

                    <div id="spellLevelsContainer">
                        <!-- Spell level sections populated by JS -->
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="prevStep()">â† BACK</button>
                    <button class="nav-btn primary" onclick="nextStep()" id="spellsNextBtn">NEXT â†’</button>
                </div>
            </section>

            <section class="step-container" data-step="8">
                <h2 class="step-title">LEVEL & ADVANCEMENT</h2>
                <p class="step-subtitle">Choose your starting level and advancement options</p>

                <!-- Level Selection -->
                <div class="level-selector">
                    <div class="level-label">STARTING LEVEL</div>
                    <div class="level-controls">
                        <button class="level-btn" onclick="adjustLevel(-1)">âˆ’</button>
                        <div class="level-display" id="levelDisplay">1</div>
                        <button class="level-btn" onclick="adjustLevel(1)">+</button>
                    </div>
                    <input type="range" min="1" max="20" value="1" class="level-slider" id="levelSlider" oninput="setLevel(this.value)">
                </div>

                <!-- Level Summary -->
                <div class="level-summary" id="levelSummary">
                    <div class="level-summary-item">
                        <span class="level-summary-label">Proficiency Bonus</span>
                        <span class="level-summary-value" id="profBonus">+2</span>
                    </div>
                    <div class="level-summary-item">
                        <span class="level-summary-label">Hit Points</span>
                        <span class="level-summary-value" id="levelHP">--</span>
                    </div>
                    <div class="level-summary-item" id="spellSlotsSummary" style="display: none;">
                        <span class="level-summary-label">Spell Slots</span>
                        <span class="level-summary-value" id="levelSpellSlots">--</span>
                    </div>
                </div>

                <!-- Spell Summary Panel (for casters) -->
                <div class="spell-summary-panel" id="spellSummaryPanel" style="display: none;">
                    <!-- Populated by JS -->
                </div>

                <!-- Variant Human Feat (if applicable) -->
                <div class="asi-section" id="variantHumanFeat" style="display: none;">
                    <div class="asi-title">ðŸŽ VARIANT HUMAN FEAT</div>
                    <div class="asi-subtitle">Variant Humans gain one feat at level 1</div>
                    <div class="feat-grid" id="variantFeatGrid">
                        <!-- Feats populated by JS -->
                    </div>
                </div>

                <!-- ASI/Feat Sections -->
                <div id="asiContainer">
                    <!-- ASI sections populated by JS based on level -->
                </div>

                <!-- Feat Options Section (for feats that grant choices) -->
                <div id="featOptionsContainer" style="display: none;">
                    <!-- Populated by JS when feats grant spells/choices -->
                </div>

                <!-- Portrait Generator Section -->
                <div class="portrait-section">
                    <div class="portrait-title">ðŸŽ¨ CHARACTER PORTRAIT</div>

                    <!-- API Key Setup -->
                    <div class="portrait-api-setup" id="portraitApiSetup">
                        <div class="api-key-label">OpenAI API Key Required</div>
                        <div class="api-key-desc">Enter your API key to generate AI portraits. Key is stored locally.</div>
                        <input type="password" id="openaiApiKey" class="api-key-input" placeholder="sk-..." />
                        <button class="portrait-btn primary" onclick="saveApiKey()">ðŸ’¾ SAVE KEY</button>
                    </div>

                    <!-- Portrait Display -->
                    <div class="portrait-display" id="portraitDisplay" style="display: none;">
                        <div class="portrait-image-container">
                            <img id="portraitImage" src="" alt="Character Portrait" />
                            <div class="portrait-loading" id="portraitLoading" style="display: none;">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Conjuring portrait...</div>
                            </div>
                            <div class="portrait-placeholder" id="portraitPlaceholder">
                                <div class="placeholder-icon">ðŸ–¼ï¸</div>
                                <div class="placeholder-text">Click Generate to create your portrait</div>
                            </div>
                        </div>

                        <div class="portrait-controls">
                            <button class="portrait-btn primary" onclick="generateAIPortrait()" id="generatePortraitBtn">âœ¨ GENERATE PORTRAIT</button>
                            <button class="portrait-btn" onclick="downloadAIPortrait()" id="downloadPortraitBtn" disabled>ðŸ’¾ SAVE IMAGE</button>
                            <button class="portrait-btn" onclick="clearApiKey()">ðŸ”‘ CHANGE API KEY</button>
                        </div>

                        <div class="portrait-options">
                            <div class="portrait-option">
                                <label>GENDER PRESENTATION</label>
                                <select id="portraitGender">
                                    <option value="masculine">Masculine</option>
                                    <option value="feminine">Feminine</option>
                                    <option value="androgynous">Androgynous</option>
                                </select>
                            </div>
                            <div class="portrait-option">
                                <label>AGE</label>
                                <select id="portraitAge">
                                    <option value="young">Young</option>
                                    <option value="adult">Adult</option>
                                    <option value="middle-aged">Middle-aged</option>
                                    <option value="elderly">Elderly</option>
                                </select>
                            </div>
                            <div class="portrait-option">
                                <label>EXPRESSION</label>
                                <select id="portraitExpression">
                                    <option value="determined">Determined</option>
                                    <option value="mysterious">Mysterious</option>
                                    <option value="fierce">Fierce</option>
                                    <option value="serene">Serene</option>
                                    <option value="cunning">Cunning</option>
                                    <option value="noble">Noble</option>
                                </select>
                            </div>
                            <div class="portrait-option">
                                <label>HAIR STYLE</label>
                                <select id="portraitHairStyle">
                                    <option value="short">Short</option>
                                    <option value="long flowing">Long Flowing</option>
                                    <option value="braided">Braided</option>
                                    <option value="bald">Bald/Shaved</option>
                                    <option value="wild untamed">Wild & Untamed</option>
                                    <option value="elegant updo">Elegant Updo</option>
                                </select>
                            </div>
                            <div class="portrait-option">
                                <label>HAIR COLOR</label>
                                <select id="portraitHairColor">
                                    <option value="black">Black</option>
                                    <option value="brown">Brown</option>
                                    <option value="blonde">Blonde</option>
                                    <option value="red">Red</option>
                                    <option value="white">White/Silver</option>
                                    <option value="gray">Gray</option>
                                    <option value="unusual fantasy color">Unusual (Blue/Green/Purple)</option>
                                </select>
                            </div>
                            <div class="portrait-option">
                                <label>SKIN TONE</label>
                                <select id="portraitSkinTone">
                                    <option value="fair">Fair</option>
                                    <option value="light">Light</option>
                                    <option value="medium">Medium</option>
                                    <option value="tan">Tan</option>
                                    <option value="dark">Dark</option>
                                    <option value="deep">Deep</option>
                                </select>
                            </div>
                        </div>

                        <div class="portrait-prompt-section">
                            <div class="prompt-mode-toggle">
                                <button class="prompt-mode-btn active" id="autoPromptBtn" onclick="setPromptMode('auto')">âœ¨ AUTO-GENERATE</button>
                                <button class="prompt-mode-btn" id="customPromptBtn" onclick="setPromptMode('custom')">âœï¸ CUSTOM PROMPT</button>
                            </div>

                            <div class="portrait-prompt-preview" id="autoPromptSection">
                                <div class="prompt-label">AUTO-GENERATED PROMPT (based on your character)</div>
                                <div class="prompt-text" id="promptPreview">Select your options and click Generate</div>
                            </div>

                            <div class="portrait-custom-prompt" id="customPromptSection" style="display: none;">
                                <div class="prompt-label">CUSTOM PROMPT</div>
                                <textarea id="customPromptInput" class="custom-prompt-textarea" placeholder="Describe your character portrait... e.g., 'A fierce half-orc barbarian with tribal tattoos, wielding a massive greataxe, standing in a snowy mountain pass, dramatic lighting, fantasy art style'"></textarea>
                                <div class="prompt-tips">
                                    <strong>Tips:</strong> Include race, class, clothing, weapons, pose, setting, and art style for best results.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Section -->
                <div class="export-section">
                    <div class="export-title">ðŸ“œ EXPORT CHARACTER</div>
                    <div class="export-buttons">
                        <button class="export-btn" onclick="exportToText()">ðŸ“‹ COPY TO CLIPBOARD</button>
                        <button class="export-btn" onclick="exportToJSON()">ðŸ’¾ SAVE AS JSON</button>
                        <button class="export-btn primary" onclick="exportToPDF()">ðŸ“„ CLASSIC PDF SHEET</button>
                    </div>
                </div>

                <!-- Play Section -->
                <div class="export-section" style="border-color: #2e7d32;">
                    <div class="export-title" style="color: #81c784;">âš”ï¸ START YOUR ADVENTURE</div>
                    <div class="export-buttons">
                        <button class="export-btn primary" onclick="playCharacter()" style="background: #2e7d32; border-color: #81c784; width: 100%;">ðŸŽ® PLAY CHARACTER</button>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="nav-btn" onclick="prevStep()">â† BACK</button>
                    <button class="nav-btn primary" onclick="finishCharacter()">âœ¨ FINISH CHARACTER</button>
                </div>
            </section>
        </main>

        <!-- Character Preview Panel -->
        <aside class="preview-panel">
            <h2 class="preview-title">CHARACTER SHEET</h2>

            <div class="preview-section">
                <div class="preview-label">NAME</div>
                <div class="preview-value empty" id="previewName">Not set</div>
            </div>

            <div class="preview-section">
                <div class="preview-label">RACE</div>
                <div class="preview-value empty" id="previewRace">Not selected</div>
            </div>

            <div class="preview-section">
                <div class="preview-label">CLASS</div>
                <div class="preview-value empty" id="previewClass">Not selected</div>
            </div>

            <div class="preview-section">
                <div class="preview-label">LEVEL</div>
                <div class="preview-value" id="previewLevel">1</div>
            </div>

            <div class="preview-section">
                <div class="preview-label">BACKGROUND</div>
                <div class="preview-value empty" id="previewBackground">Not selected</div>
            </div>

            <div class="preview-section">
                <div class="preview-label">ALIGNMENT</div>
                <div class="preview-value" id="previewAlignment">True Neutral</div>
            </div>

            <div class="preview-section">
                <div class="preview-label">ABILITY SCORES</div>
                <div class="preview-stats">
                    <div class="preview-stat">
                        <div class="preview-stat-name">STR</div>
                        <div class="preview-stat-value" id="previewSTR">--</div>
                        <div class="preview-stat-mod" id="previewSTRmod"></div>
                    </div>
                    <div class="preview-stat">
                        <div class="preview-stat-name">DEX</div>
                        <div class="preview-stat-value" id="previewDEX">--</div>
                        <div class="preview-stat-mod" id="previewDEXmod"></div>
                    </div>
                    <div class="preview-stat">
                        <div class="preview-stat-name">CON</div>
                        <div class="preview-stat-value" id="previewCON">--</div>
                        <div class="preview-stat-mod" id="previewCONmod"></div>
                    </div>
                    <div class="preview-stat">
                        <div class="preview-stat-name">INT</div>
                        <div class="preview-stat-value" id="previewINT">--</div>
                        <div class="preview-stat-mod" id="previewINTmod"></div>
                    </div>
                    <div class="preview-stat">
                        <div class="preview-stat-name">WIS</div>
                        <div class="preview-stat-value" id="previewWIS">--</div>
                        <div class="preview-stat-mod" id="previewWISmod"></div>
                    </div>
                    <div class="preview-stat">
                        <div class="preview-stat-name">CHA</div>
                        <div class="preview-stat-value" id="previewCHA">--</div>
                        <div class="preview-stat-mod" id="previewCHAmod"></div>
                    </div>
                </div>
            </div>

            <div class="preview-section">
                <div class="preview-label">HIT POINTS</div>
                <div class="preview-value empty" id="previewHP">--</div>
            </div>

            <div class="preview-section">
                <div class="preview-label">ARMOR CLASS</div>
                <div class="preview-value empty" id="previewAC">--</div>
            </div>

            <div class="preview-section">
                <div class="preview-label">PROFICIENCY BONUS</div>
                <div class="preview-value" id="previewProfBonus">+2</div>
            </div>

            <div class="preview-section">
                <div class="preview-label">SPEED</div>
                <div class="preview-value empty" id="previewSpeed">--</div>
            </div>

            <div class="preview-section" id="previewSkillsSection">
                <div class="preview-label">PROFICIENT SKILLS</div>
                <div class="preview-value empty" id="previewSkills" style="font-size: 0.5rem; line-height: 1.4;">None selected</div>
            </div>

            <div class="preview-section" id="previewSpellsSection" style="display: none;">
                <div class="preview-label">SPELLS</div>
                <div class="preview-value" id="previewSpells" style="font-size: 0.5rem; line-height: 1.4;">--</div>
            </div>
        </aside>
    </div>

    <div class="scanlines"></div>

    <script>
        // ===== CHARACTER DATA =====
        const character = {
            name: '',
            alignment: 'TN',
            race: null,
            subrace: null,
            class: null,
            subclass: null,
            background: null,
            abilities: { STR: 10, DEX: 10, CON: 10, INT: 10, WIS: 10, CHA: 10 },
            level: 1,
            skills: [],
            personality: {
                trait: null,
                ideal: null,
                bond: null,
                flaw: null
            },
            equipment: {
                choices: {},
                granted: []
            },
            spells: {
                cantrips: [],
                level1: [],
                level2: [],
                level3: [],
                level4: [],
                level5: [],
                level6: [],
                level7: [],
                level8: [],
                level9: []
            },
            feats: [],
            asiChoices: {} // { level: { type: 'asi'|'feat', asi: [ability, ability] or feat: 'featKey' } }
        };

        let currentStep = 1;
        let soundEnabled = true;
        let musicEnabled = false;
        let bgMusic = null;

        // ===== RACE DATA =====
        const RACES = {
            // PHB Races
            human: {
                name: 'Human',
                icon: 'ðŸ‘¤',
                speed: 30,
                abilityBonus: { ALL: 1 },
                traits: [
                    { name: 'Ability Score Increase', desc: '+1 to all ability scores' },
                    { name: 'Languages', desc: 'Common and one extra language of your choice' },
                    { name: 'Versatile', desc: 'Humans are adaptable and ambitious, fitting into any role' }
                ],
                subraces: {
                    standard: { name: 'Standard Human', bonus: {}, extra: '+1 to all six ability scores' },
                    variant: { name: 'Variant Human', bonus: { CHOICE2: 1 }, extra: '+1 to two different abilities, one skill proficiency, one feat' }
                }
            },
            elf: {
                name: 'Elf',
                icon: 'ðŸ§',
                speed: 30,
                abilityBonus: { DEX: 2 },
                traits: [
                    { name: 'Darkvision', desc: 'See in dim light within 60 feet as if bright light' },
                    { name: 'Keen Senses', desc: 'Proficiency in the Perception skill' },
                    { name: 'Fey Ancestry', desc: 'Advantage on saves against being charmed, immune to magic sleep' },
                    { name: 'Trance', desc: 'Elves meditate 4 hours instead of sleeping 8' }
                ],
                subraces: {
                    high: { name: 'High Elf', bonus: { INT: 1 }, extra: 'Learn one wizard cantrip' },
                    wood: { name: 'Wood Elf', bonus: { WIS: 1 }, extra: 'Speed increases to 35 ft, can hide in natural phenomena' },
                    drow: { name: 'Dark Elf (Drow)', bonus: { CHA: 1 }, extra: 'Superior darkvision (120 ft), know Dancing Lights cantrip' }
                }
            },
            dwarf: {
                name: 'Dwarf',
                icon: 'â›ï¸',
                speed: 25,
                abilityBonus: { CON: 2 },
                traits: [
                    { name: 'Darkvision', desc: 'See in dim light within 60 feet as if bright light' },
                    { name: 'Dwarven Resilience', desc: 'Advantage on saves against poison, resistance to poison damage' },
                    { name: 'Dwarven Combat Training', desc: 'Proficiency with battleaxe, handaxe, light hammer, warhammer' },
                    { name: 'Stonecunning', desc: 'Double proficiency on History checks related to stonework' }
                ],
                subraces: {
                    hill: { name: 'Hill Dwarf', bonus: { WIS: 1 }, extra: 'HP max increases by 1 per level' },
                    mountain: { name: 'Mountain Dwarf', bonus: { STR: 2 }, extra: 'Proficiency with light and medium armor' }
                }
            },
            halfling: {
                name: 'Halfling',
                icon: 'ðŸ¦¶',
                speed: 25,
                abilityBonus: { DEX: 2 },
                traits: [
                    { name: 'Lucky', desc: 'Reroll 1s on attack rolls, ability checks, or saving throws' },
                    { name: 'Brave', desc: 'Advantage on saves against being frightened' },
                    { name: 'Halfling Nimbleness', desc: 'Move through the space of larger creatures' }
                ],
                subraces: {
                    lightfoot: { name: 'Lightfoot', bonus: { CHA: 1 }, extra: 'Can hide behind creatures larger than you' },
                    stout: { name: 'Stout', bonus: { CON: 1 }, extra: 'Advantage on saves against poison, resistance to poison damage' }
                }
            },
            gnome: {
                name: 'Gnome',
                icon: 'ðŸŽ©',
                speed: 25,
                abilityBonus: { INT: 2 },
                traits: [
                    { name: 'Darkvision', desc: 'See in dim light within 60 feet as if bright light' },
                    { name: 'Gnome Cunning', desc: 'Advantage on INT, WIS, CHA saves against magic' }
                ],
                subraces: {
                    forest: { name: 'Forest Gnome', bonus: { DEX: 1 }, extra: 'Know Minor Illusion cantrip, can speak with small beasts' },
                    rock: { name: 'Rock Gnome', bonus: { CON: 1 }, extra: 'Double proficiency on History checks for magic/tech items, can create tiny clockwork devices' }
                }
            },
            halfelf: {
                name: 'Half-Elf',
                icon: 'ðŸ§â€â™‚ï¸',
                speed: 30,
                abilityBonus: { CHA: 2, CHOICE2: 1 },
                traits: [
                    { name: 'Ability Score Increase', desc: '+2 CHA and +1 to two other abilities of your choice' },
                    { name: 'Darkvision', desc: 'See in dim light within 60 feet as if bright light' },
                    { name: 'Fey Ancestry', desc: 'Advantage on saves against being charmed, immune to magic sleep' },
                    { name: 'Skill Versatility', desc: 'Proficiency in two skills of your choice' }
                ],
                subraces: null
            },
            halforc: {
                name: 'Half-Orc',
                icon: 'ðŸ‘¹',
                speed: 30,
                abilityBonus: { STR: 2, CON: 1 },
                traits: [
                    { name: 'Darkvision', desc: 'See in dim light within 60 feet as if bright light' },
                    { name: 'Menacing', desc: 'Proficiency in the Intimidation skill' },
                    { name: 'Relentless Endurance', desc: 'When reduced to 0 HP but not killed, drop to 1 HP instead (once per long rest)' },
                    { name: 'Savage Attacks', desc: 'On a critical hit with melee, roll one extra damage die' }
                ],
                subraces: null
            },
            tiefling: {
                name: 'Tiefling',
                icon: 'ðŸ˜ˆ',
                speed: 30,
                abilityBonus: { CHA: 2, INT: 1 },
                traits: [
                    { name: 'Darkvision', desc: 'See in dim light within 60 feet as if bright light' },
                    { name: 'Hellish Resistance', desc: 'Resistance to fire damage' },
                    { name: 'Infernal Legacy', desc: 'Know Thaumaturgy cantrip. At 3rd level cast Hellish Rebuke. At 5th level cast Darkness.' }
                ],
                subraces: null
            },
            dragonborn: {
                name: 'Dragonborn',
                icon: 'ðŸ‰',
                speed: 30,
                abilityBonus: { STR: 2, CHA: 1 },
                traits: [
                    { name: 'Draconic Ancestry', desc: 'Choose a dragon type for damage resistance and breath weapon' },
                    { name: 'Breath Weapon', desc: 'Exhale destructive energy based on your ancestry' },
                    { name: 'Damage Resistance', desc: 'Resistance to damage type associated with your ancestry' }
                ],
                subraces: {
                    black: { name: 'Black (Acid)', bonus: {}, extra: 'Acid breath (5x30 ft line), acid resistance' },
                    blue: { name: 'Blue (Lightning)', bonus: {}, extra: 'Lightning breath (5x30 ft line), lightning resistance' },
                    brass: { name: 'Brass (Fire)', bonus: {}, extra: 'Fire breath (5x30 ft line), fire resistance' },
                    bronze: { name: 'Bronze (Lightning)', bonus: {}, extra: 'Lightning breath (5x30 ft line), lightning resistance' },
                    copper: { name: 'Copper (Acid)', bonus: {}, extra: 'Acid breath (5x30 ft line), acid resistance' },
                    gold: { name: 'Gold (Fire)', bonus: {}, extra: 'Fire breath (15 ft cone), fire resistance' },
                    green: { name: 'Green (Poison)', bonus: {}, extra: 'Poison breath (15 ft cone), poison resistance' },
                    red: { name: 'Red (Fire)', bonus: {}, extra: 'Fire breath (15 ft cone), fire resistance' },
                    silver: { name: 'Silver (Cold)', bonus: {}, extra: 'Cold breath (15 ft cone), cold resistance' },
                    white: { name: 'White (Cold)', bonus: {}, extra: 'Cold breath (15 ft cone), cold resistance' }
                }
            },
            // Expanded Races
            aasimar: {
                name: 'Aasimar',
                icon: 'ðŸ‘¼',
                speed: 30,
                abilityBonus: { CHA: 2 },
                traits: [
                    { name: 'Darkvision', desc: 'See in dim light within 60 feet as if bright light' },
                    { name: 'Celestial Resistance', desc: 'Resistance to necrotic and radiant damage' },
                    { name: 'Healing Hands', desc: 'Touch to heal HP equal to your level (once per long rest)' },
                    { name: 'Light Bearer', desc: 'Know the Light cantrip' }
                ],
                subraces: {
                    protector: { name: 'Protector', bonus: { WIS: 1 }, extra: 'Radiant Soul: Sprout spectral wings, deal extra radiant damage' },
                    scourge: { name: 'Scourge', bonus: { CON: 1 }, extra: 'Radiant Consumption: Light damages nearby enemies' },
                    fallen: { name: 'Fallen', bonus: { STR: 1 }, extra: 'Necrotic Shroud: Frighten nearby enemies' }
                }
            },
            goliath: {
                name: 'Goliath',
                icon: 'ðŸ—¿',
                speed: 30,
                abilityBonus: { STR: 2, CON: 1 },
                traits: [
                    { name: 'Natural Athlete', desc: 'Proficiency in the Athletics skill' },
                    { name: "Stone's Endurance", desc: 'Reduce damage by 1d12 + CON mod (once per short rest)' },
                    { name: 'Powerful Build', desc: 'Count as Large for carrying capacity and push/pull' },
                    { name: 'Mountain Born', desc: 'Acclimated to high altitude and cold climates' }
                ],
                subraces: null
            },
            tabaxi: {
                name: 'Tabaxi',
                icon: 'ðŸ±',
                speed: 30,
                abilityBonus: { DEX: 2, CHA: 1 },
                traits: [
                    { name: 'Darkvision', desc: 'See in dim light within 60 feet as if bright light' },
                    { name: 'Feline Agility', desc: 'Double speed until end of turn (recharges when you stay still)' },
                    { name: "Cat's Claws", desc: 'Climbing speed of 20 ft, unarmed strikes deal 1d4 slashing' },
                    { name: "Cat's Talent", desc: 'Proficiency in Perception and Stealth' }
                ],
                subraces: null
            },
            firbolg: {
                name: 'Firbolg',
                icon: 'ðŸŒ²',
                speed: 30,
                abilityBonus: { WIS: 2, STR: 1 },
                traits: [
                    { name: 'Firbolg Magic', desc: 'Cast Detect Magic and Disguise Self (once per short rest each)' },
                    { name: 'Hidden Step', desc: 'Turn invisible until start of next turn (once per short rest)' },
                    { name: 'Powerful Build', desc: 'Count as Large for carrying capacity' },
                    { name: 'Speech of Beast and Leaf', desc: 'Communicate simple ideas with beasts and plants' }
                ],
                subraces: null
            },
            kenku: {
                name: 'Kenku',
                icon: 'ðŸ¦',
                speed: 30,
                abilityBonus: { DEX: 2, WIS: 1 },
                traits: [
                    { name: 'Expert Forgery', desc: 'Advantage on checks to produce forgeries or duplicates' },
                    { name: 'Kenku Training', desc: 'Proficiency in two skills: Acrobatics, Deception, Stealth, or Sleight of Hand' },
                    { name: 'Mimicry', desc: 'Can mimic any sound you have heard' }
                ],
                subraces: null
            },
            lizardfolk: {
                name: 'Lizardfolk',
                icon: 'ðŸ¦Ž',
                speed: 30,
                abilityBonus: { CON: 2, WIS: 1 },
                traits: [
                    { name: 'Bite', desc: 'Unarmed strikes deal 1d6 piercing damage' },
                    { name: 'Cunning Artisan', desc: 'Craft simple weapons/shields from creature remains' },
                    { name: 'Hold Breath', desc: 'Can hold breath for 15 minutes' },
                    { name: 'Natural Armor', desc: 'AC = 13 + DEX modifier when not wearing armor' },
                    { name: 'Hungry Jaws', desc: 'Bonus action bite that grants temp HP (once per short rest)' }
                ],
                subraces: null
            },
            tortle: {
                name: 'Tortle',
                icon: 'ðŸ¢',
                speed: 30,
                abilityBonus: { STR: 2, WIS: 1 },
                traits: [
                    { name: 'Claws', desc: 'Unarmed strikes deal 1d4 slashing damage' },
                    { name: 'Hold Breath', desc: 'Can hold breath for 1 hour' },
                    { name: 'Natural Armor', desc: 'AC = 17, cannot wear armor but can use shields' },
                    { name: 'Shell Defense', desc: 'Withdraw into shell for +4 AC (action)' }
                ],
                subraces: null
            },
            warforged: {
                name: 'Warforged',
                icon: 'ðŸ¤–',
                speed: 30,
                abilityBonus: { CON: 2, CHOICE1: 1 },
                traits: [
                    { name: 'Constructed Resilience', desc: 'Advantage on saves vs poison, resistance to poison, immune to disease' },
                    { name: 'Sentry\'s Rest', desc: 'When you rest, you remain conscious and aware' },
                    { name: 'Integrated Protection', desc: 'AC = armor + proficiency bonus, can integrate armor' },
                    { name: 'Specialized Design', desc: 'One skill and one tool proficiency of your choice' }
                ],
                subraces: null
            },
            goblin: {
                name: 'Goblin',
                icon: 'ðŸ‘º',
                speed: 30,
                abilityBonus: { DEX: 2, CON: 1 },
                traits: [
                    { name: 'Darkvision', desc: 'See in dim light within 60 feet as if bright light' },
                    { name: 'Fury of the Small', desc: 'Extra damage equal to level vs larger creatures (once per short rest)' },
                    { name: 'Nimble Escape', desc: 'Disengage or Hide as bonus action' }
                ],
                subraces: null
            },
            aarakocra: {
                name: 'Aarakocra',
                icon: 'ðŸ¦…',
                speed: 25,
                abilityBonus: { DEX: 2, WIS: 1 },
                traits: [
                    { name: 'Flight', desc: 'Flying speed of 50 ft (cannot fly in medium or heavy armor)' },
                    { name: 'Talons', desc: 'Unarmed strikes deal 1d4 slashing damage' }
                ],
                subraces: null
            }
        };

        // ===== CLASS DATA =====
        const CLASSES = {
            barbarian: {
                name: 'Barbarian',
                icon: 'ðŸª“',
                hitDie: 'd12',
                primaryAbility: 'STR',
                saves: ['STR', 'CON'],
                armor: 'Light, Medium, Shields',
                weapons: 'Simple, Martial',
                skills: 2,
                skillChoices: ['Animal Handling', 'Athletics', 'Intimidation', 'Nature', 'Perception', 'Survival'],
                features: [
                    { name: 'Rage', desc: 'Enter a battle fury for bonus damage and resistance to physical damage', level: 1 },
                    { name: 'Unarmored Defense', desc: 'AC = 10 + DEX mod + CON mod when not wearing armor', level: 1 },
                    { name: 'Reckless Attack', desc: 'Gain advantage on melee attacks using STR, but attacks against you have advantage', level: 2 },
                    { name: 'Danger Sense', desc: 'Advantage on DEX saves against effects you can see', level: 2 },
                    { name: 'Extra Attack', desc: 'Attack twice when taking the Attack action', level: 5 },
                    { name: 'Fast Movement', desc: '+10 ft speed when not wearing heavy armor', level: 5 },
                    { name: 'Feral Instinct', desc: 'Advantage on initiative, can act normally if surprised by raging', level: 7 },
                    { name: 'Brutal Critical', desc: 'Roll additional damage dice on critical hits', level: 9 },
                    { name: 'Relentless Rage', desc: 'If you drop to 0 HP while raging, make CON save to drop to 1 HP instead', level: 11 },
                    { name: 'Persistent Rage', desc: 'Rage only ends early if you choose or fall unconscious', level: 15 },
                    { name: 'Indomitable Might', desc: 'If STR check is less than STR score, use STR score instead', level: 18 },
                    { name: 'Primal Champion', desc: '+4 STR and CON (max 24)', level: 20 }
                ],
                subclasses: {
                    berserker: {
                        name: 'Path of the Berserker',
                        desc: 'Frenzy for extra attacks, immune to charm/fear while raging',
                        features: {
                            3: [{ name: 'Frenzy', desc: 'While raging, make a single melee weapon attack as bonus action; causes exhaustion when rage ends' }],
                            6: [{ name: 'Mindless Rage', desc: 'Can\'t be charmed or frightened while raging; effects suspended during rage' }],
                            10: [{ name: 'Intimidating Presence', desc: 'Frighten a creature within 30 ft with your menacing presence' }],
                            14: [{ name: 'Retaliation', desc: 'When hit by creature within 5 ft, make melee attack as reaction' }]
                        }
                    },
                    totem: {
                        name: 'Path of the Totem Warrior',
                        desc: 'Spirit animal grants special abilities while raging',
                        features: {
                            3: [
                                { name: 'Spirit Seeker', desc: 'Cast Beast Sense and Speak with Animals as rituals' },
                                { name: 'Totem Spirit', desc: 'Choose Bear (resistance to all but psychic), Eagle (opportunity attack disadvantage, Dash bonus), or Wolf (allies have advantage on melee attacks)' }
                            ],
                            6: [{ name: 'Aspect of the Beast', desc: 'Choose Bear (carry double, advantage on STR checks), Eagle (see 1 mile clearly), or Wolf (track at fast pace, move stealthily)' }],
                            10: [{ name: 'Spirit Walker', desc: 'Cast Commune with Nature as ritual' }],
                            14: [{ name: 'Totemic Attunement', desc: 'Choose Bear (knock prone on hit), Eagle (short fly), or Wolf (knock prone Large or smaller as bonus action)' }]
                        }
                    },
                    zealot: {
                        name: 'Path of the Zealot',
                        desc: 'Divine fury deals extra damage, harder to kill',
                        features: {
                            3: [
                                { name: 'Divine Fury', desc: 'First creature hit each turn takes extra 1d6 + half barbarian level radiant or necrotic damage' },
                                { name: 'Warrior of the Gods', desc: 'Spells to raise you from dead cost no material components' }
                            ],
                            6: [{ name: 'Fanatical Focus', desc: 'Reroll failed save while raging once per rage' }],
                            10: [{ name: 'Zealous Presence', desc: 'Grant advantage on attack/save to 10 allies within 60 ft as bonus action' }],
                            14: [{ name: 'Rage Beyond Death', desc: 'Don\'t die from falling to 0 HP while raging; only die if rage ends at 0 HP' }]
                        }
                    },
                    ancestral: {
                        name: 'Path of the Ancestral Guardian',
                        desc: 'Spectral ancestors protect allies and hinder foes',
                        features: {
                            3: [{ name: 'Ancestral Protectors', desc: 'First creature hit while raging has disadvantage attacking others, others have resistance to its damage' }],
                            6: [{ name: 'Spirit Shield', desc: 'When ally within 30 ft takes damage, reduce it by 2d6 as reaction (3d6 at 10th, 4d6 at 14th)' }],
                            10: [{ name: 'Consult the Spirits', desc: 'Cast Augury or Clairvoyance as ritual without material components' }],
                            14: [{ name: 'Vengeful Ancestors', desc: 'When Spirit Shield reduces damage, attacker takes force damage equal to reduction' }]
                        }
                    },
                    storm: {
                        name: 'Path of the Storm Herald',
                        desc: 'Aura of desert heat, frozen tundra, or stormy sea',
                        features: {
                            3: [{ name: 'Storm Aura', desc: 'Choose Desert (fire damage to enemies), Sea (lightning damage), or Tundra (temp HP to allies) in 10 ft aura' }],
                            6: [{ name: 'Storm Soul', desc: 'Desert: fire resistance, ignore extreme heat. Sea: lightning resistance, breathe water, swim speed. Tundra: cold resistance, ignore extreme cold' }],
                            10: [{ name: 'Shielding Storm', desc: 'Allies in aura gain resistance to your storm\'s damage type' }],
                            14: [{ name: 'Raging Storm', desc: 'Desert: reaction to deal fire and burn. Sea: reaction to knock prone. Tundra: aura is difficult terrain, freeze reaction' }]
                        }
                    },
                    beast: {
                        name: 'Path of the Beast',
                        desc: 'Transform with natural weapons: tail, bite, or claws',
                        features: {
                            3: [{ name: 'Form of the Beast', desc: 'When raging, grow Bite (1d8, heal on hit), Claws (1d6, extra attack), or Tail (1d8 reach, +1d8 AC reaction)' }],
                            6: [{ name: 'Bestial Soul', desc: 'Natural weapons count as magical; gain climbing speed, swimming speed, or extended jump' }],
                            10: [{ name: 'Infectious Fury', desc: 'When hitting with natural weapon, target attacks ally or takes 2d12 psychic' }],
                            14: [{ name: 'Call the Hunt', desc: 'Choose allies within 30 ft; they gain 5 ft of your speed and advantage on attacks vs your target' }]
                        }
                    },
                    wildmagic: {
                        name: 'Path of Wild Magic',
                        desc: 'Rage triggers random magical effects',
                        features: {
                            3: [
                                { name: 'Magic Awareness', desc: 'Sense magic within 60 ft as an action' },
                                { name: 'Wild Surge', desc: 'Roll d8 when raging for random effect: teleport, darkness, spirit, retribution, weapon force, burst healing, weapon light, bolt' }
                            ],
                            6: [{ name: 'Bolstering Magic', desc: 'Touch creature for 1d3 to attacks/checks or restore spell slot (level 1d3)' }],
                            10: [{ name: 'Unstable Backlash', desc: 'When taking damage or failing save while raging, roll new Wild Surge as reaction' }],
                            14: [{ name: 'Controlled Surge', desc: 'Roll Wild Surge twice and choose either result' }]
                        }
                    }
                },
                subclassLevel: 3
            },
            bard: {
                name: 'Bard',
                icon: 'ðŸŽ¸',
                hitDie: 'd8',
                primaryAbility: 'CHA',
                saves: ['DEX', 'CHA'],
                armor: 'Light',
                weapons: 'Simple, Hand Crossbows, Longswords, Rapiers, Shortswords',
                skills: 3,
                skillChoices: ['Any'],
                spellcasting: true,
                features: [
                    { name: 'Spellcasting', desc: 'Cast spells using Charisma as your spellcasting ability', level: 1 },
                    { name: 'Bardic Inspiration', desc: 'Grant allies bonus dice to add to ability checks, attacks, or saves', level: 1 },
                    { name: 'Jack of All Trades', desc: 'Add half proficiency bonus to ability checks you\'re not proficient in', level: 2 },
                    { name: 'Song of Rest', desc: 'Allies regain extra HP when spending Hit Dice during short rest', level: 2 },
                    { name: 'Expertise', desc: 'Double proficiency bonus for two skills', level: 3 },
                    { name: 'Font of Inspiration', desc: 'Bardic Inspiration recharges on short or long rest', level: 5 },
                    { name: 'Countercharm', desc: 'Allies within 30 ft have advantage on saves vs charm/fear', level: 6 },
                    { name: 'Magical Secrets', desc: 'Learn two spells from any class', level: 10 },
                    { name: 'Superior Inspiration', desc: 'Regain one Bardic Inspiration if you have none at initiative', level: 20 }
                ],
                subclasses: {
                    lore: {
                        name: 'College of Lore',
                        desc: 'Additional skills and Cutting Words to hinder enemies',
                        features: {
                            3: [
                                { name: 'Bonus Proficiencies', desc: 'Three additional skill proficiencies of your choice' },
                                { name: 'Cutting Words', desc: 'Use Bardic Inspiration to subtract from enemy\'s attack, ability check, or damage roll' }
                            ],
                            6: [{ name: 'Additional Magical Secrets', desc: 'Learn two spells from any class' }],
                            14: [{ name: 'Peerless Skill', desc: 'Add Bardic Inspiration to your own ability checks' }]
                        }
                    },
                    valor: {
                        name: 'College of Valor',
                        desc: 'Medium armor, shields, martial weapons, Combat Inspiration',
                        features: {
                            3: [
                                { name: 'Bonus Proficiencies', desc: 'Medium armor, shields, and martial weapons' },
                                { name: 'Combat Inspiration', desc: 'Bardic Inspiration can add to weapon damage or AC' }
                            ],
                            6: [{ name: 'Extra Attack', desc: 'Attack twice when taking the Attack action' }],
                            14: [{ name: 'Battle Magic', desc: 'Make one weapon attack as bonus action after casting a spell' }]
                        }
                    },
                    eloquence: {
                        name: 'College of Eloquence',
                        desc: 'Silver Tongue for reliable Persuasion/Deception',
                        features: {
                            3: [
                                { name: 'Silver Tongue', desc: 'Treat roll of 9 or lower as 10 on Persuasion and Deception checks' },
                                { name: 'Unsettling Words', desc: 'Subtract Bardic Inspiration from creature\'s next save' }
                            ],
                            6: [{ name: 'Unfailing Inspiration', desc: 'Bardic Inspiration die isn\'t expended on failed roll' }],
                            14: [{ name: 'Infectious Inspiration', desc: 'When Bardic Inspiration succeeds, grant it to another creature as reaction' }]
                        }
                    },
                    glamour: {
                        name: 'College of Glamour',
                        desc: 'Fey-touched charm, Mantle of Inspiration, Enthralling Performance',
                        features: {
                            3: [
                                { name: 'Mantle of Inspiration', desc: 'Use Bardic Inspiration to give temp HP and allow allies to move' },
                                { name: 'Enthralling Performance', desc: 'After 1 minute performance, charm humanoids who watched' }
                            ],
                            6: [{ name: 'Mantle of Majesty', desc: 'Cast Command as bonus action without slot for 1 minute; don\'t break charm' }],
                            14: [{ name: 'Unbreakable Majesty', desc: 'Creatures must save or choose different target for attacks/harmful spells' }]
                        }
                    },
                    swords: {
                        name: 'College of Swords',
                        desc: 'Blade Flourishes, Fighting Style, medium armor',
                        features: {
                            3: [
                                { name: 'Bonus Proficiencies', desc: 'Medium armor and scimitar; weapon can be spellcasting focus' },
                                { name: 'Fighting Style', desc: 'Choose Dueling (+2 damage) or Two-Weapon Fighting' },
                                { name: 'Blade Flourish', desc: 'Extra 10 ft speed; spend Bardic Inspiration for Defensive, Slashing, or Mobile Flourish' }
                            ],
                            6: [{ name: 'Extra Attack', desc: 'Attack twice when taking the Attack action' }],
                            14: [{ name: 'Master\'s Flourish', desc: 'Use d6 instead of Bardic Inspiration for Blade Flourish' }]
                        }
                    },
                    whispers: {
                        name: 'College of Whispers',
                        desc: 'Psychic Blades damage, steal identities, Words of Terror',
                        features: {
                            3: [
                                { name: 'Psychic Blades', desc: 'Spend Bardic Inspiration to deal extra 2d6 psychic on weapon hit (scales with level)' },
                                { name: 'Words of Terror', desc: 'After 1 minute speaking, frighten one creature' }
                            ],
                            6: [{ name: 'Mantle of Whispers', desc: 'Capture dying creature\'s shadow to assume their appearance' }],
                            14: [{ name: 'Shadow Lore', desc: 'Magically whisper to charm creature for 8 hours' }]
                        }
                    },
                    creation: {
                        name: 'College of Creation',
                        desc: 'Create items from nothing, animate Performance of Creation',
                        features: {
                            3: [
                                { name: 'Mote of Potential', desc: 'Bardic Inspiration creates mote that adds effects based on roll type (ability/attack/save)' },
                                { name: 'Performance of Creation', desc: 'Create nonmagical item worth up to 20Ã— bard level gp, lasts hours equal to proficiency bonus' }
                            ],
                            6: [{ name: 'Animating Performance', desc: 'Animate Large or smaller item as dancing construct' }],
                            14: [{ name: 'Creative Crescendo', desc: 'Performance of Creation can make multiple items, no gold limit' }]
                        }
                    },
                    spirits: {
                        name: 'College of Spirits',
                        desc: 'Channel spirits through tales, spiritual focus',
                        grantedSpells: {
                            3: { cantrips: ['Guidance'] }
                        },
                        features: {
                            3: [
                                { name: 'Guiding Whispers', desc: 'Learn Guidance cantrip; can cast through spiritual focus at 60 ft' },
                                { name: 'Spiritual Focus', desc: 'Candle, crystal ball, skull, spirit board, or tarokka deck as spellcasting focus; +d6 healing/damage' },
                                { name: 'Tales from Beyond', desc: 'Use Bardic Inspiration to roll on Tales table for random magical effect' }
                            ],
                            6: [{ name: 'Spirit Session', desc: 'Conduct ritual to learn a spell temporarily from any class' }],
                            14: [{ name: 'Mystical Connection', desc: 'Roll twice on Tales table and choose either result' }]
                        }
                    }
                },
                subclassLevel: 3
            },
            cleric: {
                name: 'Cleric',
                icon: 'âœï¸',
                hitDie: 'd8',
                primaryAbility: 'WIS',
                saves: ['WIS', 'CHA'],
                armor: 'Light, Medium, Shields',
                weapons: 'Simple',
                skills: 2,
                skillChoices: ['History', 'Insight', 'Medicine', 'Persuasion', 'Religion'],
                spellcasting: true,
                features: [
                    { name: 'Spellcasting', desc: 'Cast spells using Wisdom, prepare spells from the entire cleric list', level: 1 },
                    { name: 'Divine Domain', desc: 'Choose a domain that grants bonus spells and abilities', level: 1 },
                    { name: 'Channel Divinity', desc: 'Channel divine energy for powerful effects (Turn Undead + domain feature)', level: 2 },
                    { name: 'Destroy Undead', desc: 'Undead of CR 1/2 or lower destroyed by Turn Undead (CR increases with level)', level: 5 },
                    { name: 'Divine Intervention', desc: 'Call on your deity for aid; chance equals cleric level %', level: 10 },
                    { name: 'Divine Intervention Improved', desc: 'Divine Intervention succeeds automatically', level: 20 }
                ],
                subclasses: {
                    life: {
                        name: 'Life Domain',
                        desc: 'Enhanced healing spells, heavy armor proficiency',
                        grantedSpells: {
                            1: { always: ['Bless', 'Cure Wounds'] },
                            3: { always: ['Lesser Restoration', 'Spiritual Weapon'] },
                            5: { always: ['Beacon of Hope', 'Revivify'] },
                            7: { always: ['Death Ward', 'Guardian of Faith'] },
                            9: { always: ['Mass Cure Wounds', 'Raise Dead'] }
                        },
                        features: {
                            1: [{ name: 'Disciple of Life', desc: 'Healing spells restore extra 2 + spell level HP' }],
                            2: [{ name: 'Channel Divinity: Preserve Life', desc: 'Restore HP equal to 5x cleric level divided among creatures' }],
                            6: [{ name: 'Blessed Healer', desc: 'When you heal others, heal yourself for 2 + spell level' }],
                            8: [{ name: 'Divine Strike', desc: 'Weapon attacks deal extra 1d8 radiant (2d8 at 14th)' }],
                            17: [{ name: 'Supreme Healing', desc: 'Healing spells restore maximum HP' }]
                        }
                    },
                    light: {
                        name: 'Light Domain',
                        desc: 'Fire and radiant damage spells, Warding Flare',
                        grantedSpells: {
                            1: { always: ['Burning Hands', 'Faerie Fire'], cantrips: ['Light'] },
                            3: { always: ['Flaming Sphere', 'Scorching Ray'] },
                            5: { always: ['Daylight', 'Fireball'] },
                            7: { always: ['Guardian of Faith', 'Wall of Fire'] },
                            9: { always: ['Flame Strike', 'Scrying'] }
                        },
                        features: {
                            1: [{ name: 'Warding Flare', desc: 'Reaction to impose disadvantage on attack against you' }],
                            2: [{ name: 'Channel Divinity: Radiance of the Dawn', desc: 'Dispel darkness, deal 2d10+level radiant' }],
                            6: [{ name: 'Improved Flare', desc: 'Use Warding Flare to protect allies' }],
                            8: [{ name: 'Potent Spellcasting', desc: 'Add WIS mod to cantrip damage' }],
                            17: [{ name: 'Corona of Light', desc: 'Bright light aura, fire/radiant spells disadvantage to save' }]
                        }
                    },
                    war: {
                        name: 'War Domain',
                        desc: 'Martial weapons, heavy armor, bonus attacks',
                        grantedSpells: {
                            1: { always: ['Divine Favor', 'Shield of Faith'] },
                            3: { always: ['Magic Weapon', 'Spiritual Weapon'] },
                            5: { always: ['Crusader\'s Mantle', 'Spirit Guardians'] },
                            7: { always: ['Freedom of Movement', 'Stoneskin'] },
                            9: { always: ['Flame Strike', 'Hold Monster'] }
                        },
                        features: {
                            1: [{ name: 'War Priest', desc: 'Bonus action attack WIS mod times per long rest' }],
                            2: [{ name: 'Channel Divinity: Guided Strike', desc: '+10 to attack roll' }],
                            6: [{ name: 'Channel Divinity: War God\'s Blessing', desc: '+10 to ally\'s attack' }],
                            8: [{ name: 'Divine Strike', desc: 'Weapon attacks deal extra 1d8 damage (2d8 at 14th)' }],
                            17: [{ name: 'Avatar of Battle', desc: 'Resistance to nonmagical bludgeoning, piercing, slashing' }]
                        }
                    },
                    tempest: {
                        name: 'Tempest Domain',
                        desc: 'Thunder and lightning powers, heavy armor',
                        grantedSpells: {
                            1: { always: ['Fog Cloud', 'Thunderwave'] },
                            3: { always: ['Gust of Wind', 'Shatter'] },
                            5: { always: ['Call Lightning', 'Sleet Storm'] },
                            7: { always: ['Control Water', 'Ice Storm'] },
                            9: { always: ['Destructive Wave', 'Insect Plague'] }
                        },
                        features: {
                            1: [{ name: 'Wrath of the Storm', desc: 'Reaction: deal 2d8 lightning/thunder when hit' }],
                            2: [{ name: 'Channel Divinity: Destructive Wrath', desc: 'Max damage on lightning/thunder' }],
                            6: [{ name: 'Thunderbolt Strike', desc: 'Push Large or smaller 10 ft with lightning damage' }],
                            8: [{ name: 'Divine Strike', desc: 'Weapon attacks deal extra 1d8 thunder (2d8 at 14th)' }],
                            17: [{ name: 'Stormborn', desc: 'Fly speed equal to walk speed outdoors' }]
                        }
                    },
                    knowledge: {
                        name: 'Knowledge Domain',
                        desc: 'Extra languages and skills, read thoughts',
                        grantedSpells: {
                            1: { always: ['Command', 'Identify'] },
                            3: { always: ['Augury', 'Suggestion'] },
                            5: { always: ['Nondetection', 'Speak with Dead'] },
                            7: { always: ['Arcane Eye', 'Confusion'] },
                            9: { always: ['Legend Lore', 'Scrying'] }
                        },
                        features: {
                            1: [{ name: 'Blessings of Knowledge', desc: 'Two languages, two skills with double proficiency' }],
                            2: [{ name: 'Channel Divinity: Knowledge of the Ages', desc: 'Gain proficiency in any skill/tool for 10 min' }],
                            6: [{ name: 'Channel Divinity: Read Thoughts', desc: 'Read surface thoughts, then Suggestion' }],
                            8: [{ name: 'Potent Spellcasting', desc: 'Add WIS mod to cantrip damage' }],
                            17: [{ name: 'Visions of the Past', desc: 'Meditate to see past events' }]
                        }
                    },
                    trickery: {
                        name: 'Trickery Domain',
                        desc: 'Illusion and charm spells, create duplicates',
                        grantedSpells: {
                            1: { always: ['Charm Person', 'Disguise Self'] },
                            3: { always: ['Mirror Image', 'Pass without Trace'] },
                            5: { always: ['Blink', 'Dispel Magic'] },
                            7: { always: ['Dimension Door', 'Polymorph'] },
                            9: { always: ['Dominate Person', 'Modify Memory'] }
                        },
                        features: {
                            1: [{ name: 'Blessing of the Trickster', desc: 'Give ally advantage on Stealth' }],
                            2: [{ name: 'Channel Divinity: Invoke Duplicity', desc: 'Create illusion duplicate, cast through it' }],
                            6: [{ name: 'Channel Divinity: Cloak of Shadows', desc: 'Become invisible' }],
                            8: [{ name: 'Divine Strike', desc: 'Weapon attacks deal extra 1d8 poison (2d8 at 14th)' }],
                            17: [{ name: 'Improved Duplicity', desc: 'Create 4 duplicates' }]
                        }
                    },
                    nature: {
                        name: 'Nature Domain',
                        desc: 'Druid cantrip, heavy armor, charm animals/plants',
                        grantedSpells: {
                            1: { always: ['Animal Friendship', 'Speak with Animals'] },
                            3: { always: ['Barkskin', 'Spike Growth'] },
                            5: { always: ['Plant Growth', 'Wind Wall'] },
                            7: { always: ['Dominate Beast', 'Grasping Vine'] },
                            9: { always: ['Insect Plague', 'Tree Stride'] }
                        },
                        features: {
                            1: [{ name: 'Acolyte of Nature', desc: 'Learn one druid cantrip, one skill proficiency' }],
                            2: [{ name: 'Channel Divinity: Charm Animals and Plants', desc: 'Charm beasts and plants in 30 ft' }],
                            6: [{ name: 'Dampen Elements', desc: 'Grant resistance to acid, cold, fire, lightning, thunder' }],
                            8: [{ name: 'Divine Strike', desc: 'Weapon attacks deal extra 1d8 cold/fire/lightning (2d8 at 14th)' }],
                            17: [{ name: 'Master of Nature', desc: 'Command charmed animals and plants' }]
                        }
                    },
                    death: {
                        name: 'Death Domain',
                        desc: 'Reaper cantrips, necrotic damage boost, martial weapons',
                        grantedSpells: {
                            1: { always: ['False Life', 'Ray of Sickness'] },
                            3: { always: ['Blindness/Deafness', 'Ray of Enfeeblement'] },
                            5: { always: ['Animate Dead', 'Vampiric Touch'] },
                            7: { always: ['Blight', 'Death Ward'] },
                            9: { always: ['Antilife Shell', 'Cloudkill'] }
                        },
                        features: {
                            1: [{ name: 'Reaper', desc: 'Learn one necromancy cantrip, can target two creatures' }],
                            2: [{ name: 'Channel Divinity: Touch of Death', desc: 'Deal 5+2x level necrotic on melee hit' }],
                            6: [{ name: 'Inescapable Destruction', desc: 'Necrotic damage ignores resistance' }],
                            8: [{ name: 'Divine Strike', desc: 'Weapon attacks deal extra 1d8 necrotic (2d8 at 14th)' }],
                            17: [{ name: 'Improved Reaper', desc: 'Necromancy spells 1st-5th can target two creatures' }]
                        }
                    },
                    forge: {
                        name: 'Forge Domain',
                        desc: 'Create magical items, fire resistance, heavy armor',
                        grantedSpells: {
                            1: { always: ['Identify', 'Searing Smite'] },
                            3: { always: ['Heat Metal', 'Magic Weapon'] },
                            5: { always: ['Elemental Weapon', 'Protection from Energy'] },
                            7: { always: ['Fabricate', 'Wall of Fire'] },
                            9: { always: ['Animate Objects', 'Creation'] }
                        },
                        features: {
                            1: [{ name: 'Blessing of the Forge', desc: 'Enchant weapon or armor +1' }],
                            2: [{ name: 'Channel Divinity: Artisan\'s Blessing', desc: 'Create metal item worth up to 100 gp' }],
                            6: [{ name: 'Soul of the Forge', desc: '+1 AC in heavy armor, fire resistance' }],
                            8: [{ name: 'Divine Strike', desc: 'Weapon attacks deal extra 1d8 fire (2d8 at 14th)' }],
                            17: [{ name: 'Saint of Forge and Fire', desc: 'Fire immunity, resistance to nonmagical attacks in heavy armor' }]
                        }
                    },
                    grave: {
                        name: 'Grave Domain',
                        desc: 'Spare the dying, cancel critical hits, max healing on unconscious',
                        grantedSpells: {
                            1: { always: ['Bane', 'False Life'] },
                            3: { always: ['Gentle Repose', 'Ray of Enfeeblement'] },
                            5: { always: ['Revivify', 'Vampiric Touch'] },
                            7: { always: ['Blight', 'Death Ward'] },
                            9: { always: ['Antilife Shell', 'Raise Dead'] }
                        },
                        features: {
                            1: [{ name: 'Circle of Mortality', desc: 'Max healing on creatures at 0 HP, Spare the Dying bonus action at 30 ft' }],
                            2: [{ name: 'Channel Divinity: Path to the Grave', desc: 'Next attack on target is critical' }],
                            6: [{ name: 'Sentinel at Death\'s Door', desc: 'Cancel critical hit as reaction' }],
                            8: [{ name: 'Potent Spellcasting', desc: 'Add WIS mod to cantrip damage' }],
                            17: [{ name: 'Keeper of Souls', desc: 'When enemy dies nearby, heal ally for HP = enemy HD' }]
                        }
                    },
                    order: {
                        name: 'Order Domain',
                        desc: 'Voice of Authority grants ally attacks, heavy armor',
                        grantedSpells: {
                            1: { always: ['Command', 'Heroism'] },
                            3: { always: ['Hold Person', 'Zone of Truth'] },
                            5: { always: ['Mass Healing Word', 'Slow'] },
                            7: { always: ['Compulsion', 'Locate Creature'] },
                            9: { always: ['Commune', 'Dominate Person'] }
                        },
                        features: {
                            1: [{ name: 'Voice of Authority', desc: 'Ally can attack when you cast spell on them' }],
                            2: [{ name: 'Channel Divinity: Order\'s Demand', desc: 'Charm and drop weapons in 30 ft' }],
                            6: [{ name: 'Embodiment of the Law', desc: 'Cast enchantment as bonus action' }],
                            8: [{ name: 'Divine Strike', desc: 'Weapon attacks deal extra 1d8 psychic (2d8 at 14th)' }],
                            17: [{ name: 'Order\'s Wrath', desc: 'Cursed targets take 2d8 psychic from allies' }]
                        }
                    },
                    peace: {
                        name: 'Peace Domain',
                        desc: 'Emboldening Bond links allies, protective aura',
                        grantedSpells: {
                            1: { always: ['Heroism', 'Sanctuary'] },
                            3: { always: ['Aid', 'Warding Bond'] },
                            5: { always: ['Beacon of Hope', 'Sending'] },
                            7: { always: ['Aura of Purity', 'Otiluke\'s Resilient Sphere'] },
                            9: { always: ['Greater Restoration', 'Rary\'s Telepathic Bond'] }
                        },
                        features: {
                            1: [{ name: 'Emboldening Bond', desc: 'Link allies to add d4 to attacks/saves' }],
                            2: [{ name: 'Channel Divinity: Balm of Peace', desc: 'Move and heal 2d6+WIS as you pass allies' }],
                            6: [{ name: 'Protective Bond', desc: 'Bonded ally can teleport to take damage for another' }],
                            8: [{ name: 'Potent Spellcasting', desc: 'Add WIS mod to cantrip damage' }],
                            17: [{ name: 'Expansive Bond', desc: 'Bond range 60 ft, resistance when teleporting to help' }]
                        }
                    },
                    twilight: {
                        name: 'Twilight Domain',
                        desc: 'Darkvision sharing, Twilight Sanctuary temp HP, heavy armor',
                        grantedSpells: {
                            1: { always: ['Faerie Fire', 'Sleep'] },
                            3: { always: ['Moonbeam', 'See Invisibility'] },
                            5: { always: ['Aura of Vitality', 'Leomund\'s Tiny Hut'] },
                            7: { always: ['Aura of Life', 'Greater Invisibility'] },
                            9: { always: ['Circle of Power', 'Mislead'] }
                        },
                        features: {
                            1: [{ name: 'Eyes of Night', desc: '300 ft darkvision, share with allies' }],
                            2: [{ name: 'Channel Divinity: Twilight Sanctuary', desc: 'Sphere grants d6+level temp HP or end charm/fear' }],
                            6: [{ name: 'Steps of Night', desc: 'Fly in dim light or darkness' }],
                            8: [{ name: 'Divine Strike', desc: 'Weapon attacks deal extra 1d8 radiant (2d8 at 14th)' }],
                            17: [{ name: 'Twilight Shroud', desc: 'Allies in sanctuary get half cover' }]
                        }
                    }
                },
                subclassLevel: 1
            },
            druid: {
                name: 'Druid',
                icon: 'ðŸŒ¿',
                hitDie: 'd8',
                primaryAbility: 'WIS',
                saves: ['INT', 'WIS'],
                armor: 'Light, Medium, Shields (non-metal)',
                weapons: 'Clubs, Daggers, Darts, Javelins, Maces, Quarterstaffs, Scimitars, Sickles, Slings, Spears',
                skills: 2,
                skillChoices: ['Arcana', 'Animal Handling', 'Insight', 'Medicine', 'Nature', 'Perception', 'Religion', 'Survival'],
                spellcasting: true,
                features: [
                    { name: 'Druidic', desc: 'Know the secret language of druids', level: 1 },
                    { name: 'Spellcasting', desc: 'Cast spells using Wisdom, prepare from druid spell list', level: 1 },
                    { name: 'Wild Shape', desc: 'Transform into beasts you have seen; 2 uses per short rest, CR and form limits based on level', level: 2 },
                    { name: 'Wild Shape Improvement', desc: 'Transform into beasts with swimming speed', level: 4 },
                    { name: 'Wild Shape Improvement', desc: 'Transform into beasts with flying speed', level: 8 },
                    { name: 'Timeless Body', desc: 'Age 10x slower, immune to magical aging', level: 18 },
                    { name: 'Beast Spells', desc: 'Cast spells while in Wild Shape form', level: 18 },
                    { name: 'Archdruid', desc: 'Unlimited Wild Shape uses; ignore verbal/somatic components', level: 20 }
                ],
                subclasses: {
                    land: {
                        name: 'Circle of the Land',
                        desc: 'Bonus spells based on terrain, recover spell slots',
                        grantedSpells: {
                            2: { always: [] }, // Spells depend on terrain choice - handled separately
                            3: { always: ['Hold Person', 'Spike Growth'] }, // Using grassland as default
                            5: { always: ['Daylight', 'Haste'] },
                            7: { always: ['Divination', 'Freedom of Movement'] },
                            9: { always: ['Dream', 'Insect Plague'] }
                        },
                        features: {
                            2: [{ name: 'Natural Recovery', desc: 'Recover spell slots during short rest (up to half level)' }],
                            6: [{ name: 'Land\'s Stride', desc: 'Move through difficult terrain, immunity to magical plants' }],
                            10: [{ name: 'Nature\'s Ward', desc: 'Immune to charm/fear by elementals/fey, immune to poison/disease' }],
                            14: [{ name: 'Nature\'s Sanctuary', desc: 'Beasts and plants must save to attack you' }]
                        }
                    },
                    moon: {
                        name: 'Circle of the Moon',
                        desc: 'Powerful Wild Shape, transform into stronger beasts',
                        features: {
                            2: [
                                { name: 'Combat Wild Shape', desc: 'Wild Shape as bonus action, spend slots to heal in beast form' },
                                { name: 'Circle Forms', desc: 'Transform into beasts up to CR 1 (CR increases with level)' }
                            ],
                            6: [{ name: 'Primal Strike', desc: 'Beast attacks count as magical' }],
                            10: [{ name: 'Elemental Wild Shape', desc: 'Transform into air, earth, fire, or water elemental' }],
                            14: [{ name: 'Thousand Forms', desc: 'Cast Alter Self at will' }]
                        }
                    },
                    shepherd: {
                        name: 'Circle of the Shepherd',
                        desc: 'Spirit totems aid allies, enhanced summoning',
                        features: {
                            2: [
                                { name: 'Speech of the Woods', desc: 'Learn Sylvan, communicate with beasts' },
                                { name: 'Spirit Totem', desc: 'Summon Bear/Hawk/Unicorn spirit with aura effects' }
                            ],
                            6: [{ name: 'Mighty Summoner', desc: 'Summoned creatures get +2 HP per HD and magical attacks' }],
                            10: [{ name: 'Guardian Spirit', desc: 'Summoned/created beasts heal half druid level at end of turn' }],
                            14: [{ name: 'Faithful Summons', desc: 'Summon 4 beasts when reduced to 0 HP' }]
                        }
                    },
                    stars: {
                        name: 'Circle of Stars',
                        desc: 'Starry Form constellations (Archer, Chalice, Dragon), star map focus',
                        grantedSpells: {
                            2: { always: ['Guiding Bolt'], cantrips: ['Guidance'] }
                        },
                        features: {
                            2: [
                                { name: 'Star Map', desc: 'Free casting of Guiding Bolt, learn Guidance cantrip' },
                                { name: 'Starry Form', desc: 'Use Wild Shape to become starry (Archer, Chalice, or Dragon)' }
                            ],
                            6: [{ name: 'Cosmic Omen', desc: 'Roll d6 after long rest: even=Weal (add d6), odd=Woe (subtract d6)' }],
                            10: [{ name: 'Twinkling Constellations', desc: 'Change starry form as bonus action, Archer/Chalice improved' }],
                            14: [{ name: 'Full of Stars', desc: 'Starry Form grants resistance to bludgeoning/piercing/slashing' }]
                        }
                    },
                    spores: {
                        name: 'Circle of Spores',
                        desc: 'Halo of Spores damage aura, Symbiotic Entity form',
                        grantedSpells: {
                            2: { cantrips: ['Chill Touch'] },
                            3: { always: ['Blindness/Deafness', 'Gentle Repose'] },
                            5: { always: ['Animate Dead', 'Gaseous Form'] },
                            7: { always: ['Blight', 'Confusion'] },
                            9: { always: ['Cloudkill', 'Contagion'] }
                        },
                        features: {
                            2: [
                                { name: 'Halo of Spores', desc: 'Reaction: deal 1d4 necrotic to creature within 10 ft' },
                                { name: 'Symbiotic Entity', desc: 'Use Wild Shape for 4 temp HP/level, enhanced Halo' }
                            ],
                            6: [{ name: 'Fungal Infestation', desc: 'Animate Small/Medium beast/humanoid as zombie' }],
                            10: [{ name: 'Spreading Spores', desc: 'Create 10 ft cube of spores that deals damage' }],
                            14: [{ name: 'Fungal Body', desc: 'Immune to blind, deaf, fear, poison; crits become normal hits' }]
                        }
                    },
                    wildfire: {
                        name: 'Circle of Wildfire',
                        desc: 'Wildfire spirit companion, enhanced fire and healing',
                        grantedSpells: {
                            2: { always: ['Burning Hands', 'Cure Wounds'] },
                            3: { always: ['Flaming Sphere', 'Scorching Ray'] },
                            5: { always: ['Plant Growth', 'Revivify'] },
                            7: { always: ['Aura of Life', 'Fire Shield'] },
                            9: { always: ['Flame Strike', 'Mass Cure Wounds'] }
                        },
                        features: {
                            2: [{ name: 'Summon Wildfire Spirit', desc: 'Use Wild Shape to summon fire spirit companion' }],
                            6: [{ name: 'Enhanced Bond', desc: '+1d8 to fire damage and healing spells through spirit' }],
                            10: [{ name: 'Cauterizing Flames', desc: 'When creature dies, spectral flame heals or damages' }],
                            14: [{ name: 'Blazing Revival', desc: 'When you drop to 0 HP, revive with half HP and spirit explodes' }]
                        }
                    }
                },
                subclassLevel: 2
            },
            fighter: {
                name: 'Fighter',
                icon: 'âš”ï¸',
                hitDie: 'd10',
                primaryAbility: 'STR/DEX',
                saves: ['STR', 'CON'],
                armor: 'All armor, Shields',
                weapons: 'Simple, Martial',
                skills: 2,
                skillChoices: ['Acrobatics', 'Animal Handling', 'Athletics', 'History', 'Insight', 'Intimidation', 'Perception', 'Survival'],
                features: [
                    { name: 'Fighting Style', desc: 'Choose a combat specialty: Archery, Defense, Dueling, etc.', level: 1 },
                    { name: 'Second Wind', desc: 'Heal yourself as a bonus action (1d10 + fighter level)', level: 1 },
                    { name: 'Action Surge', desc: 'Take an additional action on your turn (1 use, 2 at level 17)', level: 2 },
                    { name: 'Extra Attack', desc: 'Attack twice when taking the Attack action', level: 5 },
                    { name: 'Extra Attack (2)', desc: 'Attack three times when taking the Attack action', level: 11 },
                    { name: 'Indomitable', desc: 'Reroll a failed saving throw (1 use, 2 at 13th, 3 at 17th)', level: 9 },
                    { name: 'Extra Attack (3)', desc: 'Attack four times when taking the Attack action', level: 20 }
                ],
                subclasses: {
                    champion: {
                        name: 'Champion',
                        desc: 'Improved critical hits, remarkable athleticism',
                        features: {
                            3: [{ name: 'Improved Critical', desc: 'Weapon attacks score critical hit on roll of 19 or 20' }],
                            7: [{ name: 'Remarkable Athlete', desc: 'Add half proficiency (round up) to STR/DEX/CON checks without proficiency; running jump +STR mod feet' }],
                            10: [{ name: 'Additional Fighting Style', desc: 'Choose a second Fighting Style option' }],
                            15: [{ name: 'Superior Critical', desc: 'Weapon attacks score critical hit on roll of 18-20' }],
                            18: [{ name: 'Survivor', desc: 'At start of turn, regain 5 + CON mod HP if below half HP' }]
                        }
                    },
                    battlemaster: {
                        name: 'Battle Master',
                        desc: 'Combat maneuvers with superiority dice',
                        features: {
                            3: [
                                { name: 'Combat Superiority', desc: 'Learn 3 maneuvers, gain 4 d8 superiority dice (regain on short rest)' },
                                { name: 'Student of War', desc: 'Proficiency with one artisan\'s tool' }
                            ],
                            7: [
                                { name: 'Know Your Enemy', desc: 'Learn if creature is equal/superior/inferior in 2 characteristics after 1 minute' },
                                { name: 'Additional Maneuvers', desc: 'Learn 2 more maneuvers' }
                            ],
                            10: [{ name: 'Improved Combat Superiority', desc: 'Superiority dice become d10; learn 2 more maneuvers' }],
                            15: [{ name: 'Relentless', desc: 'Regain 1 superiority die if you have none at start of combat; learn 2 more maneuvers' }],
                            18: [{ name: 'Improved Combat Superiority', desc: 'Superiority dice become d12' }]
                        }
                    },
                    eldritchknight: {
                        name: 'Eldritch Knight',
                        desc: 'Combine fighting with wizard spells',
                        features: {
                            3: [
                                { name: 'Spellcasting', desc: 'Learn wizard spells, primarily abjuration and evocation' },
                                { name: 'Weapon Bond', desc: 'Bond with weapon; can\'t be disarmed, can summon to hand' }
                            ],
                            7: [{ name: 'War Magic', desc: 'When casting cantrip, make one weapon attack as bonus action' }],
                            10: [{ name: 'Eldritch Strike', desc: 'Creature hit by weapon attack has disadvantage on next save vs your spell' }],
                            15: [{ name: 'Arcane Charge', desc: 'When using Action Surge, teleport up to 30 ft' }],
                            18: [{ name: 'Improved War Magic', desc: 'When casting spell, make one weapon attack as bonus action' }]
                        }
                    },
                    samurai: {
                        name: 'Samurai',
                        desc: 'Fighting Spirit for advantage, elegant courtier',
                        features: {
                            3: [
                                { name: 'Bonus Proficiency', desc: 'Proficiency in History, Insight, Performance, or Persuasion (or language)' },
                                { name: 'Fighting Spirit', desc: 'Bonus action for advantage on all attacks this turn and 5 temp HP (3 uses per long rest)' }
                            ],
                            7: [{ name: 'Elegant Courtier', desc: 'Add WIS to Persuasion; proficiency (or expertise) in WIS saves' }],
                            10: [{ name: 'Tireless Spirit', desc: 'Regain one Fighting Spirit use if you have none at start of combat' }],
                            15: [{ name: 'Rapid Strike', desc: 'When attacking with advantage, forgo advantage to make extra attack' }],
                            18: [{ name: 'Strength Before Death', desc: 'When reduced to 0 HP, take immediate extra turn (once per long rest)' }]
                        }
                    },
                    cavalier: {
                        name: 'Cavalier',
                        desc: 'Mounted combat master, mark and protect allies',
                        features: {
                            3: [
                                { name: 'Bonus Proficiency', desc: 'Proficiency in Animal Handling, History, Insight, Performance, or Persuasion (or language)' },
                                { name: 'Born to the Saddle', desc: 'Advantage on saves vs falling off mount; land on feet if fall less than 10 ft; mount/dismount costs 5 ft' },
                                { name: 'Unwavering Mark', desc: 'When hitting creature, mark it; disadvantage attacking others, bonus action attack if it damages others' }
                            ],
                            7: [{ name: 'Warding Maneuver', desc: 'When you or adjacent ally is hit, add 1d8 to AC as reaction; if still hit, gain resistance' }],
                            10: [{ name: 'Hold the Line', desc: 'Creatures provoke opportunity attack when moving within reach; hit reduces speed to 0' }],
                            15: [{ name: 'Ferocious Charger', desc: 'When moving 10+ ft and hitting with attack, knock prone on failed STR save' }],
                            18: [{ name: 'Vigilant Defender', desc: 'Make opportunity attack against every creature on their turn' }]
                        }
                    },
                    archercher: {
                        name: 'Arcane Archer',
                        desc: 'Magical arrows with special effects',
                        features: {
                            3: [
                                { name: 'Arcane Archer Lore', desc: 'Proficiency in Arcana or Nature; learn Prestidigitation or Druidcraft cantrip' },
                                { name: 'Arcane Shot', desc: 'Learn 2 Arcane Shot options; 2 uses per short rest, more options at higher levels' }
                            ],
                            7: [
                                { name: 'Magic Arrow', desc: 'Nonmagical arrows become magical when fired' },
                                { name: 'Curving Shot', desc: 'When missing with magic arrow, redirect to new target within 60 ft' }
                            ],
                            15: [{ name: 'Ever-Ready Shot', desc: 'Regain one Arcane Shot use if you have none at start of combat' }],
                            18: [{ name: 'Improved Arcane Shot', desc: 'All Arcane Shot options deal increased damage' }]
                        }
                    },
                    psiwarrior: {
                        name: 'Psi Warrior',
                        desc: 'Psionic powers for defense, movement, and strikes',
                        features: {
                            3: [
                                { name: 'Psionic Power', desc: 'Pool of Psionic Energy dice (d6); use for Protective Field, Psionic Strike, or Telekinetic Movement' },
                                { name: 'Protective Field', desc: 'Reduce damage to you or ally within 30 ft by Psionic Energy die + INT' },
                                { name: 'Psionic Strike', desc: 'Add Psionic Energy die + INT force damage to weapon attack' },
                                { name: 'Telekinetic Movement', desc: 'Move object or creature up to 30 ft' }
                            ],
                            7: [{ name: 'Telekinetic Adept', desc: 'Psi-Powered Leap (fly = 2Ã— speed as bonus action) and Telekinetic Thrust (push 10 ft or prone)' }],
                            10: [{ name: 'Guarded Mind', desc: 'Resistance to psychic damage; spend Psionic Energy die to end charmed/frightened' }],
                            15: [{ name: 'Bulwark of Force', desc: 'Bonus action to give half cover to INT mod creatures within 30 ft' }],
                            18: [{ name: 'Telekinetic Master', desc: 'Cast Telekinesis without components; Psionic Strike die increases to d12' }]
                        }
                    },
                    runeknight: {
                        name: 'Rune Knight',
                        desc: 'Giant runes grant powers, grow to Large size',
                        features: {
                            3: [
                                { name: 'Bonus Proficiencies', desc: 'Proficiency with smith\'s tools; learn Giant language' },
                                { name: 'Rune Carver', desc: 'Learn 2 runes, inscribe on objects for passive and invoked effects' },
                                { name: 'Giant\'s Might', desc: 'Become Large, advantage on STR checks/saves, +1d6 damage once per turn' }
                            ],
                            7: [
                                { name: 'Runic Shield', desc: 'When ally within 60 ft is hit, force reroll and use lower' },
                                { name: 'Additional Rune', desc: 'Learn one additional rune' }
                            ],
                            10: [{ name: 'Great Stature', desc: 'Grow 3d4 inches; Giant\'s Might damage increases to 1d8' }],
                            15: [{ name: 'Master of Runes', desc: 'Invoke each rune twice; learn additional rune' }],
                            18: [{ name: 'Runic Juggernaut', desc: 'Giant\'s Might becomes Huge, reach +5 ft, damage increases to 1d10' }]
                        }
                    },
                    echo: {
                        name: 'Echo Knight',
                        desc: 'Manifest echo of yourself, attack from its position',
                        features: {
                            3: [
                                { name: 'Manifest Echo', desc: 'Create translucent echo within 15 ft; can attack from its space, swap places, make opportunity attacks through it' },
                                { name: 'Unleash Incarnation', desc: 'When taking Attack action, make additional attack from echo\'s position (CON mod times per long rest)' }
                            ],
                            7: [{ name: 'Echo Avatar', desc: 'Transfer consciousness to echo for 10 minutes; see/hear through it up to 1000 ft' }],
                            10: [{ name: 'Shadow Martyr', desc: 'When creature you can see is attacked, teleport echo to take the hit instead' }],
                            15: [{ name: 'Reclaim Potential', desc: 'When echo is destroyed, gain 2d6 + CON temp HP' }],
                            18: [{ name: 'Legion of One', desc: 'Create two echoes with Manifest Echo; if both destroyed, create one as bonus action' }]
                        }
                    }
                },
                subclassLevel: 3
            },
            monk: {
                name: 'Monk',
                icon: 'ðŸ‘Š',
                hitDie: 'd8',
                primaryAbility: 'DEX/WIS',
                saves: ['STR', 'DEX'],
                armor: 'None',
                weapons: 'Simple, Shortswords',
                skills: 2,
                skillChoices: ['Acrobatics', 'Athletics', 'History', 'Insight', 'Religion', 'Stealth'],
                features: [
                    { name: 'Unarmored Defense', desc: 'AC = 10 + DEX mod + WIS mod when not wearing armor', level: 1 },
                    { name: 'Martial Arts', desc: 'Use DEX for unarmed strikes, bonus action unarmed strike', level: 1 },
                    { name: 'Ki', desc: 'Harness mystical energy for special abilities; ki points = monk level', level: 2 },
                    { name: 'Unarmored Movement', desc: '+10 ft speed when not wearing armor (increases with level)', level: 2 },
                    { name: 'Flurry of Blows', desc: 'Spend 1 ki for two unarmed strikes as bonus action', level: 2 },
                    { name: 'Patient Defense', desc: 'Spend 1 ki to Dodge as bonus action', level: 2 },
                    { name: 'Step of the Wind', desc: 'Spend 1 ki to Disengage or Dash as bonus action, double jump', level: 2 },
                    { name: 'Deflect Missiles', desc: 'Reduce ranged weapon damage; can catch and throw back', level: 3 },
                    { name: 'Slow Fall', desc: 'Reduce falling damage by 5Ã— monk level', level: 4 },
                    { name: 'Extra Attack', desc: 'Attack twice when taking the Attack action', level: 5 },
                    { name: 'Stunning Strike', desc: 'Spend 1 ki to attempt to stun target on hit', level: 5 },
                    { name: 'Ki-Empowered Strikes', desc: 'Unarmed strikes count as magical', level: 6 },
                    { name: 'Evasion', desc: 'Take no damage on successful DEX save, half on fail', level: 7 },
                    { name: 'Stillness of Mind', desc: 'End charm or fear effect on yourself as action', level: 7 },
                    { name: 'Purity of Body', desc: 'Immune to disease and poison', level: 10 },
                    { name: 'Tongue of the Sun and Moon', desc: 'Understand all spoken languages; all can understand you', level: 13 },
                    { name: 'Diamond Soul', desc: 'Proficiency in all saving throws; spend 1 ki to reroll', level: 14 },
                    { name: 'Timeless Body', desc: 'No frailty of age; need no food or water', level: 15 },
                    { name: 'Empty Body', desc: 'Spend 4 ki for invisibility and resistance to all but force', level: 18 },
                    { name: 'Perfect Self', desc: 'Regain 4 ki if you have none at initiative', level: 20 }
                ],
                subclasses: {
                    openhand: {
                        name: 'Way of the Open Hand',
                        desc: 'Enhanced unarmed techniques, Quivering Palm',
                        features: {
                            3: [{ name: 'Open Hand Technique', desc: 'When hitting with Flurry of Blows, can knock prone, push 15 ft, or prevent reactions' }],
                            6: [{ name: 'Wholeness of Body', desc: 'Regain HP equal to 3Ã— monk level as an action (once per long rest)' }],
                            11: [{ name: 'Tranquility', desc: 'Gain Sanctuary effect (WIS save DC) at end of long rest until start of combat' }],
                            17: [{ name: 'Quivering Palm', desc: 'Spend 3 ki when hitting creature; later spend action to deal 10d10 necrotic or 0 on failed CON save' }]
                        }
                    },
                    shadow: {
                        name: 'Way of Shadow',
                        desc: 'Ninja abilities, shadow teleportation',
                        grantedSpells: {
                            3: { cantrips: ['Minor Illusion'] }
                        },
                        features: {
                            3: [
                                { name: 'Shadow Arts', desc: 'Learn Minor Illusion cantrip; spend 2 ki to cast Darkness, Darkvision, Pass without Trace, or Silence' },
                                { name: 'Ki Spells', desc: 'Cast certain spells using ki points instead of spell slots' }
                            ],
                            6: [{ name: 'Shadow Step', desc: 'Teleport 60 ft from dim light/darkness to dim light/darkness as bonus action; advantage on next attack' }],
                            11: [{ name: 'Cloak of Shadows', desc: 'Become invisible in dim light or darkness as action; ends when you attack or cast spell' }],
                            17: [{ name: 'Opportunist', desc: 'When creature within 5 ft is hit by attack from someone else, make melee attack as reaction' }]
                        }
                    },
                    elements: {
                        name: 'Way of the Four Elements',
                        desc: 'Channel ki into elemental magic',
                        features: {
                            3: [{ name: 'Disciple of the Elements', desc: 'Learn 2 elemental disciplines; spend ki to cast spells or create elemental effects' }],
                            6: [{ name: 'Additional Discipline', desc: 'Learn one additional elemental discipline; can replace one discipline when learning new' }],
                            11: [{ name: 'Additional Discipline', desc: 'Learn one additional elemental discipline' }],
                            17: [{ name: 'Additional Discipline', desc: 'Learn one additional elemental discipline; access to most powerful disciplines' }]
                        }
                    },
                    mercy: {
                        name: 'Way of Mercy',
                        desc: 'Heal allies and harm foes with touch',
                        features: {
                            3: [
                                { name: 'Implements of Mercy', desc: 'Proficiency with Insight, Medicine, and herbalism kit; gain distinctive physician\'s mask' },
                                { name: 'Hand of Healing', desc: 'Spend 1 ki to heal 1d6 + WIS mod HP (replaces Flurry of Blows attack)' },
                                { name: 'Hand of Harm', desc: 'Spend 1 ki when hitting with Flurry of Blows for extra 1d6 + WIS mod necrotic' }
                            ],
                            6: [{ name: 'Physician\'s Touch', desc: 'Hand of Healing can end disease or condition; Hand of Harm can poison' }],
                            11: [{ name: 'Flurry of Healing and Harm', desc: 'Replace each Flurry of Blows attack with Hand of Healing (no ki cost)' }],
                            17: [{ name: 'Hand of Ultimate Mercy', desc: 'Touch creature dead no more than 24 hours, spend 5 ki to return to life with 4d10 + WIS HP' }]
                        }
                    },
                    drunken: {
                        name: 'Way of the Drunken Master',
                        desc: 'Unpredictable movement, redirect attacks',
                        features: {
                            3: [
                                { name: 'Bonus Proficiencies', desc: 'Proficiency with Performance and brewer\'s supplies' },
                                { name: 'Drunken Technique', desc: 'Flurry of Blows grants Disengage and +10 ft speed' }
                            ],
                            6: [{ name: 'Tipsy Sway', desc: 'Leap to Feet (stand from prone for 5 ft) and Redirect Attack (spend 1 ki to redirect missed melee to another creature)' }],
                            11: [{ name: 'Drunkard\'s Luck', desc: 'When making attack, save, or check with disadvantage, spend 2 ki to cancel disadvantage' }],
                            17: [{ name: 'Intoxicated Frenzy', desc: 'When using Flurry of Blows, make up to 3 additional attacks (each must target different creature)' }]
                        }
                    },
                    kensei: {
                        name: 'Way of the Kensei',
                        desc: 'Weapon mastery, treat weapons as monk weapons',
                        features: {
                            3: [
                                { name: 'Path of the Kensei', desc: 'Choose 2 weapons as kensei weapons (one melee, one ranged); gain +2 AC when attacking with melee kensei weapon' },
                                { name: 'Agile Parry', desc: 'When attacking with melee kensei weapon and unarmed, gain +2 AC' }
                            ],
                            6: [
                                { name: 'One with the Blade', desc: 'Kensei weapons count as magical; spend 1 ki for extra 1d6 damage with ranged kensei weapon' },
                                { name: 'Deft Strike', desc: 'Spend 1 ki when hitting with kensei weapon to deal extra martial arts die damage' }
                            ],
                            11: [{ name: 'Sharpen the Blade', desc: 'Spend up to 3 ki to grant kensei weapon +1 to +3 bonus to attack and damage' }],
                            17: [{ name: 'Unerring Accuracy', desc: 'Once per turn, reroll a missed attack with a monk weapon' }]
                        }
                    },
                    sunsoul: {
                        name: 'Way of the Sun Soul',
                        desc: 'Radiant sun bolts and searing arc strikes',
                        features: {
                            3: [{ name: 'Radiant Sun Bolt', desc: 'Ranged spell attack (30 ft) dealing 1d4 + DEX radiant damage; can replace Flurry attacks' }],
                            6: [{ name: 'Searing Arc Strike', desc: 'After Attack action, spend 2 ki to cast Burning Hands (scale damage by spending more ki)' }],
                            11: [{ name: 'Searing Sunburst', desc: 'Create 20 ft radius orb of light dealing 2d6 radiant (save for half); spend ki for extra 2d6 each' }],
                            17: [{ name: 'Sun Shield', desc: 'Bright light 30 ft, dim light 30 ft; when hit by melee, deal 5 + WIS radiant damage' }]
                        }
                    },
                    astral: {
                        name: 'Way of the Astral Self',
                        desc: 'Manifest spectral arms, visage, and body',
                        features: {
                            3: [{ name: 'Arms of the Astral Self', desc: 'Spend 1 ki to manifest spectral arms; +5 ft reach, use WIS for attacks, deal extra martial arts die force damage' }],
                            6: [{ name: 'Visage of the Astral Self', desc: 'When summoning arms, spend 1 ki for visage: darkvision 120 ft, advantage on Insight/Intimidation, voice amplified to 600 ft' }],
                            11: [{ name: 'Body of the Astral Self', desc: 'When both arms and visage active, spend 1 ki to armor: deflect energy (reduce damage by 1d10 + WIS), empower arms (extra martial arts die damage)' }],
                            17: [{ name: 'Awakened Astral Self', desc: '+2 AC while astral self is summoned; once per turn deal extra 2d10 damage on arm hit at half HP or less' }]
                        }
                    },
                    longdeath: {
                        name: 'Way of the Long Death',
                        desc: 'Gain temp HP from nearby deaths, frightening presence',
                        features: {
                            3: [{ name: 'Touch of Death', desc: 'When creature within 5 ft dies, gain temp HP equal to WIS + monk level' }],
                            6: [{ name: 'Hour of Reaping', desc: 'As action, frighten each creature within 30 ft that can see you (WIS save)' }],
                            11: [{ name: 'Mastery of Death', desc: 'When reduced to 0 HP, spend 1 ki to have 1 HP instead' }],
                            17: [{ name: 'Touch of the Long Death', desc: 'Spend 1-10 ki when hitting with unarmed strike; deal 2d10 necrotic per ki spent (CON save for half)' }]
                        }
                    }
                },
                subclassLevel: 3
            },
            paladin: {
                name: 'Paladin',
                icon: 'ðŸ›¡ï¸',
                hitDie: 'd10',
                primaryAbility: 'STR/CHA',
                saves: ['WIS', 'CHA'],
                armor: 'All armor, Shields',
                weapons: 'Simple, Martial',
                skills: 2,
                skillChoices: ['Athletics', 'Insight', 'Intimidation', 'Medicine', 'Persuasion', 'Religion'],
                spellcasting: true,
                features: [
                    { name: 'Divine Sense', desc: 'Detect celestials, fiends, and undead nearby', level: 1 },
                    { name: 'Lay on Hands', desc: 'Heal with a pool of HP equal to paladin level Ã— 5', level: 1 },
                    { name: 'Fighting Style', desc: 'Choose a combat specialty: Defense, Dueling, Great Weapon, Protection', level: 2 },
                    { name: 'Spellcasting', desc: 'Cast paladin spells using Charisma', level: 2 },
                    { name: 'Divine Smite', desc: 'Expend spell slot to deal extra 2d8+ radiant damage on hit', level: 2 },
                    { name: 'Divine Health', desc: 'Immune to disease', level: 3 },
                    { name: 'Extra Attack', desc: 'Attack twice when taking the Attack action', level: 5 },
                    { name: 'Aura of Protection', desc: 'You and allies within 10 ft add CHA mod to saves', level: 6 },
                    { name: 'Aura of Courage', desc: 'You and allies within 10 ft can\'t be frightened', level: 10 },
                    { name: 'Improved Divine Smite', desc: 'All melee hits deal +1d8 radiant damage', level: 11 },
                    { name: 'Cleansing Touch', desc: 'End one spell on yourself or willing creature', level: 14 },
                    { name: 'Aura Improvements', desc: 'Auras extend to 30 ft', level: 18 }
                ],
                subclasses: {
                    devotion: {
                        name: 'Oath of Devotion',
                        desc: 'Classic paladin, Sacred Weapon, Turn the Unholy',
                        grantedSpells: {
                            3: { always: ['Protection from Evil and Good', 'Sanctuary'] },
                            5: { always: ['Lesser Restoration', 'Zone of Truth'] },
                            9: { always: ['Beacon of Hope', 'Dispel Magic'] },
                            13: { always: ['Freedom of Movement', 'Guardian of Faith'] },
                            17: { always: ['Commune', 'Flame Strike'] }
                        },
                        features: {
                            3: [
                                { name: 'Channel Divinity: Sacred Weapon', desc: 'Add CHA to attack rolls, weapon emits bright light' },
                                { name: 'Channel Divinity: Turn the Unholy', desc: 'Turn fiends and undead' }
                            ],
                            7: [{ name: 'Aura of Devotion', desc: 'You and allies within 10 ft can\'t be charmed' }],
                            15: [{ name: 'Purity of Spirit', desc: 'Always under Protection from Evil and Good effect' }],
                            20: [{ name: 'Holy Nimbus', desc: 'Emanate sunlight, deal radiant damage to enemies' }]
                        }
                    },
                    ancients: {
                        name: 'Oath of the Ancients',
                        desc: 'Nature-themed, resist spell damage, ensnare foes',
                        grantedSpells: {
                            3: { always: ['Ensnaring Strike', 'Speak with Animals'] },
                            5: { always: ['Moonbeam', 'Misty Step'] },
                            9: { always: ['Plant Growth', 'Protection from Energy'] },
                            13: { always: ['Ice Storm', 'Stoneskin'] },
                            17: { always: ['Commune with Nature', 'Tree Stride'] }
                        },
                        features: {
                            3: [
                                { name: 'Channel Divinity: Nature\'s Wrath', desc: 'Restrain a creature with spectral vines' },
                                { name: 'Channel Divinity: Turn the Faithless', desc: 'Turn fey and fiends' }
                            ],
                            7: [{ name: 'Aura of Warding', desc: 'You and allies within 10 ft have resistance to spell damage' }],
                            15: [{ name: 'Undying Sentinel', desc: 'Drop to 1 HP instead of 0 once per long rest, no aging drawbacks' }],
                            20: [{ name: 'Elder Champion', desc: 'Transform into force of nature, regain HP, cast spells as bonus action' }]
                        }
                    },
                    vengeance: {
                        name: 'Oath of Vengeance',
                        desc: 'Hunt down evildoers, Vow of Enmity',
                        grantedSpells: {
                            3: { always: ['Bane', 'Hunter\'s Mark'] },
                            5: { always: ['Hold Person', 'Misty Step'] },
                            9: { always: ['Haste', 'Protection from Energy'] },
                            13: { always: ['Banishment', 'Dimension Door'] },
                            17: { always: ['Hold Monster', 'Scrying'] }
                        },
                        features: {
                            3: [
                                { name: 'Channel Divinity: Abjure Enemy', desc: 'Frighten a creature, speed becomes 0 if fiend/undead' },
                                { name: 'Channel Divinity: Vow of Enmity', desc: 'Advantage on attack rolls against one creature for 1 minute' }
                            ],
                            7: [{ name: 'Relentless Avenger', desc: 'Move up to half speed as reaction when hitting with opportunity attack' }],
                            15: [{ name: 'Soul of Vengeance', desc: 'Attack Vow of Enmity target as reaction when it attacks' }],
                            20: [{ name: 'Avenging Angel', desc: 'Sprout wings (60 ft fly), frightening aura' }]
                        }
                    },
                    conquest: {
                        name: 'Oath of Conquest',
                        desc: 'Dominate foes with fear, Conquering Presence',
                        grantedSpells: {
                            3: { always: ['Armor of Agathys', 'Command'] },
                            5: { always: ['Hold Person', 'Spiritual Weapon'] },
                            9: { always: ['Bestow Curse', 'Fear'] },
                            13: { always: ['Dominate Beast', 'Stoneskin'] },
                            17: { always: ['Cloudkill', 'Dominate Person'] }
                        },
                        features: {
                            3: [
                                { name: 'Channel Divinity: Conquering Presence', desc: 'Frighten creatures within 30 ft' },
                                { name: 'Channel Divinity: Guided Strike', desc: '+10 to attack roll' }
                            ],
                            7: [{ name: 'Aura of Conquest', desc: 'Frightened creatures within 10 ft have speed 0, take psychic damage' }],
                            15: [{ name: 'Scornful Rebuke', desc: 'Deal psychic damage to creatures that hit you' }],
                            20: [{ name: 'Invincible Conqueror', desc: 'Resistance to all damage, extra attack, crit on 19-20' }]
                        }
                    },
                    redemption: {
                        name: 'Oath of Redemption',
                        desc: 'Peaceful resolution, absorb damage for allies',
                        grantedSpells: {
                            3: { always: ['Sanctuary', 'Sleep'] },
                            5: { always: ['Calm Emotions', 'Hold Person'] },
                            9: { always: ['Counterspell', 'Hypnotic Pattern'] },
                            13: { always: ['Otiluke\'s Resilient Sphere', 'Stoneskin'] },
                            17: { always: ['Hold Monster', 'Wall of Force'] }
                        },
                        features: {
                            3: [
                                { name: 'Channel Divinity: Emissary of Peace', desc: '+5 to Persuasion checks for 10 minutes' },
                                { name: 'Channel Divinity: Rebuke the Violent', desc: 'Deal radiant damage equal to damage dealt to ally' }
                            ],
                            7: [{ name: 'Aura of the Guardian', desc: 'Take damage instead of ally within 10 ft' }],
                            15: [{ name: 'Protective Spirit', desc: 'Regain HP at end of turn when below half HP' }],
                            20: [{ name: 'Emissary of Redemption', desc: 'Resistance to all damage from creatures, reflect half damage back' }]
                        }
                    },
                    crown: {
                        name: 'Oath of the Crown',
                        desc: 'Serve civilization, Champion Challenge, Turn the Tide',
                        grantedSpells: {
                            3: { always: ['Command', 'Compelled Duel'] },
                            5: { always: ['Warding Bond', 'Zone of Truth'] },
                            9: { always: ['Aura of Vitality', 'Spirit Guardians'] },
                            13: { always: ['Banishment', 'Guardian of Faith'] },
                            17: { always: ['Circle of Power', 'Geas'] }
                        },
                        features: {
                            3: [
                                { name: 'Channel Divinity: Champion Challenge', desc: 'Creatures within 30 ft can\'t willingly move away' },
                                { name: 'Channel Divinity: Turn the Tide', desc: 'Heal allies within 30 ft who have half HP or less' }
                            ],
                            7: [{ name: 'Divine Allegiance', desc: 'Take damage instead of ally within 5 ft' }],
                            15: [{ name: 'Unyielding Spirit', desc: 'Advantage on saves vs paralyzed and stunned' }],
                            20: [{ name: 'Exalted Champion', desc: 'Resistance to nonmagical B/P/S, allies have advantage on saves' }]
                        }
                    },
                    glory: {
                        name: 'Oath of Glory',
                        desc: 'Athletic heroics, Peerless Athlete, Inspiring Smite',
                        grantedSpells: {
                            3: { always: ['Guiding Bolt', 'Heroism'] },
                            5: { always: ['Enhance Ability', 'Magic Weapon'] },
                            9: { always: ['Haste', 'Protection from Energy'] },
                            13: { always: ['Compulsion', 'Freedom of Movement'] },
                            17: { always: ['Commune', 'Flame Strike'] }
                        },
                        features: {
                            3: [
                                { name: 'Channel Divinity: Peerless Athlete', desc: 'Advantage on Athletics/Acrobatics, carry/lift more, jump farther' },
                                { name: 'Channel Divinity: Inspiring Smite', desc: 'Distribute temp HP to allies after Divine Smite' }
                            ],
                            7: [{ name: 'Aura of Alacrity', desc: 'You and allies within 10 ft gain +10 ft walking speed' }],
                            15: [{ name: 'Glorious Defense', desc: 'Add CHA to AC of ally, counterattack if attack misses' }],
                            20: [{ name: 'Living Legend', desc: 'Advantage on CHA checks, turn miss into hit once per turn, reroll failed save' }]
                        }
                    },
                    watchers: {
                        name: 'Oath of the Watchers',
                        desc: 'Guard against extraplanar threats, banish invaders',
                        grantedSpells: {
                            3: { always: ['Alarm', 'Detect Magic'] },
                            5: { always: ['Moonbeam', 'See Invisibility'] },
                            9: { always: ['Counterspell', 'Nondetection'] },
                            13: { always: ['Aura of Purity', 'Banishment'] },
                            17: { always: ['Hold Monster', 'Scrying'] }
                        },
                        features: {
                            3: [
                                { name: 'Channel Divinity: Watcher\'s Will', desc: 'Grant advantage on INT/WIS/CHA saves to allies within 30 ft' },
                                { name: 'Channel Divinity: Abjure the Extraplanar', desc: 'Turn aberrations, celestials, elementals, fey, and fiends' }
                            ],
                            7: [{ name: 'Aura of the Sentinel', desc: 'Add proficiency bonus to initiative for you and allies within 10 ft' }],
                            15: [{ name: 'Vigilant Rebuke', desc: 'Deal force damage when creature fails save vs your or ally\'s spell' }],
                            20: [{ name: 'Mortal Bulwark', desc: 'Truesight 120 ft, advantage vs aberrations/celestials/elementals/fey/fiends, banish on hit' }]
                        }
                    },
                    oathbreaker: {
                        name: 'Oathbreaker',
                        desc: 'Dark paladin, control undead, dread lord aura',
                        grantedSpells: {
                            3: { always: ['Hellish Rebuke', 'Inflict Wounds'] },
                            5: { always: ['Crown of Madness', 'Darkness'] },
                            9: { always: ['Animate Dead', 'Bestow Curse'] },
                            13: { always: ['Blight', 'Confusion'] },
                            17: { always: ['Contagion', 'Dominate Person'] }
                        },
                        features: {
                            3: [
                                { name: 'Channel Divinity: Control Undead', desc: 'Command an undead creature for 24 hours' },
                                { name: 'Channel Divinity: Dreadful Aspect', desc: 'Frighten creatures within 30 ft' }
                            ],
                            7: [{ name: 'Aura of Hate', desc: 'You and fiends/undead within 10 ft add CHA to melee damage' }],
                            15: [{ name: 'Supernatural Resistance', desc: 'Resistance to nonmagical B/P/S' }],
                            20: [{ name: 'Dread Lord', desc: 'Aura of shadow, deal psychic damage, create specter from slain humanoids' }]
                        }
                    }
                },
                subclassLevel: 3
            },
            ranger: {
                name: 'Ranger',
                icon: 'ðŸ¹',
                hitDie: 'd10',
                primaryAbility: 'DEX/WIS',
                saves: ['STR', 'DEX'],
                armor: 'Light, Medium, Shields',
                weapons: 'Simple, Martial',
                skills: 3,
                skillChoices: ['Animal Handling', 'Athletics', 'Insight', 'Investigation', 'Nature', 'Perception', 'Stealth', 'Survival'],
                spellcasting: true,
                features: [
                    { name: 'Favored Enemy', desc: 'Advantage on tracking and recalling info about certain creatures', level: 1 },
                    { name: 'Natural Explorer', desc: 'Expert at navigating and surviving in certain terrain', level: 1 },
                    { name: 'Fighting Style', desc: 'Choose a combat specialty: Archery, Defense, Dueling, Two-Weapon', level: 2 },
                    { name: 'Spellcasting', desc: 'Cast ranger spells using Wisdom', level: 2 },
                    { name: 'Primeval Awareness', desc: 'Sense aberrations, celestials, dragons, elementals, fey, fiends, undead within 1 mile', level: 3 },
                    { name: 'Extra Attack', desc: 'Attack twice when taking the Attack action', level: 5 },
                    { name: 'Land\'s Stride', desc: 'Move through nonmagical difficult terrain without extra cost', level: 8 },
                    { name: 'Hide in Plain Sight', desc: 'Camouflage yourself against a surface for +10 Stealth', level: 10 },
                    { name: 'Vanish', desc: 'Hide as bonus action; can\'t be tracked nonmagically', level: 14 },
                    { name: 'Feral Senses', desc: 'No disadvantage attacking invisible creatures; sense invisible within 30 ft', level: 18 },
                    { name: 'Foe Slayer', desc: 'Add WIS mod to attack or damage roll against favored enemy', level: 20 }
                ],
                subclasses: {
                    hunter: {
                        name: 'Hunter',
                        desc: 'Specialized techniques for slaying prey',
                        features: {
                            3: [{ name: 'Hunter\'s Prey', desc: 'Choose: Colossus Slayer (extra 1d8 on wounded), Giant Killer (attack as reaction), or Horde Breaker (attack second adjacent target)' }],
                            7: [{ name: 'Defensive Tactics', desc: 'Choose: Escape the Horde, Multiattack Defense, or Steel Will' }],
                            11: [{ name: 'Multiattack', desc: 'Choose: Volley (ranged attack all in 10 ft radius) or Whirlwind Attack (melee all within reach)' }],
                            15: [{ name: 'Superior Hunter\'s Defense', desc: 'Choose: Evasion, Stand Against the Tide, or Uncanny Dodge' }]
                        }
                    },
                    beastmaster: {
                        name: 'Beast Master',
                        desc: 'Animal companion fights alongside you',
                        features: {
                            3: [
                                { name: 'Primal Companion', desc: 'Gain a Beast of the Land, Sea, or Sky companion' },
                                { name: 'Companion Bond', desc: 'Companion adds proficiency to AC, damage, saves, and skills' }
                            ],
                            7: [{ name: 'Exceptional Training', desc: 'Companion\'s attacks count as magical, can Help, Dash, Disengage, or Dodge as bonus action' }],
                            11: [{ name: 'Bestial Fury', desc: 'Companion can attack twice when you command it to attack' }],
                            15: [{ name: 'Share Spells', desc: 'Spells targeting only you can also affect your companion' }]
                        }
                    },
                    gloomstalker: {
                        name: 'Gloom Stalker',
                        desc: 'Master of darkness, ambush predator',
                        grantedSpells: {
                            3: { always: ['Disguise Self'] },
                            5: { always: ['Rope Trick'] },
                            9: { always: ['Fear'] },
                            13: { always: ['Greater Invisibility'] },
                            17: { always: ['Seeming'] }
                        },
                        features: {
                            3: [
                                { name: 'Dread Ambusher', desc: '+WIS to initiative, extra attack and 1d8 damage on first turn' },
                                { name: 'Umbral Sight', desc: 'Darkvision 60 ft (or +30 ft), invisible to darkvision while in darkness' }
                            ],
                            7: [{ name: 'Iron Mind', desc: 'Proficiency in WIS saves (or INT or CHA if already proficient)' }],
                            11: [{ name: 'Stalker\'s Flurry', desc: 'Once per turn, reroll a missed weapon attack' }],
                            15: [{ name: 'Shadowy Dodge', desc: 'Impose disadvantage on attack as reaction when attacked without advantage' }]
                        }
                    },
                    swarmkeeper: {
                        name: 'Swarmkeeper',
                        desc: 'Command a swarm of nature spirits',
                        grantedSpells: {
                            3: { always: ['Faerie Fire'], cantrips: ['Mage Hand'] },
                            5: { always: ['Web'] },
                            9: { always: ['Gaseous Form'] },
                            13: { always: ['Arcane Eye'] },
                            17: { always: ['Insect Plague'] }
                        },
                        features: {
                            3: [
                                { name: 'Gathered Swarm', desc: 'Once per turn, swarm deals 1d6 piercing, moves target 15 ft, or moves you 5 ft' },
                                { name: 'Swarm', desc: 'Fey spirits form a swarm in your space' }
                            ],
                            7: [{ name: 'Writhing Tide', desc: 'Swarm lifts you, giving 10 ft hover speed as bonus action' }],
                            11: [{ name: 'Mighty Swarm', desc: 'Swarm damage increases to 1d8, can knock prone, or gives half cover' }],
                            15: [{ name: 'Swarming Dispersal', desc: 'When hit, disperse into swarm, resist attack, teleport 30 ft' }]
                        }
                    },
                    horizonwalker: {
                        name: 'Horizon Walker',
                        desc: 'Planar warrior, teleport between attacks, portal detection',
                        grantedSpells: {
                            3: { always: ['Protection from Evil and Good'] },
                            5: { always: ['Misty Step'] },
                            9: { always: ['Haste'] },
                            13: { always: ['Banishment'] },
                            17: { always: ['Teleportation Circle'] }
                        },
                        features: {
                            3: [
                                { name: 'Detect Portal', desc: 'Sense planar portals within 1 mile' },
                                { name: 'Planar Warrior', desc: 'Bonus action to deal extra 1d8 force damage (2d8 at 11th)' }
                            ],
                            7: [{ name: 'Ethereal Step', desc: 'Cast Etherealness as bonus action, lasts until end of turn' }],
                            11: [{ name: 'Distant Strike', desc: 'Teleport 10 ft before each attack, third attack if attacking two different creatures' }],
                            15: [{ name: 'Spectral Defense', desc: 'Resistance to attack damage as reaction' }]
                        }
                    },
                    monsterslayer: {
                        name: 'Monster Slayer',
                        desc: "Slayer's Prey bonus damage, counter spells and teleports",
                        grantedSpells: {
                            3: { always: ['Protection from Evil and Good'] },
                            5: { always: ['Zone of Truth'] },
                            9: { always: ['Magic Circle'] },
                            13: { always: ['Banishment'] },
                            17: { always: ['Hold Monster'] }
                        },
                        features: {
                            3: [
                                { name: 'Hunter\'s Sense', desc: 'Learn immunities, resistances, and vulnerabilities of a creature' },
                                { name: 'Slayer\'s Prey', desc: 'Deal extra 1d6 damage to designated target once per turn' }
                            ],
                            7: [{ name: 'Supernatural Defense', desc: 'Add 1d6 to saves and grapple escapes vs Slayer\'s Prey' }],
                            11: [{ name: 'Magic-User\'s Nemesis', desc: 'Reaction to force concentration or teleportation save at disadvantage' }],
                            15: [{ name: 'Slayer\'s Counter', desc: 'Attack as reaction when Slayer\'s Prey forces a save' }]
                        }
                    },
                    feywanderer: {
                        name: 'Fey Wanderer',
                        desc: 'Fey powers, add WIS to CHA checks, psychic damage',
                        grantedSpells: {
                            3: { always: ['Charm Person'] },
                            5: { always: ['Misty Step'] },
                            9: { always: ['Dispel Magic'] },
                            13: { always: ['Dimension Door'] },
                            17: { always: ['Mislead'] }
                        },
                        features: {
                            3: [
                                { name: 'Dreadful Strikes', desc: 'Deal extra 1d4 psychic damage once per turn per creature' },
                                { name: 'Otherworldly Glamour', desc: 'Add WIS to CHA checks, proficiency in one CHA skill' },
                                { name: 'Fey Wanderer Magic', desc: 'Learn additional spells at certain levels' }
                            ],
                            7: [{ name: 'Beguiling Twist', desc: 'When creature saves vs charm/frighten, redirect to another creature' }],
                            11: [{ name: 'Fey Reinforcements', desc: 'Cast Summon Fey without concentration once per long rest' }],
                            15: [{ name: 'Misty Wanderer', desc: 'Cast Misty Step with another willing creature, free casting prof bonus times' }]
                        }
                    },
                    drakewarden: {
                        name: 'Drakewarden',
                        desc: 'Drake companion that grows into a mount',
                        grantedSpells: {
                            3: { always: ['Thaumaturgy'] },
                            15: { always: [] }
                        },
                        features: {
                            3: [
                                { name: 'Draconic Gift', desc: 'Learn Draconic and Thaumaturgy cantrip' },
                                { name: 'Drake Companion', desc: 'Summon a Small drake with elemental breath and Infused Strikes' }
                            ],
                            7: [{ name: 'Bond of Fang and Scale', desc: 'Drake becomes Medium, can ride it, grants resistance, swim/fly speed' }],
                            11: [{ name: 'Drake\'s Breath', desc: 'Drake gains 30 ft cone breath weapon, 8d6 damage' }],
                            15: [{ name: 'Perfected Bond', desc: 'Drake becomes Large, breath becomes 10d6, gain blindsight while drake is within 30 ft' }]
                        }
                    }
                },
                subclassLevel: 3
            },
            rogue: {
                name: 'Rogue',
                icon: 'ðŸ—¡ï¸',
                hitDie: 'd8',
                primaryAbility: 'DEX',
                saves: ['DEX', 'INT'],
                armor: 'Light',
                weapons: 'Simple, Hand Crossbows, Longswords, Rapiers, Shortswords',
                skills: 4,
                skillChoices: ['Acrobatics', 'Athletics', 'Deception', 'Insight', 'Intimidation', 'Investigation', 'Perception', 'Performance', 'Persuasion', 'Sleight of Hand', 'Stealth'],
                features: [
                    { name: 'Expertise', desc: 'Double proficiency bonus for two skills', level: 1 },
                    { name: 'Sneak Attack', desc: 'Extra damage when you have advantage or an ally nearby (1d6, +1d6 per 2 levels)', level: 1 },
                    { name: "Thieves' Cant", desc: 'Secret language of rogues', level: 1 },
                    { name: 'Cunning Action', desc: 'Dash, Disengage, or Hide as bonus action', level: 2 },
                    { name: 'Uncanny Dodge', desc: 'Halve damage from an attack you can see as reaction', level: 5 },
                    { name: 'Evasion', desc: 'Take no damage on successful DEX save, half on fail', level: 7 },
                    { name: 'Reliable Talent', desc: 'Treat any d20 roll of 9 or lower as 10 for proficient skills', level: 11 },
                    { name: 'Blindsense', desc: 'Sense invisible or hidden creatures within 10 ft', level: 14 },
                    { name: 'Slippery Mind', desc: 'Proficiency in Wisdom saving throws', level: 15 },
                    { name: 'Elusive', desc: 'No attack roll has advantage against you unless incapacitated', level: 18 },
                    { name: 'Stroke of Luck', desc: 'Turn a miss into a hit, or treat ability check as 20', level: 20 }
                ],
                subclasses: {
                    thief: {
                        name: 'Thief',
                        desc: 'Master burglar, use items as bonus action',
                        features: {
                            3: [
                                { name: 'Fast Hands', desc: 'Use Sleight of Hand, use thieves\' tools, or Use an Object as bonus action' },
                                { name: 'Second-Story Work', desc: 'Climb at full speed, running jump distance increases by DEX mod feet' }
                            ],
                            9: [{ name: 'Supreme Sneak', desc: 'Advantage on Stealth checks if you move no more than half speed' }],
                            13: [{ name: 'Use Magic Device', desc: 'Ignore class, race, and level requirements on magic items' }],
                            17: [{ name: 'Thief\'s Reflexes', desc: 'Take two turns during first round of combat' }]
                        }
                    },
                    assassin: {
                        name: 'Assassin',
                        desc: 'Deadly first strikes, infiltration expert',
                        features: {
                            3: [
                                { name: 'Assassinate', desc: 'Advantage vs creatures that haven\'t acted; hit is auto-crit if target is surprised' },
                                { name: 'Bonus Proficiencies', desc: 'Proficiency with disguise kit and poisoner\'s kit' }
                            ],
                            9: [{ name: 'Infiltration Expertise', desc: 'Create false identity over 7 days with perfect documentation' }],
                            13: [{ name: 'Impostor', desc: 'Unerringly mimic another person\'s speech, writing, and behavior' }],
                            17: [{ name: 'Death Strike', desc: 'When hitting surprised creature, double damage on failed CON save' }]
                        }
                    },
                    arcanetrickster: {
                        name: 'Arcane Trickster',
                        desc: 'Combine stealth with illusion/enchantment magic',
                        grantedSpells: {
                            3: { cantrips: ['Mage Hand'] }
                        },
                        features: {
                            3: [
                                { name: 'Spellcasting', desc: 'Learn wizard spells, focusing on enchantment and illusion' },
                                { name: 'Mage Hand Legerdemain', desc: 'Invisible Mage Hand can stow/retrieve objects, pick locks, disarm traps' }
                            ],
                            9: [{ name: 'Magical Ambush', desc: 'Targets have disadvantage on saves vs your spells if you\'re hidden' }],
                            13: [{ name: 'Versatile Trickster', desc: 'Use Mage Hand to gain advantage on attack rolls vs adjacent creature' }],
                            17: [{ name: 'Spell Thief', desc: 'Steal spell knowledge when target fails save; they can\'t cast it, you can' }]
                        }
                    },
                    swashbuckler: {
                        name: 'Swashbuckler',
                        desc: 'Dashing duelist, easy Sneak Attack in melee',
                        features: {
                            3: [
                                { name: 'Fancy Footwork', desc: 'No opportunity attacks from creatures you attacked this turn' },
                                { name: 'Rakish Audacity', desc: 'Add CHA to initiative; Sneak Attack without advantage if alone with target' }
                            ],
                            9: [{ name: 'Panache', desc: 'Charm or goad creature with Persuasion check' }],
                            13: [{ name: 'Elegant Maneuver', desc: 'Use bonus action to gain advantage on next Acrobatics or Athletics check' }],
                            17: [{ name: 'Master Duelist', desc: 'Reroll missed attack with advantage once per short rest' }]
                        }
                    },
                    mastermind: {
                        name: 'Mastermind',
                        desc: 'Master of tactics, Help as bonus action at range',
                        features: {
                            3: [
                                { name: 'Master of Intrigue', desc: 'Two languages, disguise kit, forgery kit, one gaming set; mimic accents' },
                                { name: 'Master of Tactics', desc: 'Help as bonus action, 30 ft range instead of 5 ft' }
                            ],
                            9: [{ name: 'Insightful Manipulator', desc: 'Learn creature\'s capabilities relative to yours after 1 minute of study' }],
                            13: [{ name: 'Misdirection', desc: 'Redirect attacks against you to creature providing cover' }],
                            17: [{ name: 'Soul of Deceit', desc: 'Immune to charm, undetectable thoughts, can present false thoughts' }]
                        }
                    },
                    inquisitive: {
                        name: 'Inquisitive',
                        desc: 'Keen eye for detail, Insightful Fighting for Sneak Attack',
                        features: {
                            3: [
                                { name: 'Ear for Deceit', desc: 'Minimum 8 on Insight checks to determine if lying' },
                                { name: 'Eye for Detail', desc: 'Perception to spot hidden creature or Investigation to find clues as bonus action' },
                                { name: 'Insightful Fighting', desc: 'Insight vs Deception to use Sneak Attack without advantage for 1 minute' }
                            ],
                            9: [{ name: 'Steady Eye', desc: 'Advantage on Perception and Investigation if moved half speed or less' }],
                            13: [{ name: 'Unerring Eye', desc: 'Sense illusions, shapechangers, and other deceptions within 30 ft' }],
                            17: [{ name: 'Eye for Weakness', desc: 'Extra 3d6 Sneak Attack damage vs Insightful Fighting target' }]
                        }
                    },
                    scout: {
                        name: 'Scout',
                        desc: 'Wilderness expert, move after enemy ends turn near you',
                        features: {
                            3: [
                                { name: 'Skirmisher', desc: 'Move half speed as reaction when enemy ends turn within 5 ft; no opportunity attacks' },
                                { name: 'Survivalist', desc: 'Proficiency and expertise in Nature and Survival' }
                            ],
                            9: [{ name: 'Superior Mobility', desc: '+10 ft walking speed; applies to climb/swim if you have those speeds' }],
                            13: [{ name: 'Ambush Master', desc: 'Advantage on initiative; first creature you hit grants advantage to allies\' attacks' }],
                            17: [{ name: 'Sudden Strike', desc: 'Two Sneak Attacks per turn if attacking different targets' }]
                        }
                    },
                    phantom: {
                        name: 'Phantom',
                        desc: 'Soul trinkets, Wails from the Grave damage, ghost walk',
                        features: {
                            3: [
                                { name: 'Whispers of the Dead', desc: 'Gain a skill or tool proficiency after each rest from ghostly knowledge' },
                                { name: 'Wails from the Grave', desc: 'Deal half Sneak Attack damage to second creature within 30 ft' }
                            ],
                            9: [{ name: 'Tokens of the Departed', desc: 'Create soul trinkets from dying creatures; use for advantage or ask questions' }],
                            13: [{ name: 'Ghost Walk', desc: 'Become spectral: fly 10 ft, move through creatures/objects' }],
                            17: [{ name: 'Death\'s Friend', desc: 'Wails from the Grave doesn\'t cost Sneak Attack die; create trinket without reaction' }]
                        }
                    },
                    soulknife: {
                        name: 'Soulknife',
                        desc: 'Psychic blades, telepathy, psionic enhanced abilities',
                        features: {
                            3: [
                                { name: 'Psionic Power', desc: 'Pool of Psionic Energy dice (d6) for abilities; regain one as bonus action' },
                                { name: 'Psychic Blades', desc: 'Summon 1d6 psychic blade (1d4 offhand), disappears after attack' }
                            ],
                            9: [{ name: 'Soul Blades', desc: 'Homing Strikes (reroll miss), Psychic Teleportation (throw blade and teleport)' }],
                            13: [{ name: 'Psychic Veil', desc: 'Become invisible for 1 hour or until you attack/force a save' }],
                            17: [{ name: 'Rend Mind', desc: 'After Sneak Attack, force stunned for 1 minute on failed WIS save' }]
                        }
                    }
                },
                subclassLevel: 3
            },
            sorcerer: {
                name: 'Sorcerer',
                icon: 'âœ¨',
                hitDie: 'd6',
                primaryAbility: 'CHA',
                saves: ['CON', 'CHA'],
                armor: 'None',
                weapons: 'Daggers, Darts, Slings, Quarterstaffs, Light Crossbows',
                skills: 2,
                skillChoices: ['Arcana', 'Deception', 'Insight', 'Intimidation', 'Persuasion', 'Religion'],
                spellcasting: true,
                features: [
                    { name: 'Spellcasting', desc: 'Innate magic using Charisma', level: 1 },
                    { name: 'Sorcerous Origin', desc: 'Source of your magical power grants special abilities', level: 1 },
                    { name: 'Font of Magic', desc: 'Sorcery points pool for Flexible Casting and Metamagic', level: 2 },
                    { name: 'Flexible Casting', desc: 'Convert sorcery points to spell slots and vice versa', level: 2 },
                    { name: 'Metamagic', desc: 'Modify spells with special options (2 choices, more at higher levels)', level: 3 },
                    { name: 'Sorcerous Restoration', desc: 'Regain 4 sorcery points on short rest', level: 20 }
                ],
                subclasses: {
                    draconic: {
                        name: 'Draconic Bloodline',
                        desc: 'Dragon ancestor grants AC, damage, and resistances',
                        features: {
                            1: [
                                { name: 'Dragon Ancestor', desc: 'Choose a dragon type; learn Draconic, double proficiency on CHA checks with dragons' },
                                { name: 'Draconic Resilience', desc: 'HP increases by 1 per level, unarmored AC = 13 + DEX' }
                            ],
                            6: [{ name: 'Elemental Affinity', desc: 'Add CHA to damage of your dragon\'s type, spend 1 SP for resistance to that type' }],
                            14: [{ name: 'Dragon Wings', desc: 'Sprout wings as bonus action, fly speed equal to walking speed' }],
                            18: [{ name: 'Draconic Presence', desc: 'Spend 5 SP to create 60 ft aura of awe or fear' }]
                        }
                    },
                    wildmagic: {
                        name: 'Wild Magic',
                        desc: 'Unpredictable surges of chaotic magic',
                        features: {
                            1: [
                                { name: 'Wild Magic Surge', desc: 'Roll d20 after casting spell; on 1, roll on Wild Magic Surge table' },
                                { name: 'Tides of Chaos', desc: 'Gain advantage on one roll; DM can trigger surge to regain use' }
                            ],
                            6: [{ name: 'Bend Luck', desc: 'Spend 2 SP to add or subtract 1d4 from creature\'s roll' }],
                            14: [{ name: 'Controlled Chaos', desc: 'Roll twice on surge table, choose either result' }],
                            18: [{ name: 'Spell Bombardment', desc: 'When rolling max damage die, reroll and add to total' }]
                        }
                    },
                    divine: {
                        name: 'Divine Soul',
                        desc: 'Access to cleric spells, celestial guidance',
                        grantedSpells: {
                            1: { always: [] }
                        },
                        features: {
                            1: [
                                { name: 'Divine Magic', desc: 'Learn spells from cleric spell list in addition to sorcerer' },
                                { name: 'Favored by the Gods', desc: 'Add 2d4 to failed saving throw or missed attack roll' }
                            ],
                            6: [{ name: 'Empowered Healing', desc: 'Spend 1 SP to reroll healing dice once' }],
                            14: [{ name: 'Otherworldly Wings', desc: 'Manifest spectral wings as bonus action, 30 ft fly speed' }],
                            18: [{ name: 'Unearthly Recovery', desc: 'When below half HP, bonus action to regain half your HP once per long rest' }]
                        }
                    },
                    shadow: {
                        name: 'Shadow Magic',
                        desc: 'Darkness powers, summon shadow hound',
                        grantedSpells: {
                            1: { always: ['Darkness'] }
                        },
                        features: {
                            1: [
                                { name: 'Eyes of the Dark', desc: 'Darkvision 120 ft, can see through your own Darkness spell' },
                                { name: 'Strength of the Grave', desc: 'When reduced to 0 HP, make CHA save to drop to 1 HP instead' }
                            ],
                            6: [{ name: 'Hound of Ill Omen', desc: 'Spend 3 SP to summon dire wolf that targets one creature, gives disadvantage on saves' }],
                            14: [{ name: 'Shadow Walk', desc: 'In dim light/darkness, teleport 120 ft as bonus action' }],
                            18: [{ name: 'Umbral Form', desc: 'Spend 6 SP to become shadow: only force damage, move through creatures/objects' }]
                        }
                    },
                    storm: {
                        name: 'Storm Sorcery',
                        desc: 'Tempestuous Magic flight, control wind and lightning',
                        features: {
                            1: [
                                { name: 'Wind Speaker', desc: 'Speak, read, and write Primordial and its dialects' },
                                { name: 'Tempestuous Magic', desc: 'After casting 1st level+ spell, fly 10 ft as bonus action without provoking' }
                            ],
                            6: [
                                { name: 'Heart of the Storm', desc: 'Resistance to lightning and thunder; deal lightning/thunder damage to nearby creatures when casting' },
                                { name: 'Storm Guide', desc: 'Stop rain within 20 ft, direct wind within 100 ft' }
                            ],
                            14: [{ name: 'Storm\'s Fury', desc: 'When hit, deal lightning damage and push attacker 20 ft as reaction' }],
                            18: [{ name: 'Wind Soul', desc: 'Immunity to lightning/thunder, 60 ft fly speed, grant flight to others' }]
                        }
                    },
                    aberrant: {
                        name: 'Aberrant Mind',
                        desc: 'Psionic spells, telepathy, warp reality',
                        grantedSpells: {
                            1: { always: ['Arms of Hadar', 'Dissonant Whispers', 'Mind Sliver'] },
                            3: { always: ['Calm Emotions', 'Detect Thoughts'] },
                            5: { always: ['Hunger of Hadar', 'Sending'] },
                            7: { always: ['Evard\'s Black Tentacles', 'Summon Aberration'] },
                            9: { always: ['Rary\'s Telepathic Bond', 'Telekinesis'] }
                        },
                        features: {
                            1: [
                                { name: 'Psionic Spells', desc: 'Learn additional psionic spells at certain levels' },
                                { name: 'Telepathic Speech', desc: 'Telepathic communication with creature within 30 ft for sorcerer level minutes' }
                            ],
                            6: [{ name: 'Psionic Sorcery', desc: 'Cast psionic spells with SP instead of slots (no verbal/somatic components)' }],
                            14: [{ name: 'Revelation in Flesh', desc: 'Spend SP to see invisible, fly/swim, squeeze through 1 inch, or become slimy' }],
                            18: [{ name: 'Warping Implosion', desc: 'Teleport 120 ft, creatures near origin take force damage and are pulled' }]
                        }
                    },
                    clockwork: {
                        name: 'Clockwork Soul',
                        desc: 'Restore Balance, armor of order, Mechanus powers',
                        grantedSpells: {
                            1: { always: ['Alarm', 'Protection from Evil and Good'] },
                            3: { always: ['Aid', 'Lesser Restoration'] },
                            5: { always: ['Dispel Magic', 'Protection from Energy'] },
                            7: { always: ['Freedom of Movement', 'Summon Construct'] },
                            9: { always: ['Greater Restoration', 'Wall of Force'] }
                        },
                        features: {
                            1: [
                                { name: 'Clockwork Magic', desc: 'Learn additional order-themed spells at certain levels' },
                                { name: 'Restore Balance', desc: 'Cancel advantage or disadvantage on nearby roll, prof bonus times per long rest' }
                            ],
                            6: [{ name: 'Bastion of Law', desc: 'Spend up to 5 SP to create d8 ward that reduces damage' }],
                            14: [{ name: 'Trance of Order', desc: 'Enter state where you treat d20 rolls of 9 or lower as 10' }],
                            18: [{ name: 'Clockwork Cavalcade', desc: 'Summon spirits that restore HP, repair objects, and dispel spells' }]
                        }
                    }
                },
                subclassLevel: 1
            },
            warlock: {
                name: 'Warlock',
                icon: 'ðŸ‘ï¸',
                hitDie: 'd8',
                primaryAbility: 'CHA',
                saves: ['WIS', 'CHA'],
                armor: 'Light',
                weapons: 'Simple',
                skills: 2,
                skillChoices: ['Arcana', 'Deception', 'History', 'Intimidation', 'Investigation', 'Nature', 'Religion'],
                spellcasting: true,
                features: [
                    { name: 'Otherworldly Patron', desc: 'Pact with a powerful being grants magic', level: 1 },
                    { name: 'Pact Magic', desc: 'Few spell slots that recharge on short rest', level: 1 },
                    { name: 'Eldritch Invocations', desc: 'Fragments of forbidden knowledge grant special abilities (2 choices, more at higher levels)', level: 2 },
                    { name: 'Pact Boon', desc: 'Choose Pact of the Chain (familiar), Blade (weapon), or Tome (cantrips)', level: 3 },
                    { name: 'Mystic Arcanum (6th)', desc: 'Cast one 6th-level spell once per long rest', level: 11 },
                    { name: 'Mystic Arcanum (7th)', desc: 'Cast one 7th-level spell once per long rest', level: 13 },
                    { name: 'Mystic Arcanum (8th)', desc: 'Cast one 8th-level spell once per long rest', level: 15 },
                    { name: 'Mystic Arcanum (9th)', desc: 'Cast one 9th-level spell once per long rest', level: 17 },
                    { name: 'Eldritch Master', desc: 'Spend 1 minute to regain all Pact Magic slots', level: 20 }
                ],
                subclasses: {
                    fiend: {
                        name: 'The Fiend',
                        desc: 'Pact with demon/devil, temp HP on kills, fire magic',
                        grantedSpells: {
                            1: { always: ['Burning Hands', 'Command'] },
                            3: { always: ['Blindness/Deafness', 'Scorching Ray'] },
                            5: { always: ['Fireball', 'Stinking Cloud'] },
                            7: { always: ['Fire Shield', 'Wall of Fire'] },
                            9: { always: ['Flame Strike', 'Hallow'] }
                        },
                        features: {
                            1: [{ name: 'Dark One\'s Blessing', desc: 'Gain temp HP equal to CHA + warlock level when you reduce hostile creature to 0 HP' }],
                            6: [{ name: 'Dark One\'s Own Luck', desc: 'Add d10 to ability check or saving throw once per short rest' }],
                            10: [{ name: 'Fiendish Resilience', desc: 'Choose a damage type; gain resistance to it until your next short/long rest' }],
                            14: [{ name: 'Hurl Through Hell', desc: 'When you hit a creature, banish it to lower planes, dealing 10d10 psychic damage' }]
                        }
                    },
                    archfey: {
                        name: 'The Archfey',
                        desc: 'Pact with fey lord, charm and illusion powers',
                        grantedSpells: {
                            1: { always: ['Faerie Fire', 'Sleep'] },
                            3: { always: ['Calm Emotions', 'Phantasmal Force'] },
                            5: { always: ['Blink', 'Plant Growth'] },
                            7: { always: ['Dominate Beast', 'Greater Invisibility'] },
                            9: { always: ['Dominate Person', 'Seeming'] }
                        },
                        features: {
                            1: [{ name: 'Fey Presence', desc: 'Charm or frighten creatures within 10 ft cube as an action' }],
                            6: [{ name: 'Misty Escape', desc: 'When you take damage, turn invisible and teleport 60 ft as a reaction' }],
                            10: [{ name: 'Beguiling Defenses', desc: 'Immune to charm; when charmed, reflect it back on the attacker' }],
                            14: [{ name: 'Dark Delirium', desc: 'Charm or frighten a creature for 1 minute, creating illusory dreamworld' }]
                        }
                    },
                    greatold: {
                        name: 'The Great Old One',
                        desc: 'Pact with eldritch being, telepathy, mind powers',
                        grantedSpells: {
                            1: { always: ['Dissonant Whispers', 'Tasha\'s Hideous Laughter'] },
                            3: { always: ['Detect Thoughts', 'Phantasmal Force'] },
                            5: { always: ['Clairvoyance', 'Sending'] },
                            7: { always: ['Dominate Beast', 'Evard\'s Black Tentacles'] },
                            9: { always: ['Dominate Person', 'Telekinesis'] }
                        },
                        features: {
                            1: [{ name: 'Awakened Mind', desc: 'Telepathically communicate with any creature within 30 ft' }],
                            6: [{ name: 'Entropic Ward', desc: 'Impose disadvantage on attack against you; on miss, gain advantage on next attack vs them' }],
                            10: [{ name: 'Thought Shield', desc: 'Resistance to psychic damage, your thoughts can\'t be read unless willing' }],
                            14: [{ name: 'Create Thrall', desc: 'Charm an incapacitated humanoid permanently, communicate telepathically at any distance' }]
                        }
                    },
                    hexblade: {
                        name: 'The Hexblade',
                        desc: 'Pact with sentient weapon, medium armor, melee combat',
                        grantedSpells: {
                            1: { always: ['Shield', 'Wrathful Smite'] },
                            3: { always: ['Blur', 'Branding Smite'] },
                            5: { always: ['Blink', 'Elemental Weapon'] },
                            7: { always: ['Phantasmal Killer', 'Staggering Smite'] },
                            9: { always: ['Banishing Smite', 'Cone of Cold'] }
                        },
                        features: {
                            1: [
                                { name: 'Hexblade\'s Curse', desc: 'Curse a creature to take bonus damage, crit on 19-20, heal when it dies' },
                                { name: 'Hex Warrior', desc: 'Medium armor, shields, use CHA for weapon attacks with one weapon' }
                            ],
                            6: [{ name: 'Accursed Specter', desc: 'Raise slain humanoid as specter that obeys your commands' }],
                            10: [{ name: 'Armor of Hexes', desc: 'Roll d6 when cursed target hits you; on 4+, the attack misses' }],
                            14: [{ name: 'Master of Hexes', desc: 'When cursed creature dies, move curse to another creature without expending use' }]
                        }
                    },
                    celestial: {
                        name: 'The Celestial',
                        desc: 'Pact with celestial, healing magic, radiant damage',
                        grantedSpells: {
                            1: { always: ['Cure Wounds', 'Guiding Bolt'], cantrips: ['Light', 'Sacred Flame'] },
                            3: { always: ['Flaming Sphere', 'Lesser Restoration'] },
                            5: { always: ['Daylight', 'Revivify'] },
                            7: { always: ['Guardian of Faith', 'Wall of Fire'] },
                            9: { always: ['Flame Strike', 'Greater Restoration'] }
                        },
                        features: {
                            1: [
                                { name: 'Healing Light', desc: 'Pool of d6s (1 + warlock level) to heal creatures as bonus action' },
                                { name: 'Bonus Cantrips', desc: 'Learn Light and Sacred Flame cantrips' }
                            ],
                            6: [{ name: 'Radiant Soul', desc: 'Add CHA to fire/radiant damage, resistance to radiant damage' }],
                            10: [{ name: 'Celestial Resilience', desc: 'Gain temp HP (warlock level + CHA) when finishing short/long rest, share with allies' }],
                            14: [{ name: 'Searing Vengeance', desc: 'When making death saves, spring up with half HP, deal radiant damage, blind enemies' }]
                        }
                    },
                    undying: {
                        name: 'The Undying',
                        desc: 'Pact with immortal being, resist death, spare the dying',
                        grantedSpells: {
                            1: { always: ['False Life', 'Ray of Sickness'], cantrips: ['Spare the Dying'] },
                            3: { always: ['Blindness/Deafness', 'Silence'] },
                            5: { always: ['Feign Death', 'Speak with Dead'] },
                            7: { always: ['Aura of Life', 'Death Ward'] },
                            9: { always: ['Contagion', 'Legend Lore'] }
                        },
                        features: {
                            1: [
                                { name: 'Among the Dead', desc: 'Learn Spare the Dying, advantage on saves vs disease, undead must save to attack you' },
                                { name: 'Spare the Dying', desc: 'Bonus cantrip: Spare the Dying (can cast as bonus action)' }
                            ],
                            6: [{ name: 'Defy Death', desc: 'Regain HP equal to 1d8 + CON when succeeding on death save or using Spare the Dying' }],
                            10: [{ name: 'Undying Nature', desc: 'Don\'t need to breathe, eat, drink, or sleep; age at 1/10 rate' }],
                            14: [{ name: 'Indestructible Life', desc: 'Regain 1d8 + warlock level HP as bonus action when below half HP' }]
                        }
                    },
                    fathomless: {
                        name: 'The Fathomless',
                        desc: 'Pact with ocean entity, tentacles, water breathing',
                        grantedSpells: {
                            1: { always: ['Create or Destroy Water', 'Thunderwave'] },
                            3: { always: ['Gust of Wind', 'Silence'] },
                            5: { always: ['Lightning Bolt', 'Sleet Storm'] },
                            7: { always: ['Control Water', 'Summon Elemental'] },
                            9: { always: ['Bigby\'s Hand', 'Cone of Cold'] }
                        },
                        features: {
                            1: [
                                { name: 'Tentacle of the Deeps', desc: 'Summon 10 ft spectral tentacle that deals cold damage and reduces speed' },
                                { name: 'Gift of the Sea', desc: 'Swim speed 40 ft, water breathing' }
                            ],
                            6: [{ name: 'Oceanic Soul', desc: 'Resistance to cold damage, breathe underwater, communicate with sea creatures' }],
                            10: [{ name: 'Guardian Coil', desc: 'Tentacle reduces damage to you or ally within 10 ft of it' }],
                            14: [{ name: 'Grasping Tentacles', desc: 'Cast Evard\'s Black Tentacles without slot once per long rest, you\'re immune to its effects' }]
                        }
                    },
                    genie: {
                        name: 'The Genie',
                        desc: 'Pact with genie, vessel sanctuary, elemental gift',
                        grantedSpells: {
                            1: { always: ['Detect Evil and Good', 'Thunderwave'] },
                            3: { always: ['Phantasmal Force', 'Gust of Wind'] },
                            5: { always: ['Create Food and Water', 'Fireball'] },
                            7: { always: ['Phantasmal Killer', 'Greater Invisibility'] },
                            9: { always: ['Creation', 'Wish'] }
                        },
                        features: {
                            1: [
                                { name: 'Genie\'s Vessel', desc: 'Tether to object as sanctuary; enter for prof bonus hours, short rest in 10 min' },
                                { name: 'Genie\'s Wrath', desc: 'Deal extra damage once per turn (type based on genie patron)' }
                            ],
                            6: [{ name: 'Elemental Gift', desc: 'Resistance to a damage type, 30 ft fly speed for 10 minutes' }],
                            10: [{ name: 'Sanctuary Vessel', desc: 'Take up to 5 creatures into vessel, short rest heals extra HP' }],
                            14: [{ name: 'Limited Wish', desc: 'Request spell of 6th level or lower from any spell list once per 1d4 long rests' }]
                        }
                    },
                    undead: {
                        name: 'The Undead',
                        desc: 'Pact with undead power, Form of Dread, necrotic damage',
                        grantedSpells: {
                            1: { always: ['Bane', 'False Life'] },
                            3: { always: ['Blindness/Deafness', 'Phantasmal Force'] },
                            5: { always: ['Phantom Steed', 'Speak with Dead'] },
                            7: { always: ['Death Ward', 'Greater Invisibility'] },
                            9: { always: ['Antilife Shell', 'Cloudkill'] }
                        },
                        features: {
                            1: [{ name: 'Form of Dread', desc: 'Transform as bonus action: gain temp HP, immune to frightened, frighten on hit' }],
                            6: [{ name: 'Grave Touched', desc: 'In Form of Dread, attacks deal necrotic instead, extra die once per turn' }],
                            10: [{ name: 'Necrotic Husk', desc: 'Resistance to necrotic, immune to frightened; when reduced to 0 HP, explode and return with 1 HP' }],
                            14: [{ name: 'Spirit Projection', desc: 'Project your spirit; fly, immunity, heal when dealing necrotic damage' }]
                        }
                    }
                },
                subclassLevel: 1
            },
            wizard: {
                name: 'Wizard',
                icon: 'ðŸ§™',
                hitDie: 'd6',
                primaryAbility: 'INT',
                saves: ['INT', 'WIS'],
                armor: 'None',
                weapons: 'Daggers, Darts, Slings, Quarterstaffs, Light Crossbows',
                skills: 2,
                skillChoices: ['Arcana', 'History', 'Insight', 'Investigation', 'Medicine', 'Religion'],
                spellcasting: true,
                features: [
                    { name: 'Spellcasting', desc: 'Learn and cast wizard spells using Intelligence', level: 1 },
                    { name: 'Arcane Recovery', desc: 'Recover spell slots during short rest (up to half wizard level)', level: 1 },
                    { name: 'Spellbook', desc: 'Record spells in your book, can copy new spells', level: 1 },
                    { name: 'Arcane Tradition', desc: 'Choose a school of magic that grants special abilities', level: 2 },
                    { name: 'Spell Mastery', desc: 'Cast one 1st and one 2nd level spell at will', level: 18 },
                    { name: 'Signature Spells', desc: 'Two 3rd-level spells always prepared, cast once each without slot', level: 20 }
                ],
                subclasses: {
                    evocation: {
                        name: 'School of Evocation',
                        desc: 'Master of damage spells, protect allies from your magic',
                        features: {
                            2: [
                                { name: 'Evocation Savant', desc: 'Copy evocation spells in half time and gold' },
                                { name: 'Sculpt Spells', desc: 'Create pockets of safety in your evocation spells for allies' }
                            ],
                            6: [{ name: 'Potent Cantrip', desc: 'Cantrips deal half damage on successful save' }],
                            10: [{ name: 'Empowered Evocation', desc: 'Add INT modifier to damage of evocation spells' }],
                            14: [{ name: 'Overchannel', desc: 'Deal maximum damage with 5th level or lower spell' }]
                        }
                    },
                    abjuration: {
                        name: 'School of Abjuration',
                        desc: 'Protective magic, arcane ward absorbs damage',
                        features: {
                            2: [
                                { name: 'Abjuration Savant', desc: 'Copy abjuration spells in half time and gold' },
                                { name: 'Arcane Ward', desc: 'Create protective ward with HP equal to wizard level Ã— 2 + INT' }
                            ],
                            6: [{ name: 'Projected Ward', desc: 'Ward can absorb damage for allies within 30 ft' }],
                            10: [{ name: 'Improved Abjuration', desc: 'Add proficiency bonus to abjuration spell checks' }],
                            14: [{ name: 'Spell Resistance', desc: 'Advantage on saves vs spells, resistance to spell damage' }]
                        }
                    },
                    divination: {
                        name: 'School of Divination',
                        desc: 'See the future, replace dice rolls with portents',
                        features: {
                            2: [
                                { name: 'Divination Savant', desc: 'Copy divination spells in half time and gold' },
                                { name: 'Portent', desc: 'Roll 2d20 after long rest; replace any roll with these results' }
                            ],
                            6: [{ name: 'Expert Divination', desc: 'Regain spell slot (5th or lower) when casting divination spell' }],
                            10: [{ name: 'The Third Eye', desc: 'Gain darkvision, ethereal sight, see invisibility, or read any language' }],
                            14: [{ name: 'Greater Portent', desc: 'Roll 3d20 for Portent instead of 2d20' }]
                        }
                    },
                    necromancy: {
                        name: 'School of Necromancy',
                        desc: 'Command undead, drain life force',
                        features: {
                            2: [
                                { name: 'Necromancy Savant', desc: 'Copy necromancy spells in half time and gold' },
                                { name: 'Grim Harvest', desc: 'Regain HP when killing with spell (2Ã— spell level, or 3Ã— for necromancy)' }
                            ],
                            6: [{ name: 'Undead Thralls', desc: 'Animate Dead adds extra undead, with more HP and damage' }],
                            10: [{ name: 'Inured to Undeath', desc: 'Resistance to necrotic damage, HP max can\'t be reduced' }],
                            14: [{ name: 'Command Undead', desc: 'Take permanent control of an undead creature' }]
                        }
                    },
                    illusion: {
                        name: 'School of Illusion',
                        desc: 'Create convincing illusions that become real',
                        features: {
                            2: [
                                { name: 'Illusion Savant', desc: 'Copy illusion spells in half time and gold' },
                                { name: 'Improved Minor Illusion', desc: 'Create both sound and image with Minor Illusion' }
                            ],
                            6: [{ name: 'Malleable Illusions', desc: 'Change the nature of your illusion with an action' }],
                            10: [{ name: 'Illusory Self', desc: 'Create illusory duplicate to redirect attack that would hit you' }],
                            14: [{ name: 'Illusory Reality', desc: 'Make one object in your illusion become real for 1 minute' }]
                        }
                    },
                    conjuration: {
                        name: 'School of Conjuration',
                        desc: 'Summon creatures and objects, teleportation',
                        features: {
                            2: [
                                { name: 'Conjuration Savant', desc: 'Copy conjuration spells in half time and gold' },
                                { name: 'Minor Conjuration', desc: 'Create a nonmagical object up to 3 ft per side' }
                            ],
                            6: [{ name: 'Benign Transposition', desc: 'Teleport 30 ft or swap places with willing ally' }],
                            10: [{ name: 'Focused Conjuration', desc: 'Concentration can\'t be broken by damage' }],
                            14: [{ name: 'Durable Summons', desc: 'Summoned creatures have 30 temp HP' }]
                        }
                    },
                    transmutation: {
                        name: 'School of Transmutation',
                        desc: "Transform matter, create philosopher's stone",
                        features: {
                            2: [
                                { name: 'Transmutation Savant', desc: 'Copy transmutation spells in half time and gold' },
                                { name: 'Minor Alchemy', desc: 'Transform nonmagical objects between wood, stone, iron, copper, silver' }
                            ],
                            6: [{ name: 'Transmuter\'s Stone', desc: 'Create stone that grants darkvision, +10 speed, proficiency in CON saves, or resistance' }],
                            10: [{ name: 'Shapechanger', desc: 'Cast Polymorph without slot to become beast' }],
                            14: [{ name: 'Master Transmuter', desc: 'Destroy stone to transmute major effects: restore youth, raise dead, or more' }]
                        }
                    },
                    enchantment: {
                        name: 'School of Enchantment',
                        desc: 'Charm creatures, alter memories, Hypnotic Gaze',
                        features: {
                            2: [
                                { name: 'Enchantment Savant', desc: 'Copy enchantment spells in half time and gold' },
                                { name: 'Hypnotic Gaze', desc: 'Charm creature within 5 ft that can see you' }
                            ],
                            6: [{ name: 'Instinctive Charm', desc: 'Redirect attacker to another creature as reaction' }],
                            10: [{ name: 'Split Enchantment', desc: 'Single-target enchantment spells can target two creatures' }],
                            14: [{ name: 'Alter Memories', desc: 'Make charmed creature forget being charmed' }]
                        }
                    },
                    bladesinging: {
                        name: 'Bladesinging',
                        desc: 'Elven tradition combining sword and spell',
                        features: {
                            2: [
                                { name: 'Training in War and Song', desc: 'Proficiency with light armor and one melee weapon' },
                                { name: 'Bladesong', desc: 'Add INT to AC, concentration, Acrobatics, and speed; can\'t use two hands or heavy armor' }
                            ],
                            6: [{ name: 'Extra Attack', desc: 'Attack twice when taking Attack action; can replace one attack with cantrip' }],
                            10: [{ name: 'Song of Defense', desc: 'Expend spell slot to reduce damage by 5Ã— slot level' }],
                            14: [{ name: 'Song of Victory', desc: 'Add INT modifier to melee weapon damage while Bladesong is active' }]
                        }
                    },
                    warmagic: {
                        name: 'War Magic',
                        desc: 'Arcane Deflection, Power Surge, tactical casting',
                        features: {
                            2: [
                                { name: 'Arcane Deflection', desc: '+2 AC or +4 to save as reaction; can only cast cantrips next turn' },
                                { name: 'Tactical Wit', desc: 'Add INT modifier to initiative rolls' }
                            ],
                            6: [{ name: 'Power Surge', desc: 'Store power surges (max INT mod); spend to deal extra force damage' }],
                            10: [{ name: 'Durable Magic', desc: '+2 AC and saves while concentrating on a spell' }],
                            14: [{ name: 'Deflecting Shroud', desc: 'When using Arcane Deflection, deal force damage to nearby creatures' }]
                        }
                    },
                    scribes: {
                        name: 'Order of Scribes',
                        desc: 'Awakened Spellbook, manifest quill, change damage types',
                        features: {
                            2: [
                                { name: 'Wizardly Quill', desc: 'Create magic quill that writes quickly and erases marks' },
                                { name: 'Awakened Spellbook', desc: 'Spellbook becomes magical focus, can change damage types, cast rituals faster' }
                            ],
                            6: [{ name: 'Manifest Mind', desc: 'Create spectral mind from book that can cast spells from its position' }],
                            10: [{ name: 'Master Scrivener', desc: 'Create spell scroll of 1st or 2nd level with enhanced power' }],
                            14: [{ name: 'One with the Word', desc: 'Gain advantage on INT checks about lore; can sacrifice spells to avoid death' }]
                        }
                    },
                    chrono: {
                        name: 'Chronurgy Magic',
                        desc: 'Manipulate time, Chronal Shift rerolls, temporal stasis',
                        features: {
                            2: [
                                { name: 'Chronal Shift', desc: 'Force reroll of attack, ability check, or save within 30 ft twice per long rest' },
                                { name: 'Temporal Awareness', desc: 'Add INT modifier to initiative rolls' }
                            ],
                            6: [{ name: 'Momentary Stasis', desc: 'Force creature to make CON save or be incapacitated until end of your next turn' }],
                            10: [{ name: 'Arcane Abeyance', desc: 'Store spell of 4th level or lower in bead for later use' }],
                            14: [{ name: 'Convergent Future', desc: 'Decide if creature succeeds or fails attack, save, or check (exhaustion cost)' }]
                        }
                    },
                    gravit: {
                        name: 'Graviturgy Magic',
                        desc: 'Control gravity, adjust density, Event Horizon pull',
                        features: {
                            2: [
                                { name: 'Adjust Density', desc: 'Halve or double creature\'s weight, affecting speed and damage' },
                                { name: 'Temporal Awareness', desc: 'Add INT modifier to initiative rolls' }
                            ],
                            6: [{ name: 'Gravity Well', desc: 'Move creature 5 ft when you deal spell damage to it' }],
                            10: [{ name: 'Violent Attraction', desc: 'Increase falling or weapon damage by 1d10 as reaction' }],
                            14: [{ name: 'Event Horizon', desc: 'Create difficult terrain that deals force damage and restrains creatures' }]
                        }
                    }
                },
                subclassLevel: 2
            }
        };

        // ===== SKILLS DATA =====
        const SKILLS = {
            'Acrobatics': 'DEX', 'Animal Handling': 'WIS', 'Arcana': 'INT',
            'Athletics': 'STR', 'Deception': 'CHA', 'History': 'INT',
            'Insight': 'WIS', 'Intimidation': 'CHA', 'Investigation': 'INT',
            'Medicine': 'WIS', 'Nature': 'INT', 'Perception': 'WIS',
            'Performance': 'CHA', 'Persuasion': 'CHA', 'Religion': 'INT',
            'Sleight of Hand': 'DEX', 'Stealth': 'DEX', 'Survival': 'WIS'
        };

        // ===== SPELLS DATA =====
        const SPELLS = {
            // CANTRIPS
            cantrips: {
                // Bard Cantrips
                'Blade Ward': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Abjuration', desc: 'You have resistance against bludgeoning, piercing, and slashing damage from weapon attacks until the start of your next turn.' },
                'Dancing Lights': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'You create up to four torch-sized lights that hover in the air for 1 minute.' },
                'Friends': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'You have advantage on Charisma checks against one creature that isn\'t hostile.' },
                'Light': { classes: ['bard', 'cleric', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'You touch one object, causing it to shed bright light in a 20-foot radius.' },
                'Mage Hand': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Conjuration', desc: 'A spectral hand appears that can manipulate objects up to 30 feet away.' },
                'Mending': { classes: ['bard', 'cleric', 'druid', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Repair a single break or tear in an object you touch.' },
                'Message': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Whisper a message to a creature within 120 feet who can reply.' },
                'Minor Illusion': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Illusion', desc: 'Create a sound or image of an object within 30 feet.' },
                'Prestidigitation': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Transmutation', desc: 'Create minor magical effects like sparks, clean/soil objects, or warm/chill things.' },
                'True Strike': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Divination', desc: 'Gain advantage on your first attack roll against a target next turn.' },
                'Vicious Mockery': { classes: ['bard'], school: 'Enchantment', desc: 'Unleash a string of insults laced with enchantment, dealing 1d4 psychic damage.' },
                'Thunderclap': { classes: ['bard', 'druid', 'sorcerer', 'warlock', 'wizard'], school: 'Evocation', desc: 'Create a burst of thunderous sound audible 100 feet away, dealing 1d6 thunder damage.' },

                // Cleric Cantrips
                'Guidance': { classes: ['cleric', 'druid'], school: 'Divination', desc: 'Touch a willing creature to add 1d4 to one ability check.' },
                'Resistance': { classes: ['cleric', 'druid'], school: 'Abjuration', desc: 'Touch a willing creature to add 1d4 to one saving throw.' },
                'Sacred Flame': { classes: ['cleric'], school: 'Evocation', desc: 'Flame-like radiance descends on a creature, dealing 1d8 radiant damage on a failed Dex save.' },
                'Spare the Dying': { classes: ['cleric'], school: 'Necromancy', desc: 'Touch a living creature at 0 HP to stabilize it.' },
                'Thaumaturgy': { classes: ['cleric'], school: 'Transmutation', desc: 'Manifest a minor wonder: booming voice, flickering flames, tremors, etc.' },
                'Toll the Dead': { classes: ['cleric', 'warlock', 'wizard'], school: 'Necromancy', desc: 'Point at a creature, the sound of a dolorous bell deals 1d8 (or 1d12 if injured) necrotic.' },
                'Word of Radiance': { classes: ['cleric'], school: 'Evocation', desc: 'Burning radiance erupts, each creature within 5 feet takes 1d6 radiant on failed Con save.' },

                // Druid Cantrips
                'Druidcraft': { classes: ['druid'], school: 'Transmutation', desc: 'Create tiny nature effects: predict weather, bloom flower, sensory effect.' },
                'Poison Spray': { classes: ['druid', 'sorcerer', 'warlock', 'wizard'], school: 'Conjuration', desc: 'Project a puff of noxious gas dealing 1d12 poison damage on failed Con save.' },
                'Produce Flame': { classes: ['druid'], school: 'Conjuration', desc: 'A flickering flame appears in your hand, shedding light or thrown for 1d8 fire damage.' },
                'Shillelagh': { classes: ['druid'], school: 'Transmutation', desc: 'Imbue a club or quarterstaff with nature\'s power, use Wisdom for attacks, deals 1d8.' },
                'Thorn Whip': { classes: ['druid'], school: 'Transmutation', desc: 'A vine lash strikes a creature for 1d6 piercing and pulls it 10 feet closer.' },
                'Primal Savagery': { classes: ['druid'], school: 'Transmutation', desc: 'Your teeth or nails become sharp, make melee attack for 1d10 acid damage.' },
                'Magic Stone': { classes: ['druid', 'warlock'], school: 'Transmutation', desc: 'Imbue up to three pebbles with magic, throw or sling for 1d6+spellcasting mod.' },
                'Infestation': { classes: ['druid', 'sorcerer', 'warlock', 'wizard'], school: 'Conjuration', desc: 'Cause mites, fleas, or other vermin to appear dealing 1d6 poison and random movement.' },

                // Sorcerer/Wizard Cantrips
                'Acid Splash': { classes: ['sorcerer', 'wizard'], school: 'Conjuration', desc: 'Hurl a bubble of acid at one or two creatures within 5 feet of each other for 1d6 acid.' },
                'Chill Touch': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Necromancy', desc: 'Ghostly skeletal hand deals 1d8 necrotic and prevents healing until your next turn.' },
                'Fire Bolt': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'Hurl a mote of fire at a creature for 1d10 fire damage.' },
                'Frostbite': { classes: ['druid', 'sorcerer', 'warlock', 'wizard'], school: 'Evocation', desc: 'Cause numbing frost dealing 1d6 cold and disadvantage on next weapon attack.' },
                'Ray of Frost': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'A frigid beam deals 1d8 cold damage and reduces speed by 10 feet.' },
                'Shocking Grasp': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'Lightning springs from your hand dealing 1d8 lightning, target can\'t take reactions.' },
                'Booming Blade': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Evocation', desc: 'Make a melee attack; if target moves before your next turn, it takes 1d8 thunder.' },
                'Green-Flame Blade': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Evocation', desc: 'Make a melee attack and green fire leaps to a creature within 5 feet.' },
                'Mind Sliver': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'Drive a spike of psychic energy dealing 1d6 psychic and -1d4 to next save.' },
                'Sword Burst': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Conjuration', desc: 'Create a momentary circle of spectral blades dealing 1d6 force to all within 5 feet.' },
                'Lightning Lure': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Evocation', desc: 'Create a lash of lightning pulling target 10 feet closer, dealing 1d8 lightning.' },

                // Warlock Cantrips
                'Eldritch Blast': { classes: ['warlock'], school: 'Evocation', desc: 'A beam of crackling energy streaks toward a creature for 1d10 force damage.' },
                'Create Bonfire': { classes: ['druid', 'sorcerer', 'warlock', 'wizard'], school: 'Conjuration', desc: 'Create a bonfire on ground dealing 1d8 fire to creatures in the space.' },

                // Wizard extras
                'Encode Thoughts': { classes: ['wizard'], school: 'Enchantment', desc: 'Draw a memory from your mind as a thought strand.' },
                'Shape Water': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Manipulate water in a 5-foot cube: move it, change color, freeze it.' },
                'Control Flames': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Manipulate nonmagical fire: spread it, extinguish it, change brightness.' },
                'Gust': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Create a small blast of air: push creature, push object, or create wind.' },
                'Mold Earth': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Manipulate dirt or stone: excavate it, shape it, change color.' }
            },

            // LEVEL 1 SPELLS
            level1: {
                // Bard Spells
                'Animal Friendship': { classes: ['bard', 'druid', 'ranger'], school: 'Enchantment', desc: 'Convince a beast that you mean it no harm for 24 hours.' },
                'Bane': { classes: ['bard', 'cleric'], school: 'Enchantment', desc: 'Up to 3 creatures subtract 1d4 from attack rolls and saves.' },
                'Charm Person': { classes: ['bard', 'druid', 'sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'A humanoid you can see regards you as a friendly acquaintance.' },
                'Comprehend Languages': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Divination', ritual: true, duration: '1 hour', desc: 'Understand any spoken language you hear for 1 hour.' },
                'Cure Wounds': { classes: ['bard', 'cleric', 'druid', 'paladin', 'ranger'], school: 'Evocation', desc: 'A creature you touch regains 1d8 + spellcasting modifier hit points.' },
                'Detect Magic': { classes: ['bard', 'cleric', 'druid', 'paladin', 'ranger', 'sorcerer', 'wizard'], school: 'Divination', ritual: true, duration: '10 minutes', concentration: true, desc: 'Sense the presence of magic within 30 feet for up to 10 minutes.' },
                'Disguise Self': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Illusion', desc: 'Make yourself look different for 1 hour.' },
                'Dissonant Whispers': { classes: ['bard'], school: 'Enchantment', desc: 'Whisper a discordant melody dealing 3d6 psychic and forcing creature to flee.' },
                'Faerie Fire': { classes: ['bard', 'druid'], school: 'Evocation', desc: 'Objects and creatures in a 20-foot cube are outlined in light, granting advantage on attacks.' },
                'Feather Fall': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Up to 5 falling creatures descend slowly, taking no fall damage.' },
                'Healing Word': { classes: ['bard', 'cleric', 'druid'], school: 'Evocation', desc: 'A creature within 60 feet regains 1d4 + spellcasting modifier hit points.' },
                'Heroism': { classes: ['bard', 'paladin'], school: 'Enchantment', desc: 'A creature gains temp HP equal to your spellcasting mod each turn and is immune to fear.' },
                'Hideous Laughter': { classes: ['bard', 'wizard'], school: 'Enchantment', desc: 'A creature falls prone and is incapacitated by laughter.' },
                'Identify': { classes: ['bard', 'wizard'], school: 'Divination', ritual: true, duration: 'Instant', desc: 'Learn the properties of a magic item or if a creature is affected by a spell.' },
                'Longstrider': { classes: ['bard', 'druid', 'ranger', 'wizard'], school: 'Transmutation', desc: 'A creature\'s speed increases by 10 feet for 1 hour.' },
                'Silent Image': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Illusion', desc: 'Create a visual illusion up to a 15-foot cube.' },
                'Sleep': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Enchantment', desc: 'Put creatures in a 20-foot radius to sleep (5d8 HP of creatures affected).' },
                'Speak with Animals': { classes: ['bard', 'druid', 'ranger'], school: 'Divination', ritual: true, duration: '10 minutes', desc: 'Communicate with beasts for 10 minutes.' },
                'Thunderwave': { classes: ['bard', 'druid', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'A wave of thunder deals 2d8 thunder damage and pushes creatures 10 feet.' },
                'Unseen Servant': { classes: ['bard', 'warlock', 'wizard'], school: 'Conjuration', ritual: true, duration: '1 hour', desc: 'Create an invisible force that performs simple tasks.' },

                // Cleric Spells
                'Bless': { classes: ['cleric', 'paladin'], school: 'Enchantment', desc: 'Up to 3 creatures add 1d4 to attack rolls and saving throws.' },
                'Command': { classes: ['cleric', 'paladin'], school: 'Enchantment', desc: 'Speak a one-word command that a creature must obey on a failed save.' },
                'Create or Destroy Water': { classes: ['cleric', 'druid'], school: 'Transmutation', desc: 'Create up to 10 gallons of water or destroy fog in a 30-foot cube.' },
                'Guiding Bolt': { classes: ['cleric'], school: 'Evocation', desc: 'A flash of light deals 4d6 radiant damage and grants advantage on next attack against target.' },
                'Inflict Wounds': { classes: ['cleric'], school: 'Necromancy', desc: 'Touch attack deals 3d10 necrotic damage.' },
                'Protection from Evil and Good': { classes: ['cleric', 'paladin', 'warlock', 'wizard'], school: 'Abjuration', desc: 'Protect a creature from aberrations, celestials, fiends, fey, elementals, and undead.' },
                'Purify Food and Drink': { classes: ['cleric', 'druid', 'paladin'], school: 'Transmutation', desc: 'Render food and drink free of poison and disease.' },
                'Sanctuary': { classes: ['cleric'], school: 'Abjuration', desc: 'Ward a creature; enemies must make Wisdom save to attack them.' },
                'Shield of Faith': { classes: ['cleric', 'paladin'], school: 'Abjuration', desc: 'A shimmering field grants +2 AC to a creature for 10 minutes.' },

                // Druid Spells
                'Absorb Elements': { classes: ['druid', 'ranger', 'sorcerer', 'wizard'], school: 'Abjuration', desc: 'Capture incoming elemental energy and release it in your next melee attack.' },
                'Beast Bond': { classes: ['druid', 'ranger'], school: 'Divination', desc: 'Establish a telepathic link with one beast.' },
                'Entangle': { classes: ['druid'], school: 'Conjuration', desc: 'Grasping weeds sprout in a 20-foot square, restraining creatures.' },
                'Fog Cloud': { classes: ['druid', 'ranger', 'sorcerer', 'wizard'], school: 'Conjuration', desc: 'Create a 20-foot radius sphere of fog that heavily obscures.' },
                'Goodberry': { classes: ['druid', 'ranger'], school: 'Transmutation', desc: 'Create 10 berries that each heal 1 HP and provide a day\'s nourishment.' },
                'Ice Knife': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Conjuration', desc: 'Create a shard of ice dealing 1d10 piercing and exploding for 2d6 cold.' },
                'Jump': { classes: ['druid', 'ranger', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'A creature\'s jump distance is tripled for 1 minute.' },
                'Snare': { classes: ['druid', 'ranger', 'wizard'], school: 'Abjuration', desc: 'Create a trap that hoists creatures into the air.' },
                'Earth Tremor': { classes: ['bard', 'druid', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'Cause a tremor dealing 1d6 bludgeoning and knocking prone.' },

                // Paladin Spells
                'Compelled Duel': { classes: ['paladin'], school: 'Enchantment', desc: 'Force a creature to duel you, with disadvantage on attacks against others.' },
                'Detect Evil and Good': { classes: ['cleric', 'paladin'], school: 'Divination', desc: 'Sense aberrations, celestials, elementals, fey, fiends, and undead within 30 feet.' },
                'Detect Poison and Disease': { classes: ['cleric', 'druid', 'paladin', 'ranger'], school: 'Divination', desc: 'Sense the presence and location of poisons and diseases within 30 feet.' },
                'Divine Favor': { classes: ['paladin'], school: 'Evocation', desc: 'Your weapon deals an extra 1d4 radiant damage for 1 minute.' },
                'Searing Smite': { classes: ['paladin'], school: 'Evocation', desc: 'Your weapon flares with white-hot intensity, dealing 1d6 fire extra on hit.' },
                'Thunderous Smite': { classes: ['paladin'], school: 'Evocation', desc: 'Your weapon rings with thunder, dealing 2d6 thunder and pushing 10 feet.' },
                'Wrathful Smite': { classes: ['paladin'], school: 'Evocation', desc: 'Your weapon drips with menace, dealing 1d6 psychic and frightening the target.' },

                // Ranger Spells
                'Alarm': { classes: ['ranger', 'wizard'], school: 'Abjuration', ritual: true, duration: '8 hours', desc: 'Set a ward that alerts you when creatures enter a 20-foot cube.' },
                'Ensnaring Strike': { classes: ['ranger'], school: 'Conjuration', desc: 'Your attack causes thorny vines to restrain the target.' },
                'Hail of Thorns': { classes: ['ranger'], school: 'Conjuration', desc: 'Your ranged attack sprays thorns dealing 1d10 piercing in a 5-foot radius.' },
                'Hunter\'s Mark': { classes: ['ranger'], school: 'Divination', desc: 'Mark a creature to deal 1d6 extra damage and track it.' },
                'Zephyr Strike': { classes: ['ranger'], school: 'Transmutation', desc: 'Move without provoking opportunity attacks and gain advantage on one attack.' },

                // Sorcerer/Wizard Spells
                'Burning Hands': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'A thin sheet of flames deals 3d6 fire damage in a 15-foot cone.' },
                'Catapult': { classes: ['sorcerer', 'wizard'], school: 'Transmutation', desc: 'Hurl an object dealing 3d8 bludgeoning damage.' },
                'Chromatic Orb': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'Hurl a sphere of energy dealing 3d8 damage of a chosen type.' },
                'Color Spray': { classes: ['sorcerer', 'wizard'], school: 'Illusion', desc: 'A dazzling array of flashing colors blinds 6d10 HP of creatures.' },
                'Expeditious Retreat': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Transmutation', desc: 'Dash as a bonus action for 10 minutes.' },
                'False Life': { classes: ['sorcerer', 'wizard'], school: 'Necromancy', desc: 'Gain 1d4+4 temporary hit points for 1 hour.' },
                'Find Familiar': { classes: ['wizard'], school: 'Conjuration', ritual: true, duration: 'Instant', desc: 'Summon a spirit that takes the form of a small animal.' },
                'Grease': { classes: ['wizard'], school: 'Conjuration', desc: 'Cover ground in slippery grease, creatures fall prone.' },
                'Mage Armor': { classes: ['sorcerer', 'wizard'], school: 'Abjuration', desc: 'Touch a creature to set its base AC to 13 + Dex modifier for 8 hours.' },
                'Magic Missile': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'Three darts of magical force deal 1d4+1 force damage each, auto-hit.' },
                'Ray of Sickness': { classes: ['sorcerer', 'wizard'], school: 'Necromancy', desc: 'A ray of sickening energy deals 2d8 poison damage and poisons the target.' },
                'Shield': { classes: ['sorcerer', 'wizard'], school: 'Abjuration', desc: 'Reaction: +5 AC until start of your next turn, including against triggering attack.' },
                'Tasha\'s Hideous Laughter': { classes: ['bard', 'wizard'], school: 'Enchantment', desc: 'A creature falls prone laughing, incapacitated.' },
                'Witch Bolt': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Evocation', desc: 'A beam of crackling energy deals 1d12 lightning, 1d12 each turn as action.' },
                'Cause Fear': { classes: ['warlock', 'wizard'], school: 'Necromancy', desc: 'A creature becomes frightened of you.' },
                'Chaos Bolt': { classes: ['sorcerer'], school: 'Evocation', desc: 'Hurl a bolt of chaotic energy dealing 2d8+1d6 random damage type.' },
                'Earth Bind': { classes: ['druid', 'sorcerer', 'warlock', 'wizard'], school: 'Transmutation', desc: 'A flying creature\'s flying speed is reduced to 0.' },
                'Snilloc\'s Snowball Swarm': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'A flurry of snowballs deals 3d6 cold in a 5-foot radius.' },

                // Warlock Spells
                'Armor of Agathys': { classes: ['warlock'], school: 'Abjuration', desc: 'Gain 5 temp HP; melee attackers take 5 cold damage while you have them.' },
                'Arms of Hadar': { classes: ['warlock'], school: 'Conjuration', desc: 'Tendrils of dark energy deal 2d6 necrotic and prevent reactions.' },
                'Hellish Rebuke': { classes: ['warlock'], school: 'Evocation', desc: 'Reaction: When damaged, surround attacker in flames for 2d10 fire damage.' },
                'Hex': { classes: ['warlock'], school: 'Enchantment', desc: 'Curse a creature to take 1d6 extra necrotic damage from your attacks.' },
                'Illusory Script': { classes: ['bard', 'warlock', 'wizard'], school: 'Illusion', ritual: true, duration: '10 days', desc: 'Write a hidden message readable only by designated creatures.' },
                'Protection from Evil and Good': { classes: ['cleric', 'paladin', 'warlock', 'wizard'], school: 'Abjuration', desc: 'Protect a creature from certain creature types.' },

                // More utility
                'Tenser\'s Floating Disk': { classes: ['wizard'], school: 'Conjuration', ritual: true, duration: '1 hour', desc: 'Create a circular plane of force that can hold 500 pounds.' },
                'Comprehend Languages': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Divination', desc: 'Understand any spoken language for 1 hour.' }
            },

            // LEVEL 2 SPELLS
            level2: {
                'Aid': { classes: ['cleric', 'paladin'], school: 'Abjuration', desc: 'Bolster allies with toughness, increasing max HP by 5 for 8 hours.' },
                'Alter Self': { classes: ['sorcerer', 'wizard'], school: 'Transmutation', desc: 'Assume a different form: aquatic, change appearance, or natural weapons.' },
                'Animal Messenger': { classes: ['bard', 'druid', 'ranger'], school: 'Enchantment', ritual: true, duration: '24 hours', desc: 'Send a Tiny beast to deliver a message.' },
                'Arcane Lock': { classes: ['wizard'], school: 'Abjuration', desc: 'Magically lock a door, window, gate, chest, or other entryway.' },
                'Augury': { classes: ['cleric'], school: 'Divination', ritual: true, duration: 'Instant', desc: 'Receive an omen about the results of a specific course of action.' },
                'Barkskin': { classes: ['druid', 'ranger'], school: 'Transmutation', desc: 'A creature\'s AC can\'t be less than 16 for 1 hour.' },
                'Blindness/Deafness': { classes: ['bard', 'cleric', 'sorcerer', 'wizard'], school: 'Necromancy', desc: 'Blind or deafen a foe on a failed Con save.' },
                'Blur': { classes: ['sorcerer', 'wizard'], school: 'Illusion', desc: 'Your body becomes blurred, granting disadvantage on attacks against you.' },
                'Calm Emotions': { classes: ['bard', 'cleric'], school: 'Enchantment', desc: 'Suppress strong emotions in a group of humanoids.' },
                'Cloud of Daggers': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Conjuration', desc: 'Fill 5-foot cube with spinning daggers dealing 4d4 slashing.' },
                'Crown of Madness': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'Creature must use its action to attack a creature you choose.' },
                'Darkness': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Evocation', desc: 'Create magical darkness in a 15-foot radius sphere.' },
                'Darkvision': { classes: ['druid', 'ranger', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Grant a creature darkvision out to 60 feet.' },
                'Detect Thoughts': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Divination', desc: 'Read the surface thoughts of creatures.' },
                'Enhance Ability': { classes: ['bard', 'cleric', 'druid', 'sorcerer'], school: 'Transmutation', desc: 'Grant a creature advantage on one type of ability check.' },
                'Enlarge/Reduce': { classes: ['sorcerer', 'wizard'], school: 'Transmutation', desc: 'Make a creature or object larger or smaller.' },
                'Enthrall': { classes: ['bard', 'warlock'], school: 'Enchantment', desc: 'Weave a distracting string of words, giving others disadvantage on Perception.' },
                'Find Steed': { classes: ['paladin'], school: 'Conjuration', desc: 'Summon a spirit that assumes the form of a loyal mount.' },
                'Flame Blade': { classes: ['druid'], school: 'Evocation', desc: 'Create a scimitar of flame dealing 3d6 fire damage.' },
                'Flaming Sphere': { classes: ['druid', 'wizard'], school: 'Conjuration', desc: 'Create a 5-foot sphere of fire dealing 2d6 fire damage.' },
                'Gentle Repose': { classes: ['cleric', 'wizard'], school: 'Necromancy', ritual: true, duration: '10 days', desc: 'Protect a corpse from decay and from becoming undead.' },
                'Gust of Wind': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'Create a 60-foot line of strong wind.' },
                'Heat Metal': { classes: ['bard', 'druid'], school: 'Transmutation', desc: 'Cause a metal object to glow red-hot, dealing 2d8 fire damage.' },
                'Hold Person': { classes: ['bard', 'cleric', 'druid', 'sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'Paralyze a humanoid on a failed Wisdom save.' },
                'Invisibility': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Illusion', desc: 'A creature becomes invisible for 1 hour.' },
                'Knock': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Open a locked door, chest, or other entryway.' },
                'Lesser Restoration': { classes: ['bard', 'cleric', 'druid', 'paladin', 'ranger'], school: 'Abjuration', desc: 'End a disease or condition: blinded, deafened, paralyzed, or poisoned.' },
                'Levitate': { classes: ['sorcerer', 'wizard'], school: 'Transmutation', desc: 'Cause a creature or object to rise vertically up to 20 feet.' },
                'Locate Animals or Plants': { classes: ['bard', 'druid', 'ranger'], school: 'Divination', ritual: true, duration: 'Instant', desc: 'Describe or name a specific kind of beast or plant to sense its direction.' },
                'Locate Object': { classes: ['bard', 'cleric', 'druid', 'paladin', 'ranger', 'wizard'], school: 'Divination', desc: 'Sense the direction to a specific object within 1000 feet.' },
                'Magic Mouth': { classes: ['bard', 'wizard'], school: 'Illusion', ritual: true, duration: 'Until dispelled', desc: 'Implant a message in an object that is spoken when triggered.' },
                'Magic Weapon': { classes: ['paladin', 'wizard'], school: 'Transmutation', desc: 'Make a weapon magical with +1 to attack and damage.' },
                'Melf\'s Acid Arrow': { classes: ['wizard'], school: 'Evocation', desc: 'A green arrow deals 4d4 acid initially and 2d4 at end of target\'s next turn.' },
                'Mirror Image': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Illusion', desc: 'Create three illusory duplicates of yourself.' },
                'Misty Step': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Conjuration', desc: 'Teleport up to 30 feet as a bonus action.' },
                'Moonbeam': { classes: ['druid'], school: 'Evocation', desc: 'A beam of pale light shines down, dealing 2d10 radiant damage.' },
                'Pass without Trace': { classes: ['druid', 'ranger'], school: 'Abjuration', desc: 'You and companions gain +10 to Stealth checks.' },
                'Phantasmal Force': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Illusion', desc: 'Create a phantasm that only the target can see.' },
                'Prayer of Healing': { classes: ['cleric'], school: 'Evocation', desc: 'Up to six creatures regain 2d8 + spellcasting mod HP.' },
                'Protection from Poison': { classes: ['cleric', 'druid', 'paladin', 'ranger'], school: 'Abjuration', desc: 'Neutralize poison and grant advantage on saves against poison.' },
                'Ray of Enfeeblement': { classes: ['warlock', 'wizard'], school: 'Necromancy', desc: 'A ray weakens a creature, halving damage dealt with Strength-based attacks.' },
                'Rope Trick': { classes: ['wizard'], school: 'Transmutation', desc: 'Create an extradimensional space at the top of a rope.' },
                'Scorching Ray': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'Create three rays of fire, each dealing 2d6 fire damage.' },
                'See Invisibility': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Divination', desc: 'See invisible creatures and objects.' },
                'Shatter': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Evocation', desc: 'A burst of thunder deals 3d8 thunder damage in a 10-foot radius.' },
                'Silence': { classes: ['bard', 'cleric', 'ranger'], school: 'Illusion', desc: 'Create a 20-foot radius zone where no sound exists.' },
                'Spider Climb': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Transmutation', desc: 'Walk on walls and ceilings for 1 hour.' },
                'Spike Growth': { classes: ['druid', 'ranger'], school: 'Transmutation', desc: 'Ground sprouts spikes, dealing 2d4 piercing per 5 feet moved.' },
                'Spiritual Weapon': { classes: ['cleric'], school: 'Evocation', desc: 'Create a floating weapon that attacks for 1d8 + spellcasting mod force damage.' },
                'Suggestion': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'Suggest a course of activity to a creature.' },
                'Warding Bond': { classes: ['cleric'], school: 'Abjuration', desc: 'Protect a creature, giving +1 AC and saves, sharing damage taken.' },
                'Web': { classes: ['sorcerer', 'wizard'], school: 'Conjuration', desc: 'Conjure a mass of sticky webs that restrain creatures.' },
                'Zone of Truth': { classes: ['bard', 'cleric', 'paladin'], school: 'Enchantment', desc: 'Creatures in a 15-foot radius can\'t lie.' }
            },

            // LEVEL 3 SPELLS
            level3: {
                'Animate Dead': { classes: ['cleric', 'wizard'], school: 'Necromancy', desc: 'Create an undead servant from a corpse.' },
                'Beacon of Hope': { classes: ['cleric'], school: 'Abjuration', desc: 'Allies have advantage on Wisdom saves and death saves, and regain max HP from healing.' },
                'Bestow Curse': { classes: ['bard', 'cleric', 'wizard'], school: 'Necromancy', desc: 'Place a debilitating curse on a creature.' },
                'Blink': { classes: ['sorcerer', 'wizard'], school: 'Transmutation', desc: 'Each turn, 50% chance to vanish to the Ethereal Plane.' },
                'Call Lightning': { classes: ['druid'], school: 'Conjuration', desc: 'Call down bolts of lightning dealing 3d10 lightning damage.' },
                'Clairvoyance': { classes: ['bard', 'cleric', 'sorcerer', 'wizard'], school: 'Divination', desc: 'Create an invisible sensor to see or hear a location.' },
                'Conjure Animals': { classes: ['druid', 'ranger'], school: 'Conjuration', desc: 'Summon fey spirits in the form of beasts.' },
                'Counterspell': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Abjuration', desc: 'Interrupt a creature casting a spell of 3rd level or lower.' },
                'Create Food and Water': { classes: ['cleric', 'paladin'], school: 'Conjuration', desc: 'Create 45 pounds of food and 30 gallons of water.' },
                'Daylight': { classes: ['cleric', 'druid', 'paladin', 'ranger', 'sorcerer'], school: 'Evocation', desc: 'Create a 60-foot radius sphere of bright light.' },
                'Dispel Magic': { classes: ['bard', 'cleric', 'druid', 'paladin', 'sorcerer', 'warlock', 'wizard'], school: 'Abjuration', desc: 'End spells of 3rd level or lower on a target.' },
                'Fear': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Illusion', desc: 'Creatures in a 30-foot cone become frightened.' },
                'Feign Death': { classes: ['bard', 'cleric', 'druid', 'wizard'], school: 'Necromancy', desc: 'Touch a willing creature to put it into a cataleptic state.' },
                'Fireball': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'A bright streak explodes for 8d6 fire damage in a 20-foot radius.' },
                'Fly': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Transmutation', desc: 'A creature gains a flying speed of 60 feet for 10 minutes.' },
                'Gaseous Form': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Transmutation', desc: 'Transform into a misty cloud with flying speed 10 feet.' },
                'Glyph of Warding': { classes: ['bard', 'cleric', 'wizard'], school: 'Abjuration', desc: 'Inscribe a glyph that triggers a harmful effect when activated.' },
                'Haste': { classes: ['sorcerer', 'wizard'], school: 'Transmutation', desc: 'Double speed, +2 AC, advantage on Dex saves, extra action.' },
                'Hunger of Hadar': { classes: ['warlock'], school: 'Conjuration', desc: 'Create a sphere of darkness and cold dealing 2d6 cold and 2d6 acid.' },
                'Hypnotic Pattern': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Illusion', desc: 'Charm creatures in a 30-foot cube, incapacitating them.' },
                'Leomund\'s Tiny Hut': { classes: ['bard', 'wizard'], school: 'Evocation', ritual: true, duration: '8 hours', desc: 'Create an immobile dome that protects creatures inside.' },
                'Lightning Bolt': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'A stroke of lightning deals 8d6 lightning in a 100-foot line.' },
                'Magic Circle': { classes: ['cleric', 'paladin', 'warlock', 'wizard'], school: 'Abjuration', desc: 'Create a cylinder that protects against certain creature types.' },
                'Major Image': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Illusion', desc: 'Create a visual, auditory, and sensory illusion.' },
                'Mass Healing Word': { classes: ['cleric'], school: 'Evocation', desc: 'Up to six creatures regain 1d4 + spellcasting mod HP.' },
                'Meld into Stone': { classes: ['cleric', 'druid'], school: 'Transmutation', desc: 'Step into a stone object large enough to hold you.' },
                'Nondetection': { classes: ['bard', 'ranger', 'wizard'], school: 'Abjuration', desc: 'Hide a creature or object from divination magic.' },
                'Plant Growth': { classes: ['bard', 'druid', 'ranger'], school: 'Transmutation', desc: 'Cause plants to become thick and overgrown or enriched.' },
                'Protection from Energy': { classes: ['cleric', 'druid', 'ranger', 'sorcerer', 'wizard'], school: 'Abjuration', desc: 'Grant resistance to one damage type.' },
                'Remove Curse': { classes: ['cleric', 'paladin', 'warlock', 'wizard'], school: 'Abjuration', desc: 'End a curse affecting a creature or object.' },
                'Revivify': { classes: ['cleric', 'paladin'], school: 'Necromancy', desc: 'Return a creature dead for no more than 1 minute to life with 1 HP.' },
                'Sending': { classes: ['bard', 'cleric', 'wizard'], school: 'Evocation', desc: 'Send a 25-word message to a creature anywhere on the same plane.' },
                'Sleet Storm': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Conjuration', desc: 'Create a storm of icy sleet that obscures and causes falls.' },
                'Slow': { classes: ['sorcerer', 'wizard'], school: 'Transmutation', desc: 'Up to 6 creatures have halved speed and -2 AC.' },
                'Speak with Dead': { classes: ['bard', 'cleric'], school: 'Necromancy', ritual: true, duration: '10 minutes', desc: 'Ask a corpse up to five questions.' },
                'Speak with Plants': { classes: ['bard', 'druid', 'ranger'], school: 'Transmutation', desc: 'Communicate with plants.' },
                'Spirit Guardians': { classes: ['cleric'], school: 'Conjuration', desc: 'Spirits swirl around you, dealing 3d8 radiant or necrotic.' },
                'Stinking Cloud': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Conjuration', desc: 'Create a nauseating cloud that incapacitates creatures.' },
                'Tongues': { classes: ['bard', 'cleric', 'sorcerer', 'warlock', 'wizard'], school: 'Divination', desc: 'A creature understands any spoken language.' },
                'Vampiric Touch': { classes: ['warlock', 'wizard'], school: 'Necromancy', desc: 'Deal 3d6 necrotic damage and regain half as HP.' },
                'Water Breathing': { classes: ['druid', 'ranger', 'sorcerer', 'wizard'], school: 'Transmutation', ritual: true, duration: '24 hours', desc: 'Up to 10 creatures can breathe underwater for 24 hours.' },
                'Water Walk': { classes: ['cleric', 'druid', 'ranger', 'sorcerer'], school: 'Transmutation', desc: 'Up to 10 creatures can walk on water.' },
                'Wind Wall': { classes: ['druid', 'ranger'], school: 'Evocation', desc: 'Create a wall of wind that deflects projectiles.' }
            },

            // LEVEL 4 SPELLS
            level4: {
                'Arcane Eye': { classes: ['wizard'], school: 'Divination', desc: 'Create an invisible magical eye that you can see through.' },
                'Banishment': { classes: ['cleric', 'paladin', 'sorcerer', 'warlock', 'wizard'], school: 'Abjuration', desc: 'Banish a creature to another plane.' },
                'Blight': { classes: ['druid', 'sorcerer', 'warlock', 'wizard'], school: 'Necromancy', desc: 'Deal 8d8 necrotic damage to a creature.' },
                'Compulsion': { classes: ['bard'], school: 'Enchantment', desc: 'Force creatures to move in a direction you choose.' },
                'Confusion': { classes: ['bard', 'druid', 'sorcerer', 'wizard'], school: 'Enchantment', desc: 'Creatures in a 10-foot radius act randomly.' },
                'Conjure Minor Elementals': { classes: ['druid', 'wizard'], school: 'Conjuration', desc: 'Summon elementals of CR 2 or lower.' },
                'Conjure Woodland Beings': { classes: ['druid', 'ranger'], school: 'Conjuration', desc: 'Summon fey creatures.' },
                'Control Water': { classes: ['cleric', 'druid', 'wizard'], school: 'Transmutation', desc: 'Control freestanding water in a 100-foot cube.' },
                'Death Ward': { classes: ['cleric', 'paladin'], school: 'Abjuration', desc: 'When a creature drops to 0 HP, it drops to 1 HP instead.' },
                'Dimension Door': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Conjuration', desc: 'Teleport up to 500 feet to a location you can see or describe.' },
                'Divination': { classes: ['cleric'], school: 'Divination', desc: 'Contact a deity or divine agent for guidance.' },
                'Dominate Beast': { classes: ['druid', 'sorcerer'], school: 'Enchantment', desc: 'Take control of a beast.' },
                'Evard\'s Black Tentacles': { classes: ['wizard'], school: 'Conjuration', desc: 'Create writhing tentacles that restrain and deal 3d6 bludgeoning.' },
                'Fabricate': { classes: ['wizard'], school: 'Transmutation', desc: 'Convert raw materials into products.' },
                'Fire Shield': { classes: ['wizard'], school: 'Evocation', desc: 'Surround yourself with flames or cold, dealing damage to attackers.' },
                'Freedom of Movement': { classes: ['bard', 'cleric', 'druid', 'paladin', 'ranger'], school: 'Abjuration', desc: 'A creature\'s movement is unaffected by difficult terrain or magic.' },
                'Giant Insect': { classes: ['druid'], school: 'Transmutation', desc: 'Transform insects into giant versions.' },
                'Greater Invisibility': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Illusion', desc: 'A creature becomes invisible even while attacking.' },
                'Grasping Vine': { classes: ['druid', 'ranger'], school: 'Conjuration', desc: 'Create a vine that pulls creatures toward it.' },
                'Guardian of Faith': { classes: ['cleric'], school: 'Conjuration', desc: 'Create a Large spectral guardian that deals 20 radiant damage.' },
                'Hallucinatory Terrain': { classes: ['bard', 'druid', 'warlock', 'wizard'], school: 'Illusion', desc: 'Make terrain look, sound, and smell like another.' },
                'Ice Storm': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'Hail deals 2d8 bludgeoning and 4d6 cold in a 20-foot radius.' },
                'Leomund\'s Secret Chest': { classes: ['wizard'], school: 'Conjuration', desc: 'Hide a chest on the Ethereal Plane.' },
                'Locate Creature': { classes: ['bard', 'cleric', 'druid', 'paladin', 'ranger', 'wizard'], school: 'Divination', desc: 'Sense the direction to a creature you are familiar with.' },
                'Mordenkainen\'s Faithful Hound': { classes: ['wizard'], school: 'Conjuration', desc: 'Conjure a phantom watchdog.' },
                'Mordenkainen\'s Private Sanctum': { classes: ['wizard'], school: 'Abjuration', desc: 'Create a secure area.' },
                'Otiluke\'s Resilient Sphere': { classes: ['wizard'], school: 'Evocation', desc: 'Encase a creature in a shimmering force sphere.' },
                'Phantasmal Killer': { classes: ['wizard'], school: 'Illusion', desc: 'Create a nightmare visible only to the target, dealing 4d10 psychic.' },
                'Polymorph': { classes: ['bard', 'druid', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Transform a creature into a different beast.' },
                'Stoneskin': { classes: ['druid', 'ranger', 'sorcerer', 'wizard'], school: 'Abjuration', desc: 'Grant resistance to nonmagical bludgeoning, piercing, and slashing.' },
                'Stone Shape': { classes: ['cleric', 'druid', 'wizard'], school: 'Transmutation', desc: 'Reshape a stone object or area.' },
                'Wall of Fire': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'Create a wall of fire dealing 5d8 fire damage.' }
            },

            // LEVEL 5 SPELLS
            level5: {
                'Animate Objects': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Bring up to 10 objects to life to fight for you.' },
                'Antilife Shell': { classes: ['druid'], school: 'Abjuration', desc: 'Create a barrier that prevents creatures from approaching.' },
                'Awaken': { classes: ['bard', 'druid'], school: 'Transmutation', desc: 'Grant an animal or plant intelligence.' },
                'Bigby\'s Hand': { classes: ['wizard'], school: 'Evocation', desc: 'Create a Large hand of force that can punch, grab, or block.' },
                'Circle of Power': { classes: ['paladin'], school: 'Abjuration', desc: 'Allies have advantage on saves against magic.' },
                'Cloudkill': { classes: ['sorcerer', 'wizard'], school: 'Conjuration', desc: 'Create a poisonous cloud dealing 5d8 poison.' },
                'Commune': { classes: ['cleric'], school: 'Divination', ritual: true, duration: '1 minute', desc: 'Contact your deity to ask up to 3 yes/no questions.' },
                'Commune with Nature': { classes: ['druid', 'ranger'], school: 'Divination', desc: 'Gain knowledge about the surrounding territory.' },
                'Cone of Cold': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'A blast of cold deals 8d8 cold in a 60-foot cone.' },
                'Conjure Elemental': { classes: ['druid', 'wizard'], school: 'Conjuration', desc: 'Summon an elemental of CR 5 or lower.' },
                'Contact Other Plane': { classes: ['warlock', 'wizard'], school: 'Divination', ritual: true, duration: '1 minute', desc: 'Contact a demigod or spirit to ask 5 questions.' },
                'Contagion': { classes: ['cleric', 'druid'], school: 'Necromancy', desc: 'Inflict a disease on a creature.' },
                'Creation': { classes: ['sorcerer', 'wizard'], school: 'Illusion', desc: 'Create a nonliving object of vegetable or mineral matter.' },
                'Destructive Wave': { classes: ['paladin'], school: 'Evocation', desc: 'Deal 5d6 thunder and 5d6 radiant/necrotic in a 30-foot radius.' },
                'Dispel Evil and Good': { classes: ['cleric', 'paladin'], school: 'Abjuration', desc: 'Protect against celestials, elementals, fey, fiends, and undead.' },
                'Dominate Person': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Enchantment', desc: 'Take telepathic control of a humanoid.' },
                'Dream': { classes: ['bard', 'warlock', 'wizard'], school: 'Illusion', desc: 'Shape a creature\'s dreams.' },
                'Flame Strike': { classes: ['cleric'], school: 'Evocation', desc: 'A vertical column of divine fire deals 4d6 fire and 4d6 radiant.' },
                'Geas': { classes: ['bard', 'cleric', 'druid', 'paladin', 'wizard'], school: 'Enchantment', desc: 'Command a creature to carry out a service.' },
                'Greater Restoration': { classes: ['bard', 'cleric', 'druid'], school: 'Abjuration', desc: 'End a reduction to an ability score, or remove a debilitating effect.' },
                'Hallow': { classes: ['cleric'], school: 'Evocation', desc: 'Create a holy or unholy area with special effects.' },
                'Hold Monster': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'Paralyze any creature on a failed Wisdom save.' },
                'Insect Plague': { classes: ['cleric', 'druid', 'sorcerer'], school: 'Conjuration', desc: 'Locusts deal 4d10 piercing in a 20-foot radius sphere.' },
                'Legend Lore': { classes: ['bard', 'cleric', 'wizard'], school: 'Divination', desc: 'Learn lore about a person, place, or object.' },
                'Mass Cure Wounds': { classes: ['bard', 'cleric', 'druid'], school: 'Evocation', desc: 'Up to 6 creatures regain 3d8 + spellcasting mod HP.' },
                'Mislead': { classes: ['bard', 'wizard'], school: 'Illusion', desc: 'Become invisible and create an illusory double.' },
                'Modify Memory': { classes: ['bard', 'wizard'], school: 'Enchantment', desc: 'Alter a creature\'s memories.' },
                'Passwall': { classes: ['wizard'], school: 'Transmutation', desc: 'Create a passage through wood, plaster, or stone.' },
                'Planar Binding': { classes: ['bard', 'cleric', 'druid', 'wizard'], school: 'Abjuration', desc: 'Bind a celestial, elemental, fey, or fiend to your service.' },
                'Raise Dead': { classes: ['bard', 'cleric', 'paladin'], school: 'Necromancy', desc: 'Return a dead creature to life.' },
                'Reincarnate': { classes: ['druid'], school: 'Transmutation', desc: 'Return a dead creature to life in a new body.' },
                'Scrying': { classes: ['bard', 'cleric', 'druid', 'warlock', 'wizard'], school: 'Divination', desc: 'Observe a creature on the same plane.' },
                'Seeming': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Illusion', desc: 'Change the appearance of multiple creatures.' },
                'Telekinesis': { classes: ['sorcerer', 'wizard'], school: 'Transmutation', desc: 'Move creatures or objects with your mind.' },
                'Teleportation Circle': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Conjuration', desc: 'Create a circle that teleports to another permanent circle.' },
                'Tree Stride': { classes: ['druid', 'ranger'], school: 'Conjuration', desc: 'Teleport from tree to tree.' },
                'Wall of Force': { classes: ['wizard'], school: 'Evocation', desc: 'Create an invisible wall of force.' },
                'Wall of Stone': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'Create a stone wall.' }
            },

            // LEVEL 6 SPELLS
            level6: {
                'Blade Barrier': { classes: ['cleric'], school: 'Evocation', desc: 'Create a wall of whirling blades dealing 6d10 slashing.' },
                'Chain Lightning': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'Lightning arcs to 4 targets, dealing 10d8 lightning.' },
                'Circle of Death': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Necromancy', desc: 'Deal 8d6 necrotic in a 60-foot radius sphere.' },
                'Conjure Fey': { classes: ['druid', 'warlock'], school: 'Conjuration', desc: 'Summon a fey creature of CR 6 or lower.' },
                'Contingency': { classes: ['wizard'], school: 'Evocation', desc: 'Store a spell that triggers when conditions are met.' },
                'Create Undead': { classes: ['cleric', 'warlock', 'wizard'], school: 'Necromancy', desc: 'Create ghouls from corpses.' },
                'Disintegrate': { classes: ['sorcerer', 'wizard'], school: 'Transmutation', desc: 'Deal 10d6+40 force damage; reduce to ash if killed.' },
                'Eyebite': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Necromancy', desc: 'Your gaze can put creatures to sleep, panic them, or sicken them.' },
                'Find the Path': { classes: ['bard', 'cleric', 'druid'], school: 'Divination', desc: 'Know the shortest route to a specific location.' },
                'Flesh to Stone': { classes: ['warlock', 'wizard'], school: 'Transmutation', desc: 'Turn a creature to stone.' },
                'Globe of Invulnerability': { classes: ['sorcerer', 'wizard'], school: 'Abjuration', desc: 'Create a barrier that blocks spells of 5th level or lower.' },
                'Harm': { classes: ['cleric'], school: 'Necromancy', desc: 'Deal 14d6 necrotic damage.' },
                'Heal': { classes: ['cleric', 'druid'], school: 'Evocation', desc: 'Restore 70 hit points and cure conditions.' },
                'Heroes\' Feast': { classes: ['cleric', 'druid'], school: 'Conjuration', desc: 'Create a magnificent feast that provides powerful benefits.' },
                'Mass Suggestion': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'Suggest a course of activity to up to 12 creatures.' },
                'Move Earth': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Reshape terrain.' },
                'Otto\'s Irresistible Dance': { classes: ['bard', 'wizard'], school: 'Enchantment', desc: 'Force a creature to dance.' },
                'Programmed Illusion': { classes: ['bard', 'wizard'], school: 'Illusion', desc: 'Create an illusion that activates when triggered.' },
                'Sunbeam': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'A beam of light deals 6d8 radiant and blinds.' },
                'Transport via Plants': { classes: ['druid'], school: 'Conjuration', desc: 'Teleport from one plant to another.' },
                'True Seeing': { classes: ['bard', 'cleric', 'sorcerer', 'warlock', 'wizard'], school: 'Divination', desc: 'See through illusions, into the Ethereal Plane, and in darkness.' },
                'Wall of Ice': { classes: ['wizard'], school: 'Evocation', desc: 'Create a wall of ice panels.' },
                'Wall of Thorns': { classes: ['druid'], school: 'Conjuration', desc: 'Create a wall of thorny brush dealing 7d8 piercing.' },
                'Wind Walk': { classes: ['druid'], school: 'Transmutation', desc: 'Transform into gaseous form with 300-foot flying speed.' },
                'Word of Recall': { classes: ['cleric'], school: 'Conjuration', desc: 'Teleport to your sanctuary.' }
            },

            // LEVEL 7 SPELLS
            level7: {
                'Conjure Celestial': { classes: ['cleric'], school: 'Conjuration', desc: 'Summon a celestial of CR 4 or lower.' },
                'Delayed Blast Fireball': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'Create a bead of fire that can detonate for 12d6+ fire damage.' },
                'Divine Word': { classes: ['cleric'], school: 'Evocation', desc: 'Utter a divine word that can banish or kill creatures.' },
                'Etherealness': { classes: ['bard', 'cleric', 'sorcerer', 'warlock', 'wizard'], school: 'Transmutation', desc: 'Step into the Ethereal Plane.' },
                'Finger of Death': { classes: ['sorcerer', 'warlock', 'wizard'], school: 'Necromancy', desc: 'Deal 7d8+30 necrotic; humanoid killed rises as zombie.' },
                'Fire Storm': { classes: ['cleric', 'druid', 'sorcerer'], school: 'Evocation', desc: 'Flames deal 7d10 fire in a shaped area.' },
                'Forcecage': { classes: ['bard', 'warlock', 'wizard'], school: 'Evocation', desc: 'Create a prison of force.' },
                'Mirage Arcane': { classes: ['bard', 'druid', 'wizard'], school: 'Illusion', desc: 'Make terrain look like something else.' },
                'Mordenkainen\'s Magnificent Mansion': { classes: ['bard', 'wizard'], school: 'Conjuration', desc: 'Conjure an extradimensional dwelling.' },
                'Mordenkainen\'s Sword': { classes: ['bard', 'wizard'], school: 'Evocation', desc: 'Create a floating sword that attacks for 3d10 force.' },
                'Plane Shift': { classes: ['cleric', 'druid', 'sorcerer', 'warlock', 'wizard'], school: 'Conjuration', desc: 'Travel to another plane of existence.' },
                'Prismatic Spray': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'Eight multicolored rays with various effects.' },
                'Project Image': { classes: ['bard', 'wizard'], school: 'Illusion', desc: 'Create an illusory copy that you can speak through.' },
                'Regenerate': { classes: ['bard', 'cleric', 'druid'], school: 'Transmutation', desc: 'Restore 4d8+15 HP and regrow lost body parts.' },
                'Resurrection': { classes: ['bard', 'cleric'], school: 'Necromancy', desc: 'Return a creature dead up to 100 years to life.' },
                'Reverse Gravity': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Transmutation', desc: 'Reverse gravity in a cylinder.' },
                'Sequester': { classes: ['wizard'], school: 'Transmutation', desc: 'Hide a creature or object in stasis.' },
                'Simulacrum': { classes: ['wizard'], school: 'Illusion', desc: 'Create a duplicate of a creature.' },
                'Symbol': { classes: ['bard', 'cleric', 'wizard'], school: 'Abjuration', desc: 'Inscribe a glyph that triggers a harmful effect.' },
                'Teleport': { classes: ['bard', 'sorcerer', 'wizard'], school: 'Conjuration', desc: 'Teleport to a familiar location.' },
                'Whirlwind': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'Create a whirlwind dealing 10d6 bludgeoning.' }
            },

            // LEVEL 8 SPELLS
            level8: {
                'Antimagic Field': { classes: ['cleric', 'wizard'], school: 'Abjuration', desc: 'Create a sphere where magic doesn\'t function.' },
                'Antipathy/Sympathy': { classes: ['druid', 'wizard'], school: 'Enchantment', desc: 'Attract or repel creatures from an area or object.' },
                'Clone': { classes: ['wizard'], school: 'Necromancy', desc: 'Create a duplicate body for resurrection.' },
                'Control Weather': { classes: ['cleric', 'druid', 'wizard'], school: 'Transmutation', desc: 'Change the weather.' },
                'Demiplane': { classes: ['warlock', 'wizard'], school: 'Conjuration', desc: 'Create a door to an extradimensional space.' },
                'Dominate Monster': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'Take telepathic control of a creature.' },
                'Earthquake': { classes: ['cleric', 'druid', 'sorcerer'], school: 'Evocation', desc: 'Create a seismic disturbance.' },
                'Feeblemind': { classes: ['bard', 'druid', 'warlock', 'wizard'], school: 'Enchantment', desc: 'Blast a creature\'s mind, reducing INT and CHA to 1.' },
                'Glibness': { classes: ['bard', 'warlock'], school: 'Transmutation', desc: 'Your Charisma checks are minimum 15.' },
                'Holy Aura': { classes: ['cleric'], school: 'Abjuration', desc: 'Divine light protects allies and blinds attackers.' },
                'Incendiary Cloud': { classes: ['sorcerer', 'wizard'], school: 'Conjuration', desc: 'A cloud of smoke deals 10d8 fire damage.' },
                'Maze': { classes: ['wizard'], school: 'Conjuration', desc: 'Banish a creature to an extradimensional labyrinth.' },
                'Mind Blank': { classes: ['bard', 'wizard'], school: 'Abjuration', desc: 'A creature is immune to psychic damage and mental effects.' },
                'Power Word Stun': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'Stun a creature with 150 HP or fewer.' },
                'Sunburst': { classes: ['druid', 'sorcerer', 'wizard'], school: 'Evocation', desc: 'A burst of sunlight deals 12d6 radiant and blinds.' },
                'Telepathy': { classes: ['wizard'], school: 'Evocation', desc: 'Create a telepathic link with a creature.' },
                'Tsunami': { classes: ['druid'], school: 'Conjuration', desc: 'A wall of water sweeps through an area.' }
            },

            // LEVEL 9 SPELLS
            level9: {
                'Astral Projection': { classes: ['cleric', 'warlock', 'wizard'], school: 'Necromancy', desc: 'Project yourself to the Astral Plane.' },
                'Foresight': { classes: ['bard', 'druid', 'warlock', 'wizard'], school: 'Divination', desc: 'A creature can\'t be surprised and has advantage on everything.' },
                'Gate': { classes: ['cleric', 'sorcerer', 'wizard'], school: 'Conjuration', desc: 'Open a portal to another plane.' },
                'Imprisonment': { classes: ['warlock', 'wizard'], school: 'Abjuration', desc: 'Magically imprison a creature.' },
                'Mass Heal': { classes: ['cleric'], school: 'Evocation', desc: 'Restore up to 700 HP among creatures.' },
                'Meteor Swarm': { classes: ['sorcerer', 'wizard'], school: 'Evocation', desc: 'Four meteors deal 40d6 fire in 40-foot radius each.' },
                'Power Word Heal': { classes: ['bard'], school: 'Evocation', desc: 'Heal a creature to full HP.' },
                'Power Word Kill': { classes: ['bard', 'sorcerer', 'warlock', 'wizard'], school: 'Enchantment', desc: 'Kill a creature with 100 HP or fewer.' },
                'Prismatic Wall': { classes: ['wizard'], school: 'Abjuration', desc: 'Create a wall of seven colors with various effects.' },
                'Shapechange': { classes: ['druid', 'wizard'], school: 'Transmutation', desc: 'Transform into any creature of your level or lower.' },
                'Storm of Vengeance': { classes: ['druid'], school: 'Conjuration', desc: 'Create a devastating storm.' },
                'Time Stop': { classes: ['sorcerer', 'wizard'], school: 'Transmutation', desc: 'Take 1d4+1 extra turns.' },
                'True Polymorph': { classes: ['bard', 'warlock', 'wizard'], school: 'Transmutation', desc: 'Transform a creature or object into another creature or object.' },
                'True Resurrection': { classes: ['cleric', 'druid'], school: 'Necromancy', desc: 'Restore a creature dead up to 200 years to full life.' },
                'Weird': { classes: ['wizard'], school: 'Illusion', desc: 'Create phantasmal nightmares for multiple creatures.' },
                'Wish': { classes: ['sorcerer', 'wizard'], school: 'Conjuration', desc: 'The most powerful spell; duplicate any other spell or grant a wish.' }
            }
        };

        // ===== WEAPON LISTS =====
        const WEAPONS = {
            simple_melee: ['Club', 'Dagger', 'Greatclub', 'Handaxe', 'Javelin', 'Light hammer', 'Mace', 'Quarterstaff', 'Sickle', 'Spear'],
            simple_ranged: ['Light crossbow', 'Dart', 'Shortbow', 'Sling'],
            martial_melee: ['Battleaxe', 'Flail', 'Glaive', 'Greataxe', 'Greatsword', 'Halberd', 'Lance', 'Longsword', 'Maul', 'Morningstar', 'Pike', 'Rapier', 'Scimitar', 'Shortsword', 'Trident', 'War pick', 'Warhammer', 'Whip'],
            martial_ranged: ['Blowgun', 'Hand crossbow', 'Heavy crossbow', 'Longbow', 'Net'],
            instruments: ['Bagpipes', 'Drum', 'Dulcimer', 'Flute', 'Lute', 'Lyre', 'Horn', 'Pan flute', 'Shawm', 'Viol']
        };

        // ===== EQUIPMENT DATA =====
        const EQUIPMENT = {
            barbarian: {
                choices: [
                    { name: 'Primary Weapon', options: ['Greataxe', 'Greatsword', 'Maul', 'Glaive', 'Halberd', 'Battleaxe', 'Longsword', 'Warhammer', 'Flail'] },
                    { name: 'Shield', options: ['Shield (+2 AC)', 'No shield (two-handed weapon)'] },
                    { name: 'Secondary Weapons', options: ['Two handaxes', 'Two javelins', 'Two light hammers', 'Handaxe', 'Javelin'] }
                ],
                granted: ['Explorer\'s pack', '4 javelins']
            },
            bard: {
                choices: [
                    { name: 'Primary Weapon', options: ['Rapier', 'Longsword', 'Shortsword', 'Dagger', 'Quarterstaff'] },
                    { name: 'Shield', options: ['Shield (+2 AC)', 'No shield (free hand for spellcasting)'] },
                    { name: 'Secondary Weapon', options: ['Light crossbow and 20 bolts', 'Dagger', 'Shortsword', 'Handaxe'] },
                    { name: 'Pack', options: ['Diplomat\'s pack', 'Entertainer\'s pack'] },
                    { name: 'Instrument', options: ['Lute', 'Lyre', 'Flute', 'Drum', 'Viol', 'Bagpipes', 'Horn', 'Pan flute'] }
                ],
                granted: ['Leather armor']
            },
            cleric: {
                choices: [
                    { name: 'Weapon', options: ['Mace', 'Warhammer (if proficient)', 'Light crossbow and 20 bolts', 'Quarterstaff', 'Club'] },
                    { name: 'Armor', options: ['Scale mail (AC 14+Dex max 2)', 'Leather armor (AC 11+Dex)', 'Chain mail (AC 16, if proficient)'] },
                    { name: 'Shield', options: ['Shield (+2 AC)', 'No shield (free hand)'] },
                    { name: 'Pack', options: ['Priest\'s pack', 'Explorer\'s pack'] }
                ],
                granted: ['Holy symbol']
            },
            druid: {
                choices: [
                    { name: 'Primary Weapon', options: ['Scimitar', 'Quarterstaff', 'Club', 'Dagger', 'Sickle', 'Spear'] },
                    { name: 'Shield', options: ['Wooden shield (+2 AC)', 'No shield (free hand)'] },
                    { name: 'Secondary Weapon', options: ['Scimitar', 'Club', 'Dagger', 'Quarterstaff', 'Sickle', 'Spear'] },
                    { name: 'Focus', options: ['Druidic focus (sprig of mistletoe)', 'Druidic focus (totem)', 'Druidic focus (wooden staff)', 'Druidic focus (yew wand)'] }
                ],
                granted: ['Leather armor', 'Explorer\'s pack']
            },
            fighter: {
                choices: [
                    { name: 'Armor', options: ['Chain mail (AC 16)', 'Leather armor (AC 11+Dex)'] },
                    { name: 'Primary Weapon', options: ['Longsword', 'Battleaxe', 'Warhammer', 'Rapier', 'Flail', 'Morningstar', 'War pick', 'Greatsword', 'Greataxe', 'Maul', 'Glaive', 'Halberd', 'Pike'] },
                    { name: 'Shield', options: ['Shield (+2 AC)', 'No shield (two-handed or dual wield)'] },
                    { name: 'Secondary Weapon', options: ['Light crossbow and 20 bolts', 'Longbow and 20 arrows', 'Two handaxes', 'Two javelins', 'Shortsword', 'Handaxe', 'Pistol and 10 bullets', 'Musket and 10 bullets'] },
                    { name: 'Pack', options: ['Dungeoneer\'s pack', 'Explorer\'s pack'] }
                ],
                granted: []
            },
            monk: {
                choices: [
                    { name: 'Weapon', options: ['Shortsword', 'Quarterstaff', 'Spear', 'Club', 'Dagger', 'Handaxe', 'Javelin', 'Light hammer', 'Mace', 'Sickle'] },
                    { name: 'Pack', options: ['Dungeoneer\'s pack', 'Explorer\'s pack'] }
                ],
                granted: ['10 darts']
            },
            paladin: {
                choices: [
                    { name: 'Primary Weapon', options: ['Longsword', 'Battleaxe', 'Warhammer', 'Rapier', 'Flail', 'Morningstar', 'Greatsword', 'Greataxe', 'Maul', 'Glaive', 'Halberd'] },
                    { name: 'Shield', options: ['Shield (+2 AC)', 'No shield (two-handed weapon)'] },
                    { name: 'Secondary', options: ['5 javelins', 'Mace', 'Quarterstaff', 'Handaxe', 'Light hammer', 'Spear'] },
                    { name: 'Pack', options: ['Priest\'s pack', 'Explorer\'s pack'] }
                ],
                granted: ['Chain mail', 'Holy symbol']
            },
            ranger: {
                choices: [
                    { name: 'Armor', options: ['Scale mail (AC 14+Dex max 2)', 'Leather armor (AC 11+Dex)'] },
                    { name: 'Primary Weapon', options: ['Shortsword', 'Scimitar', 'Longsword', 'Rapier', 'Handaxe', 'Quarterstaff'] },
                    { name: 'Shield', options: ['Shield (+2 AC)', 'No shield (dual wield or two-handed)'] },
                    { name: 'Secondary Weapon', options: ['Shortsword', 'Scimitar', 'Two daggers', 'Handaxe'] },
                    { name: 'Ranged Weapon', options: ['Longbow and 20 arrows', 'Musket and 10 bullets', 'Pistol and 10 bullets'] },
                    { name: 'Pack', options: ['Dungeoneer\'s pack', 'Explorer\'s pack'] }
                ],
                granted: []
            },
            rogue: {
                choices: [
                    { name: 'Primary Weapon', options: ['Rapier', 'Shortsword', 'Scimitar'] },
                    { name: 'Secondary', options: ['Shortbow and quiver of 20 arrows', 'Shortsword', 'Pistol and 10 bullets'] },
                    { name: 'Pack', options: ['Burglar\'s pack', 'Dungeoneer\'s pack', 'Explorer\'s pack'] }
                ],
                granted: ['Leather armor', 'Two daggers', 'Thieves\' tools']
            },
            sorcerer: {
                choices: [
                    { name: 'Weapon', options: ['Light crossbow and 20 bolts', 'Quarterstaff', 'Dagger', 'Dart', 'Sling'] },
                    { name: 'Focus', options: ['Component pouch', 'Arcane focus (crystal)', 'Arcane focus (orb)', 'Arcane focus (rod)', 'Arcane focus (staff)', 'Arcane focus (wand)'] },
                    { name: 'Pack', options: ['Dungeoneer\'s pack', 'Explorer\'s pack'] }
                ],
                granted: ['Two daggers']
            },
            warlock: {
                choices: [
                    { name: 'Primary Weapon', options: ['Light crossbow and 20 bolts', 'Quarterstaff', 'Dagger', 'Club', 'Handaxe', 'Javelin', 'Mace', 'Spear', 'Sickle'] },
                    { name: 'Secondary Weapon', options: ['Dagger', 'Club', 'Handaxe', 'Quarterstaff', 'Sickle'] },
                    { name: 'Focus', options: ['Component pouch', 'Arcane focus (crystal)', 'Arcane focus (orb)', 'Arcane focus (rod)', 'Arcane focus (staff)', 'Arcane focus (wand)'] },
                    { name: 'Pack', options: ['Scholar\'s pack', 'Dungeoneer\'s pack'] }
                ],
                granted: ['Leather armor', 'Two daggers']
            },
            wizard: {
                choices: [
                    { name: 'Weapon', options: ['Quarterstaff', 'Dagger'] },
                    { name: 'Focus', options: ['Component pouch', 'Arcane focus (crystal)', 'Arcane focus (orb)', 'Arcane focus (rod)', 'Arcane focus (staff)', 'Arcane focus (wand)'] },
                    { name: 'Pack', options: ['Scholar\'s pack', 'Explorer\'s pack'] }
                ],
                granted: ['Spellbook']
            }
        };

        // Spellcasting class info
        const SPELLCASTING = {
            bard: { ability: 'CHA', type: 'full' },
            cleric: { ability: 'WIS', type: 'full', prepared: true },
            druid: { ability: 'WIS', type: 'full', prepared: true },
            paladin: { ability: 'CHA', type: 'half', startLevel: 2, prepared: true },
            ranger: { ability: 'WIS', type: 'half', startLevel: 2 },
            sorcerer: { ability: 'CHA', type: 'full' },
            warlock: { ability: 'CHA', type: 'pact' },
            wizard: { ability: 'INT', type: 'full', prepared: true }
        };

        // Class-specific cantrip progression (per D&D 5e PHB)
        const CLASS_CANTRIPS = {
            bard:     { 1: 2, 2: 2, 3: 2, 4: 3, 5: 3, 6: 3, 7: 3, 8: 3, 9: 3, 10: 4, 11: 4, 12: 4, 13: 4, 14: 4, 15: 4, 16: 4, 17: 4, 18: 4, 19: 4, 20: 4 },
            cleric:   { 1: 3, 2: 3, 3: 3, 4: 4, 5: 4, 6: 4, 7: 4, 8: 4, 9: 4, 10: 5, 11: 5, 12: 5, 13: 5, 14: 5, 15: 5, 16: 5, 17: 5, 18: 5, 19: 5, 20: 5 },
            druid:    { 1: 2, 2: 2, 3: 2, 4: 3, 5: 3, 6: 3, 7: 3, 8: 3, 9: 3, 10: 4, 11: 4, 12: 4, 13: 4, 14: 4, 15: 4, 16: 4, 17: 4, 18: 4, 19: 4, 20: 4 },
            sorcerer: { 1: 4, 2: 4, 3: 4, 4: 5, 5: 5, 6: 5, 7: 5, 8: 5, 9: 5, 10: 6, 11: 6, 12: 6, 13: 6, 14: 6, 15: 6, 16: 6, 17: 6, 18: 6, 19: 6, 20: 6 },
            wizard:   { 1: 3, 2: 3, 3: 3, 4: 4, 5: 4, 6: 4, 7: 4, 8: 4, 9: 4, 10: 5, 11: 5, 12: 5, 13: 5, 14: 5, 15: 5, 16: 5, 17: 5, 18: 5, 19: 5, 20: 5 }
        };

        // Class-specific spells known progression (per D&D 5e PHB)
        // Only for "spells known" casters - prepared casters calculate from level + ability mod
        const CLASS_SPELLS_KNOWN = {
            bard:     { 1: 4, 2: 5, 3: 6, 4: 7, 5: 8, 6: 9, 7: 10, 8: 11, 9: 12, 10: 14, 11: 15, 12: 15, 13: 16, 14: 18, 15: 19, 16: 19, 17: 20, 18: 22, 19: 22, 20: 22 },
            sorcerer: { 1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 6: 7, 7: 8, 8: 9, 9: 10, 10: 11, 11: 12, 12: 12, 13: 13, 14: 13, 15: 14, 16: 14, 17: 15, 18: 15, 19: 15, 20: 15 },
            ranger:   { 2: 2, 3: 3, 4: 3, 5: 4, 6: 4, 7: 5, 8: 5, 9: 6, 10: 6, 11: 7, 12: 7, 13: 8, 14: 8, 15: 9, 16: 9, 17: 10, 18: 10, 19: 11, 20: 11 }
        };

        // Spell slot progression for full casters (bard, cleric, druid, sorcerer, wizard)
        // Note: cantrips field here is legacy/fallback - use CLASS_CANTRIPS for accurate counts
        const FULL_CASTER_SLOTS = {
            1:  { cantrips: 3, slots: [2,0,0,0,0,0,0,0,0], spellsKnown: 4 },
            2:  { cantrips: 3, slots: [3,0,0,0,0,0,0,0,0], spellsKnown: 5 },
            3:  { cantrips: 3, slots: [4,2,0,0,0,0,0,0,0], spellsKnown: 6 },
            4:  { cantrips: 4, slots: [4,3,0,0,0,0,0,0,0], spellsKnown: 7 },
            5:  { cantrips: 4, slots: [4,3,2,0,0,0,0,0,0], spellsKnown: 8 },
            6:  { cantrips: 4, slots: [4,3,3,0,0,0,0,0,0], spellsKnown: 9 },
            7:  { cantrips: 4, slots: [4,3,3,1,0,0,0,0,0], spellsKnown: 10 },
            8:  { cantrips: 4, slots: [4,3,3,2,0,0,0,0,0], spellsKnown: 11 },
            9:  { cantrips: 4, slots: [4,3,3,3,1,0,0,0,0], spellsKnown: 12 },
            10: { cantrips: 5, slots: [4,3,3,3,2,0,0,0,0], spellsKnown: 14 },
            11: { cantrips: 5, slots: [4,3,3,3,2,1,0,0,0], spellsKnown: 15 },
            12: { cantrips: 5, slots: [4,3,3,3,2,1,0,0,0], spellsKnown: 15 },
            13: { cantrips: 5, slots: [4,3,3,3,2,1,1,0,0], spellsKnown: 16 },
            14: { cantrips: 5, slots: [4,3,3,3,2,1,1,0,0], spellsKnown: 18 },
            15: { cantrips: 5, slots: [4,3,3,3,2,1,1,1,0], spellsKnown: 19 },
            16: { cantrips: 5, slots: [4,3,3,3,2,1,1,1,0], spellsKnown: 19 },
            17: { cantrips: 5, slots: [4,3,3,3,2,1,1,1,1], spellsKnown: 20 },
            18: { cantrips: 5, slots: [4,3,3,3,3,1,1,1,1], spellsKnown: 22 },
            19: { cantrips: 5, slots: [4,3,3,3,3,2,1,1,1], spellsKnown: 22 },
            20: { cantrips: 5, slots: [4,3,3,3,3,2,2,1,1], spellsKnown: 22 }
        };

        // Half caster progression (paladin, ranger) - uses caster level = class level / 2
        const HALF_CASTER_SLOTS = {
            2:  { cantrips: 0, slots: [2,0,0,0,0], spellsKnown: 2 },
            3:  { cantrips: 0, slots: [3,0,0,0,0], spellsKnown: 3 },
            4:  { cantrips: 0, slots: [3,0,0,0,0], spellsKnown: 3 },
            5:  { cantrips: 0, slots: [4,2,0,0,0], spellsKnown: 4 },
            6:  { cantrips: 0, slots: [4,2,0,0,0], spellsKnown: 4 },
            7:  { cantrips: 0, slots: [4,3,0,0,0], spellsKnown: 5 },
            8:  { cantrips: 0, slots: [4,3,0,0,0], spellsKnown: 5 },
            9:  { cantrips: 0, slots: [4,3,2,0,0], spellsKnown: 6 },
            10: { cantrips: 0, slots: [4,3,2,0,0], spellsKnown: 6 },
            11: { cantrips: 0, slots: [4,3,3,0,0], spellsKnown: 7 },
            12: { cantrips: 0, slots: [4,3,3,0,0], spellsKnown: 7 },
            13: { cantrips: 0, slots: [4,3,3,1,0], spellsKnown: 8 },
            14: { cantrips: 0, slots: [4,3,3,1,0], spellsKnown: 8 },
            15: { cantrips: 0, slots: [4,3,3,2,0], spellsKnown: 9 },
            16: { cantrips: 0, slots: [4,3,3,2,0], spellsKnown: 9 },
            17: { cantrips: 0, slots: [4,3,3,3,1], spellsKnown: 10 },
            18: { cantrips: 0, slots: [4,3,3,3,1], spellsKnown: 10 },
            19: { cantrips: 0, slots: [4,3,3,3,2], spellsKnown: 11 },
            20: { cantrips: 0, slots: [4,3,3,3,2], spellsKnown: 11 }
        };

        // Warlock pact magic progression
        const WARLOCK_SLOTS = {
            1:  { cantrips: 2, slots: 1, slotLevel: 1, spellsKnown: 2, invocations: 0 },
            2:  { cantrips: 2, slots: 2, slotLevel: 1, spellsKnown: 3, invocations: 2 },
            3:  { cantrips: 2, slots: 2, slotLevel: 2, spellsKnown: 4, invocations: 2 },
            4:  { cantrips: 3, slots: 2, slotLevel: 2, spellsKnown: 5, invocations: 2 },
            5:  { cantrips: 3, slots: 2, slotLevel: 3, spellsKnown: 6, invocations: 3 },
            6:  { cantrips: 3, slots: 2, slotLevel: 3, spellsKnown: 7, invocations: 3 },
            7:  { cantrips: 3, slots: 2, slotLevel: 4, spellsKnown: 8, invocations: 4 },
            8:  { cantrips: 3, slots: 2, slotLevel: 4, spellsKnown: 9, invocations: 4 },
            9:  { cantrips: 3, slots: 2, slotLevel: 5, spellsKnown: 10, invocations: 5 },
            10: { cantrips: 4, slots: 2, slotLevel: 5, spellsKnown: 10, invocations: 5 },
            11: { cantrips: 4, slots: 3, slotLevel: 5, spellsKnown: 11, invocations: 5 },
            12: { cantrips: 4, slots: 3, slotLevel: 5, spellsKnown: 11, invocations: 6 },
            13: { cantrips: 4, slots: 3, slotLevel: 5, spellsKnown: 12, invocations: 6 },
            14: { cantrips: 4, slots: 3, slotLevel: 5, spellsKnown: 12, invocations: 6 },
            15: { cantrips: 4, slots: 3, slotLevel: 5, spellsKnown: 13, invocations: 7 },
            16: { cantrips: 4, slots: 3, slotLevel: 5, spellsKnown: 13, invocations: 7 },
            17: { cantrips: 4, slots: 4, slotLevel: 5, spellsKnown: 14, invocations: 7 },
            18: { cantrips: 4, slots: 4, slotLevel: 5, spellsKnown: 14, invocations: 8 },
            19: { cantrips: 4, slots: 4, slotLevel: 5, spellsKnown: 15, invocations: 8 },
            20: { cantrips: 4, slots: 4, slotLevel: 5, spellsKnown: 15, invocations: 8 }
        };

        // Get max spell level for a class at a given character level
        function getMaxSpellLevel(cls, level) {
            const spellInfo = SPELLCASTING[cls];
            if (!spellInfo) return 0;

            if (spellInfo.startLevel && level < spellInfo.startLevel) return 0;

            if (spellInfo.type === 'full') {
                if (level >= 17) return 9;
                if (level >= 15) return 8;
                if (level >= 13) return 7;
                if (level >= 11) return 6;
                if (level >= 9) return 5;
                if (level >= 7) return 4;
                if (level >= 5) return 3;
                if (level >= 3) return 2;
                return 1;
            } else if (spellInfo.type === 'half') {
                if (level >= 17) return 5;
                if (level >= 13) return 4;
                if (level >= 9) return 3;
                if (level >= 5) return 2;
                return 1;
            } else if (spellInfo.type === 'pact') {
                // Warlock: max spell level = slot level from table
                return WARLOCK_SLOTS[level].slotLevel;
            }
            return 0;
        }

        // Get spell progression data for a class at a given level
        function getSpellProgression(cls, level) {
            const spellInfo = SPELLCASTING[cls];
            if (!spellInfo) return null;

            if (spellInfo.startLevel && level < spellInfo.startLevel) return null;

            if (spellInfo.type === 'full') {
                const baseProgression = FULL_CASTER_SLOTS[level];
                // Use class-specific cantrip and spells known counts
                const classCantrips = CLASS_CANTRIPS[cls] ? CLASS_CANTRIPS[cls][level] : baseProgression.cantrips;
                const classSpellsKnown = CLASS_SPELLS_KNOWN[cls] ? CLASS_SPELLS_KNOWN[cls][level] : baseProgression.spellsKnown;
                return { ...baseProgression, cantrips: classCantrips, spellsKnown: classSpellsKnown };
            } else if (spellInfo.type === 'half') {
                const baseProgression = HALF_CASTER_SLOTS[level] || HALF_CASTER_SLOTS[2];
                // Use class-specific spells known for ranger
                const classSpellsKnown = CLASS_SPELLS_KNOWN[cls] ? CLASS_SPELLS_KNOWN[cls][level] : baseProgression.spellsKnown;
                return { ...baseProgression, spellsKnown: classSpellsKnown };
            } else if (spellInfo.type === 'pact') {
                return WARLOCK_SLOTS[level];
            }
            return null;
        }

        // ===== FEATS DATA =====
        const FEATS = {
            // PHB Feats
            alert: {
                name: 'Alert',
                desc: '+5 to initiative, can\'t be surprised while conscious, hidden creatures don\'t gain advantage on attacks against you.',
                prereq: null
            },
            athlete: {
                name: 'Athlete',
                desc: '+1 STR or DEX. Standing from prone costs only 5 feet. Climbing doesn\'t cost extra movement. Running jump with only 5 feet movement.',
                prereq: null,
                asiChoice: ['STR', 'DEX']
            },
            actor: {
                name: 'Actor',
                desc: '+1 CHA. Advantage on Deception and Performance to pass as someone else. Mimic speech or sounds.',
                prereq: null,
                asiBonus: { CHA: 1 }
            },
            charger: {
                name: 'Charger',
                desc: 'When you Dash, use bonus action to make one melee attack with +5 damage or shove 10 feet.',
                prereq: null
            },
            crossbowExpert: {
                name: 'Crossbow Expert',
                desc: 'Ignore loading on crossbows. No disadvantage at close range. Bonus action attack with hand crossbow after one-handed attack.',
                prereq: null
            },
            defensiveDuelist: {
                name: 'Defensive Duelist',
                desc: 'When wielding a finesse weapon and hit by melee attack, use reaction to add proficiency bonus to AC.',
                prereq: { DEX: 13 }
            },
            dualWielder: {
                name: 'Dual Wielder',
                desc: '+1 AC while dual wielding. Use two-weapon fighting with non-light weapons. Draw two weapons at once.',
                prereq: null
            },
            dungeonDelver: {
                name: 'Dungeon Delver',
                desc: 'Advantage to detect secret doors. Advantage on saves vs traps. Resistance to trap damage. Search for traps at normal pace.',
                prereq: null
            },
            durable: {
                name: 'Durable',
                desc: '+1 CON. When rolling Hit Dice to regain HP, minimum roll equals twice your CON modifier.',
                prereq: null,
                asiBonus: { CON: 1 }
            },
            elementalAdept: {
                name: 'Elemental Adept',
                desc: 'Choose a damage type (acid, cold, fire, lightning, thunder). Spells ignore resistance. Treat 1s as 2s on damage dice.',
                prereq: { spellcasting: true }
            },
            grappler: {
                name: 'Grappler',
                desc: 'Advantage on attacks against creatures you\'re grappling. Can pin creatures (both restrained).',
                prereq: { STR: 13 }
            },
            greatWeaponMaster: {
                name: 'Great Weapon Master',
                desc: 'On crit or kill with heavy weapon, bonus action melee attack. Take -5 to hit for +10 damage.',
                prereq: null
            },
            healer: {
                name: 'Healer',
                desc: 'Stabilize with healer\'s kit and restore 1 HP. Use healer\'s kit to restore 1d6+4+creature\'s max HD once per rest.',
                prereq: null
            },
            heavilyArmored: {
                name: 'Heavily Armored',
                desc: '+1 STR. Gain proficiency with heavy armor.',
                prereq: { armorProf: 'medium' },
                asiBonus: { STR: 1 }
            },
            heavyArmorMaster: {
                name: 'Heavy Armor Master',
                desc: '+1 STR. While wearing heavy armor, reduce bludgeoning/piercing/slashing from nonmagical weapons by 3.',
                prereq: { armorProf: 'heavy' },
                asiBonus: { STR: 1 }
            },
            inspringLeader: {
                name: 'Inspiring Leader',
                desc: 'Spend 10 minutes to give up to 6 creatures temp HP equal to your level + CHA modifier.',
                prereq: { CHA: 13 }
            },
            keenMind: {
                name: 'Keen Mind',
                desc: '+1 INT. Always know which way is north, hours until sunrise/sunset. Recall anything from past month.',
                prereq: null,
                asiBonus: { INT: 1 }
            },
            lightlyArmored: {
                name: 'Lightly Armored',
                desc: '+1 STR or DEX. Gain proficiency with light armor.',
                prereq: null,
                asiChoice: ['STR', 'DEX']
            },
            linguist: {
                name: 'Linguist',
                desc: '+1 INT. Learn 3 languages. Create written ciphers.',
                prereq: null,
                asiBonus: { INT: 1 }
            },
            lucky: {
                name: 'Lucky',
                desc: '3 luck points per long rest. Spend to reroll any d20 (yours or attacking you) and choose which to use.',
                prereq: null
            },
            mageSlayer: {
                name: 'Mage Slayer',
                desc: 'Reaction attack when adjacent creature casts spell. Advantage on saves vs spells from adjacent. Concentration disadvantage.',
                prereq: null
            },
            magicInitiate: {
                name: 'Magic Initiate',
                desc: 'Learn 2 cantrips and 1 first-level spell from bard, cleric, druid, sorcerer, warlock, or wizard list.',
                prereq: null,
                grantsSpells: { cantrips: 2, level1: 1, lists: ['bard', 'cleric', 'druid', 'sorcerer', 'warlock', 'wizard'] }
            },
            martialAdept: {
                name: 'Martial Adept',
                desc: 'Learn 2 Battle Master maneuvers. Gain one d6 superiority die per short rest.',
                prereq: null
            },
            mediumArmorMaster: {
                name: 'Medium Armor Master',
                desc: 'Medium armor doesn\'t impose disadvantage on Stealth. Max DEX bonus in medium armor is +3 instead of +2.',
                prereq: { armorProf: 'medium' }
            },
            mobile: {
                name: 'Mobile',
                desc: '+10 feet speed. Dash through difficult terrain costs no extra. No opportunity attacks from creatures you attacked.',
                prereq: null
            },
            moderatelyArmored: {
                name: 'Moderately Armored',
                desc: '+1 STR or DEX. Gain proficiency with medium armor and shields.',
                prereq: { armorProf: 'light' },
                asiChoice: ['STR', 'DEX']
            },
            mountedCombatant: {
                name: 'Mounted Combatant',
                desc: 'Advantage on melee vs unmounted smaller creatures. Force attacks to target you instead of mount. Mount takes no/half damage on DEX saves.',
                prereq: null
            },
            observant: {
                name: 'Observant',
                desc: '+1 INT or WIS. +5 to passive Perception and Investigation. Read lips if you understand the language.',
                prereq: null,
                asiChoice: ['INT', 'WIS']
            },
            polearmMaster: {
                name: 'Polearm Master',
                desc: 'Bonus action attack (1d4) with butt end of glaive/halberd/quarterstaff/spear. Opportunity attack when creatures enter reach.',
                prereq: null
            },
            resilient: {
                name: 'Resilient',
                desc: '+1 to chosen ability score. Gain proficiency in saving throws for that ability.',
                prereq: null,
                asiChoice: ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA']
            },
            ritualCaster: {
                name: 'Ritual Caster',
                desc: 'Acquire a ritual book with two 1st-level ritual spells. Cast those as rituals. Can add more rituals found.',
                prereq: { INT: 13, WIS: 13, prereqType: 'or' }
            },
            savageAttacker: {
                name: 'Savage Attacker',
                desc: 'Once per turn, reroll melee weapon damage dice and use either total.',
                prereq: null
            },
            sentinel: {
                name: 'Sentinel',
                desc: 'Opportunity attacks reduce speed to 0. Creatures in reach provoke even if Disengage. Reaction attack when ally is attacked.',
                prereq: null
            },
            sharpshooter: {
                name: 'Sharpshooter',
                desc: 'No disadvantage at long range. Ignore half and three-quarters cover. Take -5 to hit for +10 damage with ranged.',
                prereq: null
            },
            shieldMaster: {
                name: 'Shield Master',
                desc: 'Bonus action shove after Attack. Add shield AC to DEX saves vs single target. On successful DEX save, take no damage.',
                prereq: null
            },
            skilled: {
                name: 'Skilled',
                desc: 'Gain proficiency in any combination of three skills or tools.',
                prereq: null
            },
            skulker: {
                name: 'Skulker',
                desc: 'Hide when lightly obscured. Missing ranged doesn\'t reveal position. No disadvantage on Perception in dim light.',
                prereq: { DEX: 13 }
            },
            spellSniper: {
                name: 'Spell Sniper',
                desc: 'Double range on attack roll spells. Ignore half and three-quarters cover. Learn one attack cantrip.',
                prereq: { spellcasting: true }
            },
            tavernBrawler: {
                name: 'Tavern Brawler',
                desc: '+1 STR or CON. Proficient with improvised weapons. Unarmed deals 1d4. Bonus action grapple after unarmed/improvised hit.',
                prereq: null,
                asiChoice: ['STR', 'CON']
            },
            tough: {
                name: 'Tough',
                desc: 'HP maximum increases by 2 for every level you have.',
                prereq: null
            },
            warCaster: {
                name: 'War Caster',
                desc: 'Advantage on CON saves for concentration. Perform somatic components with full hands. Cast spell as opportunity attack.',
                prereq: { spellcasting: true }
            },
            weaponMaster: {
                name: 'Weapon Master',
                desc: '+1 STR or DEX. Gain proficiency with four weapons of your choice.',
                prereq: null,
                asiChoice: ['STR', 'DEX']
            },
            // Tasha's Feats
            artificerInitiate: {
                name: 'Artificer Initiate',
                desc: 'Learn one artificer cantrip and one 1st-level artificer spell. Cast spell once per long rest or with spell slots.',
                prereq: null
            },
            chef: {
                name: 'Chef',
                desc: '+1 CON or WIS. Proficiency with cook\'s utensils. Create treats that grant temp HP. Special food grants extra healing.',
                prereq: null,
                asiChoice: ['CON', 'WIS']
            },
            crusher: {
                name: 'Crusher',
                desc: '+1 STR or CON. Move creature 5 feet on bludgeoning hit. Crit grants advantage on attacks against target until your next turn.',
                prereq: null,
                asiChoice: ['STR', 'CON']
            },
            eldritchAdept: {
                name: 'Eldritch Adept',
                desc: 'Learn one Eldritch Invocation. Can replace on level up.',
                prereq: { spellcasting: true, prereqType: 'or', pactMagic: true }
            },
            feyTouched: {
                name: 'Fey Touched',
                desc: '+1 INT, WIS, or CHA. Learn Misty Step and one 1st-level divination/enchantment spell. Cast each once per long rest free.',
                prereq: null,
                asiChoice: ['INT', 'WIS', 'CHA'],
                grantsSpells: { fixed: ['Misty Step'], level1: 1, schools: ['Divination', 'Enchantment'] }
            },
            fightingInitiate: {
                name: 'Fighting Initiate',
                desc: 'Learn one Fighting Style from the fighter class.',
                prereq: { weaponProf: 'martial' }
            },
            gunner: {
                name: 'Gunner',
                desc: '+1 DEX. Proficiency with firearms. Ignore loading. No disadvantage at close range.',
                prereq: null,
                asiBonus: { DEX: 1 }
            },
            metamagicAdept: {
                name: 'Metamagic Adept',
                desc: 'Learn two Metamagic options. Gain 2 sorcery points for Metamagic only.',
                prereq: { spellcasting: true }
            },
            piercer: {
                name: 'Piercer',
                desc: '+1 STR or DEX. Reroll one piercing damage die once per turn. Extra damage die on crit.',
                prereq: null,
                asiChoice: ['STR', 'DEX']
            },
            poisoner: {
                name: 'Poisoner',
                desc: 'Ignore poison resistance. Apply poison as bonus action. Proficiency with poisoner\'s kit. Create potent poison.',
                prereq: null
            },
            shadowTouched: {
                name: 'Shadow Touched',
                desc: '+1 INT, WIS, or CHA. Learn Invisibility and one 1st-level illusion/necromancy spell. Cast each once per long rest free.',
                prereq: null,
                asiChoice: ['INT', 'WIS', 'CHA'],
                grantsSpells: { fixed: ['Invisibility'], level1: 1, schools: ['Illusion', 'Necromancy'] }
            },
            skillExpert: {
                name: 'Skill Expert',
                desc: '+1 to any ability. Gain one skill proficiency. Double proficiency bonus for one skill you\'re proficient in.',
                prereq: null,
                asiChoice: ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA']
            },
            slasher: {
                name: 'Slasher',
                desc: '+1 STR or DEX. Reduce speed by 10 on slashing hit. Crit gives disadvantage on attacks until start of your next turn.',
                prereq: null,
                asiChoice: ['STR', 'DEX']
            },
            telekinetic: {
                name: 'Telekinetic',
                desc: '+1 INT, WIS, or CHA. Learn Mage Hand (invisible, bonus action). Bonus action to shove creature 5 feet.',
                prereq: null,
                asiChoice: ['INT', 'WIS', 'CHA']
            },
            telepathic: {
                name: 'Telepathic',
                desc: '+1 INT, WIS, or CHA. Speak telepathically to creatures within 60 feet. Cast Detect Thoughts once per long rest.',
                prereq: null,
                asiChoice: ['INT', 'WIS', 'CHA']
            }
        };

        // ASI levels by class (most classes get ASI at 4, 8, 12, 16, 19)
        const ASI_LEVELS = {
            default: [4, 8, 12, 16, 19],
            fighter: [4, 6, 8, 12, 14, 16, 19],
            rogue: [4, 8, 10, 12, 16, 19]
        };

        // ===== BACKGROUNDS DATA =====
        const BACKGROUNDS = {
            acolyte: {
                name: 'Acolyte',
                icon: 'ðŸ™',
                skills: ['Insight', 'Religion'],
                tools: [],
                languages: 2,
                feature: 'Shelter of the Faithful',
                featureDesc: 'You and your companions can expect free healing and care at temples of your faith.',
                equipment: 'Holy symbol, prayer book or wheel, 5 sticks of incense, vestments, common clothes, pouch with 15 gp',
                traits: [
                    'I idolize a particular hero of my faith.',
                    'I can find common ground between enemies and become friends.',
                    'I see omens in every event and action.',
                    'Nothing can shake my optimistic attitude.',
                    'I quote sacred texts in almost every situation.',
                    'I am tolerant of other faiths and respect others\' worship.'
                ],
                ideals: [
                    'Tradition - Ancient traditions must be preserved. (Lawful)',
                    'Charity - I always help those in need. (Good)',
                    'Change - We must help bring about changes the gods work in the world. (Chaotic)',
                    'Power - I hope to rise to the top of my faith\'s hierarchy. (Lawful)',
                    'Faith - I trust my deity will guide my actions. (Any)',
                    'Aspiration - I seek to prove worthy of my god\'s favor. (Any)'
                ],
                bonds: [
                    'I would die to recover an ancient relic of my faith.',
                    'I will someday get revenge on the temple hierarchy who branded me a heretic.',
                    'I owe my life to the priest who took me in when my parents died.',
                    'Everything I do is for the common people.',
                    'I will do anything to protect the temple where I served.',
                    'I seek to preserve a sacred text that enemies seek to destroy.'
                ],
                flaws: [
                    'I judge others harshly, and myself even more severely.',
                    'I put too much trust in those who wield power within my temple.',
                    'My piety sometimes leads me to blindly trust those that profess my faith.',
                    'I am inflexible in my thinking.',
                    'I am suspicious of strangers and expect the worst of them.',
                    'Once I pick a goal, I become obsessed with it.'
                ]
            },
            charlatan: {
                name: 'Charlatan',
                icon: 'ðŸŽ­',
                skills: ['Deception', 'Sleight of Hand'],
                tools: ['Disguise kit', 'Forgery kit'],
                languages: 0,
                feature: 'False Identity',
                featureDesc: 'You have a second identity with established documentation, acquaintances, and disguises.',
                equipment: 'Fine clothes, disguise kit, tools of the con (weighted dice, marked cards), pouch with 15 gp',
                traits: [
                    'I fall in and out of love easily, always pursuing someone.',
                    'I have a joke for every occasion.',
                    'Flattery is my preferred trick for getting what I want.',
                    'I\'m a born gambler who can\'t resist taking a risk.',
                    'I lie about almost everything, even when there\'s no good reason.',
                    'Sarcasm and insults are my weapons of choice.'
                ],
                ideals: [
                    'Independence - I am a free spirit. No one tells me what to do. (Chaotic)',
                    'Fairness - I never target people who can\'t afford to lose a few coins. (Lawful)',
                    'Charity - I distribute the money I acquire to those who really need it. (Good)',
                    'Creativity - I never run the same con twice. (Chaotic)',
                    'Friendship - Material goods come and go. Bonds of friendship last forever. (Good)',
                    'Aspiration - I\'m determined to make something of myself. (Any)'
                ],
                bonds: [
                    'I fleeced the wrong person and must work to ensure they never catch up.',
                    'I owe everything to my mentorâ€”a horrible person who\'s probably rotting in jail.',
                    'Somewhere out there, I have a child who doesn\'t know me.',
                    'I come from a noble family, and my family doesn\'t know I\'ve returned.',
                    'A powerful person killed someone I love. Someday I\'ll have my revenge.',
                    'I swindled and ruined a person who didn\'t deserve it.'
                ],
                flaws: [
                    'I can\'t resist a pretty face.',
                    'I\'m always in debt. I spend my ill-gotten gains on decadent luxuries.',
                    'I\'m convinced no one could ever fool me the way I fool others.',
                    'I\'m too greedy for my own good.',
                    'I can\'t resist swindling people who are more powerful than me.',
                    'I hate to admit it, but I\'ll run to preserve my own hide.'
                ]
            },
            criminal: {
                name: 'Criminal',
                icon: 'ðŸ—¡ï¸',
                skills: ['Deception', 'Stealth'],
                tools: ['One type of gaming set', 'Thieves\' tools'],
                languages: 0,
                feature: 'Criminal Contact',
                featureDesc: 'You have a reliable and trustworthy contact who acts as your liaison to a criminal network.',
                equipment: 'Crowbar, dark common clothes with hood, pouch with 15 gp',
                traits: [
                    'I always have a plan for what to do when things go wrong.',
                    'I am always calm, no matter what the situation.',
                    'The first thing I do in a new place is note the exits.',
                    'I would rather make a new friend than a new enemy.',
                    'I am incredibly slow to trust.',
                    'I don\'t pay attention to the risks in a situation.'
                ],
                ideals: [
                    'Honor - I don\'t steal from others in the trade. (Lawful)',
                    'Freedom - Chains are meant to be broken. (Chaotic)',
                    'Charity - I steal from the wealthy so that I can help people in need. (Good)',
                    'Greed - I will do whatever it takes to become wealthy. (Evil)',
                    'People - I\'m loyal to my friends, not ideals. (Neutral)',
                    'Redemption - There\'s a spark of good in everyone. (Good)'
                ],
                bonds: [
                    'I\'m trying to pay off an old debt to a generous benefactor.',
                    'My ill-gotten gains go to support my family.',
                    'Something important was taken from me, and I must steal it back.',
                    'I will become the greatest thief that ever lived.',
                    'I\'m guilty of a terrible crime, and I hope to redeem myself.',
                    'Someone I loved died because of a mistake I made.'
                ],
                flaws: [
                    'When I see something valuable, I can\'t think about anything but taking it.',
                    'When faced with a choice between money and friends, I usually choose money.',
                    'If there\'s a plan, I\'ll forget it. If I don\'t forget it, I\'ll ignore it.',
                    'I have a "tell" that reveals when I\'m lying.',
                    'I turn tail and run when things look bad.',
                    'An innocent person is in prison for a crime I committed.'
                ]
            },
            entertainer: {
                name: 'Entertainer',
                icon: 'ðŸŽª',
                skills: ['Acrobatics', 'Performance'],
                tools: ['Disguise kit', 'One musical instrument'],
                languages: 0,
                feature: 'By Popular Demand',
                featureDesc: 'You can always find a place to perform. You receive free lodging and food in exchange.',
                equipment: 'Musical instrument, favor of an admirer, costume, pouch with 15 gp',
                traits: [
                    'I know a story relevant to almost every situation.',
                    'Whenever I come to a new place, I collect local rumors.',
                    'I\'m a hopeless romantic, always searching for that special someone.',
                    'Nobody stays angry at me for long, since I can defuse any tension.',
                    'I love a good insult, even one directed at me.',
                    'I get bitter if I\'m not the center of attention.'
                ],
                ideals: [
                    'Beauty - What I do, I strive to make the world a more beautiful place. (Good)',
                    'Tradition - The stories of the past must never be forgotten. (Lawful)',
                    'Creativity - The world is in need of new ideas and bold action. (Chaotic)',
                    'Greed - I\'m only in it for the money and fame. (Evil)',
                    'People - I like seeing smiles on people\'s faces when I perform. (Neutral)',
                    'Honesty - Art should reflect the soul; it should come from within. (Any)'
                ],
                bonds: [
                    'My instrument is my most treasured possession.',
                    'Someone stole my precious instrument, and I\'ll get it back.',
                    'I want to be famous, whatever it takes.',
                    'I idolize a hero of the old tales and measure my deeds against theirs.',
                    'I will do anything to prove myself superior to my hated rival.',
                    'I would do anything for the other members of my old troupe.'
                ],
                flaws: [
                    'I\'ll do anything to win fame and renown.',
                    'I\'m a sucker for a pretty face.',
                    'A scandal prevents me from ever going home again.',
                    'I once satirized a noble who still wants my head.',
                    'I have trouble keeping my true feelings hidden.',
                    'Despite my best efforts, I am unreliable to my friends.'
                ]
            },
            folkhero: {
                name: 'Folk Hero',
                icon: 'âš”ï¸',
                skills: ['Animal Handling', 'Survival'],
                tools: ['One type of artisan\'s tools', 'Vehicles (land)'],
                languages: 0,
                feature: 'Rustic Hospitality',
                featureDesc: 'Common folk will shield you from the law or anyone searching for you, and provide you with shelter.',
                equipment: 'Artisan\'s tools, shovel, iron pot, common clothes, pouch with 10 gp',
                traits: [
                    'I judge people by their actions, not their words.',
                    'If someone is in trouble, I\'m always ready to lend help.',
                    'When I set my mind to something, I follow through.',
                    'I have a strong sense of fair play.',
                    'I\'m confident in my own abilities.',
                    'Thinking is for other people. I prefer action.'
                ],
                ideals: [
                    'Respect - People deserve to be treated with dignity and respect. (Good)',
                    'Fairness - No one should get preferential treatment before the law. (Lawful)',
                    'Freedom - Tyrants must not be allowed to oppress the people. (Chaotic)',
                    'Might - If I become strong, I can take what I want. (Evil)',
                    'Sincerity - There\'s no good in pretending to be something I\'m not. (Neutral)',
                    'Destiny - Nothing can stop me from fulfilling my destiny. (Any)'
                ],
                bonds: [
                    'I have a family, but I have no idea where they are.',
                    'I worked the land, I love the land, and I will protect the land.',
                    'A proud noble once gave me a horrible beating, and I will take my revenge.',
                    'My tools are symbols of my past life, and I carry them everywhere.',
                    'I protect those who cannot protect themselves.',
                    'I wish my childhood sweetheart had come with me to pursue my destiny.'
                ],
                flaws: [
                    'The tyrant who rules my land will stop at nothing to see me killed.',
                    'I\'m convinced of the significance of my destiny.',
                    'I have a weakness for the vices of the city.',
                    'Secretly, I believe that things would be better if I were a tyrant.',
                    'I have trouble trusting in my allies.',
                    'I\'m too quick to assume that I can solve everyone\'s problems.'
                ]
            },
            guildartisan: {
                name: 'Guild Artisan',
                icon: 'ðŸ”¨',
                skills: ['Insight', 'Persuasion'],
                tools: ['One type of artisan\'s tools'],
                languages: 1,
                feature: 'Guild Membership',
                featureDesc: 'Your guild offers lodging, support members in legal trouble, and political connections.',
                equipment: 'Artisan\'s tools, letter of introduction from guild, traveler\'s clothes, pouch with 15 gp',
                traits: [
                    'I believe that anything worth doing is worth doing right.',
                    'I\'m rude to people who lack my commitment to hard work.',
                    'I like to talk at length about my profession.',
                    'I don\'t part with my money easily.',
                    'I\'m well known for my work, and I want to make sure everyone appreciates it.',
                    'I\'m always taking on new projects, even when I shouldn\'t.'
                ],
                ideals: [
                    'Community - We all must help one another. (Good)',
                    'Generosity - My talents were given to me so that I could use them for others. (Good)',
                    'Freedom - Everyone should be free to pursue their livelihood. (Chaotic)',
                    'Greed - I\'m only in it for the money. (Evil)',
                    'People - I\'m committed to the people I care about. (Neutral)',
                    'Aspiration - I work hard to be the best there is at my craft. (Any)'
                ],
                bonds: [
                    'The workshop where I learned my trade is the most important place to me.',
                    'I created a great work for someone, and then discovered they were unworthy.',
                    'I owe my guild a great debt for forging me into the person I am today.',
                    'I pursue wealth to secure someone\'s love.',
                    'One day I will return to my guild and prove I am the greatest artisan.',
                    'I will get revenge on the evil forces that destroyed my workplace.'
                ],
                flaws: [
                    'I\'ll do anything to get my hands on something rare or priceless.',
                    'I\'m quick to assume that someone is trying to cheat me.',
                    'No one must ever learn that I once stole from my guild.',
                    'I\'m never satisfied with what I have.',
                    'I would kill to acquire a noble title.',
                    'I\'m horribly jealous of anyone who can outshine my handiwork.'
                ]
            },
            hermit: {
                name: 'Hermit',
                icon: 'ðŸ”ï¸',
                skills: ['Medicine', 'Religion'],
                tools: ['Herbalism kit'],
                languages: 1,
                feature: 'Discovery',
                featureDesc: 'You have discovered a unique and powerful truthâ€”a revelation that could change the world.',
                equipment: 'Case for scrolls, winter blanket, common clothes, herbalism kit, 5 gp',
                traits: [
                    'I\'ve been isolated for so long that I rarely speak.',
                    'I am utterly serene, even in the face of disaster.',
                    'The leader of my community had something wise to say.',
                    'I feel tremendous empathy for all who suffer.',
                    'I\'m oblivious to etiquette and social expectations.',
                    'I connect everything that happens to me to a grand, cosmic plan.'
                ],
                ideals: [
                    'Greater Good - My gifts are meant to be shared with all. (Good)',
                    'Logic - Emotions must not cloud logical thinking. (Lawful)',
                    'Free Thinking - Inquiry and curiosity are pillars of progress. (Chaotic)',
                    'Power - Solitude and contemplation are paths toward mystical power. (Evil)',
                    'Live and Let Live - Meddling in the affairs of others brings trouble. (Neutral)',
                    'Self-Knowledge - Know yourself, and you shall know the universe. (Any)'
                ],
                bonds: [
                    'Nothing is more important than the other members of my hermitage.',
                    'I entered seclusion to hide from those who might still be hunting me.',
                    'I\'m still seeking the enlightenment I pursued in my seclusion.',
                    'I entered seclusion because I loved someone I could not have.',
                    'Should my discovery come to light, it could bring ruin to the world.',
                    'My isolation gave me great insight into a great evil only I can destroy.'
                ],
                flaws: [
                    'Now that I\'ve returned to the world, I enjoy its delights a little too much.',
                    'I harbor dark, bloodthirsty thoughts that my isolation failed to quell.',
                    'I am dogmatic in my thoughts and philosophy.',
                    'I let my need to win arguments overshadow friendships.',
                    'I\'d risk too much to uncover a lost bit of knowledge.',
                    'I like keeping secrets and won\'t share them with anyone.'
                ]
            },
            noble: {
                name: 'Noble',
                icon: 'ðŸ‘‘',
                skills: ['History', 'Persuasion'],
                tools: ['One type of gaming set'],
                languages: 1,
                feature: 'Position of Privilege',
                featureDesc: 'You are welcome in high society, and commoners try to accommodate you and avoid your displeasure.',
                equipment: 'Fine clothes, signet ring, scroll of pedigree, purse with 25 gp',
                traits: [
                    'My eloquent flattery makes everyone I talk to feel important.',
                    'The common folk love me for my kindness and generosity.',
                    'No one could doubt by looking at me that I am a cut above.',
                    'I take great pains to always look my best.',
                    'I don\'t like to get my hands dirty.',
                    'Despite my noble birth, I do not place myself above other folk.'
                ],
                ideals: [
                    'Respect - Respect is due to me because of my position. (Lawful)',
                    'Responsibility - It is my duty to protect my people. (Good)',
                    'Independence - I must prove that I can handle myself. (Chaotic)',
                    'Power - If I can attain more power, no one will tell me what to do. (Evil)',
                    'Family - Blood runs thicker than water. (Any)',
                    'Noble Obligation - It is my duty to protect those beneath my station. (Good)'
                ],
                bonds: [
                    'I will face any challenge to win the approval of my family.',
                    'My house\'s alliance with another noble family must be sustained.',
                    'Nothing is more important than the other members of my family.',
                    'I am in love with the heir of a family that my family despises.',
                    'My loyalty to my sovereign is unwavering.',
                    'The common folk must see me as a hero of the people.'
                ],
                flaws: [
                    'I secretly believe that everyone is beneath me.',
                    'I hide a truly scandalous secret that could ruin my family.',
                    'I too often hear veiled insults and threats in every word addressed to me.',
                    'I have an insatiable desire for carnal pleasures.',
                    'In fact, the world does revolve around me.',
                    'By my words and actions, I often bring shame to my family.'
                ]
            },
            outlander: {
                name: 'Outlander',
                icon: 'ðŸ•ï¸',
                skills: ['Athletics', 'Survival'],
                tools: ['One musical instrument'],
                languages: 1,
                feature: 'Wanderer',
                featureDesc: 'You have an excellent memory for maps and geography. You can always find food and water for yourself and five others.',
                equipment: 'Staff, hunting trap, trophy from animal, traveler\'s clothes, pouch with 10 gp',
                traits: [
                    'I\'m driven by a wanderlust that led me away from home.',
                    'I watch over my friends as if they were a litter of newborn pups.',
                    'I once ran twenty-five miles without stopping to warn my clan of danger.',
                    'I have a lesson for every situation, drawn from observing nature.',
                    'I place no stock in wealthy or well-mannered folk.',
                    'I\'m always picking things up and absently playing with them.'
                ],
                ideals: [
                    'Change - Life is like the seasons, in constant change. (Chaotic)',
                    'Greater Good - It is each person\'s responsibility to help one another. (Good)',
                    'Honor - If I dishonor myself, I dishonor my whole clan. (Lawful)',
                    'Might - The strongest are meant to rule. (Evil)',
                    'Nature - The natural world is more important than civilization. (Neutral)',
                    'Glory - I must earn glory in battle, for myself and my clan. (Any)'
                ],
                bonds: [
                    'My family, clan, or tribe is the most important thing in my life.',
                    'An injury to the unspoiled wilderness is an injury to me.',
                    'I will bring terrible wrath down on the evildoers who destroyed my homeland.',
                    'I am the last of my tribe, and it is up to me to ensure their names are not forgotten.',
                    'I suffer awful visions of a coming disaster and will do anything to prevent it.',
                    'It is my duty to provide children to sustain my tribe.'
                ],
                flaws: [
                    'I am too enamored of ale, wine, and other intoxicants.',
                    'There\'s no room for caution in a life lived to the fullest.',
                    'I remember every insult I\'ve received and nurse a silent resentment.',
                    'I am slow to trust members of other races, tribes, and societies.',
                    'Violence is my answer to almost any challenge.',
                    'Don\'t expect me to save those who can\'t save themselves.'
                ]
            },
            sage: {
                name: 'Sage',
                icon: 'ðŸ“š',
                skills: ['Arcana', 'History'],
                tools: [],
                languages: 2,
                feature: 'Researcher',
                featureDesc: 'When you don\'t know information, you know where and from whom you can obtain it.',
                equipment: 'Bottle of black ink, quill, small knife, letter from dead colleague, common clothes, pouch with 10 gp',
                traits: [
                    'I use polysyllabic words that convey the impression of great erudition.',
                    'I\'ve read every book in the world\'s greatest libraries.',
                    'I\'m used to helping out those who aren\'t as smart as I am.',
                    'There\'s nothing I like more than a good mystery.',
                    'I\'m willing to listen to every side of an argument before making a judgment.',
                    'I... speak... slowly... when talking... to idiots.'
                ],
                ideals: [
                    'Knowledge - The path to power and self-improvement is through knowledge. (Neutral)',
                    'Beauty - What is beautiful points us beyond itself toward what is true. (Good)',
                    'Logic - Emotions must not cloud our sense of what is right and true. (Lawful)',
                    'No Limits - Nothing should fetter the infinite possibility inherent in all existence. (Chaotic)',
                    'Power - Knowledge is the path to power and domination. (Evil)',
                    'Self-Improvement - The goal of a life of study is the betterment of oneself. (Any)'
                ],
                bonds: [
                    'It is my duty to protect my students.',
                    'I have an ancient text that holds terrible secrets that must not fall into the wrong hands.',
                    'I work to preserve a library, university, scriptorium, or monastery.',
                    'My life\'s work is a series of tomes related to a specific field of lore.',
                    'I\'ve been searching my whole life for the answer to a certain question.',
                    'I sold my soul for knowledge. I hope to do great deeds to win it back.'
                ],
                flaws: [
                    'I am easily distracted by the promise of information.',
                    'Most people scream and run when they see a demon. I stop and take notes.',
                    'Unlocking an ancient mystery is worth the price of a civilization.',
                    'I overlook obvious solutions in favor of complicated ones.',
                    'I speak without really thinking through my words, invariably insulting others.',
                    'I can\'t keep a secret to save my life, or anyone else\'s.'
                ]
            },
            sailor: {
                name: 'Sailor',
                icon: 'âš“',
                skills: ['Athletics', 'Perception'],
                tools: ['Navigator\'s tools', 'Vehicles (water)'],
                languages: 0,
                feature: 'Ship\'s Passage',
                featureDesc: 'You can secure free passage on a sailing ship for yourself and your companions.',
                equipment: 'Belaying pin (club), 50 feet of silk rope, lucky charm, common clothes, pouch with 10 gp',
                traits: [
                    'My friends know they can rely on me, no matter what.',
                    'I work hard so that I can play hard when the work is done.',
                    'I enjoy sailing into new ports and making new friends over a flagon of ale.',
                    'I stretch the truth for the sake of a good story.',
                    'To me, a tavern brawl is a nice way to get to know a new city.',
                    'I never pass up a friendly wager.'
                ],
                ideals: [
                    'Respect - The thing that keeps a ship together is mutual respect. (Good)',
                    'Fairness - We all do the work, so we all share in the rewards. (Lawful)',
                    'Freedom - The sea is freedomâ€”the freedom to go anywhere and do anything. (Chaotic)',
                    'Mastery - I\'m a predator, and the other ships are my prey. (Evil)',
                    'People - I\'m committed to my crewmates, not to ideals. (Neutral)',
                    'Aspiration - Someday I\'ll own my own ship and chart my own destiny. (Any)'
                ],
                bonds: [
                    'I\'m loyal to my captain first, everything else second.',
                    'The ship is most importantâ€”crewmates and captains come and go.',
                    'I\'ll always remember my first ship.',
                    'In a harbor town, I have a paramour whose eyes nearly stole me from the sea.',
                    'I was cheated out of my fair share of the profits, and I want to get my due.',
                    'Ruthless pirates murdered my captain and crewmates, and I will have revenge.'
                ],
                flaws: [
                    'I follow orders, even if I think they\'re wrong.',
                    'I\'ll say anything to avoid having to do extra work.',
                    'Once someone questions my courage, I never back down no matter how dangerous.',
                    'Once I start drinking, it\'s hard for me to stop.',
                    'I can\'t help but pocket loose coins and other trinkets I come across.',
                    'My pride will probably lead to my destruction.'
                ]
            },
            soldier: {
                name: 'Soldier',
                icon: 'ðŸ›¡ï¸',
                skills: ['Athletics', 'Intimidation'],
                tools: ['One type of gaming set', 'Vehicles (land)'],
                languages: 0,
                feature: 'Military Rank',
                featureDesc: 'Soldiers loyal to your former military organization still recognize your authority and defer to you.',
                equipment: 'Insignia of rank, trophy from fallen enemy, bone dice, common clothes, pouch with 10 gp',
                traits: [
                    'I\'m always polite and respectful.',
                    'I\'m haunted by memories of war. I can\'t get the images of violence out of my mind.',
                    'I\'ve lost too many friends, and I\'m slow to make new ones.',
                    'I\'m full of inspiring and cautionary tales from my military experience.',
                    'I can stare down a hell hound without flinching.',
                    'I enjoy being strong and like breaking things.'
                ],
                ideals: [
                    'Greater Good - Our lot is to lay down our lives in defense of others. (Good)',
                    'Responsibility - I do what I must and obey just authority. (Lawful)',
                    'Independence - When people follow orders blindly, they embrace a kind of tyranny. (Chaotic)',
                    'Might - In life as in war, the stronger force wins. (Evil)',
                    'Live and Let Live - Ideals aren\'t worth killing over or going to war for. (Neutral)',
                    'Nation - My city, nation, or people are all that matter. (Any)'
                ],
                bonds: [
                    'I would still lay down my life for the people I served with.',
                    'Someone saved my life on the battlefield. I\'ll never leave a friend behind.',
                    'My honor is my life.',
                    'I\'ll never forget the crushing defeat my company suffered.',
                    'Those who fight beside me are those worth dying for.',
                    'I fight for those who cannot fight for themselves.'
                ],
                flaws: [
                    'The monstrous enemy we faced in battle still leaves me quivering with fear.',
                    'I have little respect for anyone who is not a proven warrior.',
                    'I made a terrible mistake in battle that cost many lives.',
                    'My hatred of my enemies is blind and unreasoning.',
                    'I obey the law, even if the law causes misery.',
                    'I\'d rather eat my armor than admit when I\'m wrong.'
                ]
            },
            urchin: {
                name: 'Urchin',
                icon: 'ðŸ€',
                skills: ['Sleight of Hand', 'Stealth'],
                tools: ['Disguise kit', 'Thieves\' tools'],
                languages: 0,
                feature: 'City Secrets',
                featureDesc: 'You know the secret patterns and flow of cities and can find passages through the urban sprawl others would miss.',
                equipment: 'Small knife, map of your home city, pet mouse, token to remember your parents by, common clothes, pouch with 10 gp',
                traits: [
                    'I hide scraps of food and trinkets away in my pockets.',
                    'I ask a lot of questions.',
                    'I like to squeeze into small places where no one else can get to me.',
                    'I sleep with my back to a wall or tree, with everything I own wrapped in a bundle.',
                    'I eat like a pig and have bad manners.',
                    'I think anyone who\'s nice to me is hiding evil intent.'
                ],
                ideals: [
                    'Respect - All people, rich or poor, deserve respect. (Good)',
                    'Community - We have to take care of each other. (Lawful)',
                    'Change - The low are lifted up, and the high and mighty are brought down. (Chaotic)',
                    'Retribution - The rich need to be shown what life and death are like in the gutters. (Evil)',
                    'People - I help the people who help me. (Neutral)',
                    'Aspiration - I\'m going to prove that I\'m worthy of a better life. (Any)'
                ],
                bonds: [
                    'My town or city is my home, and I\'ll fight to defend it.',
                    'I sponsor an orphanage to keep others from enduring what I was forced to.',
                    'I owe my survival to another urchin who taught me to live on the streets.',
                    'I owe a debt I can never repay to the person who took pity on me.',
                    'I escaped my life of poverty by robbing an important person.',
                    'No one else should have to endure the hardships I\'ve been through.'
                ],
                flaws: [
                    'If I\'m outnumbered, I will run away from a fight.',
                    'Gold seems like a lot of money to me, and I\'ll do just about anything for more.',
                    'I will never fully trust anyone other than myself.',
                    'I\'d rather kill someone in their sleep than fight fair.',
                    'It\'s not stealing if I need it more than someone else.',
                    'People who can\'t take care of themselves get what they deserve.'
                ]
            }
        };

        // ===== ALIGNMENT DATA =====
        const ALIGNMENTS = {
            'LG': 'Lawful Good',
            'NG': 'Neutral Good',
            'CG': 'Chaotic Good',
            'LN': 'Lawful Neutral',
            'TN': 'True Neutral',
            'CN': 'Chaotic Neutral',
            'LE': 'Lawful Evil',
            'NE': 'Neutral Evil',
            'CE': 'Chaotic Evil'
        };

        // ===== ABILITY SCORE VARS =====
        let abilityMethod = 'standard';
        let pointsRemaining = 27;
        let rolledScores = [];
        let rollCount = 0;
        const POINT_COSTS = { 8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9 };
        const STANDARD_ARRAY = [15, 14, 13, 12, 10, 8];
        let standardArrayAssignments = { STR: null, DEX: null, CON: null, INT: null, WIS: null, CHA: null };
        let chosenRacialBonuses = []; // Track abilities chosen for racial +1 bonuses
        let racialBonusMax = 0; // How many bonuses can be chosen (e.g., 2 for Variant Human)
        let draggedValue = null;

        // ===== INITIALIZE =====
        document.addEventListener('DOMContentLoaded', () => {
            initRaceCards();
            initClassCards();
            initAbilityGrid();
            setupEventListeners();
            setupDragAndDrop();
        });

        function setupEventListeners() {
            // Character name input
            document.getElementById('charName').addEventListener('input', (e) => {
                character.name = e.target.value;
                updatePreview();
            });

            // Alignment buttons
            document.querySelectorAll('.alignment-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.alignment-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    character.alignment = btn.dataset.align;
                    updatePreview();
                    playSound('click');
                });
            });

            // Progress bar navigation
            document.querySelectorAll('.progress-step').forEach(step => {
                step.addEventListener('click', () => {
                    if (!step.classList.contains('locked')) {
                        goToStep(parseInt(step.dataset.step));
                    }
                });
            });
        }

        // ===== RACE CARDS =====
        function initRaceCards() {
            const grid = document.getElementById('raceGrid');
            grid.innerHTML = '';

            for (const [key, race] of Object.entries(RACES)) {
                const bonusText = formatAbilityBonus(race.abilityBonus);

                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.race = key;
                card.innerHTML = `
                    <div class="card-icon">${race.icon}</div>
                    <div class="card-title">${race.name}</div>
                    <div class="card-subtitle">${bonusText}</div>
                    <div class="card-stats">
                        <div class="card-stat">
                            <span>Speed</span>
                            <span class="card-stat-value">${race.speed} ft</span>
                        </div>
                        <div class="card-stat">
                            <span>Subraces</span>
                            <span class="card-stat-value">${race.subraces ? Object.keys(race.subraces).length : 'None'}</span>
                        </div>
                    </div>
                `;

                card.addEventListener('click', () => selectRace(key));
                grid.appendChild(card);
            }
        }

        function formatAbilityBonus(bonus) {
            const parts = [];
            for (const [stat, val] of Object.entries(bonus)) {
                if (stat === 'ALL') {
                    parts.push('+1 All');
                } else if (stat === 'CHOICE1') {
                    parts.push('+1 Any');
                } else if (stat === 'CHOICE2') {
                    parts.push('+1 Two Others');
                } else {
                    parts.push(`+${val} ${stat}`);
                }
            }
            return parts.join(', ');
        }

        function selectRace(raceKey) {
            const race = RACES[raceKey];
            character.race = raceKey;
            character.subrace = null;

            // Update card selection
            document.querySelectorAll('#raceGrid .card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-race="${raceKey}"]`).classList.add('selected');

            // Show subraces if available
            const subracePanel = document.getElementById('subracePanel');
            const subraceGrid = document.getElementById('subraceGrid');

            if (race.subraces) {
                subraceGrid.innerHTML = '';
                for (const [key, sub] of Object.entries(race.subraces)) {
                    const bonusText = Object.keys(sub.bonus).length > 0
                        ? formatAbilityBonus(sub.bonus)
                        : 'Special';

                    const card = document.createElement('div');
                    card.className = 'subrace-card';
                    card.dataset.subrace = key;
                    card.innerHTML = `
                        <div class="subrace-name">${sub.name}</div>
                        <div class="subrace-bonus">${bonusText}</div>
                        <div class="trait-desc" style="margin-top: 6px;">${sub.extra}</div>
                    `;
                    card.addEventListener('click', () => selectSubrace(key));
                    subraceGrid.appendChild(card);
                }
                subracePanel.classList.add('active');
                document.getElementById('raceNextBtn').disabled = true;
            } else {
                subracePanel.classList.remove('active');
                document.getElementById('raceNextBtn').disabled = false;
            }

            // Show traits
            showTraits(race);
            updatePreview();
            playSound('click');
        }

        function selectSubrace(subraceKey) {
            character.subrace = subraceKey;

            document.querySelectorAll('.subrace-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-subrace="${subraceKey}"]`).classList.add('selected');

            // Update traits panel to show subrace-specific info
            const race = RACES[character.race];
            showTraits(race, subraceKey);

            document.getElementById('raceNextBtn').disabled = false;
            updatePreview();
            playSound('click');
        }

        function showTraits(race, subraceKey = null) {
            const panel = document.getElementById('traitsPanel');
            const list = document.getElementById('traitsList');

            list.innerHTML = '';

            // Get subrace info if selected
            const subrace = subraceKey && race.subraces ? race.subraces[subraceKey] : null;

            // Show subrace name as header if applicable
            if (subrace) {
                const header = document.createElement('div');
                header.className = 'trait-item';
                header.innerHTML = `
                    <div class="trait-name" style="color: #daa520; font-size: 0.6rem;">${subrace.name}</div>
                    <div class="trait-desc">${subrace.extra}</div>
                `;
                list.appendChild(header);
            }

            // Show base race traits (but modify for special cases like Variant Human)
            race.traits.forEach(trait => {
                let traitName = trait.name;
                let traitDesc = trait.desc;

                // Special handling for Human subraces
                if (race.name === 'Human' && trait.name === 'Ability Score Increase') {
                    if (subraceKey === 'variant') {
                        traitDesc = '+1 to two different ability scores of your choice';
                    } else if (subraceKey === 'standard') {
                        traitDesc = '+1 to all ability scores';
                    }
                }

                const item = document.createElement('div');
                item.className = 'trait-item';
                item.innerHTML = `
                    <div class="trait-name">${traitName}</div>
                    <div class="trait-desc">${traitDesc}</div>
                `;
                list.appendChild(item);
            });

            // Add Variant Human specific traits
            if (race.name === 'Human' && subraceKey === 'variant') {
                const skillTrait = document.createElement('div');
                skillTrait.className = 'trait-item';
                skillTrait.innerHTML = `
                    <div class="trait-name">Skills</div>
                    <div class="trait-desc">Proficiency in one skill of your choice</div>
                `;
                list.appendChild(skillTrait);

                const featTrait = document.createElement('div');
                featTrait.className = 'trait-item';
                featTrait.innerHTML = `
                    <div class="trait-name">Feat</div>
                    <div class="trait-desc">One feat of your choice (a powerful ability normally gained at 4th level)</div>
                `;
                list.appendChild(featTrait);
            }

            panel.style.display = 'block';
        }

        // ===== CLASS CARDS =====
        function initClassCards() {
            const grid = document.getElementById('classGrid');
            grid.innerHTML = '';

            for (const [key, cls] of Object.entries(CLASSES)) {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.class = key;
                card.innerHTML = `
                    <div class="card-icon">${cls.icon}</div>
                    <div class="card-title">${cls.name}</div>
                    <div class="card-subtitle">${cls.primaryAbility}</div>
                    <div class="card-stats">
                        <div class="card-stat">
                            <span>Hit Die</span>
                            <span class="card-stat-value">${cls.hitDie}</span>
                        </div>
                        <div class="card-stat">
                            <span>Skills</span>
                            <span class="card-stat-value">${cls.skills}</span>
                        </div>
                    </div>
                `;

                card.addEventListener('click', () => selectClass(key));
                grid.appendChild(card);
            }
        }

        function selectClass(classKey) {
            const cls = CLASSES[classKey];
            character.class = classKey;
            character.subclass = null;

            // Reset class-dependent selections when class changes
            character.equipment = { choices: {}, granted: [] };
            character.spells = { cantrips: [], level1: [], level2: [], level3: [], level4: [], level5: [], level6: [], level7: [], level8: [], level9: [] };
            // Reset skills but keep background skills
            const bgSkills = character.background ? BACKGROUNDS[character.background].skills : [];
            character.skills = [...bgSkills];
            selectedClassSkills = [];

            // Update card selection
            document.querySelectorAll('#classGrid .card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-class="${classKey}"]`).classList.add('selected');

            // Show subclasses
            const subclassPanel = document.getElementById('subclassPanel');
            const subclassGrid = document.getElementById('subclassGrid');

            subclassGrid.innerHTML = '';
            for (const [key, sub] of Object.entries(cls.subclasses)) {
                const card = document.createElement('div');
                card.className = 'subrace-card';
                card.dataset.subclass = key;
                card.innerHTML = `
                    <div class="subrace-name">${sub.name}</div>
                    <div class="trait-desc">${sub.desc}</div>
                `;
                card.addEventListener('click', () => selectSubclass(key));
                subclassGrid.appendChild(card);
            }

            // Note about subclass level
            if (cls.subclassLevel > 1) {
                const note = document.createElement('div');
                note.className = 'trait-desc';
                note.style.marginTop = '15px';
                note.style.color = '#888';
                note.textContent = `Note: Subclass is chosen at level ${cls.subclassLevel}, but you can select now for planning.`;
                subclassGrid.appendChild(note);
            }

            subclassPanel.classList.add('active');

            // Show class features
            showClassFeatures(cls);
            updatePreview();
            playSound('click');

            // Enable next if subclass level is > 1 (optional at level 1)
            document.getElementById('classNextBtn').disabled = cls.subclassLevel === 1;
        }

        function selectSubclass(subclassKey) {
            character.subclass = subclassKey;

            document.querySelectorAll('#subclassGrid .subrace-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-subclass="${subclassKey}"]`).classList.add('selected');

            document.getElementById('classNextBtn').disabled = false;
            updatePreview();
            playSound('click');
        }

        function showClassFeatures(cls) {
            const panel = document.getElementById('classTraitsPanel');
            const list = document.getElementById('classTraitsList');

            list.innerHTML = '';

            // Add basic info
            const info = document.createElement('div');
            info.className = 'trait-item';
            info.innerHTML = `
                <div class="trait-name">Proficiencies</div>
                <div class="trait-desc">
                    <strong>Armor:</strong> ${cls.armor}<br>
                    <strong>Weapons:</strong> ${cls.weapons}<br>
                    <strong>Saving Throws:</strong> ${cls.saves.join(', ')}<br>
                    <strong>Skills:</strong> Choose ${cls.skills} from ${cls.skillChoices.join(', ')}
                </div>
            `;
            list.appendChild(info);

            // Add features with level indicator
            cls.features.forEach(feature => {
                const item = document.createElement('div');
                item.className = 'trait-item';
                const levelText = feature.level ? ` (Level ${feature.level})` : '';
                item.innerHTML = `
                    <div class="trait-name">${feature.name}<span style="color: #6b4423; font-size: 0.45rem;">${levelText}</span></div>
                    <div class="trait-desc">${feature.desc}</div>
                `;
                list.appendChild(item);
            });

            panel.style.display = 'block';
        }

        // Get class features for the current character level
        function getClassFeatures() {
            if (!character.class) return [];

            const cls = CLASSES[character.class];
            if (!cls || !cls.features) return [];

            // Filter features by level
            return cls.features
                .filter(f => !f.level || f.level <= character.level)
                .map(f => ({
                    name: f.name,
                    desc: f.desc,
                    level: f.level || 1
                }));
        }

        // ===== ABILITY SCORES =====
        function initAbilityGrid() {
            const grid = document.getElementById('abilityGrid');
            const abilities = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
            const abilityNames = {
                STR: 'STRENGTH',
                DEX: 'DEXTERITY',
                CON: 'CONSTITUTION',
                INT: 'INTELLIGENCE',
                WIS: 'WISDOM',
                CHA: 'CHARISMA'
            };

            grid.innerHTML = '';

            abilities.forEach(ability => {
                const box = document.createElement('div');
                box.className = 'ability-box';
                box.dataset.ability = ability;
                box.innerHTML = `
                    <div class="ability-name">${abilityNames[ability]}</div>
                    <div class="ability-score" id="score${ability}">${character.abilities[ability]}</div>
                    <div class="ability-mod" id="mod${ability}">${getModifier(character.abilities[ability])}</div>
                    <div class="ability-bonus" id="bonus${ability}"></div>
                    <div class="ability-controls" id="controls${ability}" style="display: none;">
                        <button class="ability-btn" onclick="adjustAbility('${ability}', -1)">-</button>
                        <button class="ability-btn" onclick="adjustAbility('${ability}', 1)">+</button>
                    </div>
                    <div class="ability-drop-zone" id="drop${ability}" data-ability="${ability}">
                        Drop here
                    </div>
                `;
                grid.appendChild(box);
            });

            updateAbilityDisplay();
        }

        function setAbilityMethod(method) {
            abilityMethod = method;

            // Update toggle buttons
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === method);
            });

            // Show/hide method-specific UI
            document.getElementById('standardArrayMethod').style.display = method === 'standard' ? 'block' : 'none';
            document.getElementById('pointBuyMethod').style.display = method === 'pointbuy' ? 'block' : 'none';
            document.getElementById('rollMethod').style.display = method === 'roll' ? 'block' : 'none';

            // Show/hide controls and drop zones
            const showControls = method === 'pointbuy';
            const showDropZones = method === 'standard' || method === 'roll';

            document.querySelectorAll('.ability-controls').forEach(el => {
                el.style.display = showControls ? 'flex' : 'none';
            });

            document.querySelectorAll('.ability-drop-zone').forEach(el => {
                el.style.display = showDropZones ? 'flex' : 'none';
            });

            // Reset scores
            resetAbilityScores();

            playSound('click');
        }

        function resetAbilityScores() {
            const baseScore = abilityMethod === 'pointbuy' ? 8 : 10;
            character.abilities = { STR: baseScore, DEX: baseScore, CON: baseScore, INT: baseScore, WIS: baseScore, CHA: baseScore };
            pointsRemaining = 27;
            standardArrayAssignments = { STR: null, DEX: null, CON: null, INT: null, WIS: null, CHA: null };
            rolledScores = [];
            rollCount = 0;

            // Reset standard array values
            document.querySelectorAll('.array-value').forEach(el => {
                el.classList.remove('used');
            });

            // Reset drop zones
            document.querySelectorAll('.ability-drop-zone').forEach(el => {
                el.classList.remove('filled');
                el.textContent = 'Drop here';
            });

            // Reset roll results
            document.getElementById('rollResults').innerHTML = '';
            document.getElementById('rollBtn').disabled = false;

            // Reset dice display
            document.querySelectorAll('.die').forEach(die => {
                die.textContent = '?';
                die.classList.remove('rolling', 'dropped');
            });

            updateAbilityDisplay();
        }

        function adjustAbility(ability, delta) {
            const current = character.abilities[ability];
            const newScore = current + delta;

            if (newScore < 8 || newScore > 15) return;

            const currentCost = POINT_COSTS[current];
            const newCost = POINT_COSTS[newScore];
            const costDiff = newCost - currentCost;

            if (pointsRemaining - costDiff < 0) return;

            pointsRemaining -= costDiff;
            character.abilities[ability] = newScore;

            updateAbilityDisplay();
            updatePreview();
            playSound('click');
        }

        function getModifier(score) {
            const mod = Math.floor((score - 10) / 2);
            return mod >= 0 ? `+${mod}` : `${mod}`;
        }

        // Helper to get racial bonus for an ability, properly handling subraces
        // Check if race needs manual bonus selection
        function needsRacialBonusSelection() {
            if (!character.race) return false;
            const race = RACES[character.race];

            // Variant Human: +1 to 2 chosen
            if (character.race === 'human' && character.subrace === 'variant') return true;

            // Half-Elf: +1 to 2 others (besides CHA)
            if (character.race === 'halfelf') return true;

            // Warforged (and similar with CHOICE1): +1 to 1 chosen
            if (race.abilityBonus.CHOICE1) return true;

            return false;
        }

        function getRacialBonusConfig() {
            if (!character.race) return { count: 0, exclude: [] };

            if (character.race === 'human' && character.subrace === 'variant') {
                return { count: 2, exclude: [] };
            }
            if (character.race === 'halfelf') {
                return { count: 2, exclude: ['CHA'] }; // Can't choose CHA, already get +2
            }
            const race = RACES[character.race];
            if (race.abilityBonus.CHOICE1) {
                return { count: 1, exclude: [] };
            }
            return { count: 0, exclude: [] };
        }

        function setupRacialBonusPanel() {
            const panel = document.getElementById('racialBonusPanel');
            const config = getRacialBonusConfig();

            if (config.count > 0) {
                racialBonusMax = config.count;
                chosenRacialBonuses = [];

                // Update title based on race
                const title = document.getElementById('racialBonusTitle');
                const subtitle = document.getElementById('racialBonusSubtitle');

                if (character.race === 'human' && character.subrace === 'variant') {
                    title.textContent = 'VARIANT HUMAN BONUSES';
                    subtitle.textContent = 'Choose 2 different abilities to receive +1';
                } else if (character.race === 'halfelf') {
                    title.textContent = 'HALF-ELF BONUSES';
                    subtitle.textContent = 'Choose 2 abilities (other than CHA) to receive +1';
                } else {
                    title.textContent = 'RACIAL BONUS';
                    subtitle.textContent = 'Choose 1 ability to receive +1';
                }

                // Update buttons
                document.querySelectorAll('.racial-bonus-btn').forEach(btn => {
                    const ability = btn.dataset.ability;
                    btn.classList.remove('selected');
                    btn.disabled = config.exclude.includes(ability);
                });

                updateRacialBonusCounter();
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function toggleRacialBonus(ability) {
            const config = getRacialBonusConfig();

            if (config.exclude.includes(ability)) return;

            const index = chosenRacialBonuses.indexOf(ability);

            if (index > -1) {
                // Remove it
                chosenRacialBonuses.splice(index, 1);
            } else {
                // Add it if not at max
                if (chosenRacialBonuses.length < racialBonusMax) {
                    chosenRacialBonuses.push(ability);
                } else {
                    // At max - remove first and add new
                    chosenRacialBonuses.shift();
                    chosenRacialBonuses.push(ability);
                }
            }

            // Update button states
            document.querySelectorAll('.racial-bonus-btn').forEach(btn => {
                const btnAbility = btn.dataset.ability;
                btn.classList.toggle('selected', chosenRacialBonuses.includes(btnAbility));
            });

            updateRacialBonusCounter();
            updateAbilityDisplay();
            playSound('click');
        }

        function updateRacialBonusCounter() {
            const counter = document.getElementById('racialBonusCounter');
            counter.textContent = `Selected: ${chosenRacialBonuses.length} / ${racialBonusMax}`;

            if (chosenRacialBonuses.length === racialBonusMax) {
                counter.style.color = '#2e7d32';
            } else {
                counter.style.color = '#daa520';
            }
        }

        function getRacialBonus(ability) {
            if (!character.race) return 0;

            const race = RACES[character.race];
            let bonus = 0;

            // Check if this race uses manual bonus selection
            if (needsRacialBonusSelection()) {
                // Check if this ability was chosen
                if (chosenRacialBonuses.includes(ability)) {
                    bonus = 1;
                }

                // Half-elf also gets +2 CHA base
                if (character.race === 'halfelf' && ability === 'CHA') {
                    bonus += 2;
                }

                return bonus;
            }

            // Standard Human or base human with ALL bonus
            const isStandardHuman = character.race === 'human' && character.subrace === 'standard';
            if (isStandardHuman || race.abilityBonus.ALL) {
                bonus = 1;
            } else {
                // Normal race - apply base race bonus
                if (race.abilityBonus[ability]) {
                    bonus = race.abilityBonus[ability];
                }
            }

            // Add subrace bonus (additive for most races)
            if (character.subrace && race.subraces && race.subraces[character.subrace]) {
                const subBonus = race.subraces[character.subrace].bonus[ability];
                if (subBonus) bonus += subBonus;
            }

            return bonus;
        }

        function updateAbilityDisplay() {
            const abilities = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];

            abilities.forEach(ability => {
                const score = character.abilities[ability];
                document.getElementById(`score${ability}`).textContent = score;
                document.getElementById(`mod${ability}`).textContent = getModifier(score);

                // Show racial bonus if applicable
                const bonusEl = document.getElementById(`bonus${ability}`);
                if (character.race) {
                    const bonus = getRacialBonus(ability);

                    // Special display for Variant Human
                    if (character.race === 'human' && character.subrace === 'variant') {
                        bonusEl.textContent = '(+1 choose 2)';
                        bonusEl.style.color = '#8b2500';
                    } else if (bonus > 0) {
                        bonusEl.textContent = `(+${bonus} racial)`;
                        bonusEl.style.color = '#1565c0';
                    } else {
                        bonusEl.textContent = '';
                    }
                }
            });

            // Update points remaining display
            const pointsEl = document.getElementById('pointsRemaining');
            pointsEl.textContent = pointsRemaining;
            pointsEl.className = 'points-value';
            if (pointsRemaining === 0) pointsEl.classList.add('depleted');
            else if (pointsRemaining < 5) pointsEl.classList.add('warning');

            // Update preview (includes AC, HP, etc.)
            updatePreview();
        }

        function updateAbilityPreview() {
            const abilities = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];

            abilities.forEach(ability => {
                let baseScore = character.abilities[ability];

                // Use getFinalAbilityScore to include racial, ASI, and feat bonuses
                const total = getFinalAbilityScore(ability);
                const previewEl = document.getElementById(`preview${ability}`);
                const modEl = document.getElementById(`preview${ability}mod`);

                if (baseScore > 0 && (abilityMethod !== 'standard' || standardArrayAssignments[ability] !== null)) {
                    previewEl.textContent = total;
                    modEl.textContent = getModifier(total);
                } else {
                    previewEl.textContent = '--';
                    modEl.textContent = '';
                }
            });

            // Update HP
            updateHPPreview();
        }

        function updateHPPreview() {
            const hpEl = document.getElementById('previewHP');
            if (character.class) {
                const cls = CLASSES[character.class];
                const hitDie = parseInt(cls.hitDie.substring(1));

                // Use getFinalAbilityScore to include all bonuses (racial, ASI, feats)
                const totalCon = getFinalAbilityScore('CON');
                const totalConMod = Math.floor((totalCon - 10) / 2);
                const hp = hitDie + totalConMod;

                hpEl.textContent = Math.max(1, hp);
                hpEl.classList.remove('empty');
            }
        }

        // ===== DRAG AND DROP =====
        function setupDragAndDrop() {
            // Standard array values
            document.querySelectorAll('.array-value').forEach(el => {
                el.addEventListener('dragstart', (e) => {
                    if (el.classList.contains('used')) {
                        e.preventDefault();
                        return;
                    }
                    draggedValue = parseInt(el.dataset.value);
                    el.classList.add('dragging');
                });

                el.addEventListener('dragend', () => {
                    el.classList.remove('dragging');
                });
            });

            // Drop zones will be set up after initAbilityGrid
            setTimeout(() => {
                document.querySelectorAll('.ability-drop-zone').forEach(zone => {
                    zone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        zone.classList.add('drag-over');
                    });

                    zone.addEventListener('dragleave', () => {
                        zone.classList.remove('drag-over');
                    });

                    zone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        zone.classList.remove('drag-over');

                        if (draggedValue !== null) {
                            const ability = zone.dataset.ability;

                            // If already has a value, free it up
                            if (standardArrayAssignments[ability] !== null) {
                                const oldValue = standardArrayAssignments[ability];
                                document.querySelector(`.array-value[data-value="${oldValue}"]`).classList.remove('used');
                            }

                            // Assign new value
                            standardArrayAssignments[ability] = draggedValue;
                            character.abilities[ability] = draggedValue;

                            // Mark as used
                            document.querySelector(`.array-value[data-value="${draggedValue}"]`).classList.add('used');

                            // Update zone display
                            zone.textContent = draggedValue;
                            zone.classList.add('filled');

                            draggedValue = null;
                            updateAbilityDisplay();
                            playSound('click');
                        }
                    });

                    // Click to clear
                    zone.addEventListener('click', () => {
                        const ability = zone.dataset.ability;
                        if (standardArrayAssignments[ability] !== null) {
                            const value = standardArrayAssignments[ability];
                            document.querySelector(`.array-value[data-value="${value}"]`).classList.remove('used');
                            standardArrayAssignments[ability] = null;
                            character.abilities[ability] = 10;
                            zone.textContent = 'Drop here';
                            zone.classList.remove('filled');
                            updateAbilityDisplay();
                            playSound('click');
                        }
                    });
                });
            }, 100);
        }

        // ===== DICE ROLLING =====
        function rollAbilityScore() {
            if (rollCount >= 6) return;

            const dice = document.querySelectorAll('.die');
            const rolls = [];

            // Start rolling animation
            dice.forEach(die => {
                die.classList.add('rolling');
                die.classList.remove('dropped');
            });

            playSound('roll');

            // Animate for a bit then show results
            let animCount = 0;
            const animInterval = setInterval(() => {
                dice.forEach(die => {
                    die.textContent = Math.floor(Math.random() * 6) + 1;
                });
                animCount++;
                if (animCount > 15) {
                    clearInterval(animInterval);

                    // Final roll
                    dice.forEach((die, i) => {
                        const roll = Math.floor(Math.random() * 6) + 1;
                        rolls.push(roll);
                        die.textContent = roll;
                        die.classList.remove('rolling');
                    });

                    // Find lowest and mark it
                    const minRoll = Math.min(...rolls);
                    let dropped = false;
                    dice.forEach((die, i) => {
                        if (rolls[i] === minRoll && !dropped) {
                            die.classList.add('dropped');
                            dropped = true;
                        }
                    });

                    // Calculate total (drop lowest)
                    const sorted = [...rolls].sort((a, b) => b - a);
                    const total = sorted[0] + sorted[1] + sorted[2];

                    rolledScores.push(total);
                    rollCount++;

                    // Add to results
                    const resultsDiv = document.getElementById('rollResults');
                    const result = document.createElement('div');
                    result.className = 'roll-result';
                    result.textContent = total;
                    result.draggable = true;
                    result.dataset.value = total;
                    result.dataset.index = rollCount - 1;

                    // Make draggable
                    result.addEventListener('dragstart', (e) => {
                        if (result.classList.contains('assigned')) {
                            e.preventDefault();
                            return;
                        }
                        draggedValue = parseInt(result.dataset.value);
                        result.classList.add('dragging');
                    });

                    result.addEventListener('dragend', () => {
                        result.classList.remove('dragging');
                    });

                    resultsDiv.appendChild(result);

                    // Disable button if done
                    if (rollCount >= 6) {
                        document.getElementById('rollBtn').disabled = true;
                        document.getElementById('rollBtn').textContent = 'ALL ROLLED!';
                    } else {
                        document.getElementById('rollBtn').textContent = `ðŸŽ² ROLL (${6 - rollCount} left)`;
                    }

                    playSound('next');
                }
            }, 50);
        }

        // ===== BACKGROUND FUNCTIONS =====
        let classSkillsToSelect = 0;
        let selectedClassSkills = [];

        function initBackgrounds() {
            const grid = document.getElementById('backgroundGrid');
            grid.innerHTML = '';

            Object.keys(BACKGROUNDS).forEach(bgKey => {
                const bg = BACKGROUNDS[bgKey];
                const card = document.createElement('div');
                card.className = 'background-card';
                card.dataset.background = bgKey;
                card.onclick = () => selectBackground(bgKey);

                card.innerHTML = `
                    <div class="background-icon">${bg.icon}</div>
                    <div class="background-name">${bg.name}</div>
                    <div class="background-skills">${bg.skills.join(', ')}</div>
                `;

                grid.appendChild(card);
            });
        }

        function selectBackground(bgKey) {
            character.background = bgKey;
            const bg = BACKGROUNDS[bgKey];

            // Update card selection
            document.querySelectorAll('.background-card').forEach(c => {
                c.classList.toggle('selected', c.dataset.background === bgKey);
            });

            // Show background details
            const details = document.getElementById('backgroundDetails');
            details.style.display = 'block';

            document.getElementById('bgDetailsIcon').textContent = bg.icon;
            document.getElementById('bgDetailsName').textContent = bg.name;

            // Proficiencies
            let profText = `<strong>Skills:</strong> ${bg.skills.join(', ')}`;
            if (bg.tools.length > 0) {
                profText += `<br><strong>Tools:</strong> ${bg.tools.join(', ')}`;
            }
            if (bg.languages > 0) {
                profText += `<br><strong>Languages:</strong> ${bg.languages} of your choice`;
            }
            document.getElementById('bgProficiencies').innerHTML = profText;

            // Feature
            document.getElementById('bgFeatureName').textContent = bg.feature;
            document.getElementById('bgFeatureDesc').textContent = bg.featureDesc;

            // Equipment
            document.getElementById('bgEquipment').textContent = bg.equipment;

            // Show skills section
            initSkillsSection();

            // Show personality section
            initPersonalitySection(bgKey);

            // Enable next button if valid
            checkBackgroundComplete();

            playSound('click');
            updatePreview();
        }

        function initSkillsSection() {
            const section = document.getElementById('skillsSection');
            section.style.display = 'block';

            const grid = document.getElementById('skillsGrid');
            grid.innerHTML = '';

            // Get class skill choices
            const cls = CLASSES[character.class];
            const bgSkills = BACKGROUNDS[character.background].skills;

            // Calculate how many class skills to select
            classSkillsToSelect = cls.skills;
            selectedClassSkills = [];

            // Get race skill proficiencies (like Elf: Perception)
            let raceSkills = [];
            if (character.race === 'elf') raceSkills.push('Perception');
            if (character.race === 'halfelf') {
                // Half-elf gets 2 skill proficiencies - we'd need another selection UI
                // For now, just note it
            }
            if (character.race === 'human' && character.subrace === 'variant') {
                // Variant human gets 1 skill - would need selection
            }

            // Update subtitle
            const subtitle = document.getElementById('skillsSubtitle');
            subtitle.textContent = `Background grants: ${bgSkills.join(', ')}. Select ${classSkillsToSelect} from class options.`;

            // Create skill items
            Object.keys(SKILLS).forEach(skill => {
                const ability = SKILLS[skill];
                const item = document.createElement('div');
                item.className = 'skill-item';
                item.dataset.skill = skill;

                const isBackgroundSkill = bgSkills.includes(skill);
                const isRaceSkill = raceSkills.includes(skill);
                // Check if class can choose this skill - 'Any' means all skills are available
                const isClassOption = cls.skillChoices.includes('Any') || cls.skillChoices.includes(skill);

                if (isBackgroundSkill || isRaceSkill) {
                    item.classList.add('granted');
                    if (!character.skills.includes(skill)) {
                        character.skills.push(skill);
                    }
                    item.innerHTML = `
                        <span class="skill-name">${skill} <span class="skill-source">(${isBackgroundSkill ? 'BG' : 'Race'})</span></span>
                        <span class="skill-ability">${ability}</span>
                    `;
                } else if (isClassOption) {
                    item.onclick = () => toggleClassSkill(skill);
                    item.innerHTML = `
                        <span class="skill-name">${skill}</span>
                        <span class="skill-ability">${ability}</span>
                    `;
                } else {
                    item.classList.add('locked');
                    item.innerHTML = `
                        <span class="skill-name">${skill}</span>
                        <span class="skill-ability">${ability}</span>
                    `;
                }

                grid.appendChild(item);
            });
        }

        function toggleClassSkill(skill) {
            const index = selectedClassSkills.indexOf(skill);

            if (index > -1) {
                // Remove skill
                selectedClassSkills.splice(index, 1);
                character.skills = character.skills.filter(s => s !== skill);
            } else if (selectedClassSkills.length < classSkillsToSelect) {
                // Add skill
                selectedClassSkills.push(skill);
                if (!character.skills.includes(skill)) {
                    character.skills.push(skill);
                }
            } else {
                // At max - remove first and add new
                const removed = selectedClassSkills.shift();
                character.skills = character.skills.filter(s => s !== removed);
                selectedClassSkills.push(skill);
                if (!character.skills.includes(skill)) {
                    character.skills.push(skill);
                }
            }

            // Update UI
            document.querySelectorAll('.skill-item').forEach(item => {
                if (!item.classList.contains('granted') && !item.classList.contains('locked')) {
                    item.classList.toggle('selected', selectedClassSkills.includes(item.dataset.skill));
                }
            });

            // Update subtitle
            const remaining = classSkillsToSelect - selectedClassSkills.length;
            const subtitle = document.getElementById('skillsSubtitle');
            const bgSkills = BACKGROUNDS[character.background].skills;
            if (remaining > 0) {
                subtitle.textContent = `Background grants: ${bgSkills.join(', ')}. Select ${remaining} more skill(s).`;
            } else {
                subtitle.textContent = `Background grants: ${bgSkills.join(', ')}. Class skills selected!`;
            }

            checkBackgroundComplete();
            playSound('click');
            updatePreview();
        }

        function initPersonalitySection(bgKey) {
            const section = document.getElementById('personalitySection');
            section.style.display = 'block';

            const bg = BACKGROUNDS[bgKey];

            // Populate trait options
            populatePersonalityOptions('trait', bg.traits);
            populatePersonalityOptions('ideal', bg.ideals);
            populatePersonalityOptions('bond', bg.bonds);
            populatePersonalityOptions('flaw', bg.flaws);
        }

        function populatePersonalityOptions(type, options) {
            const container = document.getElementById(`${type}Options`);
            container.innerHTML = '';

            options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'personality-option';
                div.textContent = option;
                div.onclick = () => selectPersonality(type, index, option);

                if (character.personality[type] === option) {
                    div.classList.add('selected');
                }

                container.appendChild(div);
            });
        }

        function selectPersonality(type, index, value) {
            character.personality[type] = value;

            // Update UI
            const container = document.getElementById(`${type}Options`);
            container.querySelectorAll('.personality-option').forEach((opt, i) => {
                opt.classList.toggle('selected', i === index);
            });

            checkBackgroundComplete();
            playSound('click');
        }

        function randomPersonality(type) {
            const bg = BACKGROUNDS[character.background];
            let options;
            switch(type) {
                case 'trait': options = bg.traits; break;
                case 'ideal': options = bg.ideals; break;
                case 'bond': options = bg.bonds; break;
                case 'flaw': options = bg.flaws; break;
            }

            const randomIndex = Math.floor(Math.random() * options.length);
            selectPersonality(type, randomIndex, options[randomIndex]);
            playSound('dice');
        }

        function checkBackgroundComplete() {
            const btn = document.getElementById('bgNextBtn');
            const hasBackground = character.background !== null;
            const hasEnoughSkills = selectedClassSkills.length === classSkillsToSelect;
            const hasPersonality = character.personality.trait && character.personality.ideal &&
                                   character.personality.bond && character.personality.flaw;

            btn.disabled = !(hasBackground && hasEnoughSkills && hasPersonality);
        }

        // ===== EQUIPMENT FUNCTIONS =====
        function initEquipment() {
            const cls = character.class;
            const equipData = EQUIPMENT[cls];

            if (!equipData) return;

            const choicesContainer = document.getElementById('equipmentChoices');
            const grantedList = document.getElementById('grantedList');

            choicesContainer.innerHTML = '';
            grantedList.innerHTML = '';
            character.equipment.choices = {};
            character.equipment.granted = [...equipData.granted];

            // Render equipment choices
            equipData.choices.forEach((choice, index) => {
                const div = document.createElement('div');
                div.className = 'equipment-choice';
                div.innerHTML = `
                    <div class="equipment-choice-title">${choice.name}</div>
                    <div class="equipment-options" data-choice="${index}">
                        ${choice.options.map((opt, optIndex) => `
                            <div class="equipment-option" data-choice="${index}" data-option="${optIndex}" onclick="selectEquipment(${index}, ${optIndex}, '${opt.replace(/'/g, "\\'")}')">
                                ${opt}
                            </div>
                        `).join('')}
                    </div>
                `;
                choicesContainer.appendChild(div);
            });

            // Render granted equipment
            equipData.granted.forEach(item => {
                const div = document.createElement('div');
                div.className = 'equipment-item';
                div.textContent = 'â€¢ ' + item;
                grantedList.appendChild(div);
            });

            // Add background equipment
            if (character.background) {
                const bg = BACKGROUNDS[character.background];
                const bgDiv = document.createElement('div');
                bgDiv.className = 'equipment-item';
                bgDiv.textContent = 'â€¢ (Background) ' + bg.equipment;
                bgDiv.style.color = '#8b2500';
                grantedList.appendChild(bgDiv);
            }

            updateInventorySummary();
        }

        function selectEquipment(choiceIndex, optionIndex, itemName) {
            // Check if this option is incompatible
            const option = document.querySelector(`.equipment-option[data-choice="${choiceIndex}"][data-option="${optionIndex}"]`);
            if (option && option.classList.contains('incompatible')) {
                playSound('click');
                return; // Don't allow selecting incompatible items
            }

            // Check if already selected - if so, deselect it
            if (character.equipment.choices[choiceIndex] === itemName) {
                delete character.equipment.choices[choiceIndex];
                // Update UI - deselect
                document.querySelectorAll(`.equipment-option[data-choice="${choiceIndex}"]`).forEach(opt => {
                    opt.classList.remove('selected');
                });
            } else {
                // Select the new item
                character.equipment.choices[choiceIndex] = itemName;
                // Update UI
                document.querySelectorAll(`.equipment-option[data-choice="${choiceIndex}"]`).forEach((opt, i) => {
                    opt.classList.toggle('selected', i === optionIndex);
                });
            }

            // Update compatibility for other choices
            updateEquipmentCompatibility();

            updateInventorySummary();
            updatePreview(); // Ensure AC updates
            playSound('click');
        }

        function updateInventorySummary() {
            const inventoryList = document.getElementById('inventoryList');
            inventoryList.innerHTML = '';

            // Add granted items
            character.equipment.granted.forEach(item => {
                const div = document.createElement('div');
                div.className = 'equipment-item';
                div.textContent = 'â€¢ ' + item;
                inventoryList.appendChild(div);
            });

            // Add chosen items
            Object.values(character.equipment.choices).forEach(item => {
                const div = document.createElement('div');
                div.className = 'equipment-item';
                div.textContent = 'â€¢ ' + item;
                div.style.color = '#2e7d32';
                inventoryList.appendChild(div);
            });

            // Add background equipment
            if (character.background) {
                const bg = BACKGROUNDS[character.background];
                const bgDiv = document.createElement('div');
                bgDiv.className = 'equipment-item';
                bgDiv.textContent = 'â€¢ ' + bg.equipment;
                bgDiv.style.color = '#8b2500';
                inventoryList.appendChild(bgDiv);
            }

            updatePreview();
        }

        // Check if a weapon is two-handed (requires both hands, incompatible with shield)
        function isTwoHandedWeapon(itemName) {
            // Strictly two-handed weapons only (not versatile weapons like quarterstaff, longsword, etc.)
            const twoHandedWeapons = [
                'Greataxe', 'Greatsword', 'Maul', 'Glaive', 'Halberd', 'Pike',
                'Heavy crossbow'
            ];

            // Dual-wield options that use both hands
            const dualWieldOptions = [
                'Two longswords', 'Two shortswords', 'Two handaxes', 'Two javelins',
                'Two daggers', 'Two martial weapons', 'Two light hammers',
                'Quarterstaff and Dagger', 'Shortsword and Scimitar'
            ];

            const itemLower = itemName.toLowerCase();

            // Check for "Two X" pattern (dual wielding)
            if (itemName.startsWith('Two ')) return true;

            // Check for "X and Y" weapon combos (dual wielding)
            if (itemLower.includes(' and ') && !itemLower.includes('bolts') && !itemLower.includes('arrows') && !itemLower.includes('bullets')) {
                return true;
            }

            // Bows require two hands to shoot
            if (itemLower.includes('longbow') || itemLower.includes('shortbow')) return true;
            if (itemLower.includes('crossbow')) return true;
            if (itemLower.includes('musket')) return true;

            // Check exact matches for heavy two-handed melee weapons
            return twoHandedWeapons.some(w => itemName === w);
        }

        // Check if an item is a shield option (but not "No shield")
        function isShieldItem(itemName) {
            const itemLower = itemName.toLowerCase();
            return itemLower.includes('shield') && !itemLower.includes('no shield');
        }

        // Check if an item includes a shield (like "Longsword and Shield")
        function includesShield(itemName) {
            return itemName.toLowerCase().includes('and shield');
        }

        // Check if selecting "No shield" option
        function isNoShieldOption(itemName) {
            return itemName.toLowerCase().includes('no shield');
        }

        // Update equipment option availability based on compatibility
        function updateEquipmentCompatibility() {
            const equipData = EQUIPMENT[character.class];
            if (!equipData) return;

            // Find which choice indices are "Primary Weapon" and "Shield"
            let primaryWeaponIndex = -1;
            let shieldIndex = -1;
            equipData.choices.forEach((choice, index) => {
                const nameLower = choice.name.toLowerCase();
                if (nameLower.includes('primary') && nameLower.includes('weapon')) {
                    primaryWeaponIndex = index;
                }
                if (nameLower === 'shield') {
                    shieldIndex = index;
                }
            });

            // Check primary weapon choice for two-handed weapons
            let hasTwoHandedPrimary = false;
            let hasShield = false;

            Object.entries(character.equipment.choices).forEach(([index, item]) => {
                const idx = parseInt(index);
                // Only check primary weapon for two-handed
                if (idx === primaryWeaponIndex && isTwoHandedWeapon(item)) {
                    hasTwoHandedPrimary = true;
                }
                // Check shield selection
                if (idx === shieldIndex && isShieldItem(item) && !isNoShieldOption(item)) {
                    hasShield = true;
                }
            });

            // Update equipment options - only apply restrictions to Primary Weapon and Shield choices
            document.querySelectorAll('.equipment-option').forEach(option => {
                const choiceIndex = parseInt(option.dataset.choice);
                const itemName = option.textContent.trim();
                const isSelected = option.classList.contains('selected');

                // Don't disable currently selected items
                if (isSelected) {
                    option.classList.remove('incompatible');
                    return;
                }

                let incompatible = false;

                // If primary weapon is two-handed, disable shield options (but not "No shield")
                if (hasTwoHandedPrimary && choiceIndex === shieldIndex && isShieldItem(itemName) && !isNoShieldOption(itemName)) {
                    incompatible = true;
                }

                // If we have a shield, disable two-handed primary weapons only
                if (hasShield && choiceIndex === primaryWeaponIndex && isTwoHandedWeapon(itemName)) {
                    incompatible = true;
                }

                option.classList.toggle('incompatible', incompatible);
            });
        }

        // Calculate AC based on equipment choices
        function calculateAC() {
            if (!character.class) return null;

            const dexMod = getModifierValue(getFinalAbilityScore('DEX'));
            let baseAC = 10 + dexMod; // Unarmored
            let hasShield = false;

            // Check equipment choices for armor and shield
            Object.values(character.equipment.choices).forEach(item => {
                const itemLower = item.toLowerCase();

                // Check for shield (but not "no shield")
                if (itemLower.includes('shield') && !itemLower.includes('no shield')) {
                    hasShield = true;
                }

                // Check for armor types
                if (itemLower.includes('chain mail') || itemLower.includes('(ac 16')) {
                    baseAC = 16; // Chain mail, no DEX
                } else if (itemLower.includes('scale mail') || itemLower.includes('(ac 14')) {
                    baseAC = 14 + Math.min(2, dexMod); // Scale mail, max +2 DEX
                } else if (itemLower.includes('leather armor') || itemLower.includes('(ac 11')) {
                    baseAC = 11 + dexMod; // Leather armor
                }
            });

            // Check granted equipment for armor
            character.equipment.granted.forEach(item => {
                const itemLower = item.toLowerCase();
                if (itemLower.includes('chain mail')) {
                    baseAC = 16;
                } else if (itemLower.includes('leather armor')) {
                    baseAC = Math.max(baseAC, 11 + dexMod);
                }
            });

            // Barbarian unarmored defense
            if (character.class === 'barbarian') {
                const conMod = getModifierValue(getFinalAbilityScore('CON'));
                const barbarianAC = 10 + dexMod + conMod;
                baseAC = Math.max(baseAC, barbarianAC);
            }

            // Monk unarmored defense
            if (character.class === 'monk') {
                const wisMod = getModifierValue(getFinalAbilityScore('WIS'));
                const monkAC = 10 + dexMod + wisMod;
                baseAC = Math.max(baseAC, monkAC);
            }

            // Add shield bonus
            if (hasShield) {
                baseAC += 2;
            }

            return baseAC;
        }

        // ===== SPELLS FUNCTIONS =====
        let maxCantrips = 0;
        let maxSpellsKnown = 0;
        let currentMaxSpellLevel = 0;
        let spellLimits = {}; // Track limits per level

        function initSpells() {
            const cls = character.class;
            const spellInfo = SPELLCASTING[cls];
            const level = character.level;

            // Check if class is a spellcaster at current level
            if (!spellInfo || (spellInfo.startLevel && level < spellInfo.startLevel)) {
                document.getElementById('nonCasterMessage').style.display = 'block';
                document.getElementById('spellcastingSection').style.display = 'none';
                if (spellInfo && spellInfo.startLevel) {
                    document.getElementById('spellsSubtitle').textContent = `${CLASSES[cls].name}s begin casting spells at level ${spellInfo.startLevel}`;
                } else {
                    document.getElementById('spellsSubtitle').textContent = 'Your class does not have spellcasting';
                }
                return;
            }

            document.getElementById('nonCasterMessage').style.display = 'none';
            document.getElementById('spellcastingSection').style.display = 'block';

            // Get spell progression for this level
            const progression = getSpellProgression(cls, level);
            currentMaxSpellLevel = getMaxSpellLevel(cls, level);

            // Set spell limits
            maxCantrips = progression.cantrips || 0;
            maxSpellsKnown = progression.spellsKnown || 0;

            // For prepared casters, calculate spells prepared
            if (spellInfo.prepared) {
                const abilityMod = getModifierValue(getFinalAbilityScore(spellInfo.ability));
                if (spellInfo.type === 'half') {
                    maxSpellsKnown = Math.max(1, abilityMod + Math.floor(level / 2));
                } else {
                    maxSpellsKnown = Math.max(1, abilityMod + level);
                }
            }

            // Build slot display string
            let slotsDisplay = '';
            if (spellInfo.type === 'pact') {
                slotsDisplay = `${progression.slots} slots (${getOrdinal(progression.slotLevel)} level)`;
            } else {
                const slots = progression.slots;
                let slotParts = [];
                for (let i = 0; i < slots.length; i++) {
                    if (slots[i] > 0) {
                        slotParts.push(`${getOrdinal(i+1)}: ${slots[i]}`);
                    }
                }
                slotsDisplay = slotParts.join(', ');
            }

            // Update spell info panel
            const infoPanel = document.getElementById('spellInfoPanel');
            infoPanel.innerHTML = `
                <div class="spell-info-item">
                    <div class="spell-info-label">SPELLCASTING ABILITY</div>
                    <div class="spell-info-value">${spellInfo.ability}</div>
                </div>
                <div class="spell-info-item">
                    <div class="spell-info-label">CANTRIPS KNOWN</div>
                    <div class="spell-info-value">${maxCantrips}</div>
                </div>
                <div class="spell-info-item">
                    <div class="spell-info-label">SPELLS ${spellInfo.prepared ? 'PREPARED' : 'KNOWN'}</div>
                    <div class="spell-info-value">${maxSpellsKnown}</div>
                </div>
                <div class="spell-info-item">
                    <div class="spell-info-label">MAX SPELL LEVEL</div>
                    <div class="spell-info-value">${getOrdinal(currentMaxSpellLevel)}</div>
                </div>
                <div class="spell-info-item spell-info-wide">
                    <div class="spell-info-label">SPELL SLOTS</div>
                    <div class="spell-info-value spell-slots-display">${slotsDisplay}</div>
                </div>
            `;

            // Update subtitle
            document.getElementById('spellsSubtitle').textContent =
                `Select ${maxCantrips} cantrips and up to ${maxSpellsKnown} spells (max level ${currentMaxSpellLevel})`;

            // Build spell level sections dynamically
            buildSpellLevelSections(cls);

            // Update counts
            updateSpellCounts();
        }

        function getOrdinal(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function buildSpellLevelSections(cls) {
            const container = document.getElementById('spellLevelsContainer');
            container.innerHTML = '';

            // Cantrips section (if class has cantrips)
            if (maxCantrips > 0) {
                const cantripsSection = document.createElement('div');
                cantripsSection.className = 'cantrips-section';
                cantripsSection.innerHTML = `
                    <div class="spell-section-title">CANTRIPS <span id="cantripCount">(0/${maxCantrips})</span></div>
                    <div class="spell-grid" id="cantripGrid"></div>
                `;
                container.appendChild(cantripsSection);
                populateSpellGrid('cantrips', 'cantripGrid', cls);
            }

            // Leveled spell sections
            for (let lvl = 1; lvl <= currentMaxSpellLevel; lvl++) {
                const levelKey = `level${lvl}`;
                const section = document.createElement('div');
                section.className = 'spells-section';
                section.innerHTML = `
                    <div class="spell-section-title">LEVEL ${lvl} SPELLS <span id="spell${lvl}Count">(0)</span></div>
                    <div class="spell-grid" id="spellLevel${lvl}Grid"></div>
                `;
                container.appendChild(section);
                populateSpellGrid(levelKey, `spellLevel${lvl}Grid`, cls);
            }
        }

        function populateSpellGrid(spellLevel, gridId, cls) {
            const grid = document.getElementById(gridId);
            if (!grid) return;
            grid.innerHTML = '';

            const spellList = SPELLS[spellLevel];
            if (!spellList) return;

            // Get subclass granted spells to mark them
            const subclassGranted = getSubclassGrantedSpells();
            const grantedSpellsList = spellLevel === 'cantrips' ? subclassGranted.cantrips : subclassGranted.spells;

            Object.keys(spellList).sort().forEach(spellName => {
                const spell = spellList[spellName];

                // Check if this is a subclass granted spell
                const isGranted = grantedSpellsList.includes(spellName);

                // Only show spells available to this class (or if granted by subclass)
                if (!spell.classes.includes(cls) && !isGranted) return;

                const card = document.createElement('div');
                card.className = 'spell-card';
                card.dataset.spell = spellName;
                card.dataset.level = spellLevel;

                // Subclass-granted spells are shown differently
                if (isGranted) {
                    card.classList.add('spell-granted');
                    card.onclick = null; // Can't deselect granted spells
                    card.innerHTML = `
                        <div class="spell-name">${spellName}<span class="granted-spell-badge">GRANTED</span></div>
                        <div class="spell-school">${spell.school}</div>
                        <div class="spell-desc">${spell.desc}</div>
                    `;
                } else {
                    card.onclick = () => toggleSpell(spellName, spellLevel);
                    card.innerHTML = `
                        <div class="spell-name">${spellName}</div>
                        <div class="spell-school">${spell.school}</div>
                        <div class="spell-desc">${spell.desc}</div>
                    `;
                }

                // Check if already selected
                if (character.spells[spellLevel] && character.spells[spellLevel].includes(spellName)) {
                    card.classList.add('selected');
                }

                grid.appendChild(card);
            });

            // Also add any subclass-granted spells that aren't in the normal spell list
            grantedSpellsList.forEach(spellName => {
                // Check if already added from main list
                if (grid.querySelector(`[data-spell="${spellName}"]`)) return;

                // Create a card for granted spells not in the class list
                const card = document.createElement('div');
                card.className = 'spell-card spell-granted';
                card.dataset.spell = spellName;
                card.dataset.level = spellLevel;

                card.innerHTML = `
                    <div class="spell-name">${spellName}<span class="granted-spell-badge">GRANTED</span></div>
                    <div class="spell-school">Subclass</div>
                    <div class="spell-desc">Granted by your subclass - always prepared</div>
                `;

                // Insert at the beginning
                grid.insertBefore(card, grid.firstChild);
            });
        }

        function toggleSpell(spellName, spellLevel) {
            const spellArray = character.spells[spellLevel];
            if (!spellArray) return;

            // Count total non-cantrip spells
            const totalLeveledSpells = getTotalLeveledSpells();
            const isCantrip = spellLevel === 'cantrips';
            const maxForLevel = isCantrip ? maxCantrips : maxSpellsKnown;

            const index = spellArray.indexOf(spellName);

            if (index > -1) {
                // Remove spell
                spellArray.splice(index, 1);
            } else {
                // Check limits
                if (isCantrip) {
                    if (spellArray.length >= maxCantrips) {
                        playSound('click');
                        return;
                    }
                } else {
                    if (totalLeveledSpells >= maxSpellsKnown) {
                        playSound('click');
                        return;
                    }
                }
                spellArray.push(spellName);
            }

            // Update UI
            const card = document.querySelector(`.spell-card[data-spell="${spellName}"][data-level="${spellLevel}"]`);
            if (card) {
                card.classList.toggle('selected', spellArray.includes(spellName));
            }

            updateSpellCounts();
            updatePreview();
            playSound('click');
        }

        function getTotalLeveledSpells() {
            let total = 0;
            for (let lvl = 1; lvl <= 9; lvl++) {
                total += (character.spells[`level${lvl}`] || []).length;
            }
            return total;
        }

        function updateSpellCounts() {
            // Update cantrip count
            const cantripEl = document.getElementById('cantripCount');
            if (cantripEl) {
                const cantripCount = character.spells.cantrips.length;
                cantripEl.textContent = `(${cantripCount}/${maxCantrips})`;
                cantripEl.style.color = cantripCount === maxCantrips ? '#2e7d32' : '#daa520';
            }

            // Update leveled spell counts
            const totalLeveledSpells = getTotalLeveledSpells();
            for (let lvl = 1; lvl <= currentMaxSpellLevel; lvl++) {
                const el = document.getElementById(`spell${lvl}Count`);
                if (el) {
                    const count = (character.spells[`level${lvl}`] || []).length;
                    el.textContent = `(${count})`;
                    el.style.color = count > 0 ? '#2e7d32' : '#6b4423';
                }
            }

            // Update total display in subtitle
            document.getElementById('spellsSubtitle').textContent =
                `Cantrips: ${character.spells.cantrips.length}/${maxCantrips} | Spells: ${totalLeveledSpells}/${maxSpellsKnown}`;

            // Check if we can proceed
            checkSpellsComplete();
        }

        function checkSpellsComplete() {
            const btn = document.getElementById('spellsNextBtn');
            const spellInfo = SPELLCASTING[character.class];

            // Non-casters can always proceed
            if (!spellInfo || (spellInfo.startLevel && character.level < spellInfo.startLevel)) {
                btn.disabled = false;
                return;
            }

            const cantripsComplete = maxCantrips === 0 || character.spells.cantrips.length === maxCantrips;
            const spellsComplete = getTotalLeveledSpells() >= 1; // At least 1 spell selected

            btn.disabled = !(cantripsComplete && spellsComplete);
        }

        function getModifierValue(score) {
            return Math.floor((score - 10) / 2);
        }

        // ===== LEVEL & ADVANCEMENT FUNCTIONS =====
        function initLevelSection() {
            setLevel(character.level);
            checkVariantHumanFeat();
            updateLevelSummary();
            buildSubclassFeaturesPanel();
            updateSpellSummary();
            buildASISections();
            buildFeatOptionsSection();
        }

        function adjustLevel(delta) {
            const newLevel = Math.max(1, Math.min(20, character.level + delta));
            setLevel(newLevel);
        }

        function setLevel(level) {
            level = parseInt(level);
            character.level = level;

            document.getElementById('levelDisplay').textContent = level;
            document.getElementById('levelSlider').value = level;

            updateLevelSummary();
            buildASISections();
            buildSubclassFeaturesPanel(); // Show subclass features for current level
            updateSpellSummary(); // Update spell display on level page
            updatePreview();
            playSound('click');
        }

        function updateSpellSummary() {
            const spellInfo = SPELLCASTING[character.class];
            const spellSummary = document.getElementById('spellSummaryPanel');
            if (!spellSummary) return;

            if (!spellInfo || (spellInfo.startLevel && character.level < spellInfo.startLevel)) {
                spellSummary.style.display = 'none';
                return;
            }

            spellSummary.style.display = 'block';

            const maxLevel = getMaxSpellLevel(character.class, character.level);
            const progression = getSpellProgression(character.class, character.level);

            // Get subclass granted spells
            const subclassGranted = getSubclassGrantedSpells();
            const grantedCantripsCount = subclassGranted.cantrips.length;
            const grantedSpellsCount = subclassGranted.spells.length;

            // Count current spells
            const cantripCount = character.spells.cantrips.length;
            const leveledCount = getTotalLeveledSpells();

            // Calculate max spells known/prepared
            let maxSpells = progression.spellsKnown || 0;
            if (spellInfo.prepared) {
                const abilityMod = getModifierValue(getFinalAbilityScore(spellInfo.ability));
                if (spellInfo.type === 'half') {
                    maxSpells = Math.max(1, abilityMod + Math.floor(character.level / 2));
                } else {
                    maxSpells = Math.max(1, abilityMod + character.level);
                }
            }

            // Build slot display
            let slotsHtml = '';
            if (spellInfo.type === 'pact') {
                slotsHtml = `<span class="slot-info">${progression.slots} Ã— ${getOrdinal(progression.slotLevel)} level</span>`;
            } else {
                const slots = progression.slots;
                for (let i = 0; i < slots.length; i++) {
                    if (slots[i] > 0) {
                        slotsHtml += `<span class="slot-info">${getOrdinal(i+1)}: ${slots[i]}</span>`;
                    }
                }
            }

            const needsMoreSpells = leveledCount < maxSpells || cantripCount < (progression.cantrips || 0);

            // Build subclass spells display
            let subclassSpellsHtml = '';
            if (grantedSpellsCount > 0 || grantedCantripsCount > 0) {
                subclassSpellsHtml = `
                    <div class="subclass-spells-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #8b4513;">
                        <div style="color: #b8860b; font-size: 0.55rem; margin-bottom: 4px;">â˜… SUBCLASS SPELLS (Always Prepared)</div>
                        ${grantedCantripsCount > 0 ? `<div style="color: #2e7d32; font-size: 0.5rem;">Cantrips: ${subclassGranted.cantrips.join(', ')}</div>` : ''}
                        ${grantedSpellsCount > 0 ? `<div style="color: #2e7d32; font-size: 0.5rem;">Spells: ${subclassGranted.spells.join(', ')}</div>` : ''}
                    </div>
                `;
            }

            spellSummary.innerHTML = `
                <div class="spell-summary-title">ðŸ“œ SPELLCASTING</div>
                <div class="spell-summary-stats">
                    <div>Max Spell Level: <strong>${getOrdinal(maxLevel)}</strong></div>
                    <div>Cantrips: <strong>${cantripCount}/${progression.cantrips || 0}</strong>${grantedCantripsCount > 0 ? ` <span style="color: #b8860b;">(+${grantedCantripsCount} granted)</span>` : ''}</div>
                    <div>Spells Known: <strong>${leveledCount}/${maxSpells}</strong>${grantedSpellsCount > 0 ? ` <span style="color: #b8860b;">(+${grantedSpellsCount} granted)</span>` : ''}</div>
                </div>
                <div class="spell-slots-row">
                    <div class="slot-label">Spell Slots:</div>
                    ${slotsHtml}
                </div>
                ${subclassSpellsHtml}
                ${needsMoreSpells ? `<div class="spell-warning">âš ï¸ Go back to Spells step to select more spells</div>` : ''}
                <button class="edit-spells-btn" onclick="goToStep(7)">ðŸ“– EDIT SPELLS</button>
            `;
        }

        function buildSubclassFeaturesPanel() {
            // Check if container exists, create if not
            let container = document.getElementById('subclassFeaturesPanel');
            if (!container) {
                // Find the right place to insert (after spell summary)
                const spellSummary = document.getElementById('spellSummaryPanel');
                if (!spellSummary) return;

                container = document.createElement('div');
                container.id = 'subclassFeaturesPanel';
                container.className = 'subclass-features-panel';
                spellSummary.after(container);
            }

            const features = getSubclassFeatures();

            if (features.length === 0 || !character.subclass) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            const cls = CLASSES[character.class];
            const subclassName = cls.subclasses[character.subclass].name;

            let featuresHtml = features.map(f => `
                <div class="subclass-feature-card">
                    <div class="subclass-feature-name">${f.name}</div>
                    <div class="subclass-feature-level">Level ${f.level}</div>
                    <div class="subclass-feature-desc">${f.desc}</div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="subclass-features-title">âš”ï¸ ${subclassName.toUpperCase()} FEATURES</div>
                <div class="subclass-features-grid">
                    ${featuresHtml}
                </div>
            `;
        }

        function updateLevelSummary() {
            // Proficiency bonus
            const profBonus = Math.ceil(character.level / 4) + 1;
            document.getElementById('profBonus').textContent = '+' + profBonus;

            // HP calculation
            if (character.class) {
                const cls = CLASSES[character.class];
                const hitDieMax = parseInt(cls.hitDie.substring(1));
                const conMod = getModifierValue(getFinalAbilityScore('CON'));
                // Level 1: max die + CON, subsequent levels: average + CON
                const avgDie = Math.floor(hitDieMax / 2) + 1;
                const hp = hitDieMax + conMod + (character.level - 1) * (avgDie + conMod);
                document.getElementById('levelHP').textContent = Math.max(1, hp);
            }

            // Spell slots for casters
            const spellInfo = SPELLCASTING[character.class];
            if (spellInfo && (!spellInfo.startLevel || character.level >= spellInfo.startLevel)) {
                document.getElementById('spellSlotsSummary').style.display = 'block';
                const slots = getSpellSlots(character.level, character.class);
                document.getElementById('levelSpellSlots').textContent = slots;
            } else {
                document.getElementById('spellSlotsSummary').style.display = 'none';
            }
        }

        function getSpellSlots(level, cls) {
            // Simplified spell slot progression
            const fullCaster = ['bard', 'cleric', 'druid', 'sorcerer', 'wizard'];
            const halfCaster = ['paladin', 'ranger'];
            const pactMagic = ['warlock'];

            if (pactMagic.includes(cls)) {
                // Warlock pact magic slots
                const slots = level >= 17 ? 4 : level >= 11 ? 3 : level >= 2 ? 2 : 1;
                const slotLevel = Math.min(5, Math.ceil(level / 2));
                return `${slots} Ã— Lvl ${slotLevel}`;
            }

            if (fullCaster.includes(cls)) {
                const slotTable = [
                    '2', '3', '4/2', '4/3', '4/3/2', '4/3/3', '4/3/3/1', '4/3/3/2',
                    '4/3/3/3/1', '4/3/3/3/2', '4/3/3/3/2/1', '4/3/3/3/2/1',
                    '4/3/3/3/2/1/1', '4/3/3/3/2/1/1', '4/3/3/3/2/1/1/1',
                    '4/3/3/3/2/1/1/1', '4/3/3/3/2/1/1/1/1', '4/3/3/3/3/1/1/1/1',
                    '4/3/3/3/3/2/1/1/1', '4/3/3/3/3/2/2/1/1'
                ];
                return slotTable[level - 1];
            }

            if (halfCaster.includes(cls) && level >= 2) {
                const effectiveLevel = Math.floor(level / 2);
                const slotTable = ['2', '3', '3', '4/2', '4/2', '4/3', '4/3', '4/3/2', '4/3/2', '4/3/3'];
                return slotTable[Math.min(effectiveLevel - 1, 9)] || '4/3/3';
            }

            return '--';
        }

        function getFinalAbilityScore(ability) {
            let score = character.abilities[ability];
            score += getRacialBonus(ability);

            // Add ASI bonuses from level advancement
            Object.values(character.asiChoices).forEach(choice => {
                if (choice.type === 'asi' && choice.abilities) {
                    choice.abilities.forEach(a => {
                        if (a === ability) score += 1;
                    });
                }
                // Add feat bonuses from ASI/Feat choices
                if (choice.type === 'feat' && choice.feat) {
                    score += getFeatAbilityBonus(choice.feat, ability, choice.featAbilityChoice);
                }
            });

            // Add bonuses from Variant Human feat
            character.feats.forEach(f => {
                if (f.source === 'variantHuman' && f.key) {
                    score += getFeatAbilityBonus(f.key, ability, f.abilityChoice);
                }
            });

            return Math.min(20, score); // Cap at 20
        }

        // Get ability bonus from a feat
        function getFeatAbilityBonus(featKey, ability, chosenAbility) {
            const feat = FEATS[featKey];
            if (!feat) return 0;

            // Fixed bonus (e.g., Actor gives +1 CHA)
            if (feat.asiBonus && feat.asiBonus[ability]) {
                return feat.asiBonus[ability];
            }

            // Choice bonus (e.g., Athlete gives +1 STR or DEX)
            if (feat.asiChoice && chosenAbility === ability) {
                return 1;
            }

            return 0;
        }

        function checkVariantHumanFeat() {
            const isVariantHuman = character.race === 'human' && character.subrace === 'variant';
            const panel = document.getElementById('variantHumanFeat');

            if (isVariantHuman) {
                panel.style.display = 'block';
                populateFeatGrid('variantFeatGrid', 'variantHuman');
            } else {
                panel.style.display = 'none';
            }
        }

        function buildASISections() {
            const container = document.getElementById('asiContainer');
            container.innerHTML = '';

            const asiLevels = ASI_LEVELS[character.class] || ASI_LEVELS.default;
            const availableASIs = asiLevels.filter(lvl => lvl <= character.level);

            if (availableASIs.length === 0) {
                container.innerHTML = '<div class="asi-section"><div class="asi-subtitle">Reach level 4 to gain Ability Score Improvements or Feats</div></div>';
                return;
            }

            availableASIs.forEach(level => {
                const section = document.createElement('div');
                section.className = 'asi-section';
                section.id = `asi-${level}`;

                const choice = character.asiChoices[level] || { type: null };

                section.innerHTML = `
                    <div class="asi-title">â¬†ï¸ LEVEL ${level} ADVANCEMENT</div>
                    <div class="asi-subtitle">Choose: Increase ability scores OR gain a feat</div>
                    <div class="asi-toggle">
                        <button class="asi-toggle-btn ${choice.type === 'asi' ? 'active' : ''}" onclick="selectASIType(${level}, 'asi')">+2 ABILITY SCORES</button>
                        <button class="asi-toggle-btn ${choice.type === 'feat' ? 'active' : ''}" onclick="selectASIType(${level}, 'feat')">FEAT</button>
                    </div>
                    <div class="asi-abilities ${choice.type === 'asi' ? 'active' : ''}" id="asiAbilities-${level}">
                        <div class="asi-subtitle">Select two +1 bonuses (or same ability twice for +2)</div>
                        <div class="asi-ability-grid" id="asiGrid-${level}"></div>
                    </div>
                    <div class="feat-grid ${choice.type === 'feat' ? '' : 'hidden'}" id="featGrid-${level}" style="${choice.type === 'feat' ? '' : 'display: none;'}"></div>
                `;

                container.appendChild(section);

                // Populate ability buttons
                populateASIAbilities(level, choice);

                // Populate feat grid
                if (choice.type === 'feat') {
                    populateFeatGrid(`featGrid-${level}`, level);
                }
            });
        }

        function populateASIAbilities(level, choice) {
            const grid = document.getElementById(`asiGrid-${level}`);
            if (!grid) return;

            const abilities = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
            const selected = choice.abilities || [];

            grid.innerHTML = abilities.map(ability => {
                const currentScore = getFinalAbilityScore(ability);
                const isSelected = selected.includes(ability);
                const timesSelected = selected.filter(a => a === ability).length;
                const canSelect = currentScore < 20 || isSelected;

                return `
                    <button class="asi-ability-btn ${isSelected ? 'selected' : ''} ${!canSelect ? 'disabled' : ''}"
                            onclick="toggleASIAbility(${level}, '${ability}')"
                            ${!canSelect ? 'disabled' : ''}>
                        ${ability} ${timesSelected > 1 ? '(+2)' : timesSelected === 1 ? '(+1)' : ''}
                        <span class="asi-ability-score">${currentScore}${isSelected ? ' â†’ ' + Math.min(20, currentScore + 1) : ''}</span>
                    </button>
                `;
            }).join('');
        }

        function selectASIType(level, type) {
            character.asiChoices[level] = { type: type, abilities: [], feat: null };

            // Update toggle buttons
            document.querySelectorAll(`#asi-${level} .asi-toggle-btn`).forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide appropriate section
            const abilitiesDiv = document.getElementById(`asiAbilities-${level}`);
            const featDiv = document.getElementById(`featGrid-${level}`);

            if (type === 'asi') {
                abilitiesDiv.classList.add('active');
                featDiv.style.display = 'none';
                populateASIAbilities(level, character.asiChoices[level]);
            } else {
                abilitiesDiv.classList.remove('active');
                featDiv.style.display = 'grid';
                populateFeatGrid(`featGrid-${level}`, level);
            }

            playSound('click');
            updatePreview();
        }

        function toggleASIAbility(level, ability) {
            const choice = character.asiChoices[level];
            if (!choice || choice.type !== 'asi') return;

            if (!choice.abilities) choice.abilities = [];

            const timesSelected = choice.abilities.filter(a => a === ability).length;

            if (timesSelected === 2) {
                // Already at +2 for this ability, remove both
                choice.abilities = choice.abilities.filter(a => a !== ability);
            } else if (timesSelected === 1) {
                // Already at +1 - if room, add second for +2; otherwise remove
                if (choice.abilities.length < 2) {
                    choice.abilities.push(ability);
                } else {
                    // At max with 2 different abilities - remove this one
                    const index = choice.abilities.indexOf(ability);
                    choice.abilities.splice(index, 1);
                }
            } else if (choice.abilities.length < 2) {
                // Not selected yet and room available - add it
                choice.abilities.push(ability);
            } else {
                // At max with 2 different abilities - replace oldest with new
                choice.abilities.shift();
                choice.abilities.push(ability);
            }

            populateASIAbilities(level, choice);
            updateLevelSummary();
            updatePreview();
            playSound('click');
        }

        function populateFeatGrid(gridId, levelOrKey) {
            const grid = document.getElementById(gridId);
            if (!grid) return;

            grid.innerHTML = '';

            // Get currently selected feat for this level
            let selectedFeat = null;
            if (levelOrKey === 'variantHuman') {
                selectedFeat = character.feats.find(f => f.source === 'variantHuman');
            } else {
                const choice = character.asiChoices[levelOrKey];
                selectedFeat = choice && choice.feat ? { key: choice.feat } : null;
            }

            // Get already taken feats (to prevent duplicates)
            const takenFeats = character.feats.map(f => f.key);
            Object.values(character.asiChoices).forEach(c => {
                if (c.feat) takenFeats.push(c.feat);
            });

            Object.keys(FEATS).forEach(featKey => {
                const feat = FEATS[featKey];
                const meetsPrereq = checkFeatPrereq(feat);
                const alreadyTaken = takenFeats.includes(featKey) && (!selectedFeat || selectedFeat.key !== featKey);
                const isSelected = selectedFeat && selectedFeat.key === featKey;

                const card = document.createElement('div');
                card.className = `feat-card ${isSelected ? 'selected' : ''} ${(!meetsPrereq || alreadyTaken) ? 'disabled' : ''}`;

                if (meetsPrereq && !alreadyTaken) {
                    card.onclick = (e) => {
                        // Don't trigger if clicking on a select dropdown
                        if (e.target.tagName !== 'SELECT') {
                            selectFeat(levelOrKey, featKey);
                        }
                    };
                }

                let prereqText = '';
                if (feat.prereq) {
                    prereqText = getPrereqText(feat.prereq);
                }

                // Build bonus text
                let bonusText = '';
                if (feat.asiBonus) {
                    const bonuses = Object.entries(feat.asiBonus).map(([ab, val]) => `+${val} ${ab}`).join(', ');
                    bonusText = `<div class="feat-bonus">Bonus: ${bonuses}</div>`;
                }

                // Build ability choice dropdown for selected feats with asiChoice
                let abilityChoiceHtml = '';
                if (isSelected && feat.asiChoice) {
                    const currentChoice = levelOrKey === 'variantHuman'
                        ? (selectedFeat.abilityChoice || feat.asiChoice[0])
                        : (character.asiChoices[levelOrKey]?.featAbilityChoice || feat.asiChoice[0]);

                    abilityChoiceHtml = `
                        <div class="feat-ability-choice">
                            <label>+1 to:</label>
                            <select onchange="setFeatAbilityChoice('${levelOrKey}', this.value)">
                                ${feat.asiChoice.map(ab => `<option value="${ab}" ${ab === currentChoice ? 'selected' : ''}>${ab}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else if (feat.asiChoice) {
                    bonusText = `<div class="feat-bonus">Bonus: +1 to ${feat.asiChoice.join(' or ')}</div>`;
                }

                card.innerHTML = `
                    <div class="feat-name">${feat.name}</div>
                    <div class="feat-desc">${feat.desc}</div>
                    ${bonusText}
                    ${prereqText ? `<div class="feat-prereq">Requires: ${prereqText}</div>` : ''}
                    ${abilityChoiceHtml}
                `;

                grid.appendChild(card);
            });
        }

        function checkFeatPrereq(feat) {
            if (!feat.prereq) return true;

            const prereq = feat.prereq;

            // Check ability score prerequisites
            for (const ability of ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA']) {
                if (prereq[ability]) {
                    const score = getFinalAbilityScore(ability);
                    if (prereq.prereqType === 'or') {
                        // Any one of the abilities meets requirement
                        let anyMet = false;
                        for (const a of ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA']) {
                            if (prereq[a] && getFinalAbilityScore(a) >= prereq[a]) {
                                anyMet = true;
                                break;
                            }
                        }
                        return anyMet;
                    }
                    if (score < prereq[ability]) return false;
                }
            }

            // Check spellcasting prerequisite
            if (prereq.spellcasting) {
                const spellInfo = SPELLCASTING[character.class];
                if (!spellInfo) return false;
            }

            // Check armor proficiency
            if (prereq.armorProf) {
                const cls = CLASSES[character.class];
                if (!cls) return false;
                const armor = cls.armor.toLowerCase();
                if (prereq.armorProf === 'light' && !armor.includes('light')) return false;
                if (prereq.armorProf === 'medium' && !armor.includes('medium')) return false;
                if (prereq.armorProf === 'heavy' && !armor.includes('heavy')) return false;
            }

            return true;
        }

        function getPrereqText(prereq) {
            const parts = [];
            for (const ability of ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA']) {
                if (prereq[ability]) {
                    parts.push(`${ability} ${prereq[ability]}+`);
                }
            }
            if (prereq.spellcasting) parts.push('Spellcasting');
            if (prereq.armorProf) parts.push(`${prereq.armorProf} armor proficiency`);

            return parts.join(prereq.prereqType === 'or' ? ' or ' : ', ');
        }

        function selectFeat(levelOrKey, featKey) {
            const feat = FEATS[featKey];

            if (levelOrKey === 'variantHuman') {
                // Remove old variant human feat
                character.feats = character.feats.filter(f => f.source !== 'variantHuman');
                // Add new one with ability choice if needed
                const newFeat = { key: featKey, source: 'variantHuman' };
                if (feat.asiChoice) {
                    newFeat.abilityChoice = feat.asiChoice[0]; // Default to first option
                }
                character.feats.push(newFeat);
                populateFeatGrid('variantFeatGrid', 'variantHuman');
            } else {
                character.asiChoices[levelOrKey].feat = featKey;
                if (feat.asiChoice) {
                    character.asiChoices[levelOrKey].featAbilityChoice = feat.asiChoice[0]; // Default to first option
                }
                populateFeatGrid(`featGrid-${levelOrKey}`, levelOrKey);
            }

            updatePreview();
            buildFeatOptionsSection(); // Update feat spell options
            playSound('click');
        }

        function setFeatAbilityChoice(levelOrKey, ability) {
            if (levelOrKey === 'variantHuman') {
                const feat = character.feats.find(f => f.source === 'variantHuman');
                if (feat) {
                    feat.abilityChoice = ability;
                }
            } else if (character.asiChoices[levelOrKey]) {
                character.asiChoices[levelOrKey].featAbilityChoice = ability;
            }
            updatePreview();
            playSound('click');
        }

        // ===== FEAT OPTIONS (Spells granted by feats) =====
        function buildFeatOptionsSection() {
            const container = document.getElementById('featOptionsContainer');
            if (!container) return;

            container.innerHTML = '';
            let hasOptions = false;

            // Check all selected feats for spell-granting ones
            const allFeats = [];

            // Variant Human feat
            const variantFeat = character.feats.find(f => f.source === 'variantHuman');
            if (variantFeat) {
                allFeats.push({ ...variantFeat, source: 'variantHuman' });
            }

            // ASI/Feat choices
            Object.entries(character.asiChoices).forEach(([level, choice]) => {
                if (choice.type === 'feat' && choice.feat) {
                    allFeats.push({ key: choice.feat, source: `level${level}` });
                }
            });

            // Build sections for feats with spell grants
            allFeats.forEach(featData => {
                const feat = FEATS[featData.key];
                if (!feat || !feat.grantsSpells) return;

                hasOptions = true;
                const section = document.createElement('div');
                section.className = 'feat-options-section';

                let contentHtml = `<div class="feat-options-title">âœ¨ ${feat.name} Spells</div>`;

                // Fixed spells
                if (feat.grantsSpells.fixed) {
                    contentHtml += `<div class="feat-fixed-spells">`;
                    contentHtml += `<div class="feat-spell-label">Granted Spells:</div>`;
                    feat.grantsSpells.fixed.forEach(spell => {
                        contentHtml += `<div class="feat-spell-item granted">ðŸ“– ${spell}</div>`;
                    });
                    contentHtml += `</div>`;
                }

                // Spell choices
                if (feat.grantsSpells.level1 || feat.grantsSpells.cantrips) {
                    contentHtml += `<div class="feat-spell-choices">`;

                    if (feat.grantsSpells.cantrips) {
                        contentHtml += `<div class="feat-spell-label">Choose ${feat.grantsSpells.cantrips} cantrip(s):</div>`;
                        contentHtml += `<div class="feat-spell-note">Select on the Spells page (Step 7)</div>`;
                    }

                    if (feat.grantsSpells.level1) {
                        const schoolNote = feat.grantsSpells.schools
                            ? ` (${feat.grantsSpells.schools.join(' or ')} school)`
                            : '';
                        const listNote = feat.grantsSpells.lists
                            ? ` from ${feat.grantsSpells.lists.join(', ')} lists`
                            : '';
                        contentHtml += `<div class="feat-spell-label">Choose ${feat.grantsSpells.level1} 1st-level spell(s)${schoolNote}${listNote}:</div>`;
                        contentHtml += `<div class="feat-spell-note">âš ï¸ Remember to add these spells on the Spells page (Step 7)</div>`;
                    }

                    contentHtml += `</div>`;
                }

                section.innerHTML = contentHtml;
                container.appendChild(section);
            });

            container.style.display = hasOptions ? 'block' : 'none';
        }

        // ===== AI PORTRAIT GENERATOR =====
        let currentPortraitUrl = null;

        function initPortraitGenerator() {
            // Check if API key is stored
            const apiKey = localStorage.getItem('openai_api_key');
            if (apiKey) {
                document.getElementById('portraitApiSetup').style.display = 'none';
                document.getElementById('portraitDisplay').style.display = 'block';
            } else {
                document.getElementById('portraitApiSetup').style.display = 'block';
                document.getElementById('portraitDisplay').style.display = 'none';
            }

            // Add change listeners to update prompt preview
            const selects = ['portraitGender', 'portraitAge', 'portraitExpression', 'portraitHairStyle', 'portraitHairColor', 'portraitSkinTone'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', updatePromptPreview);
            });

            updatePromptPreview();
        }

        function saveApiKey() {
            const apiKey = document.getElementById('openaiApiKey').value.trim();
            if (!apiKey || !apiKey.startsWith('sk-')) {
                alert('Please enter a valid OpenAI API key (starts with sk-)');
                return;
            }
            localStorage.setItem('openai_api_key', apiKey);
            document.getElementById('portraitApiSetup').style.display = 'none';
            document.getElementById('portraitDisplay').style.display = 'block';
            updatePromptPreview();
            playSound('click');
        }

        function clearApiKey() {
            localStorage.removeItem('openai_api_key');
            document.getElementById('openaiApiKey').value = '';
            document.getElementById('portraitApiSetup').style.display = 'block';
            document.getElementById('portraitDisplay').style.display = 'none';
            playSound('click');
        }

        function buildPortraitPrompt() {
            // Get character details
            const race = character.race ? RACES[character.race] : null;
            const raceName = race ? race.name : 'human';
            const subrace = character.subrace && race?.subraces ? race.subraces[character.subrace]?.name : null;
            const cls = character.class ? CLASSES[character.class] : null;
            const className = cls ? cls.name : 'adventurer';
            const subclass = character.subclass && cls?.subclasses ? cls.subclasses[character.subclass]?.name : null;

            // Get portrait options
            const gender = document.getElementById('portraitGender')?.value || 'masculine';
            const age = document.getElementById('portraitAge')?.value || 'adult';
            const expression = document.getElementById('portraitExpression')?.value || 'determined';
            const hairStyle = document.getElementById('portraitHairStyle')?.value || 'short';
            const hairColor = document.getElementById('portraitHairColor')?.value || 'brown';
            const skinTone = document.getElementById('portraitSkinTone')?.value || 'medium';

            // Get equipment
            let weapon = '';
            const equipment = character.equipment;
            if (equipment && equipment.choices) {
                const choices = Object.values(equipment.choices).flat();
                if (choices.some(e => e.includes('sword'))) weapon = 'wielding a sword';
                else if (choices.some(e => e.includes('axe'))) weapon = 'wielding an axe';
                else if (choices.some(e => e.includes('bow'))) weapon = 'with a bow';
                else if (choices.some(e => e.includes('staff'))) weapon = 'holding a magical staff';
                else if (choices.some(e => e.includes('dagger'))) weapon = 'with daggers at their belt';
            }

            // Build racial features (using safe, fantasy-appropriate language)
            let racialFeatures = '';
            const raceKey = raceName.toLowerCase();
            if (raceKey.includes('elf') || raceKey.includes('half-elf')) {
                racialFeatures = 'with elegant pointed ears, refined angular features';
            } else if (raceKey.includes('dwarf')) {
                racialFeatures = 'with a sturdy build, magnificent braided beard';
            } else if (raceKey.includes('tiefling')) {
                racialFeatures = 'with elegant curved horns, unique reddish-purple skin tones, fantasy heritage';
            } else if (raceKey.includes('dragonborn')) {
                racialFeatures = 'with noble draconic features, iridescent scaled skin';
            } else if (raceKey.includes('halfling') || raceKey.includes('gnome')) {
                racialFeatures = 'with a small stature, warm cheerful features';
            } else if (raceKey.includes('orc') || raceKey.includes('half-orc')) {
                racialFeatures = 'with strong noble features, small tusks, gray-green skin';
            } else if (raceKey.includes('aasimar')) {
                racialFeatures = 'with radiant features, luminous eyes, otherworldly grace';
            }

            // Build class-specific attire (fantasy appropriate)
            let attire = '';
            const classKey = className.toLowerCase();
            if (classKey === 'wizard' || classKey === 'sorcerer') {
                attire = 'wearing ornate robes with mystical symbols, arcane accessories';
            } else if (classKey === 'paladin') {
                attire = 'wearing gleaming plate armor with sacred symbols, noble cape';
            } else if (classKey === 'rogue') {
                attire = 'wearing supple leather armor, a shadowy hooded cloak';
            } else if (classKey === 'barbarian') {
                attire = 'wearing fur-trimmed leather armor, tribal jewelry, powerful build';
            } else if (classKey === 'cleric') {
                attire = 'wearing ceremonial vestments with sacred iconography';
            } else if (classKey === 'druid') {
                attire = 'wearing natural materials, leaves and vines woven into clothing';
            } else if (classKey === 'ranger') {
                attire = 'wearing practical woodland gear, a weathered traveling cloak';
            } else if (classKey === 'fighter') {
                attire = 'wearing well-crafted armor, confident military bearing';
            } else if (classKey === 'monk') {
                attire = 'wearing simple flowing robes, prayer beads, serene presence';
            } else if (classKey === 'bard') {
                attire = 'wearing colorful elaborate clothing, a musical instrument visible';
            } else if (classKey === 'warlock') {
                attire = 'wearing mysterious dark robes, arcane symbols, mystical aura';
            }

            // Build the prompt
            const prompt = `A dramatic watercolor fantasy portrait painting of a ${age} ${gender} ${subrace || raceName} ${subclass || className} ${racialFeatures}. ` +
                `${skinTone} skin tone, ${hairColor} ${hairStyle} hair, ${expression} expression. ` +
                `${attire}. ${weapon}. ` +
                `Painted in the style of classic fantasy novel cover art, rich colors with watercolor textures, ` +
                `dramatic lighting, detailed costume and jewelry, painterly brushstrokes, ` +
                `portrait composition showing head and shoulders, fantasy medieval setting background. ` +
                `High quality illustration, professional fantasy art.`;

            return prompt;
        }

        let promptMode = 'auto'; // 'auto' or 'custom'

        function setPromptMode(mode) {
            promptMode = mode;

            // Update button states
            document.getElementById('autoPromptBtn').classList.toggle('active', mode === 'auto');
            document.getElementById('customPromptBtn').classList.toggle('active', mode === 'custom');

            // Show/hide sections
            document.getElementById('autoPromptSection').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('customPromptSection').style.display = mode === 'custom' ? 'block' : 'none';

            // Show/hide the trait options (only relevant for auto mode)
            const optionsEl = document.querySelector('.portrait-options');
            if (optionsEl) {
                optionsEl.style.display = mode === 'auto' ? 'grid' : 'none';
            }

            playSound('click');
        }

        function updatePromptPreview() {
            const previewEl = document.getElementById('promptPreview');
            if (previewEl) {
                previewEl.textContent = buildPortraitPrompt();
            }
        }

        function getActivePrompt() {
            if (promptMode === 'custom') {
                const customPrompt = document.getElementById('customPromptInput')?.value.trim();
                if (!customPrompt) {
                    return null; // Signal that prompt is empty
                }
                // Add style guidance to custom prompts for consistency
                return customPrompt + ' Painted in dramatic watercolor fantasy art style, rich colors, professional illustration quality.';
            }
            return buildPortraitPrompt();
        }

        async function generateAIPortrait() {
            const apiKey = localStorage.getItem('openai_api_key');
            if (!apiKey) {
                alert('Please enter your OpenAI API key first');
                return;
            }

            const prompt = getActivePrompt();
            if (!prompt) {
                alert('Please enter a prompt describing your character');
                return;
            }

            const generateBtn = document.getElementById('generatePortraitBtn');
            const downloadBtn = document.getElementById('downloadPortraitBtn');
            const loadingEl = document.getElementById('portraitLoading');
            const placeholderEl = document.getElementById('portraitPlaceholder');
            const imageEl = document.getElementById('portraitImage');

            // Show loading state
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            loadingEl.style.display = 'flex';
            placeholderEl.style.display = 'none';
            imageEl.classList.remove('loaded');

            try {
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'dall-e-3',
                        prompt: prompt,
                        n: 1,
                        size: '1024x1024',
                        quality: 'standard',
                        style: 'vivid'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Failed to generate image');
                }

                const data = await response.json();
                const imageUrl = data.data[0].url;

                // Load and display the image
                imageEl.onload = function() {
                    loadingEl.style.display = 'none';
                    imageEl.classList.add('loaded');
                    downloadBtn.disabled = false;
                    currentPortraitUrl = imageUrl;
                    playSound('click');
                };

                imageEl.onerror = function() {
                    throw new Error('Failed to load generated image');
                };

                imageEl.src = imageUrl;

            } catch (error) {
                console.error('Portrait generation error:', error);
                alert('Error generating portrait: ' + error.message);
                loadingEl.style.display = 'none';
                placeholderEl.style.display = 'flex';
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'âœ¨ GENERATE PORTRAIT';
            }
        }

        async function downloadAIPortrait() {
            const imageEl = document.getElementById('portraitImage');
            if (!imageEl.src) return;

            try {
                // Fetch the image and convert to blob
                const response = await fetch(imageEl.src);
                const blob = await response.blob();

                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${character.name || 'character'}-portrait.png`;
                link.click();
                URL.revokeObjectURL(url);
                playSound('click');
            } catch (error) {
                console.error('Download error:', error);
                // Fallback: open image in new tab
                window.open(imageEl.src, '_blank');
            }
        }

        // Export functions
        function exportToText() {
            const text = generateCharacterText();
            navigator.clipboard.writeText(text).then(() => {
                alert('Character copied to clipboard!');
            });
        }

        function exportToJSON() {
            const json = JSON.stringify(character, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${character.name || 'character'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function printCharacter() {
            window.print();
        }

        async function exportToPDF() {
            try {
                // Create a canvas for the classic character sheet
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Letter size at 96 DPI (8.5 x 11 inches)
                canvas.width = 816;
                canvas.height = 1056;

                // Load handwriting-style font (don't block on failure)
                try {
                    await loadHandwritingFont();
                } catch (e) {
                    console.log('Font loading failed, using fallback');
                }

                // Draw the classic character sheet
                drawClassicSheet(ctx, canvas.width, canvas.height);

                // Convert to image and download
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `${character.name || 'character'}-sheet.png`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                playSound('click');
            } catch (error) {
                console.error('PDF Export Error:', error);
                alert('Error generating character sheet: ' + error.message);
            }
        }

        async function loadHandwritingFont() {
            // Use a web-safe cursive font, or load a custom one
            try {
                const font = new FontFace('PatrickHand', 'url(https://fonts.gstatic.com/s/patrickhand/v23/LDI1apSQOAYtSuYWp8ZhfYeMWcjKm7sp8g.woff2)');
                await font.load();
                document.fonts.add(font);
                return true;
            } catch (e) {
                console.log('Using fallback font');
                return false;
            }
        }

        function drawClassicSheet(ctx, w, h) {
            // Get character data
            const race = RACES[character.race];
            let raceName = race ? race.name : '';
            if (character.subrace && race && race.subraces) {
                raceName = race.subraces[character.subrace].name;
            }
            const cls = CLASSES[character.class];
            let className = cls ? cls.name : '';
            if (character.subclass && cls) {
                className += ` (${cls.subclasses[character.subclass].name})`;
            }
            const bg = character.background ? BACKGROUNDS[character.background] : null;
            const profBonus = Math.ceil(character.level / 4) + 1;

            // Calculate HP
            let hp = 0;
            if (cls) {
                const hitDieMax = parseInt(cls.hitDie.substring(1));
                const conMod = getModifierValue(getFinalAbilityScore('CON'));
                const avgDie = Math.floor(hitDieMax / 2) + 1;
                hp = hitDieMax + conMod + (character.level - 1) * (avgDie + conMod);
                hp = Math.max(1, hp);
            }

            // Aged paper background
            ctx.fillStyle = '#f4e4bc';
            ctx.fillRect(0, 0, w, h);

            // Add paper texture/aging
            ctx.fillStyle = 'rgba(139, 69, 19, 0.03)';
            for (let i = 0; i < 500; i++) {
                const x = Math.random() * w;
                const y = Math.random() * h;
                const size = Math.random() * 3 + 1;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }

            // Coffee stain effect in corner
            const gradient = ctx.createRadialGradient(680, 180, 10, 680, 180, 80);
            gradient.addColorStop(0, 'rgba(139, 90, 43, 0.15)');
            gradient.addColorStop(0.5, 'rgba(139, 90, 43, 0.08)');
            gradient.addColorStop(1, 'rgba(139, 90, 43, 0)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(680, 180, 80, 0, Math.PI * 2);
            ctx.fill();

            // Set up fonts
            const handFont = 'PatrickHand, cursive, "Comic Sans MS", sans-serif';
            const titleFont = 'Georgia, serif';
            const inkColor = '#1a0a00';
            const labelColor = '#4a3520';

            // Draw outer border (hand-drawn style)
            ctx.strokeStyle = inkColor;
            ctx.lineWidth = 2;
            drawWobblyRect(ctx, 30, 30, w - 60, h - 60);

            // Title
            ctx.fillStyle = inkColor;
            ctx.font = `bold 28px ${titleFont}`;
            ctx.textAlign = 'center';
            ctx.fillText('DUNGEONS & DRAGONS', w / 2, 70);
            ctx.font = `italic 16px ${titleFont}`;
            ctx.fillText('Character Record Sheet', w / 2, 92);

            // Decorative line under title
            ctx.beginPath();
            ctx.moveTo(200, 105);
            ctx.lineTo(w - 200, 105);
            ctx.stroke();

            // ===== CHARACTER NAME BOX =====
            ctx.lineWidth = 1.5;
            drawWobblyRect(ctx, 50, 115, w - 100, 45);

            // Character name (large, centered)
            ctx.font = `28px ${handFont}`;
            ctx.textAlign = 'center';
            ctx.fillStyle = inkColor;
            ctx.fillText(character.name || '________________________', w / 2, 145);

            ctx.font = `9px ${titleFont}`;
            ctx.fillStyle = labelColor;
            ctx.fillText('CHARACTER NAME', w / 2, 156);

            // ===== CHARACTER INFO ROW =====
            // Draw individual boxes for each field
            const infoRowY = 165;
            const boxHeight = 40;

            // Race box
            drawWobblyRect(ctx, 50, infoRowY, 150, boxHeight);
            ctx.font = `14px ${handFont}`;
            ctx.fillStyle = inkColor;
            ctx.textAlign = 'center';
            const displayRace = raceName.length > 14 ? raceName.substring(0, 12) + '..' : raceName;
            ctx.fillText(displayRace || '______', 125, infoRowY + 22);
            ctx.font = `9px ${titleFont}`;
            ctx.fillStyle = labelColor;
            ctx.fillText('RACE', 125, infoRowY + 35);

            // Class box
            drawWobblyRect(ctx, 210, infoRowY, 200, boxHeight);
            ctx.font = `14px ${handFont}`;
            ctx.fillStyle = inkColor;
            const displayClass = className.length > 22 ? className.substring(0, 20) + '..' : className;
            ctx.fillText(displayClass || '______', 310, infoRowY + 22);
            ctx.font = `9px ${titleFont}`;
            ctx.fillStyle = labelColor;
            ctx.fillText('CLASS', 310, infoRowY + 35);

            // Level box
            drawWobblyRect(ctx, 420, infoRowY, 60, boxHeight);
            ctx.font = `18px ${handFont}`;
            ctx.fillStyle = inkColor;
            ctx.fillText(character.level.toString(), 450, infoRowY + 24);
            ctx.font = `9px ${titleFont}`;
            ctx.fillStyle = labelColor;
            ctx.fillText('LEVEL', 450, infoRowY + 35);

            // Background box
            drawWobblyRect(ctx, 490, infoRowY, 130, boxHeight);
            ctx.font = `14px ${handFont}`;
            ctx.fillStyle = inkColor;
            const bgName = bg ? bg.name : '______';
            const displayBg = bgName.length > 12 ? bgName.substring(0, 10) + '..' : bgName;
            ctx.fillText(displayBg, 555, infoRowY + 22);
            ctx.font = `9px ${titleFont}`;
            ctx.fillStyle = labelColor;
            ctx.fillText('BACKGROUND', 555, infoRowY + 35);

            // Alignment box
            drawWobblyRect(ctx, 630, infoRowY, 130, boxHeight);
            ctx.font = `14px ${handFont}`;
            ctx.fillStyle = inkColor;
            const alignName = ALIGNMENTS[character.alignment] || '______';
            const displayAlign = alignName.length > 14 ? alignName.substring(0, 12) + '..' : alignName;
            ctx.fillText(displayAlign, 695, infoRowY + 22);
            ctx.font = `9px ${titleFont}`;
            ctx.fillStyle = labelColor;
            ctx.fillText('ALIGNMENT', 695, infoRowY + 35);

            // ===== ABILITY SCORES BOX =====
            const abilityBoxY = 215;
            drawWobblyRect(ctx, 50, abilityBoxY, 200, 280);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'center';
            ctx.fillStyle = labelColor;
            ctx.fillText('ABILITY SCORES', 150, abilityBoxY + 25);

            const abilities = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
            const abilityNames = ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'];
            let aY = abilityBoxY + 55;

            abilities.forEach((ability, i) => {
                const score = getFinalAbilityScore(ability);
                const mod = getModifierValue(score);
                const modStr = mod >= 0 ? `+${mod}` : `${mod}`;

                // Ability box
                drawWobblyRect(ctx, 70, aY - 15, 160, 38);

                ctx.font = `10px ${titleFont}`;
                ctx.fillStyle = labelColor;
                ctx.textAlign = 'left';
                ctx.fillText(abilityNames[i].toUpperCase(), 78, aY - 2);

                ctx.font = `bold 22px ${handFont}`;
                ctx.fillStyle = inkColor;
                ctx.textAlign = 'right';
                ctx.fillText(score.toString(), 180, aY + 15);

                ctx.font = `14px ${handFont}`;
                ctx.fillText(modStr, 220, aY + 8);

                aY += 40;
            });

            // ===== COMBAT STATS BOX =====
            const combatBoxY = 215;
            drawWobblyRect(ctx, 270, combatBoxY, 240, 140);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'center';
            ctx.fillStyle = labelColor;
            ctx.fillText('COMBAT', 390, combatBoxY + 25);

            // Combat stats in a grid
            const combatStats = [
                { label: 'Armor Class', value: calculateAC() || 10 },
                { label: 'Initiative', value: (getModifierValue(getFinalAbilityScore('DEX')) >= 0 ? '+' : '') + getModifierValue(getFinalAbilityScore('DEX')) },
                { label: 'Speed', value: (race ? race.speed : 30) + ' ft' },
                { label: 'Prof. Bonus', value: '+' + profBonus }
            ];

            let cX = 290;
            let cY = combatBoxY + 55;
            combatStats.forEach((stat, i) => {
                if (i === 2) { cX = 290; cY += 50; }

                drawWobblyRect(ctx, cX, cY - 15, 100, 45);

                ctx.font = `9px ${titleFont}`;
                ctx.fillStyle = labelColor;
                ctx.textAlign = 'center';
                ctx.fillText(stat.label.toUpperCase(), cX + 50, cY + 25);

                ctx.font = `bold 20px ${handFont}`;
                ctx.fillStyle = inkColor;
                ctx.fillText(stat.value.toString(), cX + 50, cY + 10);

                cX += 110;
            });

            // ===== HIT POINTS BOX =====
            const hpBoxY = 215;
            drawWobblyRect(ctx, 530, hpBoxY, 230, 140);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'center';
            ctx.fillStyle = labelColor;
            ctx.fillText('HIT POINTS', 645, hpBoxY + 25);

            // HP circle
            ctx.beginPath();
            ctx.arc(600, hpBoxY + 85, 40, 0, Math.PI * 2);
            ctx.stroke();
            ctx.font = `bold 28px ${handFont}`;
            ctx.fillStyle = inkColor;
            ctx.fillText(hp.toString(), 600, hpBoxY + 95);
            ctx.font = `10px ${titleFont}`;
            ctx.fillStyle = labelColor;
            ctx.fillText('MAX', 600, hpBoxY + 115);

            // Current HP box
            drawWobblyRect(ctx, 660, hpBoxY + 50, 80, 60);
            ctx.font = `9px ${titleFont}`;
            ctx.fillText('CURRENT', 700, hpBoxY + 105);

            // Hit Die
            ctx.font = `12px ${handFont}`;
            ctx.fillStyle = inkColor;
            ctx.textAlign = 'left';
            ctx.fillText(`Hit Die: ${character.level}${cls ? cls.hitDie : 'd8'}`, 540, hpBoxY + 135);

            // ===== SAVING THROWS =====
            const saveBoxY = 370;
            drawWobblyRect(ctx, 270, saveBoxY, 240, 125);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'center';
            ctx.fillStyle = labelColor;
            ctx.fillText('SAVING THROWS', 390, saveBoxY + 25);

            let sY = saveBoxY + 50;
            const classSaves = cls ? cls.saves : [];
            abilities.forEach((ability, i) => {
                const mod = getModifierValue(getFinalAbilityScore(ability));
                const isProficient = classSaves.includes(ability);
                const saveBonus = isProficient ? mod + profBonus : mod;
                const saveStr = saveBonus >= 0 ? `+${saveBonus}` : `${saveBonus}`;

                ctx.font = `12px ${handFont}`;
                ctx.textAlign = 'left';
                ctx.fillStyle = inkColor;

                const sX = i < 3 ? 285 : 400;
                const sYOffset = (i % 3) * 22;

                // Proficiency circle
                ctx.beginPath();
                ctx.arc(sX, sY + sYOffset - 3, 5, 0, Math.PI * 2);
                if (isProficient) ctx.fill();
                else ctx.stroke();

                ctx.fillText(`${ability}  ${saveStr}`, sX + 12, sY + sYOffset);
            });

            // ===== SKILLS =====
            const skillBoxY = 370;
            drawWobblyRect(ctx, 530, skillBoxY, 230, 125);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'center';
            ctx.fillStyle = labelColor;
            ctx.fillText('PROFICIENT SKILLS', 645, skillBoxY + 25);

            ctx.font = `12px ${handFont}`;
            ctx.textAlign = 'left';
            ctx.fillStyle = inkColor;
            const skills = character.skills || [];
            let skillY = skillBoxY + 48;
            skills.forEach((skill, i) => {
                const col = i % 2 === 0 ? 545 : 650;
                const row = Math.floor(i / 2);
                ctx.fillText('â€¢ ' + skill, col, skillY + row * 18);
            });

            // ===== PROFICIENCIES & LANGUAGES =====
            const profBoxY = 510;
            drawWobblyRect(ctx, 50, profBoxY, 460, 100);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'left';
            ctx.fillStyle = labelColor;
            ctx.fillText('PROFICIENCIES & LANGUAGES', 65, profBoxY + 25);

            ctx.font = `12px ${handFont}`;
            ctx.fillStyle = inkColor;

            // Armor & Weapons
            if (cls) {
                ctx.fillText(`Armor: ${cls.armor}`, 65, profBoxY + 48);
                ctx.fillText(`Weapons: ${cls.weapons.substring(0, 60)}${cls.weapons.length > 60 ? '...' : ''}`, 65, profBoxY + 66);
            }

            // Languages
            const languages = race ? (race.languages || ['Common']) : ['Common'];
            ctx.fillText(`Languages: ${languages.join(', ')}`, 65, profBoxY + 84);

            // ===== FEATURES & TRAITS =====
            const featBoxY = 510;
            drawWobblyRect(ctx, 530, featBoxY, 230, 100);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'left';
            ctx.fillStyle = labelColor;
            ctx.fillText('FEATURES & TRAITS', 545, featBoxY + 25);

            ctx.font = `11px ${handFont}`;
            ctx.fillStyle = inkColor;
            let fY = featBoxY + 45;

            // Race traits
            if (race && race.traits) {
                race.traits.slice(0, 2).forEach(trait => {
                    ctx.fillText('â€¢ ' + trait.name, 545, fY);
                    fY += 16;
                });
            }

            // Class features
            const classFeatures = getClassFeatures().slice(0, 2);
            classFeatures.forEach(f => {
                ctx.fillText('â€¢ ' + f.name, 545, fY);
                fY += 16;
            });

            // ===== SPELLS (if spellcaster) =====
            const spellBoxY = 625;
            drawWobblyRect(ctx, 50, spellBoxY, 710, 150);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'left';
            ctx.fillStyle = labelColor;
            ctx.fillText('SPELLS', 65, spellBoxY + 25);

            if (cls && cls.spellcasting) {
                const spellInfo = SPELLCASTING[character.class];
                if (spellInfo) {
                    ctx.font = `11px ${titleFont}`;
                    ctx.fillText(`Spellcasting Ability: ${spellInfo.ability}`, 180, spellBoxY + 25);

                    const spellMod = getModifierValue(getFinalAbilityScore(spellInfo.ability));
                    const spellDC = 8 + profBonus + spellMod;
                    const spellAttack = profBonus + spellMod;
                    ctx.fillText(`Spell Save DC: ${spellDC}`, 350, spellBoxY + 25);
                    ctx.fillText(`Spell Attack: +${spellAttack}`, 480, spellBoxY + 25);
                }
            }

            ctx.font = `12px ${handFont}`;
            ctx.fillStyle = inkColor;

            // Cantrips
            if (character.spells.cantrips.length > 0) {
                ctx.fillText(`Cantrips: ${character.spells.cantrips.join(', ')}`, 65, spellBoxY + 50);
            }

            // Leveled spells
            let spellY = spellBoxY + 70;
            for (let lvl = 1; lvl <= 9; lvl++) {
                const spells = character.spells[`level${lvl}`] || [];
                if (spells.length > 0) {
                    const ordinal = lvl === 1 ? '1st' : lvl === 2 ? '2nd' : lvl === 3 ? '3rd' : `${lvl}th`;
                    ctx.fillText(`${ordinal} Level: ${spells.join(', ')}`, 65, spellY);
                    spellY += 18;
                }
            }

            // Subclass granted spells
            const grantedSpells = getSubclassGrantedSpells();
            if (grantedSpells.spells.length > 0 || grantedSpells.cantrips.length > 0) {
                ctx.fillStyle = labelColor;
                ctx.font = `italic 11px ${handFont}`;
                let grantedText = 'Always Prepared: ';
                if (grantedSpells.cantrips.length > 0) grantedText += grantedSpells.cantrips.join(', ');
                if (grantedSpells.spells.length > 0) {
                    if (grantedSpells.cantrips.length > 0) grantedText += ', ';
                    grantedText += grantedSpells.spells.join(', ');
                }
                ctx.fillText(grantedText, 65, spellY);
            }

            // ===== EQUIPMENT =====
            const equipBoxY = 790;
            drawWobblyRect(ctx, 50, equipBoxY, 350, 120);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'left';
            ctx.fillStyle = labelColor;
            ctx.fillText('EQUIPMENT', 65, equipBoxY + 25);

            ctx.font = `11px ${handFont}`;
            ctx.fillStyle = inkColor;
            let eY = equipBoxY + 45;

            // Get all equipment
            const allEquipment = [];
            if (character.equipment && character.equipment.choices) {
                Object.values(character.equipment.choices).forEach(item => {
                    if (Array.isArray(item)) {
                        item.forEach(i => allEquipment.push(i));
                    } else if (item) {
                        allEquipment.push(item);
                    }
                });
            }
            if (character.equipment && character.equipment.granted && Array.isArray(character.equipment.granted)) {
                character.equipment.granted.forEach(item => allEquipment.push(item));
            }

            // Display equipment in columns
            allEquipment.slice(0, 12).forEach((item, i) => {
                const col = i % 2 === 0 ? 65 : 220;
                const row = Math.floor(i / 2);
                ctx.fillText('â€¢ ' + item, col, eY + row * 15);
            });

            // ===== PERSONALITY =====
            const persBoxY = 790;
            drawWobblyRect(ctx, 420, persBoxY, 340, 120);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'left';
            ctx.fillStyle = labelColor;
            ctx.fillText('PERSONALITY', 435, persBoxY + 25);

            ctx.font = `10px ${handFont}`;
            ctx.fillStyle = inkColor;

            const wrapText = (text, maxWidth) => {
                if (!text) return '';
                if (text.length <= maxWidth) return text;
                return text.substring(0, maxWidth - 3) + '...';
            };

            if (character.personality.trait) {
                ctx.fillText('Trait: ' + wrapText(character.personality.trait, 45), 435, persBoxY + 45);
            }
            if (character.personality.ideal) {
                ctx.fillText('Ideal: ' + wrapText(character.personality.ideal, 45), 435, persBoxY + 62);
            }
            if (character.personality.bond) {
                ctx.fillText('Bond: ' + wrapText(character.personality.bond, 45), 435, persBoxY + 79);
            }
            if (character.personality.flaw) {
                ctx.fillText('Flaw: ' + wrapText(character.personality.flaw, 45), 435, persBoxY + 96);
            }

            // ===== NOTES =====
            const notesBoxY = 925;
            drawWobblyRect(ctx, 50, notesBoxY, 710, 80);

            ctx.font = `bold 14px ${titleFont}`;
            ctx.textAlign = 'left';
            ctx.fillStyle = labelColor;
            ctx.fillText('NOTES', 65, notesBoxY + 25);

            // Draw lines for notes
            ctx.strokeStyle = 'rgba(74, 53, 32, 0.3)';
            ctx.lineWidth = 0.5;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(65, notesBoxY + 45 + i * 20);
                ctx.lineTo(740, notesBoxY + 45 + i * 20);
                ctx.stroke();
            }

            // Footer
            ctx.font = `italic 10px ${titleFont}`;
            ctx.fillStyle = labelColor;
            ctx.textAlign = 'center';
            ctx.fillText('Created with 8-Bit D&D Character Creator', w / 2, h - 40);
        }

        function drawWobblyRect(ctx, x, y, width, height) {
            // Draw a slightly wobbly rectangle to simulate hand-drawn look
            ctx.beginPath();

            // Top line
            ctx.moveTo(x + Math.random() * 2, y + Math.random() * 2);
            ctx.lineTo(x + width + Math.random() * 2 - 1, y + Math.random() * 2);

            // Right line
            ctx.lineTo(x + width + Math.random() * 2 - 1, y + height + Math.random() * 2 - 1);

            // Bottom line
            ctx.lineTo(x + Math.random() * 2, y + height + Math.random() * 2 - 1);

            // Left line
            ctx.closePath();
            ctx.stroke();
        }

        function generateCharacterText() {
            const lines = [];
            lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            lines.push(`  ${character.name || 'Unnamed Character'}`);
            lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            lines.push('');

            // Basic info
            const race = RACES[character.race];
            let raceName = race ? race.name : 'Unknown';
            if (character.subrace && race && race.subraces) {
                raceName = race.subraces[character.subrace].name;
            }
            const cls = CLASSES[character.class];
            let className = cls ? cls.name : 'Unknown';
            if (character.subclass && cls) {
                className = cls.subclasses[character.subclass].name;
            }

            lines.push(`Race: ${raceName}`);
            lines.push(`Class: ${className}`);
            lines.push(`Level: ${character.level}`);
            lines.push(`Background: ${character.background ? BACKGROUNDS[character.background].name : 'None'}`);
            lines.push(`Alignment: ${ALIGNMENTS[character.alignment]}`);
            lines.push('');

            // Ability Scores
            lines.push('â”€â”€â”€ ABILITY SCORES â”€â”€â”€');
            ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'].forEach(ability => {
                const score = getFinalAbilityScore(ability);
                const mod = getModifierValue(score);
                const modStr = mod >= 0 ? `+${mod}` : `${mod}`;
                lines.push(`${ability}: ${score} (${modStr})`);
            });
            lines.push('');

            // Combat stats
            const profBonus = Math.ceil(character.level / 4) + 1;
            const ac = calculateAC();
            lines.push('â”€â”€â”€ COMBAT â”€â”€â”€');
            lines.push(`Armor Class: ${ac || 10}`);
            lines.push(`Proficiency Bonus: +${profBonus}`);
            if (cls) {
                const hitDieMax = parseInt(cls.hitDie.substring(1));
                const conMod = getModifierValue(getFinalAbilityScore('CON'));
                const avgDie = Math.floor(hitDieMax / 2) + 1;
                const hp = hitDieMax + conMod + (character.level - 1) * (avgDie + conMod);
                lines.push(`Hit Points: ${Math.max(1, hp)}`);
                lines.push(`Hit Die: ${character.level}${cls.hitDie}`);
            }
            if (race) {
                lines.push(`Speed: ${race.speed} ft`);
            }
            lines.push('');

            // Skills
            if (character.skills.length > 0) {
                lines.push('â”€â”€â”€ SKILLS â”€â”€â”€');
                lines.push(character.skills.join(', '));
                lines.push('');
            }

            // Feats
            const allFeats = [...character.feats];
            Object.values(character.asiChoices).forEach(c => {
                if (c.feat) allFeats.push({ key: c.feat });
            });
            if (allFeats.length > 0) {
                lines.push('â”€â”€â”€ FEATS â”€â”€â”€');
                allFeats.forEach(f => {
                    lines.push(`â€¢ ${FEATS[f.key].name}`);
                });
                lines.push('');
            }

            // Spells
            if (character.spells.cantrips.length > 0 || character.spells.level1.length > 0) {
                lines.push('â”€â”€â”€ SPELLS â”€â”€â”€');
                if (character.spells.cantrips.length > 0) {
                    lines.push(`Cantrips: ${character.spells.cantrips.join(', ')}`);
                }
                if (character.spells.level1.length > 0) {
                    lines.push(`1st Level: ${character.spells.level1.join(', ')}`);
                }
                lines.push('');
            }

            // Personality
            if (character.personality.trait) {
                lines.push('â”€â”€â”€ PERSONALITY â”€â”€â”€');
                lines.push(`Trait: ${character.personality.trait}`);
                lines.push(`Ideal: ${character.personality.ideal}`);
                lines.push(`Bond: ${character.personality.bond}`);
                lines.push(`Flaw: ${character.personality.flaw}`);
                lines.push('');
            }

            lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            lines.push('  Generated by 8-Bit D&D Character Creator');
            lines.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            return lines.join('\n');
        }

        function prepareExportCharacter() {
            // Compute final ability scores including racial and ASI bonuses
            const exportChar = JSON.parse(JSON.stringify(character));
            ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'].forEach(ability => {
                exportChar.abilities[ability] = getFinalAbilityScore(ability);
            });

            // Add subclass granted spells
            const subclassSpells = getSubclassGrantedSpells();
            exportChar.grantedSpells = {
                subclass: subclassSpells,
                feats: getFeatGrantedSpells()
            };

            // Add saving throw proficiencies from class
            const cls = CLASSES[character.class];
            if (cls) {
                exportChar.savingThrows = cls.saves;
            }

            // Add max spell level for this class/level
            exportChar.maxSpellLevel = getMaxSpellLevel(character.class, character.level);

            // Add available class spell list for preparation modal
            const spellInfo = SPELLCASTING[character.class];
            if (spellInfo) {
                exportChar.availableSpells = {};
                const maxLevel = exportChar.maxSpellLevel;

                // Cantrips
                const classCantrips = [];
                Object.entries(SPELLS.cantrips).forEach(([name, data]) => {
                    if (data.classes.includes(character.class)) {
                        classCantrips.push({ name, ...data });
                    }
                });
                exportChar.availableSpells.cantrips = classCantrips;

                // Leveled spells (1-9, up to max)
                for (let lvl = 1; lvl <= maxLevel; lvl++) {
                    const levelSpells = [];
                    const spellLevel = SPELLS[`level${lvl}`];
                    if (spellLevel) {
                        Object.entries(spellLevel).forEach(([name, data]) => {
                            if (data.classes.includes(character.class)) {
                                levelSpells.push({ name, ...data });
                            }
                        });
                    }
                    exportChar.availableSpells[`level${lvl}`] = levelSpells;
                }
            }

            return exportChar;
        }

        function finishCharacter() {
            const exportChar = prepareExportCharacter();

            // Save character to localStorage for the interactive sheet
            localStorage.setItem('dnd-active-character', JSON.stringify(exportChar));

            const text = generateCharacterText();
            alert('ðŸŽ‰ Character Complete!\n\n' + text.substring(0, 500) + '...\n\nYour character has been saved! Use the export buttons or click "Play Character" to start your adventure!');
        }

        function playCharacter() {
            const exportChar = prepareExportCharacter();

            // Ensure character is saved with final scores
            localStorage.setItem('dnd-active-character', JSON.stringify(exportChar));
            // Open the interactive character sheet
            window.location.href = 'dnd-sheet.html';
        }

        // ===== NAVIGATION =====
        function nextStep() {
            if (currentStep < 8) {
                // Mark current step as completed
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('completed');

                currentStep++;

                // Unlock and activate next step
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('locked');
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');

                // Show next step container
                document.querySelectorAll('.step-container').forEach(c => c.classList.remove('active'));
                document.querySelector(`.step-container[data-step="${currentStep}"]`).classList.add('active');

                // Step-specific initialization
                if (currentStep === 4) {
                    // Entering Ability Scores - setup racial bonus panel
                    setupRacialBonusPanel();
                    updateAbilityDisplay();
                }

                if (currentStep === 5) {
                    // Entering Background - initialize backgrounds
                    initBackgrounds();
                }

                if (currentStep === 6) {
                    // Entering Equipment - initialize equipment choices
                    initEquipment();
                }

                if (currentStep === 7) {
                    // Entering Spells - initialize spells
                    initSpells();
                }

                if (currentStep === 8) {
                    // Entering Level & Advancement - initialize level section
                    initLevelSection();
                    initPortraitGenerator();
                }

                playSound('next');
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');

                currentStep--;

                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('completed');
                document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');

                document.querySelectorAll('.step-container').forEach(c => c.classList.remove('active'));
                document.querySelector(`.step-container[data-step="${currentStep}"]`).classList.add('active');

                // Re-initialize step if needed
                if (currentStep === 4) {
                    setupRacialBonusPanel();
                    updateAbilityDisplay();
                }
                if (currentStep === 5 && character.background) {
                    initSkillsSection();
                    checkBackgroundComplete();
                }
                if (currentStep === 6) {
                    initEquipment();
                }
                if (currentStep === 7) {
                    initSpells();
                }
                if (currentStep === 8) {
                    initLevelSection();
                    initPortraitGenerator();
                }

                playSound('click');
            }
        }

        function goToStep(step) {
            document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('completed');

            currentStep = step;

            document.querySelectorAll('.progress-step').forEach(s => {
                if (parseInt(s.dataset.step) === step) {
                    s.classList.remove('completed');
                    s.classList.add('active');
                }
            });

            document.querySelectorAll('.step-container').forEach(c => c.classList.remove('active'));
            document.querySelector(`.step-container[data-step="${step}"]`).classList.add('active');

            // Re-initialize step if needed
            if (step === 4) {
                setupRacialBonusPanel();
                updateAbilityDisplay();
            }
            if (step === 5 && character.background) {
                initSkillsSection();
                checkBackgroundComplete();
            }
            if (step === 6) {
                initEquipment();
            }
            if (step === 7) {
                initSpells();
            }
            if (step === 8) {
                initLevelSection();
                initPortraitGenerator();
            }

            playSound('click');
        }

        // ===== PREVIEW UPDATE =====
        function updatePreview() {
            // Name
            const nameEl = document.getElementById('previewName');
            if (character.name) {
                nameEl.textContent = character.name;
                nameEl.classList.remove('empty');
            } else {
                nameEl.textContent = 'Not set';
                nameEl.classList.add('empty');
            }

            // Race
            const raceEl = document.getElementById('previewRace');
            if (character.race) {
                const race = RACES[character.race];
                let raceText = race.name;
                if (character.subrace && race.subraces) {
                    raceText = race.subraces[character.subrace].name;
                }
                raceEl.textContent = raceText;
                raceEl.classList.remove('empty');
            } else {
                raceEl.textContent = 'Not selected';
                raceEl.classList.add('empty');
            }

            // Class
            const classEl = document.getElementById('previewClass');
            if (character.class) {
                const cls = CLASSES[character.class];
                let classText = cls.name;
                if (character.subclass) {
                    classText = cls.subclasses[character.subclass].name;
                }
                classEl.textContent = classText;
                classEl.classList.remove('empty');
            } else {
                classEl.textContent = 'Not selected';
                classEl.classList.add('empty');
            }

            // Level
            document.getElementById('previewLevel').textContent = character.level;

            // Background
            const bgEl = document.getElementById('previewBackground');
            if (character.background) {
                bgEl.textContent = BACKGROUNDS[character.background].name;
                bgEl.classList.remove('empty');
            } else {
                bgEl.textContent = 'Not selected';
                bgEl.classList.add('empty');
            }

            // Alignment
            document.getElementById('previewAlignment').textContent = ALIGNMENTS[character.alignment];

            // Skills
            const skillsEl = document.getElementById('previewSkills');
            if (character.skills.length > 0) {
                skillsEl.textContent = character.skills.join(', ');
                skillsEl.classList.remove('empty');
            } else {
                skillsEl.textContent = 'None selected';
                skillsEl.classList.add('empty');
            }

            // Proficiency Bonus
            const profBonus = Math.ceil(character.level / 4) + 1;
            document.getElementById('previewProfBonus').textContent = '+' + profBonus;

            // Armor Class
            const acEl = document.getElementById('previewAC');
            const ac = calculateAC();
            if (ac) {
                acEl.textContent = ac;
                acEl.classList.remove('empty');
            } else {
                acEl.textContent = '--';
                acEl.classList.add('empty');
            }

            // Speed
            const speedEl = document.getElementById('previewSpeed');
            if (character.race) {
                let speed = RACES[character.race].speed;
                // Wood elf speed bonus
                if (character.race === 'elf' && character.subrace === 'wood') {
                    speed = 35;
                }
                speedEl.textContent = speed + ' ft';
                speedEl.classList.remove('empty');
            }

            // Update ability preview
            updateAbilityPreview();

            // Spells
            const spellsSection = document.getElementById('previewSpellsSection');
            const spellsEl = document.getElementById('previewSpells');

            // Count all spells including feat-granted and subclass-granted
            const featSpells = getFeatGrantedSpells();
            const subclassSpells = getSubclassGrantedSpells();
            let totalSpells = character.spells.cantrips.length + featSpells.length + subclassSpells.spells.length + subclassSpells.cantrips.length;
            for (let lvl = 1; lvl <= 9; lvl++) {
                totalSpells += (character.spells[`level${lvl}`] || []).length;
            }

            if (totalSpells > 0) {
                spellsSection.style.display = 'block';
                let spellText = '';

                // Cantrips (combine regular and subclass-granted)
                const allCantrips = [...character.spells.cantrips];
                // Add subclass cantrips with a marker
                const subclassCantripsFormatted = subclassSpells.cantrips.map(c => `<span style="color: #b8860b;">${c}*</span>`);

                if (allCantrips.length > 0 || subclassSpells.cantrips.length > 0) {
                    spellText += 'Cantrips: ' + allCantrips.join(', ');
                    if (subclassSpells.cantrips.length > 0) {
                        if (allCantrips.length > 0) spellText += ', ';
                        spellText += subclassCantripsFormatted.join(', ');
                    }
                }

                // Leveled spells
                for (let lvl = 1; lvl <= 9; lvl++) {
                    const spells = character.spells[`level${lvl}`] || [];
                    if (spells.length > 0) {
                        if (spellText) spellText += '<br>';
                        spellText += `${getOrdinal(lvl)}: ` + spells.join(', ');
                    }
                }

                // Subclass-granted spells (always prepared)
                if (subclassSpells.spells.length > 0) {
                    if (spellText) spellText += '<br>';
                    spellText += '<span style="color: #b8860b;">Subclass: ' + subclassSpells.spells.join(', ') + '</span>';
                }

                // Feat-granted spells
                if (featSpells.length > 0) {
                    if (spellText) spellText += '<br>';
                    spellText += '<span style="color: #9b59b6;">Feat: ' + featSpells.join(', ') + '</span>';
                }

                spellsEl.innerHTML = spellText;
            } else {
                spellsSection.style.display = 'none';
            }

            // Subclass Features
            updateSubclassFeaturesPreview();

            // Class Features
            updateClassFeaturesPreview();
        }

        // Update class features section in preview
        function updateClassFeaturesPreview() {
            let featuresSection = document.getElementById('previewClassFeaturesSection');
            if (!featuresSection) {
                // Create the section if it doesn't exist
                const previewContent = document.querySelector('.preview-content');
                if (!previewContent) return;

                featuresSection = document.createElement('div');
                featuresSection.id = 'previewClassFeaturesSection';
                featuresSection.className = 'preview-section';
                featuresSection.innerHTML = `
                    <div class="preview-label">CLASS FEATURES</div>
                    <div id="previewClassFeatures" class="preview-value"></div>
                `;
                // Insert after skills section
                const skillsSection = document.getElementById('previewSkillsSection');
                if (skillsSection) {
                    skillsSection.after(featuresSection);
                } else {
                    previewContent.appendChild(featuresSection);
                }
            }

            const features = getClassFeatures();
            const featuresEl = document.getElementById('previewClassFeatures');

            if (features.length > 0) {
                featuresSection.style.display = 'block';
                let featuresHtml = features.map(f =>
                    `<div class="subclass-feature-item"><span class="feature-name">${f.name}</span> <span class="feature-level">(Lv ${f.level})</span></div>`
                ).join('');
                featuresEl.innerHTML = featuresHtml;
            } else {
                featuresSection.style.display = 'none';
            }
        }

        // Update subclass features section in preview
        function updateSubclassFeaturesPreview() {
            let featuresSection = document.getElementById('previewSubclassFeaturesSection');
            if (!featuresSection) {
                // Create the section if it doesn't exist
                const previewContent = document.querySelector('.preview-content');
                if (!previewContent) return;

                featuresSection = document.createElement('div');
                featuresSection.id = 'previewSubclassFeaturesSection';
                featuresSection.className = 'preview-section';
                featuresSection.innerHTML = `
                    <div class="preview-label">SUBCLASS FEATURES</div>
                    <div id="previewSubclassFeatures" class="preview-value"></div>
                `;
                // Insert after spells section or at the end
                const spellsSection = document.getElementById('previewSpellsSection');
                if (spellsSection) {
                    spellsSection.after(featuresSection);
                } else {
                    previewContent.appendChild(featuresSection);
                }
            }

            const features = getSubclassFeatures();
            const featuresEl = document.getElementById('previewSubclassFeatures');

            if (features.length > 0) {
                featuresSection.style.display = 'block';
                let featuresHtml = features.map(f =>
                    `<div class="subclass-feature-item"><span class="feature-name">${f.name}</span> <span class="feature-level">(Lv ${f.level})</span></div>`
                ).join('');
                featuresEl.innerHTML = featuresHtml;
            } else {
                featuresSection.style.display = 'none';
            }
        }

        // Get spells granted by feats
        function getFeatGrantedSpells() {
            const spells = [];

            // Check variant human feat
            const variantFeat = character.feats.find(f => f.source === 'variantHuman');
            if (variantFeat && variantFeat.key) {
                const feat = FEATS[variantFeat.key];
                if (feat && feat.grantsSpells && feat.grantsSpells.fixed) {
                    spells.push(...feat.grantsSpells.fixed);
                }
            }

            // Check ASI feat choices
            Object.values(character.asiChoices).forEach(choice => {
                if (choice.type === 'feat' && choice.feat) {
                    const feat = FEATS[choice.feat];
                    if (feat && feat.grantsSpells && feat.grantsSpells.fixed) {
                        spells.push(...feat.grantsSpells.fixed);
                    }
                }
            });

            return spells;
        }

        // Get subclass-granted spells based on character level
        function getSubclassGrantedSpells() {
            if (!character.class || !character.subclass) return { spells: [], cantrips: [] };

            const cls = CLASSES[character.class];
            const subclass = cls.subclasses[character.subclass];
            if (!subclass || !subclass.grantedSpells) return { spells: [], cantrips: [] };

            let spells = [];
            let cantrips = [];

            // Accumulate spells from subclass level up to current level
            for (let lvl = cls.subclassLevel; lvl <= character.level; lvl++) {
                const granted = subclass.grantedSpells[lvl];
                if (granted) {
                    if (granted.always) spells.push(...granted.always);
                    if (granted.cantrips) cantrips.push(...granted.cantrips);
                }
            }

            // Remove duplicates
            return {
                spells: [...new Set(spells)],
                cantrips: [...new Set(cantrips)]
            };
        }

        // Get subclass features based on character level
        function getSubclassFeatures() {
            if (!character.class || !character.subclass) return [];

            const cls = CLASSES[character.class];
            const subclass = cls.subclasses[character.subclass];
            if (!subclass || !subclass.features) return [];

            let features = [];

            // Accumulate features from subclass level up to current level
            for (let lvl = cls.subclassLevel; lvl <= character.level; lvl++) {
                if (subclass.features[lvl]) {
                    features.push(...subclass.features[lvl].map(f => ({
                        ...f,
                        level: lvl
                    })));
                }
            }

            return features;
        }

        // ===== SOUND =====
        let tavernMusicCtx = null;
        let tavernMusicNodes = [];
        let tavernMusicInterval = null;

        function toggleMusic() {
            musicEnabled = !musicEnabled;
            const btn = document.querySelector('.music-toggle');

            if (musicEnabled) {
                startTavernMusic();
                btn.textContent = 'ðŸŽµ MUSIC ON';
                btn.classList.remove('muted');
            } else {
                stopTavernMusic();
                btn.textContent = 'ðŸŽµ MUSIC OFF';
                btn.classList.add('muted');
            }
        }

        function startTavernMusic() {
            if (!tavernMusicCtx) {
                tavernMusicCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Resume context if suspended (browser autoplay policy)
            if (tavernMusicCtx.state === 'suspended') {
                tavernMusicCtx.resume();
            }

            // Medieval/tavern-style melody notes (pentatonic scale for pleasant sound)
            const melody = [
                // Stanza 1 - Opening theme
                { note: 'D4', duration: 0.5 },
                { note: 'E4', duration: 0.25 },
                { note: 'G4', duration: 0.5 },
                { note: 'A4', duration: 0.25 },
                { note: 'G4', duration: 0.5 },
                { note: 'E4', duration: 0.25 },
                { note: 'D4', duration: 0.75 },
                { note: 'REST', duration: 0.25 },
                // Stanza 2 - Rising phrase
                { note: 'A4', duration: 0.5 },
                { note: 'G4', duration: 0.25 },
                { note: 'E4', duration: 0.5 },
                { note: 'D4', duration: 0.25 },
                { note: 'E4', duration: 0.5 },
                { note: 'G4', duration: 0.5 },
                { note: 'A4', duration: 0.75 },
                { note: 'REST', duration: 0.25 },
                // Stanza 3 - High melody
                { note: 'B4', duration: 0.5 },
                { note: 'A4', duration: 0.25 },
                { note: 'G4', duration: 0.5 },
                { note: 'E4', duration: 0.5 },
                { note: 'D4', duration: 0.75 },
                { note: 'REST', duration: 0.5 },
                // Stanza 4 - Gentle descent
                { note: 'G4', duration: 0.5 },
                { note: 'A4', duration: 0.5 },
                { note: 'B4', duration: 0.5 },
                { note: 'A4', duration: 0.25 },
                { note: 'G4', duration: 0.75 },
                { note: 'E4', duration: 0.5 },
                { note: 'D4', duration: 0.5 },
                { note: 'REST', duration: 0.5 },
                // Stanza 5 - Wandering phrase
                { note: 'E4', duration: 0.5 },
                { note: 'G4', duration: 0.25 },
                { note: 'A4', duration: 0.5 },
                { note: 'B4', duration: 0.25 },
                { note: 'A4', duration: 0.5 },
                { note: 'G4', duration: 0.5 },
                { note: 'E4', duration: 0.75 },
                { note: 'REST', duration: 0.25 },
                // Stanza 6 - Soft interlude
                { note: 'D4', duration: 0.75 },
                { note: 'E4', duration: 0.5 },
                { note: 'D4', duration: 0.5 },
                { note: 'C4', duration: 0.75 },
                { note: 'D4', duration: 0.5 },
                { note: 'REST', duration: 0.5 },
                // Stanza 7 - Building phrase
                { note: 'E4', duration: 0.25 },
                { note: 'G4', duration: 0.25 },
                { note: 'A4', duration: 0.5 },
                { note: 'B4', duration: 0.5 },
                { note: 'D5', duration: 0.75 },
                { note: 'B4', duration: 0.25 },
                { note: 'A4', duration: 0.5 },
                { note: 'REST', duration: 0.25 },
                // Stanza 8 - Cascading down
                { note: 'D5', duration: 0.5 },
                { note: 'B4', duration: 0.25 },
                { note: 'A4', duration: 0.5 },
                { note: 'G4', duration: 0.25 },
                { note: 'E4', duration: 0.5 },
                { note: 'D4', duration: 0.75 },
                { note: 'REST', duration: 0.5 },
                // Stanza 9 - Reflective melody
                { note: 'G4', duration: 0.75 },
                { note: 'E4', duration: 0.5 },
                { note: 'G4', duration: 0.5 },
                { note: 'A4', duration: 0.75 },
                { note: 'G4', duration: 0.25 },
                { note: 'E4', duration: 0.5 },
                { note: 'REST', duration: 0.25 },
                // Stanza 10 - Final resolution
                { note: 'A4', duration: 0.5 },
                { note: 'G4', duration: 0.5 },
                { note: 'E4', duration: 0.5 },
                { note: 'D4', duration: 1.0 },
                { note: 'REST', duration: 0.75 },
            ];

            const noteFreqs = {
                'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23,
                'G4': 392.00, 'A4': 440.00, 'B4': 493.88, 'C5': 523.25,
                'D5': 587.33, 'REST': 0
            };

            let noteIndex = 0;
            const playNextNote = () => {
                if (!musicEnabled) return;

                const { note, duration } = melody[noteIndex];
                const freq = noteFreqs[note];

                if (freq > 0) {
                    // Main melody (lute-like sound)
                    const osc = tavernMusicCtx.createOscillator();
                    const gain = tavernMusicCtx.createGain();
                    const filter = tavernMusicCtx.createBiquadFilter();

                    osc.type = 'triangle';
                    osc.frequency.value = freq;

                    filter.type = 'lowpass';
                    filter.frequency.value = 1500;

                    gain.gain.setValueAtTime(0.15, tavernMusicCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, tavernMusicCtx.currentTime + duration * 0.9);

                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(tavernMusicCtx.destination);

                    osc.start();
                    osc.stop(tavernMusicCtx.currentTime + duration);

                    // Add a subtle drone/bass note
                    if (noteIndex % 4 === 0) {
                        const bassOsc = tavernMusicCtx.createOscillator();
                        const bassGain = tavernMusicCtx.createGain();

                        bassOsc.type = 'sine';
                        bassOsc.frequency.value = freq / 2;

                        bassGain.gain.setValueAtTime(0.08, tavernMusicCtx.currentTime);
                        bassGain.gain.exponentialRampToValueAtTime(0.01, tavernMusicCtx.currentTime + duration * 2);

                        bassOsc.connect(bassGain);
                        bassGain.connect(tavernMusicCtx.destination);

                        bassOsc.start();
                        bassOsc.stop(tavernMusicCtx.currentTime + duration * 2);
                    }
                }

                noteIndex = (noteIndex + 1) % melody.length;

                tavernMusicInterval = setTimeout(playNextNote, duration * 650); // Tempo (slower for relaxing feel)
            };

            playNextNote();
        }

        function stopTavernMusic() {
            if (tavernMusicInterval) {
                clearTimeout(tavernMusicInterval);
                tavernMusicInterval = null;
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.querySelector('.sound-toggle:not(.music-toggle)');
            btn.textContent = soundEnabled ? 'ðŸ”Š SOUND ON' : 'ðŸ”‡ SOUND OFF';
            btn.classList.toggle('muted', !soundEnabled);
        }

        function playSound(type) {
            if (!soundEnabled) return;

            // Create audio context for 8-bit sounds
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'square';
            gainNode.gain.value = 0.1;

            switch (type) {
                case 'click':
                    oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(600, audioCtx.currentTime + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    break;
                case 'next':
                    oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(600, audioCtx.currentTime + 0.05);
                    oscillator.frequency.setValueAtTime(800, audioCtx.currentTime + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.15);
                    break;
                case 'roll':
                    // Dice rolling sound - multiple quick notes
                    oscillator.type = 'triangle';
                    for (let i = 0; i < 6; i++) {
                        oscillator.frequency.setValueAtTime(200 + Math.random() * 400, audioCtx.currentTime + i * 0.05);
                    }
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                case 'dice':
                    // Quick dice roll sound
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
                    oscillator.frequency.setValueAtTime(500, audioCtx.currentTime + 0.05);
                    oscillator.frequency.setValueAtTime(700, audioCtx.currentTime + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.15);
                    break;
            }
        }

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('SW registration failed:', err));
        }
    </script>
</body>
</html>
